<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üéØ Turnuva Y√∂netim Paneli - Akƒ±l Zeka</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- React Production Build for better performance and security -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update, query, limitToLast, orderByChild, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // üîå Connection State Monitoring
        const connectedRef = ref(db, '.info/connected');
        window.isFirebaseConnected = false;
        onValue(connectedRef, (snap) => {
            window.isFirebaseConnected = snap.val() === true;
            window.dispatchEvent(new CustomEvent('firebase-connection', { detail: snap.val() }));
        });
        
        // üìä Firebase i≈ülemlerini sarmalayan error handler with timeout
        const safeDbOperation = async (operation, fallbackValue = null, timeout = 10000) => {
            try {
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ƒ∞≈ülem zaman a≈üƒ±mƒ±na uƒüradƒ±')), timeout)
                );
                return await Promise.race([operation(), timeoutPromise]);
            } catch (error) {
                console.error('Firebase Error:', error);
                window.dispatchEvent(new CustomEvent('firebase-error', { detail: error.message }));
                return fallbackValue;
            }
        };
        
        // üîÑ Retry mekanizmasƒ± ile g√ºvenli yazma with timeout
        const safeDbSet = async (refPath, data, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Set i≈ülemi zaman a≈üƒ±mƒ±na uƒüradƒ±')), 10000)
                    );
                    await Promise.race([set(refPath, data), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Set Failed after retries:', error);
                        window.dispatchEvent(new CustomEvent('firebase-error', { detail: error.message }));
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1))); // Exponential backoff
                }
            }
        };
        
        const safeDbUpdate = async (refPath, data, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update i≈ülemi zaman a≈üƒ±mƒ±na uƒüradƒ±')), 10000)
                    );
                    await Promise.race([update(refPath, data), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Update Failed after retries:', error);
                        window.dispatchEvent(new CustomEvent('firebase-error', { detail: error.message }));
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        };
        
        const safeDbRemove = async (refPath, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Remove i≈ülemi zaman a≈üƒ±mƒ±na uƒüradƒ±')), 10000)
                    );
                    await Promise.race([remove(refPath), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Remove Failed after retries:', error);
                        window.dispatchEvent(new CustomEvent('firebase-error', { detail: error.message }));
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        };
        
        // üì¶ Offline Operation Queue
        window.pendingOperations = [];
        window.processingQueue = false;
        
        const processOfflineQueue = async () => {
            if (window.processingQueue || !window.isFirebaseConnected) return;
            window.processingQueue = true;
            
            while (window.pendingOperations.length > 0 && window.isFirebaseConnected) {
                const op = window.pendingOperations.shift();
                try {
                    await op.execute();
                    console.log('Offline operation processed:', op.type);
                } catch (error) {
                    console.error('Failed to process offline operation:', error);
                    // Re-queue if critical
                    if (op.critical) {
                        window.pendingOperations.unshift(op);
                        break;
                    }
                }
            }
            window.processingQueue = false;
        };
        
        // Auto-process queue when connection restored
        onValue(connectedRef, (snap) => {
            const wasConnected = window.isFirebaseConnected;
            window.isFirebaseConnected = snap.val() === true;
            window.dispatchEvent(new CustomEvent('firebase-connection', { detail: snap.val() }));
            
            if (!wasConnected && window.isFirebaseConnected) {
                setTimeout(processOfflineQueue, 1000); // Small delay for stability
            }
        });
        
        // üîê Basit ≈üifre hash fonksiyonu (client-side g√ºvenlik i√ßin)
        const simpleHash = async (str) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(str + 'akilzeka_salt_2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };
        window.simpleHash = simpleHash;
        
        // üö¶ Rate Limiting - Brute force korumasƒ±
        const rateLimiter = {
            attempts: {},
            maxAttempts: 5,
            lockoutTime: 60000, // 1 dakika
            
            canAttempt(key) {
                const now = Date.now();
                if (!this.attempts[key]) {
                    this.attempts[key] = { count: 0, lastAttempt: now, lockedUntil: 0 };
                }
                
                const record = this.attempts[key];
                
                // Lockout kontrol√º
                if (record.lockedUntil > now) {
                    const remainingSec = Math.ceil((record.lockedUntil - now) / 1000);
                    return { allowed: false, message: `√áok fazla deneme. ${remainingSec} saniye bekleyin.` };
                }
                
                // Eski denemeleri temizle (5 dakikadan eski)
                if (now - record.lastAttempt > 300000) {
                    record.count = 0;
                }
                
                return { allowed: true };
            },
            
            recordAttempt(key, success) {
                const now = Date.now();
                if (!this.attempts[key]) {
                    this.attempts[key] = { count: 0, lastAttempt: now, lockedUntil: 0 };
                }
                
                const record = this.attempts[key];
                record.lastAttempt = now;
                
                if (success) {
                    record.count = 0;
                    record.lockedUntil = 0;
                } else {
                    record.count++;
                    if (record.count >= this.maxAttempts) {
                        record.lockedUntil = now + this.lockoutTime;
                        record.count = 0;
                    }
                }
            }
        };
        window.rateLimiter = rateLimiter;
        
        window.db = db;
        window.dbRef = ref;
        window.dbSet = safeDbSet;
        window.dbOnValue = onValue;
        window.dbRemove = safeDbRemove;
        window.dbUpdate = safeDbUpdate;
        window.dbQuery = query;
        window.dbLimitToLast = limitToLast;
        window.dbOrderByChild = orderByChild;
        window.dbGet = get;
        window.processOfflineQueue = processOfflineQueue;
        
        // ‚ö†Ô∏è Global Error Handlers
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled Promise Rejection:', event.reason);
            window.dispatchEvent(new CustomEvent('firebase-error', { 
                detail: 'Beklenmeyen bir hata olu≈ütu: ' + (event.reason?.message || 'Bilinmeyen hata') 
            }));
            event.preventDefault();
        });
        
        window.addEventListener('error', (event) => {
            console.error('Global Error:', event.error);
            if (event.error?.message?.includes('Firebase')) {
                window.dispatchEvent(new CustomEvent('firebase-error', { 
                    detail: event.error.message 
                }));
            }
        });
    </script>

    <style>
        * { box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0;
            font-family: 'Fredoka', 'Baloo 2', sans-serif;
            min-height: 100vh;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* üåà FUN GRADIENT BACKGROUND */
        .fun-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* ‚ú® FLOATING SHAPES */
        .floating-shapes {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: floatShape 20s infinite ease-in-out;
        }
        @keyframes floatShape {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-50px) rotate(180deg); }
        }

        /* üé® GLASS CARDS */
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .glass-card-light {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        /* üéØ COLORFUL BUTTONS */
        .btn-candy {
            position: relative;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 rgba(0,0,0,0.15), 0 8px 20px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        .btn-candy:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 rgba(0,0,0,0.15), 0 12px 30px rgba(0,0,0,0.25);
        }
        .btn-candy:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.2);
        }
        
        /* üì± Mobile Performance Optimizations */
        @media (max-width: 768px) {
            .btn-candy {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .glass-card {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            /* Reduce animations on mobile for better performance */
            @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }
        }
        
        /* ‚ö° Shimmer Loading Animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .shimmer {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.1) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .btn-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .btn-red { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); color: white; }
        .btn-yellow { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); color: #333; }
        .btn-teal { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-indigo { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-gray { background: linear-gradient(135deg, #a8a8a8 0%, #c0c0c0 100%); color: #333; }

        /* üåà RAINBOW TEXT */
        .rainbow-text {
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowMove 3s linear infinite;
        }
        @keyframes rainbowMove {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* ‚≠ê ANIMATIONS */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .bounce { animation: bounce 2s ease-in-out infinite; }

        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        .wave { animation: wave 1s ease-in-out infinite; display: inline-block; }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }

        /* üìä STATS CARDS */
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* üéÆ GAME CARDS */
        .game-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .game-card.playing {
            border-color: #38ef7d;
        }
        .game-card.finished {
            border-color: #f5576c;
            opacity: 0.7;
        }

        /* üë§ USER CARDS */
        .user-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .user-card:hover {
            transform: translateX(5px);
            border-color: #667eea;
        }
        .user-card.waiting {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        }
        .user-card.playing {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        /* üè∑Ô∏è TABS */
        .tab-btn {
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }
        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* üìù INPUT STYLES */
        .input-fun {
            background: rgba(255,255,255,0.9);
            border: 3px solid #e0e0e0;
            border-radius: 16px;
            padding: 14px 18px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
            color: #333;
        }
        .input-fun:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        .input-fun::placeholder {
            color: #999;
        }

        /* üìã TABLE STYLES */
        .fun-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        .fun-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            font-weight: 700;
            text-align: left;
        }
        .fun-table th:first-child { border-radius: 12px 0 0 12px; }
        .fun-table th:last-child { border-radius: 0 12px 12px 0; }
        .fun-table td {
            background: white;
            padding: 14px 16px;
            border-top: 2px solid #f0f0f0;
            border-bottom: 2px solid #f0f0f0;
        }
        .fun-table td:first-child { border-left: 2px solid #f0f0f0; border-radius: 12px 0 0 12px; }
        .fun-table td:last-child { border-right: 2px solid #f0f0f0; border-radius: 0 12px 12px 0; }
        .fun-table tr:hover td {
            background: #f8f9ff;
        }

        /* üè∑Ô∏è BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        .badge-green { background: linear-gradient(135deg, #d4fc79, #96e6a1); color: #1a5928; }
        .badge-blue { background: linear-gradient(135deg, #a8edea, #fed6e3); color: #1a3a5c; }
        .badge-purple { background: linear-gradient(135deg, #e0c3fc, #8ec5fc); color: #4a1a5c; }
        .badge-orange { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .badge-red { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        /* üé≤ GAME TYPE ICONS */
        .game-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        @media (min-width: 640px) {
            .game-icon {
                width: 50px;
                height: 50px;
                border-radius: 12px;
                font-size: 1.5rem;
            }
        }
        .game-icon.mangala { background: linear-gradient(135deg, #f7971e, #ffd200); }
        .game-icon.reversi { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .game-icon.pentago { background: linear-gradient(135deg, #667eea, #764ba2); }
        .game-icon.kulami { background: linear-gradient(135deg, #ff6b6b, #ee5a6f); }
        .game-icon.kure { background: linear-gradient(135deg, #4CAF50, #2196F3); }
        .game-icon.qbitz { background: linear-gradient(135deg, #9C27B0, #E91E63); }

        /* üß© KULAMI ANIMATIONS */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.4); }
        }
        .kulami-valid-cell {
            animation: pulse-glow 2s ease-in-out infinite;
            cursor: pointer;
        }
        .kulami-forbidden {
            opacity: 0.4;
            position: relative;
        }
        .kulami-last-move {
            box-shadow: 0 0 0 3px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.6);
        }

        /* üì± RESPONSIVE */
        @media (max-width: 768px) {
            .btn-candy {
                padding: 10px 16px;
                font-size: 0.8rem;
            }
            .tab-btn {
                padding: 8px 12px;
                font-size: 0.7rem;
            }
            .stat-card {
                padding: 1rem;
            }
            .stat-card .text-4xl {
                font-size: 1.5rem;
            }
            .stat-card .text-3xl {
                font-size: 1.5rem;
            }
            .glass-card, .glass-card-light {
                padding: 1rem;
            }
            .game-card {
                padding: 0;
            }
            .game-card .p-4 {
                padding: 0.75rem;
            }
            .user-card {
                padding: 0.5rem;
            }
            .input-fun {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            .fun-table th, .fun-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
            .badge {
                padding: 2px 6px;
                font-size: 0.65rem;
            }
        }
        @media (max-width: 480px) {
            .btn-candy {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
            .tab-btn {
                padding: 6px 10px;
                font-size: 0.65rem;
            }
            .input-fun {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }

        /* LIVE INDICATOR */
        .live-dot {
            width: 12px;
            height: 12px;
            background: #ff4757;
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
        }
        @keyframes livePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
        }

        /* GEM STONE FOR MARBLES */
        .gem-stone {
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.3), inset 2px 2px 6px rgba(255,255,255,0.4);
        }

        /* üîÑ SHIMMER ANIMATION FOR LOADING */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* üö´ DISABLED STATE */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
</head>
<body class="fun-bg">
    <!-- Floating Shapes Background -->
    <div class="floating-shapes">
        <div class="shape" style="width: 300px; height: 300px; background: #667eea; top: 10%; left: -100px;"></div>
        <div class="shape" style="width: 200px; height: 200px; background: #f093fb; top: 60%; right: -50px; animation-delay: -5s;"></div>
        <div class="shape" style="width: 150px; height: 150px; background: #4facfe; bottom: 10%; left: 30%; animation-delay: -10s;"></div>
        <div class="shape" style="width: 250px; height: 250px; background: #38ef7d; top: 30%; right: 20%; animation-delay: -15s;"></div>
    </div>

    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // üîî Toast Notification Component
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            const bgColor = type === 'error' ? 'from-red-500 to-red-600' : 
                           type === 'success' ? 'from-green-500 to-green-600' : 
                           'from-blue-500 to-blue-600';
            
            return (
                <div className={`fixed top-4 left-4 right-4 sm:left-auto sm:right-4 z-[100] bg-gradient-to-r ${bgColor} text-white px-4 sm:px-6 py-3 rounded-xl shadow-2xl pop-in flex items-center gap-2 sm:gap-3`}>
                    <i className={`fas text-sm sm:text-base ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}`}></i>
                    <span className="font-bold text-sm sm:text-base flex-1">{message}</span>
                    <button onClick={onClose} className="ml-2 active:opacity-70 p-1">
                        <i className="fas fa-times"></i>
                    </button>
                </div>
            );
        };

        // üîÑ Connection Status Component with Retry
        const ConnectionStatus = ({ isConnected, isLoading }) => {
            const [retrying, setRetrying] = React.useState(false);
            
            const handleRetry = () => {
                setRetrying(true);
                window.processOfflineQueue();
                setTimeout(() => setRetrying(false), 2000);
            };
            
            return (
                <div className={`fixed bottom-4 right-4 z-50 flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm transition-all cursor-pointer ${
                    isLoading ? 'bg-yellow-500 text-yellow-900' :
                    isConnected ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 
                    'bg-red-500 text-white animate-pulse'
                }`} onClick={!isConnected && !retrying ? handleRetry : undefined}>
                    <div className={`w-2 h-2 rounded-full ${retrying ? 'animate-spin' : ''} ${isLoading ? 'bg-yellow-900' : isConnected ? 'bg-green-400' : 'bg-white'}`}></div>
                    {isLoading ? 'Y√ºkleniyor...' : retrying ? 'Yeniden baƒülanƒ±yor...' : isConnected ? 'Baƒülƒ±' : 'Baƒülantƒ± Kesildi! (Tƒ±kla)'}
                    {!isConnected && window.pendingOperations && window.pendingOperations.length > 0 && (
                        <span className="ml-1 bg-white/20 px-2 py-0.5 rounded-full text-xs">
                            {window.pendingOperations.length} bekliyor
                        </span>
                    )}
                </div>
            );
        };

        // üìä Loading Skeleton Component
        const Skeleton = ({ className }) => (
            <div className={`animate-pulse bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 bg-[length:200%_100%] rounded ${className}`}
                 style={{ animation: 'shimmer 1.5s infinite' }}></div>
        );

        //   ROZET Sƒ∞STEMƒ∞ - Panel i√ßin
        const BADGES = {
            // Ba≈ülangƒ±√ß
            first_win: { icon: "‚≠ê", name: "ƒ∞lk Zafer", desc: "ƒ∞lk galibiyetini kazan", color: "#ffd700", rarity: "common" },
            first_blood: { icon: "üéØ", name: "ƒ∞lk Adƒ±m", desc: "ƒ∞lk oyununu tamamla", color: "#4ade80", rarity: "common" },
            // Mangala
            mangala_novice: { icon: "ü•â", name: "Mangala √áƒ±raƒüƒ±", desc: "3 Mangala galibiyeti", color: "#cd7f32", rarity: "common" },
            mangala_master: { icon: "ü¶Å", name: "Mangala Ustasƒ±", desc: "10 Mangala galibiyeti", color: "#ff9f43", rarity: "rare" },
            mangala_legend: { icon: "üëë", name: "Mangala Kralƒ±", desc: "25 Mangala galibiyeti", color: "#ffd700", rarity: "legendary" },
            // Reversi
            reversi_novice: { icon: "üé≤", name: "Reversi Ba≈ülangƒ±√ß", desc: "3 Reversi galibiyeti", color: "#22d3ee", rarity: "common" },
            reversi_brain: { icon: "üß†", name: "Strateji Dehasƒ±", desc: "10 Reversi galibiyeti", color: "#54a0ff", rarity: "rare" },
            reversi_genius: { icon: "üîÆ", name: "Reversi B√ºy√ºc√ºs√º", desc: "25 Reversi galibiyeti", color: "#a855f7", rarity: "legendary" },
            // Pentago
            pentago_novice: { icon: "üéØ", name: "Pentago Acemi", desc: "3 Pentago galibiyeti", color: "#f472b6", rarity: "common" },
            pentago_pro: { icon: "üíé", name: "Pentago Pro", desc: "10 Pentago galibiyeti", color: "#5f27cd", rarity: "rare" },
            pentago_master: { icon: "üåü", name: "Pentago Efsanesi", desc: "25 Pentago galibiyeti", color: "#ec4899", rarity: "legendary" },
            // Kulami
            kulami_novice: { icon: "üß©", name: "Kulami √áƒ±raƒüƒ±", desc: "3 Kulami galibiyeti", color: "#e74c3c", rarity: "common" },
            kulami_master: { icon: "üéØ", name: "Kulami Ustasƒ±", desc: "10 Kulami galibiyeti", color: "#c0392b", rarity: "rare" },
            kulami_legend: { icon: "üíé", name: "Kulami Efsanesi", desc: "25 Kulami galibiyeti", color: "#ff6b6b", rarity: "legendary" },
            // Seri
            streak_3: { icon: "üî•", name: "Ate≈ü Ba≈üladƒ±", desc: "3 ma√ß √ºst √ºste kazan", color: "#f97316", rarity: "common" },
            streak_5: { icon: "üí•", name: "Durdurulamaz", desc: "5 ma√ß √ºst √ºste kazan", color: "#ef4444", rarity: "rare" },
            streak_10: { icon: "‚òÑÔ∏è", name: "Meteor", desc: "10 ma√ß √ºst √ºste kazan", color: "#dc2626", rarity: "epic" },
            // Toplam
            wins_5: { icon: "üéñÔ∏è", name: "Yƒ±ldƒ±z Aday", desc: "5 galibiyet", color: "#84cc16", rarity: "common" },
            wins_10: { icon: "üèÖ", name: "Bronz ≈ûampiyon", desc: "10 galibiyet", color: "#cd7f32", rarity: "common" },
            wins_25: { icon: "ü•à", name: "G√ºm√º≈ü ≈ûampiyon", desc: "25 galibiyet", color: "#c0c0c0", rarity: "rare" },
            wins_50: { icon: "ü•á", name: "Altƒ±n ≈ûampiyon", desc: "50 galibiyet", color: "#ffd700", rarity: "epic" },
            wins_100: { icon: "üíé", name: "Elmas ≈ûampiyon", desc: "100 galibiyet", color: "#06b6d4", rarity: "legendary" },
            // √áoklu
            all_rounder: { icon: "üåà", name: "√áok Y√∂nl√º", desc: "Her oyundan galibiyet", color: "#8b5cf6", rarity: "rare" },
            triple_master: { icon: "üé™", name: "√ú√ßl√º Usta", desc: "Her oyundan 5 galibiyet", color: "#f43f5e", rarity: "epic" },
            ultimate_champion: { icon: "üë∏", name: "S√ºper ≈ûampiyon", desc: "Her oyundan 15 galibiyet", color: "#fbbf24", rarity: "legendary" },
            // √ñzel
            veteran: { icon: "üéì", name: "Veteran", desc: "50 oyun tamamla", color: "#6366f1", rarity: "epic" },
            legend: { icon: "üåü", name: "Efsane", desc: "100 oyun tamamla", color: "#eab308", rarity: "legendary" },
            // √ñƒüretmen tarafƒ±ndan verilebilir
            tournament_winner: { icon: "üèÜ", name: "Turnuva ≈ûampiyonu", desc: "Okul turnuvasƒ±nƒ± kazan", color: "#fbbf24", rarity: "legendary" },
            fair_play: { icon: "ü§ù", name: "Fair Play", desc: "√ñrnek sporcu davranƒ±≈üƒ±", color: "#14b8a6", rarity: "special" },
            rising_star: { icon: "üí´", name: "Y√ºkselen Yƒ±ldƒ±z", desc: "En √ßok geli≈üen oyuncu", color: "#f472b6", rarity: "special" },
            brain_master: { icon: "üß©", name: "Beyin Ustasƒ±", desc: "Zeka oyunlarƒ±nda √ºst√ºn ba≈üarƒ±", color: "#8b5cf6", rarity: "special" }
        };

        // üè´ OKUL ROZETLERƒ∞
        const SCHOOL_BADGES = {
            // Turnuva Rozetleri
            tournament_champion: { icon: "üèÜ", name: "Turnuva ≈ûampiyonu", desc: "Okul turnuvasƒ±nƒ± kazanan okul", color: "#ffd700", rarity: "legendary" },
            interschool_winner: { icon: "ü•á", name: "Okullar Arasƒ± 1.", desc: "Okullar arasƒ± turnuva birincisi", color: "#ffd700", rarity: "legendary" },
            interschool_second: { icon: "ü•à", name: "Okullar Arasƒ± 2.", desc: "Okullar arasƒ± turnuva ikincisi", color: "#c0c0c0", rarity: "epic" },
            interschool_third: { icon: "ü•â", name: "Okullar Arasƒ± 3.", desc: "Okullar arasƒ± turnuva √º√ß√ºnc√ºs√º", color: "#cd7f32", rarity: "rare" },
            // Ba≈üarƒ± Rozetleri
            active_school: { icon: "üî•", name: "Aktif Okul", desc: "En aktif turnuva katƒ±lƒ±mcƒ±sƒ±", color: "#f97316", rarity: "rare" },
            rising_school: { icon: "üìà", name: "Y√ºkselen Okul", desc: "Hƒ±zla geli≈üen okul", color: "#22c55e", rarity: "rare" },
            fair_play_school: { icon: "ü§ù", name: "Fair Play Okulu", desc: "√ñrnek sportmenlik sergileyen okul", color: "#14b8a6", rarity: "special" },
            brain_school: { icon: "üß†", name: "Beyin Takƒ±mƒ±", desc: "Zeka oyunlarƒ±nda √ºst√ºn ba≈üarƒ±", color: "#8b5cf6", rarity: "epic" },
            // √ñzel Rozetler
            star_school: { icon: "‚≠ê", name: "Yƒ±ldƒ±z Okul", desc: "√ñzel ba≈üarƒ± rozeti", color: "#fbbf24", rarity: "special" },
            pioneer_school: { icon: "üöÄ", name: "√ñnc√º Okul", desc: "ƒ∞lk katƒ±lan okullardan biri", color: "#3b82f6", rarity: "special" },
            creative_school: { icon: "üé®", name: "Yaratƒ±cƒ± Okul", desc: "Yaratƒ±cƒ± stratejiler geli≈ütiren okul", color: "#ec4899", rarity: "special" },
            community_school: { icon: "üíù", name: "Topluluk Okulu", desc: "Topluluk ruhu ta≈üƒ±yan okul", color: "#f472b6", rarity: "special" }
        };

        const RARITY_COLORS = {
            common: { bg: "bg-gray-100", border: "border-gray-300", text: "text-gray-600" },
            rare: { bg: "bg-blue-50", border: "border-blue-300", text: "text-blue-600" },
            epic: { bg: "bg-purple-50", border: "border-purple-300", text: "text-purple-600" },
            legendary: { bg: "bg-yellow-50", border: "border-yellow-400", text: "text-yellow-600" },
            special: { bg: "bg-pink-50", border: "border-pink-300", text: "text-pink-600" }
        };

        const SPECIAL_BADGES = ['tournament_winner', 'fair_play', 'rising_star', 'brain_master'];

        // üß© KULAMI PANEL OLU≈ûTURMA FONKSƒ∞YONU
        const createKulamiPanels = () => {
            // Panel t√ºrleri: [rows, cols, count]
            const panelTypes = [
                { rows: 2, cols: 3, count: 4 }, // 6 delikli (3x2)
                { rows: 2, cols: 2, count: 5 }, // 4 delikli (2x2)
                { rows: 3, cols: 1, count: 4 }, // 3 delikli (3x1)
                { rows: 2, cols: 1, count: 4 }  // 2 delikli (2x1)
            ];
            
            const panels = [];
            let panelId = 0;
            
            // Her panel t√ºr√º i√ßin panelleri olu≈ütur
            panelTypes.forEach(({ rows, cols, count }) => {
                for (let i = 0; i < count; i++) {
                    const cells = [];
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            cells.push({ player: 0, row: r, col: c });
                        }
                    }
                    panels.push({
                        id: panelId++,
                        rows,
                        cols,
                        cells,
                        x: 0, // Konumlar sonra hesaplanacak
                        y: 0,
                        width: 0,
                        height: 0
                    });
                }
            });
            
            // Panelleri karƒ±≈ütƒ±r
            for (let i = panels.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [panels[i], panels[j]] = [panels[j], panels[i]];
            }
            
            // Panel konumlarƒ±nƒ± hesapla (asimetrik yerle≈üim)
            const cellSize = 35;
            const gap = 8;
            const gridSize = 10;
            const placed = Array(gridSize).fill(null).map(() => Array(gridSize).fill(false));
            
            panels.forEach((panel, idx) => {
                panel.id = idx; // ID'leri yeniden d√ºzenle
                let positioned = false;
                let attempts = 0;
                
                while (!positioned && attempts < 100) {
                    const startRow = Math.floor(Math.random() * (gridSize - panel.rows + 1));
                    const startCol = Math.floor(Math.random() * (gridSize - panel.cols + 1));
                    
                    // Bu konuma yerle≈ütirilebilir mi kontrol et
                    let canPlace = true;
                    for (let r = startRow; r < startRow + panel.rows; r++) {
                        for (let c = startCol; c < startCol + panel.cols; c++) {
                            if (placed[r][c]) {
                                canPlace = false;
                                break;
                            }
                        }
                        if (!canPlace) break;
                    }
                    
                    if (canPlace) {
                        // Yerle≈ütir
                        for (let r = startRow; r < startRow + panel.rows; r++) {
                            for (let c = startCol; c < startCol + panel.cols; c++) {
                                placed[r][c] = true;
                            }
                        }
                        
                        panel.x = startCol * (cellSize + gap);
                        panel.y = startRow * (cellSize + gap);
                        panel.width = panel.cols * cellSize + (panel.cols - 1) * (gap / 2);
                        panel.height = panel.rows * cellSize + (panel.rows - 1) * (gap / 2);
                        panel.gridRow = startRow;  // Global grid pozisyonu ekle
                        panel.gridCol = startCol;  // Global grid pozisyonu ekle
                        positioned = true;
                    }
                    
                    attempts++;
                }
                
                // Eƒüer yerle≈ütirilemezse default konum
                if (!positioned) {
                    panel.x = (idx % 5) * 80;
                    panel.y = Math.floor(idx / 5) * 80;
                    panel.width = panel.cols * cellSize;
                    panel.height = panel.rows * cellSize;
                }
            });
            
            return panels;
        };

        //  üéÆ GAME BOARDS FOR SPECTATING
        const MangalaBoard = ({ game }) => {
            const board = game.board || [];
            const Pit = ({ c, owner, store }) => (
                <div className={`relative flex justify-center items-center transition-all 
                    ${store ? 'w-12 h-24 sm:w-16 sm:h-32 rounded-[1.5rem] sm:rounded-[2rem]' : 'w-8 h-8 sm:w-10 sm:h-10 rounded-full'} 
                    ${owner === 'me' ? 'bg-gradient-to-br from-amber-200 to-amber-400 border-3 sm:border-4 border-amber-500' : 'bg-gradient-to-br from-cyan-200 to-cyan-400 border-3 sm:border-4 border-cyan-500'} 
                    shadow-lg`}>
                    <div className="flex flex-wrap gap-0.5 justify-center p-0.5 sm:p-1 overflow-hidden h-full items-center content-center">
                        {[...Array(c > 8 ? 0 : c)].map((_, i) => (
                            <div key={i} className={`w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full gem-stone 
                                ${owner === 'me' ? 'bg-gradient-to-br from-yellow-300 to-amber-600' : 'bg-gradient-to-br from-blue-300 to-cyan-600'}`}></div>
                        ))}
                        {c > 8 && <span className="font-bold text-gray-700 text-xs sm:text-sm">+{c}</span>}
                    </div>
                    <div className="absolute -bottom-5 sm:-bottom-6 bg-white px-1.5 sm:px-2 py-0.5 rounded-lg text-xs font-bold border-2 shadow-sm">{c}</div>
                </div>
            );
            return (
                <div className="bg-gradient-to-br from-amber-800 to-amber-900 p-2 sm:p-4 rounded-2xl shadow-2xl mx-auto max-w-2xl">
                    <div className="bg-gradient-to-br from-amber-700 to-amber-800 p-2 sm:p-4 rounded-xl border-3 sm:border-4 border-amber-600 flex items-center justify-between gap-2 sm:gap-3">
                        <div className="flex flex-col items-center gap-1 sm:gap-2">
                            <span className="text-white/80 text-xs font-bold hidden sm:block">{game.players.p2.name.split(' ')[0]}</span>
                            <Pit c={board[13]} owner="opponent" store={true} />
                        </div>
                        <div className="flex flex-col gap-2 sm:gap-3 flex-1">
                            <div className="flex justify-between flex-row-reverse bg-black/20 p-1.5 sm:p-2 rounded-xl">
                                {[0,1,2,3,4,5].map(i => <Pit key={12-i} c={board[12-i]} owner="opponent"/>)}
                            </div>
                            <div className="flex justify-between bg-black/20 p-1.5 sm:p-2 rounded-xl">
                                {[0,1,2,3,4,5].map(i => <Pit key={i} c={board[i]} owner="me"/>)}
                            </div>
                        </div>
                        <div className="flex flex-col items-center gap-1 sm:gap-2">
                            <span className="text-white/80 text-xs font-bold hidden sm:block">{game.players.p1.name.split(' ')[0]}</span>
                            <Pit c={board[6]} owner="me" store={true} />
                        </div>
                    </div>
                </div>
            );
        };

        const ReversiBoard = ({ game }) => (
            <div className="flex flex-col items-center gap-3 sm:gap-4">
                <div className="flex gap-3 sm:gap-4">
                    <div className="flex items-center gap-1 sm:gap-2 bg-gray-800 text-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold text-sm sm:text-base">
                        <div className="w-4 h-4 sm:w-5 sm:h-5 bg-black border-2 border-gray-500 rounded-full"></div>
                        {game.board.filter(x => x === 1).length}
                    </div>
                    <div className="flex items-center gap-1 sm:gap-2 bg-white text-gray-800 px-2 sm:px-4 py-1.5 sm:py-2 rounded-full border-2 font-bold text-sm sm:text-base">
                        <div className="w-4 h-4 sm:w-5 sm:h-5 bg-white border-2 border-gray-400 rounded-full"></div>
                        {game.board.filter(x => x === 2).length}
                    </div>
                </div>
                <div className="bg-gradient-to-br from-green-600 to-green-800 p-1.5 sm:p-2 rounded-xl border-3 sm:border-4 border-green-900 shadow-xl">
                    <div className="grid grid-cols-8 gap-0.5 sm:gap-1">
                        {game.board.map((cell, i) => (
                            <div key={i} className="w-5 h-5 sm:w-7 sm:h-7 bg-green-500 rounded flex items-center justify-center shadow-inner">
                                {cell !== 0 && (
                                    <div className={`w-3.5 h-3.5 sm:w-5 sm:h-5 rounded-full shadow-md gem-stone 
                                        ${cell === 1 ? 'bg-gradient-to-br from-gray-700 to-black border border-gray-500' : 'bg-gradient-to-br from-white to-gray-200 border border-gray-300'}`}></div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const PentagoBoard = ({ game }) => {
            const board = game.board || Array(36).fill(0);
            const getQuadrantCells = (qId) => {
                const starts = [0, 3, 18, 21];
                const offsets = [0, 1, 2, 6, 7, 8, 12, 13, 14];
                return offsets.map(o => starts[qId] + o);
            };

            return (
                <div className="flex flex-col items-center gap-3 sm:gap-4">
                    <div className="flex gap-2 sm:gap-4 items-center flex-wrap justify-center">
                        <div className="flex items-center gap-1 sm:gap-2 bg-gradient-to-r from-rose-400 to-rose-600 text-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold text-xs sm:text-base">
                            <div className="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white/30"></div>
                            {game.players.p1.name.split(' ')[0]}: {board.filter(x => x === 1).length}
                        </div>
                        <div className={`px-2 sm:px-3 py-1 rounded-full text-xs font-bold ${game.phase === 'place' ? 'bg-blue-100 text-blue-600' : 'bg-amber-100 text-amber-600'}`}>
                            {game.phase === 'place' ? 'üéØ Ta≈ü' : 'üîÑ D√∂n'}
                        </div>
                        <div className="flex items-center gap-1 sm:gap-2 bg-gradient-to-r from-cyan-400 to-cyan-600 text-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold text-xs sm:text-base">
                            <div className="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white/30"></div>
                            {game.players.p2.name.split(' ')[0]}: {board.filter(x => x === 2).length}
                        </div>
                    </div>
                    <div className="bg-gradient-to-br from-slate-700 to-slate-900 p-2 sm:p-3 rounded-2xl shadow-2xl">
                        <div className="grid grid-cols-2 gap-1.5 sm:gap-2">
                            {[0, 1, 2, 3].map(qId => (
                                <div key={qId} className="grid grid-cols-3 gap-0.5 sm:gap-1 p-1.5 sm:p-2 bg-slate-600 rounded-xl">
                                    {getQuadrantCells(qId).map(cellIdx => {
                                        const cell = board[cellIdx];
                                        return (
                                            <div key={cellIdx} className={`w-6 h-6 sm:w-8 sm:h-8 rounded-lg flex items-center justify-center bg-slate-800 ${game.lastPlaced === cellIdx ? 'ring-2 ring-yellow-400' : ''}`}>
                                                {cell !== 0 && (
                                                    <div className={`w-4 h-4 sm:w-5 sm:h-5 rounded-full gem-stone ${cell === 1 ? 'bg-gradient-to-br from-rose-400 to-rose-600' : 'bg-gradient-to-br from-cyan-400 to-cyan-600'}`}></div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // üß© KULAMI BOARD
        const KulamiBoard = ({ game }) => {
            const board = game.board || [];
            const panels = game.panels || [];
            const lastMove = game.lastMove || null;
            const forbiddenPanel = game.forbiddenPanel || null;
            const validMoves = game.validMoves || [];
            
            // Mobil i√ßin √∂l√ßek fakt√∂r√º
            const scale = typeof window !== 'undefined' && window.innerWidth < 640 ? 0.65 : 1;
            
            return (
                <div className="flex flex-col items-center gap-3 sm:gap-4">
                    <div className="flex gap-2 sm:gap-4 items-center flex-wrap justify-center">
                        <div className="flex items-center gap-1 sm:gap-2 bg-gradient-to-r from-red-500 to-red-700 text-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold shadow-lg text-xs sm:text-base">
                            <div className="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white/30"></div>
                            {game.players.p1.name.split(' ')[0]}: {game.p1Score || 0}
                        </div>
                        <div className="px-2 sm:px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-600">
                            üß© Kulami
                        </div>
                        <div className="flex items-center gap-1 sm:gap-2 bg-gradient-to-r from-gray-700 to-black text-white px-2 sm:px-4 py-1.5 sm:py-2 rounded-full font-bold shadow-lg text-xs sm:text-base">
                            <div className="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white/30"></div>
                            {game.players.p2.name.split(' ')[0]}: {game.p2Score || 0}
                        </div>
                    </div>
                    
                    <div className="bg-gradient-to-br from-amber-100 to-orange-100 p-3 sm:p-6 rounded-2xl shadow-2xl overflow-auto">
                        <div className="relative" style={{width: `${420 * scale}px`, height: `${420 * scale}px`, transform: `scale(${scale})`, transformOrigin: 'top left'}}>
                            {panels.map((panel, panelIdx) => {
                                const isForbidden = forbiddenPanel === panelIdx;
                                
                                return (
                                    <div 
                                        key={panelIdx}
                                        className={`absolute rounded-lg border-3 transition-all ${
                                            isForbidden 
                                                ? 'kulami-forbidden bg-red-100/60 border-red-300' 
                                                : 'bg-white/90 border-gray-400 shadow-md'
                                        }`}
                                        style={{
                                            left: `${panel.x}px`,
                                            top: `${panel.y}px`,
                                            width: `${panel.width}px`,
                                            height: `${panel.height}px`
                                        }}
                                    >
                                        {/* Forbidden X overlay */}
                                        {isForbidden && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                <span className="text-red-500 text-6xl font-bold opacity-50">√ó</span>
                                            </div>
                                        )}
                                        
                                        <div className="grid gap-1 p-2 h-full" style={{
                                            gridTemplateColumns: `repeat(${panel.cols}, 1fr)`,
                                            gridTemplateRows: `repeat(${panel.rows}, 1fr)`
                                        }}>
                                            {panel.cells.map((cell, cellIdx) => {
                                                const isLastMove = lastMove && lastMove.panelId === panelIdx && lastMove.cellIdx === cellIdx;
                                                const isValidMove = validMoves.some(m => m.panelId === panelIdx && m.cellIdx === cellIdx);
                                                
                                                return (
                                                    <div 
                                                        key={cellIdx}
                                                        className={`rounded-full border-2 flex items-center justify-center transition-all ${
                                                            isLastMove ? 'kulami-last-move' : ''
                                                        } ${
                                                            isValidMove && !isForbidden ? 'kulami-valid-cell border-green-400' : ''
                                                        } ${
                                                            cell.player === 0 ? 'bg-gray-100 border-gray-300' :
                                                            cell.player === 1 ? 'bg-gradient-to-br from-red-500 to-red-700 border-red-600 shadow-lg' :
                                                            'bg-gradient-to-br from-gray-700 to-black border-gray-900 shadow-lg'
                                                        }`}
                                                        style={{
                                                            minWidth: '25px',
                                                            minHeight: '25px'
                                                        }}
                                                    >
                                                        {/* Valid move indicator */}
                                                        {isValidMove && !isForbidden && cell.player === 0 && (
                                                            <div className="w-3 h-3 rounded-full bg-green-400 opacity-60"></div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* Oyun Bilgisi */}
                    {lastMove && (
                        <div className="text-sm text-gray-600 bg-white/80 px-4 py-2 rounded-full">
                            Son hamle: Panel {lastMove.panelId + 1}
                        </div>
                    )}
                </div>
            );
        };

        // üåê K√úRE BOARD (SPECTATOR) - TAZOF KURALLARI
        const KureBoard = ({ game }) => {
            const board = game.board || Array(49).fill(0);
            const p1Captured = game.p1Captured || 0;  // P1'in aldƒ±ƒüƒ± ta≈ülar
            const p2Captured = game.p2Captured || 0;  // P2'nin aldƒ±ƒüƒ± ta≈ülar
            const lastMove = game.lastMove;
            
            // Satƒ±r ve s√ºtun bilgisi i√ßin yardƒ±mcƒ±
            const getRowCol = (idx) => ({ row: Math.floor(idx / 7), col: idx % 7 });
            
            return (
                <div className="flex flex-col items-center gap-3 sm:gap-4">
                    {/* Score Display */}
                    <div className="flex gap-3 sm:gap-6 mb-2 sm:mb-4">
                        <div className="bg-white rounded-lg px-2 sm:px-4 py-1.5 sm:py-2 shadow-md flex items-center gap-1 sm:gap-2">
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-purple-500 to-purple-700"></div>
                            <span className="font-bold text-gray-700 text-xs sm:text-base">{game.players?.p1?.name?.split(' ')[0]}</span>
                            <span className="text-purple-600 font-bold text-xs sm:text-base">üèÜ {p1Captured}/4</span>
                        </div>
                        <div className="bg-white rounded-lg px-2 sm:px-4 py-1.5 sm:py-2 shadow-md flex items-center gap-1 sm:gap-2">
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-orange-500 to-orange-700"></div>
                            <span className="font-bold text-gray-700 text-xs sm:text-base">{game.players?.p2?.name?.split(' ')[0]}</span>
                            <span className="text-orange-600 font-bold text-xs sm:text-base">üèÜ {p2Captured}/4</span>
                        </div>
                    </div>
                    
                    {/* Turn Indicator */}
                    <div className={`text-xs sm:text-sm font-bold px-3 py-1 rounded-full ${game.isP1Turn ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700'}`}>
                        {game.isP1Turn ? 'üü£ Mor Oynuyor' : 'üü† Turuncu Oynuyor'}
                    </div>
                    
                    {/* 7x7 Board */}
                    <div className="grid grid-cols-7 gap-1 sm:gap-2 bg-gradient-to-br from-slate-700 to-slate-900 p-2 sm:p-3 rounded-2xl shadow-2xl">
                        {board.map((cell, idx) => {
                            const { row, col } = getRowCol(idx);
                            const isStartRowP1 = row === 0; // Mor ba≈ülangƒ±√ß sƒ±rasƒ±
                            const isStartRowP2 = row === 6; // Turuncu ba≈ülangƒ±√ß sƒ±rasƒ±
                            const isLastMoveFrom = lastMove && lastMove.from === idx;
                            const isLastMoveTo = lastMove && lastMove.to === idx;
                            
                            return (
                                <div
                                    key={idx}
                                    className={`w-8 h-8 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center transition-all
                                        ${isStartRowP1 ? 'bg-purple-900/40' : isStartRowP2 ? 'bg-orange-900/40' : 'bg-slate-600/50'}
                                        ${isLastMoveTo ? 'ring-2 ring-cyan-400' : ''}
                                        ${isLastMoveFrom ? 'bg-cyan-500/20' : ''}
                                    `}
                                >
                                    {cell === 1 && (
                                        <div className={`w-6 h-6 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-purple-400 to-purple-700 shadow-lg border-2 border-purple-300
                                            ${isLastMoveTo && !game.isP1Turn ? 'ring-2 ring-cyan-300' : ''}
                                        `}></div>
                                    )}
                                    {cell === 2 && (
                                        <div className={`w-6 h-6 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-orange-400 to-orange-700 shadow-lg border-2 border-orange-300
                                            ${isLastMoveTo && game.isP1Turn ? 'ring-2 ring-cyan-300' : ''}
                                        `}></div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="text-xs sm:text-sm text-gray-600 bg-white/80 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full">
                        üåê K√ºre - 4 ta≈ü alan kazanƒ±r | Sƒ±kƒ±≈ütƒ±rarak ta≈ü al
                    </div>
                </div>
            );
        };

        // üé≤ Q-BITZ BOARD (SPECTATOR)
        const QbitzBoard = ({ game }) => {
            const target = game.target || Array(16).fill(0);
            const p1Grid = game.p1Grid || Array(16).fill(0);
            const p2Grid = game.p2Grid || Array(16).fill(0);
            
            // K√ºp y√ºz√º render
            const renderCubeFace = (faceValue, size = 'w-7 h-7 sm:w-10 sm:h-10') => {
                const baseClass = `${size} rounded flex items-center justify-center`;
                
                switch(faceValue) {
                    case 0: return <div className={`${baseClass} bg-gray-900`}></div>;
                    case 1: return <div className={`${baseClass} bg-white border border-gray-300`}></div>;
                    case 2: return (
                        <div className={`${baseClass} bg-white border border-gray-300 relative overflow-hidden`}>
                            <div className="absolute top-0 left-0 w-0 h-0 border-t-[28px] sm:border-t-[40px] border-t-gray-900 border-r-[28px] sm:border-r-[40px] border-r-transparent"></div>
                        </div>
                    );
                    case 3: return (
                        <div className={`${baseClass} bg-white border border-gray-300 relative overflow-hidden`}>
                            <div className="absolute bottom-0 right-0 w-0 h-0 border-b-[28px] sm:border-b-[40px] border-b-gray-900 border-l-[28px] sm:border-l-[40px] border-l-transparent"></div>
                        </div>
                    );
                    case 4: return (
                        <div className={`${baseClass} bg-gray-900 relative overflow-hidden`}>
                            <div className="absolute top-0 left-0 w-0 h-0 border-t-[14px] sm:border-t-[20px] border-t-white border-r-[14px] sm:border-r-[20px] border-r-transparent"></div>
                            <div className="absolute top-0 right-0 w-0 h-0 border-t-[14px] sm:border-t-[20px] border-t-white border-l-[14px] sm:border-l-[20px] border-l-transparent"></div>
                            <div className="absolute bottom-0 left-0 w-0 h-0 border-b-[14px] sm:border-b-[20px] border-b-white border-r-[14px] sm:border-r-[20px] border-r-transparent"></div>
                            <div className="absolute bottom-0 right-0 w-0 h-0 border-b-[14px] sm:border-b-[20px] border-b-white border-l-[14px] sm:border-l-[20px] border-l-transparent"></div>
                        </div>
                    );
                    case 5: return (
                        <div className={`${baseClass} bg-white border border-gray-300`}>
                            <div className="w-3 h-3 sm:w-5 sm:h-5 rounded-full bg-gray-900"></div>
                        </div>
                    );
                    default: return <div className={`${baseClass} bg-gray-500`}></div>;
                }
            };
            
            return (
                <div className="flex flex-col items-center gap-4 sm:gap-6">
                    {/* Hedef Desen */}
                    <div className="text-center">
                        <h4 className="text-xs sm:text-sm font-bold text-gray-600 mb-2 sm:mb-3">üéØ HEDEF DESEN</h4>
                        <div className="grid grid-cols-4 gap-1 sm:gap-2 bg-gradient-to-br from-slate-700 to-slate-900 p-2 sm:p-3 rounded-xl shadow-xl">
                            {target.map((face, idx) => (
                                <div key={`target-${idx}`}>{renderCubeFace(face)}</div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Oyuncu Grid'leri */}
                    <div className="flex gap-4 sm:gap-8">
                        <div className="text-center">
                            <h4 className="text-xs sm:text-sm font-bold text-blue-600 mb-2 sm:mb-3">
                                {game.players?.p1?.name?.split(' ')[0]}
                            </h4>
                            <div className="grid grid-cols-4 gap-1 sm:gap-2 bg-gradient-to-br from-blue-100 to-blue-200 p-2 sm:p-3 rounded-xl shadow-lg">
                                {p1Grid.map((face, idx) => (
                                    <div key={`p1-${idx}`}>{renderCubeFace(face)}</div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="text-center">
                            <h4 className="text-xs sm:text-sm font-bold text-red-600 mb-2 sm:mb-3">
                                {game.players?.p2?.name?.split(' ')[0]}
                            </h4>
                            <div className="grid grid-cols-4 gap-1 sm:gap-2 bg-gradient-to-br from-red-100 to-red-200 p-2 sm:p-3 rounded-xl shadow-lg">
                                {p2Grid.map((face, idx) => (
                                    <div key={`p2-${idx}`}>{renderCubeFace(face)}</div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="text-xs sm:text-sm text-gray-600 bg-white/80 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full">
                        üé≤ Q-bitz - Hedef deseni ilk tamamlayan kazanƒ±r
                    </div>
                </div>
            );
        };

        // üè∞ ABLUKA BOARD (SPECTATOR)
        const AblukaBoard = ({ game }) => {
            const board = game.board || Array(49).fill(0);
            const p1SetsWon = game.p1SetsWon || 0;
            const p2SetsWon = game.p2SetsWon || 0;
            const currentSet = game.currentSet || 1;
            const lastMove = game.lastMove;
            
            // Satƒ±r ve s√ºtun bilgisi i√ßin yardƒ±mcƒ±
            const getRowCol = (idx) => ({ row: Math.floor(idx / 7), col: idx % 7 });
            
            return (
                <div className="flex flex-col items-center gap-3 sm:gap-4">
                    {/* Set Score Display */}
                    <div className="flex gap-3 sm:gap-6 mb-2 sm:mb-4 items-center">
                        <div className="bg-white rounded-lg px-2 sm:px-4 py-1.5 sm:py-2 shadow-md flex items-center gap-1 sm:gap-2">
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 border-2 border-gray-500"></div>
                            <span className="font-bold text-gray-700 text-xs sm:text-base">{game.players?.p1?.name?.split(' ')[0]}</span>
                            <span className="text-gray-700 font-bold text-xs sm:text-base">üèÜ {p1SetsWon}</span>
                        </div>
                        <div className="flex flex-col items-center">
                            <span className="text-xs sm:text-sm font-bold text-gray-600">Set {currentSet}/3</span>
                        </div>
                        <div className="bg-white rounded-lg px-2 sm:px-4 py-1.5 sm:py-2 shadow-md flex items-center gap-1 sm:gap-2">
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-gray-100 to-white border-2 border-gray-300"></div>
                            <span className="font-bold text-gray-700 text-xs sm:text-base">{game.players?.p2?.name?.split(' ')[0]}</span>
                            <span className="text-gray-700 font-bold text-xs sm:text-base">üèÜ {p2SetsWon}</span>
                        </div>
                    </div>
                    
                    {/* Turn Indicator */}
                    <div className={`text-xs sm:text-sm font-bold px-3 py-1 rounded-full ${game.isP1Turn ? 'bg-gray-200 text-gray-800' : 'bg-gray-100 text-gray-600'}`}>
                        {game.isP1Turn ? '‚ö´ Siyah Oynuyor' : '‚ö™ Beyaz Oynuyor'}
                    </div>
                    
                    {/* 7x7 Board */}
                    <div className="grid grid-cols-7 gap-1 sm:gap-2 bg-gradient-to-br from-amber-800 to-amber-950 p-2 sm:p-3 rounded-2xl shadow-2xl border-2 border-amber-700/50">
                        {board.map((cell, idx) => {
                            const { row, col } = getRowCol(idx);
                            const isLastMoveTo = lastMove && lastMove.to === idx;
                            const isLastMoveFrom = lastMove && lastMove.from === idx;
                            const isLastBlock = lastMove && lastMove.block === idx;
                            
                            return (
                                <div
                                    key={idx}
                                    className={`w-8 h-8 sm:w-12 sm:h-12 rounded-md flex items-center justify-center transition-all
                                        ${cell === 0 ? 'bg-amber-700/40' : ''}
                                        ${cell === 3 ? 'bg-red-900/60' : ''}
                                        ${isLastMoveTo ? 'ring-2 ring-cyan-400' : ''}
                                        ${isLastMoveFrom ? 'bg-cyan-500/20' : ''}
                                        ${isLastBlock ? 'ring-2 ring-orange-400' : ''}
                                    `}
                                >
                                    {/* Siyah Ta≈ü (P1) */}
                                    {cell === 1 && (
                                        <div className={`w-6 h-6 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-gray-600 to-gray-900 shadow-lg border-2 border-gray-500
                                            ${isLastMoveTo && !game.isP1Turn ? 'ring-2 ring-cyan-300' : ''}
                                        `}></div>
                                    )}
                                    {/* Beyaz Ta≈ü (P2) */}
                                    {cell === 2 && (
                                        <div className={`w-6 h-6 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-gray-100 to-white shadow-lg border-2 border-gray-300
                                            ${isLastMoveTo && game.isP1Turn ? 'ring-2 ring-cyan-300' : ''}
                                        `}></div>
                                    )}
                                    {/* Engel Ta≈üƒ± */}
                                    {cell === 3 && (
                                        <div className="w-5 h-5 sm:w-8 sm:h-8 rounded bg-gradient-to-br from-red-600 to-red-900 shadow-lg border-2 border-red-500"></div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="text-xs sm:text-sm text-gray-600 bg-white/80 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full">
                        üè∞ Abluka - 2 set alan kazanƒ±r | Rakibi k√∂≈üeye sƒ±kƒ±≈ütƒ±r
                    </div>
                </div>
            );
        };

        // üîç SPECTATOR MODAL
        const SpectatorModal = ({ game, gameId, onClose }) => {
            if (!game) return null;
            const gameEmojis = { mangala: 'üéØ', reversi: '‚ö´', pentago: 'üîÆ', kulami: 'üß©', kure: 'üåê', qbitz: 'üé≤', abluka: 'üè∞' };
            const gameNames = { mangala: 'Mangala', reversi: 'Reversi', pentago: 'Pentago', kulami: 'Kulami', kure: 'K√ºre', qbitz: 'Q-bitz', abluka: 'Abluka' };
            
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4 pop-in">
                    <div className="glass-card-light w-full max-w-4xl overflow-hidden relative">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-600 via-pink-500 to-red-500 p-3 sm:p-4 flex justify-between items-center">
                            <div className="flex items-center gap-2 sm:gap-3">
                                <div className="flex items-center gap-1 sm:gap-2 bg-white/20 px-2 sm:px-3 py-1 rounded-full">
                                    <div className="live-dot" style={{width:'8px',height:'8px'}}></div>
                                    <span className="text-white font-bold text-xs sm:text-sm">CANLI</span>
                                </div>
                                <div className="text-white">
                                    <span className="text-xl sm:text-2xl mr-1 sm:mr-2">{gameEmojis[game.type]}</span>
                                    <span className="font-bold text-sm sm:text-base">{gameNames[game.type]} - Masa #{gameId}</span>
                                </div>
                            </div>
                            <button onClick={onClose} className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/20 active:bg-white/30 flex items-center justify-center text-white font-bold transition">
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        
                        {/* Players */}
                        <div className="flex justify-between items-center px-3 sm:px-6 py-3 sm:py-4 bg-gray-50 border-b">
                            <div className="flex items-center gap-2 sm:gap-3">
                                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-bold text-lg sm:text-xl shadow-lg">
                                    {game.players.p1.name.charAt(0)}
                                </div>
                                <div>
                                    <div className="font-bold text-gray-800 text-sm sm:text-base">{game.players.p1.name}</div>
                                    <div className={`text-xs font-bold ${game.isP1Turn ? 'text-green-500' : 'text-gray-400'}`}>
                                        {game.isP1Turn ? 'üéØ Oynuyor' : 'Bekliyor'}
                                    </div>
                                </div>
                            </div>
                            <div className="text-2xl sm:text-4xl font-black text-gray-300">VS</div>
                            <div className="flex items-center gap-2 sm:gap-3">
                                <div>
                                    <div className="font-bold text-gray-800 text-right text-sm sm:text-base">{game.players.p2.name}</div>
                                    <div className={`text-xs font-bold text-right ${!game.isP1Turn ? 'text-green-500' : 'text-gray-400'}`}>
                                        {!game.isP1Turn ? 'üéØ Oynuyor' : 'Bekliyor'}
                                    </div>
                                </div>
                                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-lg sm:text-xl shadow-lg">
                                    {game.players.p2.name.charAt(0)}
                                </div>
                            </div>
                        </div>

                        {/* Game Board */}
                        <div className="p-4 sm:p-8 flex justify-center items-center min-h-[250px] sm:min-h-[350px] bg-gradient-to-br from-gray-100 to-gray-200 overflow-auto">
                            {game.type === 'reversi' ? <ReversiBoard game={game} /> : 
                             game.type === 'pentago' ? <PentagoBoard game={game} /> : 
                             game.type === 'kulami' ? <KulamiBoard game={game} /> :
                             game.type === 'kure' ? <KureBoard game={game} /> :
                             game.type === 'qbitz' ? <QbitzBoard game={game} /> :
                             game.type === 'abluka' ? <AblukaBoard game={game} /> :
                             <MangalaBoard game={game} />}
                        </div>

                        {/* Winner Banner */}
                        {game.winner && (
                            <div className={`p-4 text-center ${game.endReason === 'quit' ? 'bg-gradient-to-r from-red-500 via-red-600 to-red-500' : 'bg-gradient-to-r from-yellow-400 via-amber-500 to-orange-500'}`}>
                                {game.endReason === 'quit' ? (
                                    <>
                                        <span className="text-white/80 text-sm mr-2">üö®</span>
                                        <span className="text-white font-bold">{game.quitter} oyundan ayrƒ±ldƒ± - </span>
                                        <span className="text-2xl mr-2">üèÜ</span>
                                        <span className="text-white font-bold text-xl">Kazanan: {game.winner}</span>
                                    </>
                                ) : (
                                    <>
                                        <span className="text-2xl mr-2">üèÜ</span>
                                        <span className="text-white font-bold text-xl">Kazanan: {game.winner}</span>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // üìÑ T√ºrk√ße karakter d√∂n√º≈üt√ºrme fonksiyonu (Global)
        const turkishToAscii = (text) => {
            if (!text) return '';
            const turkishMap = {
                '√ß': 'c', '√á': 'C',
                'ƒü': 'g', 'ƒû': 'G',
                'ƒ±': 'i', 'I': 'I',
                'ƒ∞': 'I', 'i': 'i',
                '√∂': 'o', '√ñ': 'O',
                '≈ü': 's', '≈û': 'S',
                '√º': 'u', '√ú': 'U'
            };
            return text.split('').map(char => turkishMap[char] || char).join('');
        };

        // üéõÔ∏è MAIN ADMIN PANEL
        const AdminPanel = () => {
            const [view, setView] = useState("dashboard");
            const [lobbyUsers, setLobbyUsers] = useState({});
            const [games, setGames] = useState({});
            const [pendingUsers, setPendingUsers] = useState({});
            const [schools, setSchools] = useState({});
            const [allUsers, setAllUsers] = useState({});
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [password, setPassword] = useState("");
            const [newSchoolName, setNewSchoolName] = useState("");
            const [newSchoolCode, setNewSchoolCode] = useState(""); // Yeni okul giri≈ü kodu
            const [newSchoolPassword, setNewSchoolPassword] = useState(""); // Yeni okul ≈üifresi
            const [selectedSchoolFilter, setSelectedSchoolFilter] = useState("");
            const [showGameSelector, setShowGameSelector] = useState(false);
            const [spectatingGameId, setSpectatingGameId] = useState(null);
            
            // üè´ Y√ñNETƒ∞Cƒ∞ OKUL Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞
            const [adminSchool, setAdminSchool] = useState(null); // Giri≈ü yapƒ±lan okul
            const [loginCode, setLoginCode] = useState(""); // Giri≈ü kodu
            const [isSuperAdmin, setIsSuperAdmin] = useState(false); // S√ºper admin mi (t√ºm okullar)
            
            // üè´ OKULLAR ARASI TURNUVA Sƒ∞STEMƒ∞
            const [interSchoolRequests, setInterSchoolRequests] = useState({}); // Okullar arasƒ± turnuva istekleri
            const [showInterSchoolModal, setShowInterSchoolModal] = useState(false); // Modal g√∂sterimi
            const [interSchoolForm, setInterSchoolForm] = useState({
                targetSchool: '',
                date: '',
                games: [],
                studentCount: 5,
                description: ''
            });
            const [selectedInterSchoolStudents, setSelectedInterSchoolStudents] = useState(new Set()); // Turnuvaya katƒ±lacak √∂ƒürenciler
            const [showStudentSelectModal, setShowStudentSelectModal] = useState(null); // √ñƒürenci se√ßim modalƒ± (request id)
            const [activeInterSchoolTournament, setActiveInterSchoolTournament] = useState(null); // Aktif okullar arasƒ± turnuva
            
            // üéØ E≈üle≈ütirme Modlarƒ±
            const [matchingMode, setMatchingMode] = useState('random'); // 'random', 'manual', 'school-random', 'cross-school', 'swiss'
            const [selectedPlayer1, setSelectedPlayer1] = useState(null);
            const [selectedPlayer2, setSelectedPlayer2] = useState(null);
            const [selectedSchool1, setSelectedSchool1] = useState("");
            const [selectedSchool2, setSelectedSchool2] = useState("");
            
            // üÜï Performance & UX States
            const [isConnected, setIsConnected] = useState(true);
            const [isLoading, setIsLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [operationInProgress, setOperationInProgress] = useState(false);
            const [loginError, setLoginError] = useState("");
            
            // üèÜ Rozet Y√∂netimi State
            const [badgeModalUser, setBadgeModalUser] = useState(null);
            const [selectedBadgeToGive, setSelectedBadgeToGive] = useState(null);
            const [selectedSchoolForBadges, setSelectedSchoolForBadges] = useState(null); // Rozet g√∂sterilecek okul
            const [showSchoolBadgeModal, setShowSchoolBadgeModal] = useState(false); // Okul rozet modalƒ±
            
            // üî¢ Pagination States
            const [gamesPage, setGamesPage] = useState(1);
            const [usersPage, setUsersPage] = useState(1);
            const ITEMS_PER_PAGE = 50;
            
            // üë®‚Äçüéì √ñƒürenci Y√∂netimi State'leri
            const [editModalUser, setEditModalUser] = useState(null); // D√ºzenleme modalƒ± i√ßin
            const [selectedStudents, setSelectedStudents] = useState(new Set()); // Toplu se√ßim i√ßin
            const [studentSearch, setStudentSearch] = useState(""); // Arama
            const [studentViewMode, setStudentViewMode] = useState("table"); // "table" veya "bySchool"
            const [expandedSchools, setExpandedSchools] = useState(new Set()); // Accordion i√ßin
            const [selectedClassFilter, setSelectedClassFilter] = useState(""); // Sƒ±nƒ±f bazlƒ± filtreleme
            const [bulkClassUpdate, setBulkClassUpdate] = useState(""); // Toplu sƒ±nƒ±f g√ºncelleme i√ßin yeni sƒ±nƒ±f
            
            // üîÑ Debounce ref for preventing rapid operations
            const lastOperationTime = useRef(0);
            const OPERATION_COOLDOWN = 500; // ms

            // üì° Connection & Error Listeners
            useEffect(() => {
                const handleConnection = (e) => setIsConnected(e.detail);
                const handleError = (e) => {
                    setToast({ message: `Hata: ${e.detail}`, type: 'error' });
                };
                
                window.addEventListener('firebase-connection', handleConnection);
                window.addEventListener('firebase-error', handleError);
                
                return () => {
                    window.removeEventListener('firebase-connection', handleConnection);
                    window.removeEventListener('firebase-error', handleError);
                };
            }, []);

            // üî• Firebase Listeners with Optimization
            useEffect(() => {
                // Okullarƒ± her zaman y√ºkle (login i√ßin gerekli)
                const schoolsRef = window.dbRef(window.db, 'schools');
                const schoolsUnsub = window.dbOnValue(schoolsRef, (s) => {
                    try {
                        setSchools(s.val() || {});
                    } catch (err) {
                        console.error('Schools data processing error:', err);
                    }
                }, (error) => {
                    console.error('Schools listener error:', error);
                });
                
                // Giri≈ü yapƒ±lmadƒ±ysa sadece okullarƒ± y√ºkle
                if (!isLoggedIn) {
                    return () => schoolsUnsub();
                }
                
                setIsLoading(true);
                
                const unsubscribers = [schoolsUnsub];
                let loadedCount = 1; // Schools already counted
                const totalListeners = 5;
                
                const checkAllLoaded = () => {
                    loadedCount++;
                    if (loadedCount >= totalListeners) {
                        setIsLoading(false);
                    }
                };
                
                const lobbyRef = window.dbRef(window.db, 'lobby');
                const gamesRef = window.dbRef(window.db, 'games');
                const pendingRef = window.dbRef(window.db, 'pending_users');
                const usersRef = window.dbRef(window.db, 'users');
                
                // Optimized listeners with proper error handling and cleanup
                try {
                    const lobbyUnsub = window.dbOnValue(lobbyRef, (s) => {
                        try {
                            setLobbyUsers(s.val() || {});
                            checkAllLoaded();
                        } catch (err) {
                            console.error('Lobby data processing error:', err);
                            checkAllLoaded();
                        }
                    }, (error) => {
                        console.error('Lobby listener error:', error);
                        setToast({ message: 'Lobi verileri y√ºklenemedi', type: 'error' });
                        checkAllLoaded();
                    });
                    unsubscribers.push(lobbyUnsub);
                    
                    const gamesUnsub = window.dbOnValue(gamesRef, (s) => {
                        try {
                            setGames(s.val() || {});
                            checkAllLoaded();
                        } catch (err) {
                            console.error('Games data processing error:', err);
                            checkAllLoaded();
                        }
                    }, (error) => {
                        console.error('Games listener error:', error);
                        setToast({ message: 'Oyun verileri y√ºklenemedi', type: 'error' });
                        checkAllLoaded();
                    });
                    unsubscribers.push(gamesUnsub);
                    
                    const pendingUnsub = window.dbOnValue(pendingRef, (s) => {
                        try {
                            setPendingUsers(s.val() || {});
                            checkAllLoaded();
                        } catch (err) {
                            console.error('Pending users data processing error:', err);
                            checkAllLoaded();
                        }
                    }, (error) => {
                        console.error('Pending users listener error:', error);
                        setToast({ message: 'Bekleyen kullanƒ±cƒ±lar y√ºklenemedi', type: 'error' });
                        checkAllLoaded();
                    });
                    unsubscribers.push(pendingUnsub);
                    
                    // Schools zaten yukarƒ±da y√ºklendi, sadece checkAllLoaded √ßaƒüƒ±r
                    checkAllLoaded();
                    
                    const usersUnsub = window.dbOnValue(usersRef, (s) => {
                        try {
                            setAllUsers(s.val() || {});
                            checkAllLoaded();
                        } catch (err) {
                            console.error('Users data processing error:', err);
                            checkAllLoaded();
                        }
                    }, (error) => {
                        console.error('Users listener error:', error);
                        setToast({ message: 'Kullanƒ±cƒ± verileri y√ºklenemedi', type: 'error' });
                        checkAllLoaded();
                    });
                    unsubscribers.push(usersUnsub);
                    
                    // üè´ Okullar Arasƒ± Turnuva ƒ∞stekleri Dinleyicisi
                    const interSchoolRef = window.dbRef(window.db, 'interSchoolRequests');
                    const interSchoolUnsub = window.dbOnValue(interSchoolRef, (s) => {
                        try {
                            setInterSchoolRequests(s.val() || {});
                        } catch (err) {
                            console.error('Inter-school requests data processing error:', err);
                        }
                    }, (error) => {
                        console.error('Inter-school requests listener error:', error);
                    });
                    unsubscribers.push(interSchoolUnsub);
                } catch (error) {
                    console.error('Failed to setup listeners:', error);
                    setIsLoading(false);
                    setToast({ message: 'Veri y√ºklenirken kritik hata olu≈ütu', type: 'error' });
                }
                
                return () => {
                    unsubscribers.forEach(unsub => {
                        if (typeof unsub === 'function') unsub();
                    });
                };
            }, [isLoggedIn]);

            // üõ°Ô∏è Rate limiting helper
            const canPerformOperation = useCallback(() => {
                const now = Date.now();
                if (now - lastOperationTime.current < OPERATION_COOLDOWN) {
                    setToast({ message: 'L√ºtfen biraz bekleyin...', type: 'info' });
                    return false;
                }
                lastOperationTime.current = now;
                return true;
            }, []);

            // üè´ Memoized school operations
            const addSchool = useCallback(async () => {
                if (!newSchoolName.trim()) {
                    setToast({ message: 'Okul adƒ± girin!', type: 'error' });
                    return;
                }
                if (!newSchoolCode.trim() || newSchoolCode.length < 3) {
                    setToast({ message: 'Okul kodu en az 3 karakter olmalƒ±!', type: 'error' });
                    return;
                }
                if (!newSchoolPassword.trim() || newSchoolPassword.length < 4) {
                    setToast({ message: 'Okul ≈üifresi en az 4 karakter olmalƒ±!', type: 'error' });
                    return;
                }
                
                // Kod benzersizliƒüi kontrol√º
                const codeUpper = newSchoolCode.toUpperCase();
                const existingCode = Object.values(schools).find(s => s.code?.toUpperCase() === codeUpper);
                if (existingCode) {
                    setToast({ message: 'Bu kod zaten kullanƒ±lƒ±yor!', type: 'error' });
                    return;
                }
                
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const id = newSchoolName.toLowerCase().replace(/[^a-z0-9]/g, '');
                const success = await window.dbSet(window.dbRef(window.db, 'schools/' + id), { 
                    name: newSchoolName, 
                    id,
                    code: codeUpper,
                    password: newSchoolPassword,
                    createdAt: Date.now()
                });
                
                if (success) {
                    setToast({ message: `Okul eklendi! Kod: ${codeUpper}`, type: 'success' });
                    setNewSchoolName("");
                    setNewSchoolCode("");
                    setNewSchoolPassword("");
                }
                setOperationInProgress(false);
            }, [newSchoolName, newSchoolCode, newSchoolPassword, schools, canPerformOperation]);

            const deleteSchool = useCallback(async (id) => {
                if (!isSuperAdmin) {
                    setToast({ message: 'Sadece s√ºper admin okul silebilir!', type: 'error' });
                    return;
                }
                if (!confirm("Bu okulu silmek istediƒüinize emin misiniz? üè´")) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbRemove(window.dbRef(window.db, 'schools/' + id));
                if (success) {
                    setToast({ message: 'Okul silindi', type: 'success' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation, isSuperAdmin]);
            
            // üè´ Okul ≈üifresi g√ºncelleme
            const updateSchoolPassword = useCallback(async (schoolId, newPassword) => {
                if (!newPassword || newPassword.length < 4) {
                    setToast({ message: '≈ûifre en az 4 karakter olmalƒ±!', type: 'error' });
                    return;
                }
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'schools/' + schoolId), { 
                    password: newPassword 
                });
                if (success) {
                    setToast({ message: 'Okul ≈üifresi g√ºncellendi!', type: 'success' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation]);
            
            // üè´ Okul kodu g√ºncelleme
            const updateSchoolCode = useCallback(async (schoolId, newCode) => {
                if (!newCode || newCode.length < 3) {
                    setToast({ message: 'Kod en az 3 karakter olmalƒ±!', type: 'error' });
                    return;
                }
                
                const codeUpper = newCode.toUpperCase();
                
                // Kod benzersizliƒüi kontrol√º
                const existingCode = Object.values(schools).find(s => s.code?.toUpperCase() === codeUpper && s.id !== schoolId);
                if (existingCode) {
                    setToast({ message: 'Bu kod zaten kullanƒ±lƒ±yor!', type: 'error' });
                    return;
                }
                
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'schools/' + schoolId), { 
                    code: codeUpper 
                });
                if (success) {
                    setToast({ message: `Okul kodu g√ºncellendi: ${codeUpper}`, type: 'success' });
                }
                setOperationInProgress(false);
            }, [schools, canPerformOperation]);
            
            // üè´ OKULLAR ARASI TURNUVA FONKSƒ∞YONLARI
            
            // Turnuva isteƒüi g√∂nder
            const sendInterSchoolRequest = useCallback(async () => {
                if (!adminSchool) {
                    setToast({ message: '√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z!', type: 'error' });
                    return;
                }
                if (!interSchoolForm.targetSchool) {
                    setToast({ message: 'Hedef okul se√ßin!', type: 'error' });
                    return;
                }
                if (!interSchoolForm.date) {
                    setToast({ message: 'Tarih se√ßin!', type: 'error' });
                    return;
                }
                if (interSchoolForm.games.length === 0) {
                    setToast({ message: 'En az bir oyun se√ßin!', type: 'error' });
                    return;
                }
                if (interSchoolForm.studentCount < 1 || interSchoolForm.studentCount > 50) {
                    setToast({ message: '√ñƒürenci sayƒ±sƒ± 1-50 arasƒ±nda olmalƒ±!', type: 'error' });
                    return;
                }
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const requestId = Date.now().toString();
                const requestData = {
                    id: requestId,
                    fromSchool: adminSchool,
                    fromSchoolName: schools[adminSchool]?.name || adminSchool,
                    toSchool: interSchoolForm.targetSchool,
                    toSchoolName: schools[interSchoolForm.targetSchool]?.name || interSchoolForm.targetSchool,
                    date: interSchoolForm.date,
                    games: interSchoolForm.games,
                    studentCount: interSchoolForm.studentCount,
                    description: interSchoolForm.description,
                    status: 'pending', // pending, accepted, rejected
                    createdAt: Date.now(),
                    fromSchoolStudents: [],
                    toSchoolStudents: [],
                    rejectionReason: ''
                };
                
                const success = await window.dbSet(window.dbRef(window.db, 'interSchoolRequests/' + requestId), requestData);
                
                if (success) {
                    setToast({ message: 'Turnuva isteƒüi g√∂nderildi!', type: 'success' });
                    setShowInterSchoolModal(false);
                    setInterSchoolForm({
                        targetSchool: '',
                        date: '',
                        games: [],
                        studentCount: 5,
                        description: ''
                    });
                }
                setOperationInProgress(false);
            }, [adminSchool, interSchoolForm, schools, canPerformOperation]);
            
            // Turnuva isteƒüini kabul et
            const acceptInterSchoolRequest = useCallback(async (requestId) => {
                if (!confirm('Bu turnuva isteƒüini kabul etmek istediƒüinize emin misiniz?')) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'interSchoolRequests/' + requestId), {
                    status: 'accepted',
                    acceptedAt: Date.now()
                });
                
                if (success) {
                    setToast({ message: 'Turnuva isteƒüi kabul edildi!', type: 'success' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation]);
            
            // Turnuva isteƒüini reddet
            const rejectInterSchoolRequest = useCallback(async (requestId, reason = '') => {
                if (!confirm('Bu turnuva isteƒüini reddetmek istediƒüinize emin misiniz?')) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'interSchoolRequests/' + requestId), {
                    status: 'rejected',
                    rejectionReason: reason,
                    rejectedAt: Date.now()
                });
                
                if (success) {
                    setToast({ message: 'Turnuva isteƒüi reddedildi.', type: 'info' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation]);
            
            // Turnuvaya √∂ƒürenci ekle
            const addStudentsToInterSchool = useCallback(async (requestId, students) => {
                const request = interSchoolRequests[requestId];
                if (!request) return;
                
                const isFromSchool = request.fromSchool === adminSchool;
                const studentKey = isFromSchool ? 'fromSchoolStudents' : 'toSchoolStudents';
                
                if (students.length > request.studentCount) {
                    setToast({ message: `Maksimum ${request.studentCount} √∂ƒürenci se√ßebilirsiniz!`, type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'interSchoolRequests/' + requestId), {
                    [studentKey]: students
                });
                
                if (success) {
                    setToast({ message: '√ñƒürenciler eklendi!', type: 'success' });
                    setShowStudentSelectModal(null);
                    setSelectedInterSchoolStudents(new Set());
                }
                setOperationInProgress(false);
            }, [adminSchool, interSchoolRequests]);
            
            // Okullar arasƒ± turnuva ba≈ülat
            const startInterSchoolTournament = useCallback(async (requestId) => {
                const request = interSchoolRequests[requestId];
                if (!request) return;
                
                if (request.fromSchoolStudents.length === 0 || request.toSchoolStudents.length === 0) {
                    setToast({ message: 'Her iki okul da √∂ƒürenci se√ßmeli!', type: 'error' });
                    return;
                }
                
                if (request.fromSchoolStudents.length !== request.toSchoolStudents.length) {
                    setToast({ message: 'Her iki okuldan e≈üit sayƒ±da √∂ƒürenci olmalƒ±!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                const success = await window.dbUpdate(window.dbRef(window.db, 'interSchoolRequests/' + requestId), {
                    status: 'active',
                    startedAt: Date.now()
                });
                
                if (success) {
                    setToast({ message: 'Okullar arasƒ± turnuva ba≈üladƒ±!', type: 'success' });
                    setActiveInterSchoolTournament(requestId);
                }
                setOperationInProgress(false);
            }, [interSchoolRequests]);

            // üë§ Memoized user operations with transaction safety
            const approveUser = useCallback(async (uid, data) => {
                // Okul bazlƒ± yetki kontrol√º
                if (!isSuperAdmin && adminSchool && data.school !== adminSchool) {
                    setToast({ message: 'Sadece kendi okulunuzdaki √∂ƒürencileri onaylayabilirsiniz!', type: 'error' });
                    return;
                }
                if (!confirm(`${data.name} onaylansƒ±n mƒ±? ‚úÖ`)) return;
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok! Tekrar deneyin.', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    // First verify pending user still exists
                    const pendingSnapshot = await window.dbGet(window.dbRef(window.db, 'pending_users/' + uid));
                    if (!pendingSnapshot.exists()) {
                        setToast({ message: 'Kullanƒ±cƒ± bulunamadƒ±!', type: 'error' });
                        setOperationInProgress(false);
                        return;
                    }
                    
                    const success1 = await window.dbSet(window.dbRef(window.db, 'users/' + uid), data);
                    if (!success1) throw new Error('Kullanƒ±cƒ± ekleme ba≈üarƒ±sƒ±z');
                    
                    const success2 = await window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid));
                    if (!success2) {
                        // Rollback: remove from users if pending removal failed
                        await window.dbRemove(window.dbRef(window.db, 'users/' + uid));
                        throw new Error('Pending kullanƒ±cƒ± kaldƒ±rma ba≈üarƒ±sƒ±z');
                    }
                    
                    setToast({ message: `${data.name} onaylandƒ±!`, type: 'success' });
                } catch (error) {
                    console.error('Approve user error:', error);
                    setToast({ message: 'Onaylama ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);

            const rejectUser = useCallback(async (uid) => {
                if (!confirm("Bu kayƒ±t reddedilsin mi? ‚ùå")) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid));
                if (success) {
                    setToast({ message: 'Kayƒ±t reddedildi', type: 'success' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation]);

            const deleteStudent = useCallback(async (uid, name) => {
                if (!confirm(`${name} silinsin mi? üóëÔ∏è`)) return;
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    // Cascade delete with proper error handling
                    const results = await Promise.allSettled([
                        window.dbRemove(window.dbRef(window.db, 'users/' + uid)),
                        window.dbRemove(window.dbRef(window.db, 'lobby/' + uid))
                    ]);
                    
                    const failed = results.filter(r => r.status === 'rejected');
                    if (failed.length > 0) {
                        console.error('Some delete operations failed:', failed);
                        setToast({ message: `${name} kƒ±smen silindi (${results.filter(r => r.status === 'fulfilled').length}/2)`, type: 'error' });
                    } else {
                        setToast({ message: `${name} silindi`, type: 'success' });
                    }
                } catch (error) {
                    console.error('Delete student error:', error);
                    setToast({ message: 'Silme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);
            
            // üìù √ñƒürenci D√ºzenleme Fonksiyonu
            const editStudent = useCallback(async (uid, updatedData) => {
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const userRef = window.dbRef(window.db, 'users/' + uid);
                    const success = await window.dbUpdate(userRef, updatedData);
                    if (!success) throw new Error('G√ºncelleme ba≈üarƒ±sƒ±z');
                    setToast({ message: `√ñƒürenci bilgileri g√ºncellendi!`, type: 'success' });
                    setEditModalUser(null);
                } catch (error) {
                    console.error('Edit student error:', error);
                    setToast({ message: 'D√ºzenleme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);
            
            // üóëÔ∏è Toplu Silme Fonksiyonu
            const deleteSelectedStudents = useCallback(async () => {
                if (selectedStudents.size === 0) {
                    setToast({ message: 'L√ºtfen en az bir √∂ƒürenci se√ßin', type: 'error' });
                    return;
                }
                if (!confirm(`${selectedStudents.size} √∂ƒürenci silinecek. Emin misiniz? üóëÔ∏è`)) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                try {
                    const deletePromises = Array.from(selectedStudents).flatMap(uid => [
                        window.dbRemove(window.dbRef(window.db, 'users/' + uid)),
                        window.dbRemove(window.dbRef(window.db, 'lobby/' + uid))
                    ]);
                    
                    await Promise.all(deletePromises);
                    setToast({ message: `${selectedStudents.size} √∂ƒürenci silindi`, type: 'success' });
                    setSelectedStudents(new Set());
                } catch (error) {
                    console.error('Bulk delete error:', error);
                    setToast({ message: 'Toplu silme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [selectedStudents, canPerformOperation]);
            
            // üìù Toplu Sƒ±nƒ±f G√ºncelleme Fonksiyonu
            const bulkUpdateClass = useCallback(async () => {
                if (selectedStudents.size === 0) {
                    setToast({ message: 'L√ºtfen en az bir √∂ƒürenci se√ßin', type: 'error' });
                    return;
                }
                if (!bulkClassUpdate.trim()) {
                    setToast({ message: 'L√ºtfen yeni sƒ±nƒ±f girin', type: 'error' });
                    return;
                }
                if (!confirm(`${selectedStudents.size} √∂ƒürencinin sƒ±nƒ±fƒ± "${bulkClassUpdate}" olarak g√ºncellenecek. Emin misiniz?`)) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                try {
                    const updatePromises = Array.from(selectedStudents).map(uid =>
                        window.dbUpdate(window.dbRef(window.db, 'users/' + uid), { class: bulkClassUpdate })
                    );
                    
                    await Promise.all(updatePromises);
                    setToast({ message: `${selectedStudents.size} √∂ƒürencinin sƒ±nƒ±fƒ± g√ºncellendi`, type: 'success' });
                    setSelectedStudents(new Set());
                    setBulkClassUpdate("");
                } catch (error) {
                    console.error('Bulk class update error:', error);
                    setToast({ message: 'Toplu g√ºncelleme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [selectedStudents, bulkClassUpdate, canPerformOperation]);
            
            // üìÑ Sƒ±nƒ±f Listesi PDF Olu≈üturma
            const generateClassListPDF = useCallback(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    
                    // Filtrelere g√∂re √∂ƒürencileri al
                    let students = Object.entries(allUsers);
                    
                    // Okul filtresi
                    if (selectedSchoolFilter) {
                        students = students.filter(([_, u]) => u.schoolId === selectedSchoolFilter);
                    }
                    
                    // Sƒ±nƒ±f filtresi
                    if (selectedClassFilter) {
                        students = students.filter(([_, u]) => u.class === selectedClassFilter);
                    }
                    
                    // Arama filtresi
                    if (studentSearch.trim()) {
                        const searchLower = studentSearch.toLowerCase();
                        students = students.filter(([_, u]) => 
                            u.name.toLowerCase().includes(searchLower) ||
                            u.class.toLowerCase().includes(searchLower) ||
                            u.number.toString().includes(searchLower)
                        );
                    }
                    
                    if (students.length === 0) {
                        setToast({ message: 'Listelenecek ogrenci bulunamadi!', type: 'error' });
                        return;
                    }
                    
                    // ƒ∞statistikler hesapla
                    const totalWins = students.reduce((sum, [_, u]) => sum + (u.stats?.wins || 0), 0);
                    const avgWins = students.length > 0 ? (totalWins / students.length).toFixed(1) : 0;
                    const topStudent = students.reduce((top, [_, u]) => 
                        (u.stats?.wins || 0) > (top.stats?.wins || 0) ? u : top
                    , students[0]?.[1] || {});
                    
                    // Okula g√∂re grupla
                    const bySchool = {};
                    students.forEach(([uid, user]) => {
                        const schoolName = user.schoolName || 'Bilinmeyen Okul';
                        if (!bySchool[schoolName]) bySchool[schoolName] = [];
                        bySchool[schoolName].push(user);
                    });
                    
                    // KAPAK SAYFASI
                    // Gradient background effect
                    doc.setFillColor(139, 92, 246);
                    doc.rect(0, 0, pageWidth, 80, 'F');
                    doc.setFillColor(236, 72, 153);
                    doc.circle(pageWidth + 20, -20, 60, 'F');
                    doc.setFillColor(59, 130, 246);
                    doc.circle(-20, 100, 50, 'F');
                    
                    // Ba≈ülƒ±k
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text('SINIF LISTESI', pageWidth / 2, 35, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Akil Zeka Oyunlari', pageWidth / 2, 50, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text('Turnuva Yonetim Sistemi', pageWidth / 2, 60, { align: 'center' });
                    
                    // Bilgi Kutusu
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(15, 95, pageWidth - 30, 80, 3, 3, 'F');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RAPOR BILGILERI', 25, 105);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const infoY = 115;
                    doc.text('Tarih: ' + new Date().toLocaleDateString('tr-TR'), 25, infoY);
                    doc.text('Saat: ' + new Date().toLocaleTimeString('tr-TR'), 25, infoY + 7);
                    
                    if (selectedSchoolFilter) {
                        const schoolName = schools[selectedSchoolFilter]?.name || '';
                        doc.text('Okul: ' + turkishToAscii(schoolName), 25, infoY + 14);
                    } else {
                        doc.text('Okul: Tum Okullar', 25, infoY + 14);
                    }
                    
                    if (selectedClassFilter) {
                        doc.text('Sinif: ' + selectedClassFilter, 25, infoY + 21);
                    } else {
                        doc.text('Sinif: Tum Siniflar', 25, infoY + 21);
                    }
                    
                    // ƒ∞statistik Kartlarƒ±
                    const cardY = 185;
                    const cardWidth = (pageWidth - 50) / 3;
                    
                    // Kart 1: Toplam √ñƒürenci
                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(15, cardY, cardWidth, 30, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.text(students.length.toString(), 15 + cardWidth / 2, cardY + 15, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Toplam Ogrenci', 15 + cardWidth / 2, cardY + 23, { align: 'center' });
                    
                    // Kart 2: Ortalama Ba≈üarƒ±
                    doc.setFillColor(16, 185, 129);
                    doc.roundedRect(20 + cardWidth, cardY, cardWidth, 30, 2, 2, 'F');
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.text(avgWins.toString(), 20 + cardWidth + cardWidth / 2, cardY + 15, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Ort. Galibiyet', 20 + cardWidth + cardWidth / 2, cardY + 23, { align: 'center' });
                    
                    // Kart 3: En Ba≈üarƒ±lƒ±
                    doc.setFillColor(245, 158, 11);
                    doc.roundedRect(25 + cardWidth * 2, cardY, cardWidth, 30, 2, 2, 'F');
                    doc.setFontSize(24);
                    doc.setFont('helvetica', 'bold');
                    doc.text((topStudent?.stats?.wins || 0).toString(), 25 + cardWidth * 2 + cardWidth / 2, cardY + 15, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('En Yuksek Skor', 25 + cardWidth * 2 + cardWidth / 2, cardY + 23, { align: 'center' });
                    
                    // En ba≈üarƒ±lƒ± √∂ƒürenci bilgisi
                    if (topStudent?.name) {
                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(8);
                        doc.text('(' + turkishToAscii(topStudent.name) + ')', pageWidth / 2, cardY + 38, { align: 'center' });
                    }
                    
                    // Yeni sayfa - Listeler i√ßin
                    doc.addPage();
                    let startY = 20;
                    
                    // Sayfa header fonksiyonu
                    const addPageHeader = (pageNum) => {
                        doc.setFillColor(139, 92, 246);
                        doc.rect(0, 0, pageWidth, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('SINIF LISTESI', 15, 10);
                        doc.text('Sayfa ' + pageNum, pageWidth - 15, 10, { align: 'right' });
                    };
                    
                    let pageNum = 2;
                    addPageHeader(pageNum);
                    startY = 25;
                    
                    Object.entries(bySchool).sort().forEach(([schoolName, schoolStudents], schoolIndex) => {
                        // Sƒ±nƒ±fa g√∂re grupla
                        const byClass = {};
                        schoolStudents.forEach(student => {
                            if (!byClass[student.class]) byClass[student.class] = [];
                            byClass[student.class].push(student);
                        });
                        
                        Object.entries(byClass).sort().forEach(([className, classStudents]) => {
                            // Yeni sayfa kontrol√º (ba≈ülƒ±k i√ßin)
                            if (startY > 240) {
                                doc.addPage();
                                pageNum++;
                                addPageHeader(pageNum);
                                startY = 25;
                            }
                            
                            // Sƒ±nƒ±f i√ßin mini istatistikler
                            const classWins = classStudents.reduce((sum, s) => sum + (s.stats?.wins || 0), 0);
                            const classAvg = (classWins / classStudents.length).toFixed(1);
                            
                            // Okul ve Sƒ±nƒ±f Ba≈ülƒ±ƒüƒ± - Geli≈ütirilmi≈ü
                            doc.setFillColor(139, 92, 246);
                            doc.roundedRect(15, startY, pageWidth - 30, 12, 2, 2, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            const headerText = turkishToAscii(schoolName) + ' - ' + className;
                            doc.text(headerText, 20, startY + 8);
                            
                            // Sƒ±nƒ±f istatistiƒüi saƒüda
                            doc.setFontSize(9);
                            doc.text(classStudents.length + ' ogrenci | Ort: ' + classAvg, pageWidth - 20, startY + 8, { align: 'right' });
                            
                            doc.setTextColor(0, 0, 0);
                            startY += 17;
                            
                            // √ñƒürencileri sƒ±rala
                            const sortedStudents = classStudents
                                .sort((a, b) => a.number - b.number)
                                .map((student, index) => {
                                    const winRate = student.stats?.total > 0 
                                        ? Math.round((student.stats.wins / student.stats.total) * 100) 
                                        : 0;
                                    return [
                                        (index + 1).toString(),
                                        turkishToAscii(student.name),
                                        student.number.toString(),
                                        (student.stats?.wins || 0).toString(),
                                        winRate + '%'
                                    ];
                                });
                            
                            // AutoTable ile tablo olu≈ütur - Geli≈ütirilmi≈ü
                            doc.autoTable({
                                startY: startY,
                                head: [['#', 'Ogrenci Adi', 'No', 'Galibiyet', 'Basari']],
                                body: sortedStudents,
                                theme: 'striped',
                                headStyles: {
                                    fillColor: [99, 102, 241],
                                    textColor: 255,
                                    fontSize: 9,
                                    fontStyle: 'bold',
                                    halign: 'center'
                                },
                                bodyStyles: {
                                    fontSize: 8,
                                    cellPadding: 2
                                },
                                alternateRowStyles: {
                                    fillColor: [249, 250, 251]
                                },
                                columnStyles: {
                                    0: { halign: 'center', cellWidth: 10 },
                                    1: { halign: 'left', cellWidth: 80 },
                                    2: { halign: 'center', cellWidth: 20 },
                                    3: { halign: 'center', cellWidth: 25 },
                                    4: { halign: 'center', cellWidth: 25 }
                                },
                                margin: { left: 15, right: 15 },
                                didParseCell: (data) => {
                                    // En y√ºksek skorlarƒ± vurgula
                                    if (data.section === 'body' && data.column.index === 3) {
                                        const wins = parseInt(data.cell.text[0]);
                                        if (wins >= 10) {
                                            data.cell.styles.textColor = [16, 185, 129];
                                            data.cell.styles.fontStyle = 'bold';
                                        }
                                    }
                                }
                            });
                            
                            startY = doc.lastAutoTable.finalY + 12;
                        });
                    });
                    
                    // Footer t√ºm sayfalara
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        
                        // Alt √ßizgi
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.5);
                        doc.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);
                        
                        // Footer metni
                        doc.setFontSize(8);
                        doc.setTextColor(128, 128, 128);
                        doc.setFont('helvetica', 'normal');
                        
                        if (i === 1) {
                            doc.text('Akil Zeka Oyunlari - Turnuva Yonetim Sistemi', pageWidth / 2, pageHeight - 10, { align: 'center' });
                        } else {
                            doc.text('Akil Zeka Oyunlari', 15, pageHeight - 10);
                            doc.text('Sayfa ' + i + ' / ' + totalPages, pageWidth - 15, pageHeight - 10, { align: 'right' });
                        }
                    }
                    
                    // Dosya adƒ±
                    let fileName = 'Sinif_Listesi';
                    if (selectedSchoolFilter) {
                        const schoolName = schools[selectedSchoolFilter]?.name || '';
                        fileName += '_' + turkishToAscii(schoolName).replace(/\s/g, '_');
                    }
                    if (selectedClassFilter) {
                        fileName += '_' + selectedClassFilter;
                    }
                    fileName += '_' + new Date().toISOString().split('T')[0] + '.pdf';
                    
                    doc.save(fileName);
                    setToast({ message: 'PDF basariyla olusturuldu! (' + students.length + ' ogrenci)', type: 'success' });
                } catch (error) {
                    console.error('PDF generation error:', error);
                    setToast({ message: 'PDF olusturma hatasi: ' + error.message, type: 'error' });
                }
            }, [allUsers, selectedSchoolFilter, selectedClassFilter, studentSearch, schools]);
            
            // üèÜ Turnuva Sonu√ßlarƒ± PDF Olu≈üturma
            const generateTournamentPDF = useCallback(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    
                    // ƒ∞statistikleri hesapla
                    const tournamentGames = Object.values(games);
                    const completedGames = tournamentGames.filter(g => g.winner);
                    const activeGames = tournamentGames.filter(g => !g.winner);
                    
                    // Oyuncu istatistikleri
                    const playerStats = {};
                    completedGames.forEach(game => {
                        const p1Name = game.players.p1.name;
                        const p2Name = game.players.p2.name;
                        
                        if (!playerStats[p1Name]) playerStats[p1Name] = { wins: 0, losses: 0, games: 0 };
                        if (!playerStats[p2Name]) playerStats[p2Name] = { wins: 0, losses: 0, games: 0 };
                        
                        playerStats[p1Name].games++;
                        playerStats[p2Name].games++;
                        
                        if (game.winner === p1Name) {
                            playerStats[p1Name].wins++;
                            playerStats[p2Name].losses++;
                        } else if (game.winner === p2Name) {
                            playerStats[p2Name].wins++;
                            playerStats[p1Name].losses++;
                        }
                    });
                    
                    // Kazananlara g√∂re sƒ±rala
                    const sortedPlayers = Object.entries(playerStats)
                        .sort(([, a], [, b]) => b.wins - a.wins);
                    
                    // Oyun t√ºr√º istatistikleri
                    const gameTypeStats = {
                        mangala: { total: 0, completed: 0 },
                        reversi: { total: 0, completed: 0 },
                        pentago: { total: 0, completed: 0 },
                        kulami: { total: 0, completed: 0 },
                        kure: { total: 0, completed: 0 },
                        qbitz: { total: 0, completed: 0 }
                    };
                    tournamentGames.forEach(game => {
                        if (gameTypeStats[game.type]) {
                            gameTypeStats[game.type].total++;
                            if (game.winner) gameTypeStats[game.type].completed++;
                        }
                    });
                    
                    // ============ KAPAK SAYFASI ============
                    // Gradient background
                    doc.setFillColor(236, 72, 153);
                    doc.rect(0, 0, pageWidth, 100, 'F');
                    doc.setFillColor(139, 92, 246);
                    doc.circle(pageWidth + 30, -30, 80, 'F');
                    doc.setFillColor(59, 130, 246);
                    doc.circle(-30, 120, 70, 'F');
                    
                    // Ana Ba≈ülƒ±k
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(36);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TURNUVA', pageWidth / 2, 40, { align: 'center' });
                    doc.text('RAPORU', pageWidth / 2, 55, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Akil Zeka Oyunlari', pageWidth / 2, 70, { align: 'center' });
                    doc.setFontSize(11);
                    doc.text('Detayli Analiz ve Istatistikler', pageWidth / 2, 80, { align: 'center' });
                    
                    // ƒ∞statistik Kartlarƒ± - 2x3 grid
                    let cardStartY = 120;
                    const cardHeight = 35;
                    const cardWidth = (pageWidth - 50) / 2;
                    const cardSpacing = 10;
                    
                    const stats = [
                        { label: 'Toplam Oyun', value: tournamentGames.length, color: [59, 130, 246] },
                        { label: 'Tamamlanan', value: completedGames.length, color: [16, 185, 129] },
                        { label: 'Devam Eden', value: activeGames.length, color: [245, 158, 11] },
                        { label: 'Toplam Oyuncu', value: Object.keys(playerStats).length, color: [139, 92, 246] },
                        { label: 'Aktif Oyuncu', value: sortedPlayers.filter(([,s]) => s.wins > 0).length, color: [236, 72, 153] },
                        { label: 'Tamamlanma', value: Math.round((completedGames.length / tournamentGames.length) * 100) + '%', color: [34, 197, 94] }
                    ];
                    
                    stats.forEach((stat, index) => {
                        const row = Math.floor(index / 2);
                        const col = index % 2;
                        const x = 15 + col * (cardWidth + cardSpacing);
                        const y = cardStartY + row * (cardHeight + cardSpacing);
                        
                        // Kart arka planƒ±
                        doc.setFillColor(...stat.color);
                        doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'F');
                        
                        // ƒ∞kon g√∂sterimi (basit daire)
                        doc.setFillColor(255, 255, 255);
                        doc.circle(x + 15, y + cardHeight / 2, 8, 'F');
                        
                        // Deƒüer
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(28);
                        doc.setFont('helvetica', 'bold');
                        doc.text(stat.value.toString(), x + cardWidth - 15, y + cardHeight / 2, { align: 'right' });
                        
                        // Label
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(stat.label, x + cardWidth / 2, y + cardHeight - 8, { align: 'center' });
                    });
                    
                    // Tarih bilgisi
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.text('Rapor Tarihi: ' + new Date().toLocaleDateString('tr-TR') + ' ' + new Date().toLocaleTimeString('tr-TR'), pageWidth / 2, pageHeight - 20, { align: 'center' });
                    
                    // ============ SAYFA 2: Lƒ∞DERLƒ∞K TABLOSU ============
                    doc.addPage();
                    let startY = 20;
                    
                    
                    // Sayfa ba≈ülƒ±ƒüƒ±
                    doc.setFillColor(236, 72, 153);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('LIDERLIK TABLOSU', pageWidth / 2, 16, { align: 'center' });
                    
                    startY = 35;
                    
                    // Top 3 √∂zel g√∂sterim - Podyum
                    if (sortedPlayers.length >= 3) {
                        const podiumY = startY;
                        const podiumWidth = 50;
                        const spacing = 10;
                        
                        // 2. - G√ºm√º≈ü (sol)
                        doc.setFillColor(192, 192, 192);
                        doc.roundedRect(25, podiumY + 15, podiumWidth, 45, 2, 2, 'F');
                        doc.setFillColor(169, 169, 169);
                        doc.circle(25 + podiumWidth / 2, podiumY + 10, 12, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('2', 25 + podiumWidth / 2, podiumY + 14, { align: 'center' });
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(turkishToAscii(sortedPlayers[1][0].substring(0, 20)), 25 + podiumWidth / 2, podiumY + 30, { align: 'center' });
                        doc.setFontSize(14);
                        doc.text(sortedPlayers[1][1].wins.toString(), 25 + podiumWidth / 2, podiumY + 45, { align: 'center' });
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.text('galibiyet', 25 + podiumWidth / 2, podiumY + 53, { align: 'center' });
                        
                        // 1. - Altƒ±n (orta, daha y√ºksek)
                        doc.setFillColor(255, 215, 0);
                        doc.roundedRect(25 + podiumWidth + spacing, podiumY, podiumWidth, 60, 2, 2, 'F');
                        doc.setFillColor(218, 165, 32);
                        doc.circle(25 + podiumWidth + spacing + podiumWidth / 2, podiumY - 5, 15, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(20);
                        doc.setFont('helvetica', 'bold');
                        doc.text('1', 25 + podiumWidth + spacing + podiumWidth / 2, podiumY + 1, { align: 'center' });
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(turkishToAscii(sortedPlayers[0][0].substring(0, 20)), 25 + podiumWidth + spacing + podiumWidth / 2, podiumY + 20, { align: 'center' });
                        doc.setFontSize(18);
                        doc.text(sortedPlayers[0][1].wins.toString(), 25 + podiumWidth + spacing + podiumWidth / 2, podiumY + 40, { align: 'center' });
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text('galibiyet', 25 + podiumWidth + spacing + podiumWidth / 2, podiumY + 50, { align: 'center' });
                        
                        // 3. - Bronz (saƒü)
                        doc.setFillColor(205, 127, 50);
                        doc.roundedRect(25 + (podiumWidth + spacing) * 2, podiumY + 25, podiumWidth, 35, 2, 2, 'F');
                        doc.setFillColor(184, 115, 51);
                        doc.circle(25 + (podiumWidth + spacing) * 2 + podiumWidth / 2, podiumY + 20, 12, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.text('3', 25 + (podiumWidth + spacing) * 2 + podiumWidth / 2, podiumY + 24, { align: 'center' });
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(turkishToAscii(sortedPlayers[2][0].substring(0, 20)), 25 + (podiumWidth + spacing) * 2 + podiumWidth / 2, podiumY + 40, { align: 'center' });
                        doc.setFontSize(14);
                        doc.text(sortedPlayers[2][1].wins.toString(), 25 + (podiumWidth + spacing) * 2 + podiumWidth / 2, podiumY + 52, { align: 'center' });
                        
                        startY = podiumY + 70;
                    }
                    
                    // Tam liderlik tablosu
                    const leaderboardData = sortedPlayers.slice(0, 30).map(([name, stats], index) => {
                        const winRate = stats.games > 0 ? Math.round((stats.wins / stats.games) * 100) : 0;
                        const medal = index === 0 ? '1.' : index === 1 ? '2.' : index === 2 ? '3.' : (index + 1) + '.';
                        return [
                            medal,
                            turkishToAscii(name.length > 35 ? name.substring(0, 35) + '...' : name),
                            stats.wins.toString(),
                            stats.losses.toString(),
                            stats.games.toString(),
                            winRate + '%'
                        ];
                    });
                    
                    doc.autoTable({
                        startY: startY,
                        head: [['#', 'Oyuncu Adi', 'Galibiyet', 'Maglubiyet', 'Toplam', 'Basari']],
                        body: leaderboardData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [236, 72, 153],
                            textColor: 255,
                            fontSize: 9,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        alternateRowStyles: {
                            fillColor: [252, 252, 253]
                        },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 12 },
                            1: { halign: 'left', cellWidth: 80 },
                            2: { halign: 'center', cellWidth: 22 },
                            3: { halign: 'center', cellWidth: 25 },
                            4: { halign: 'center', cellWidth: 20 },
                            5: { halign: 'center', cellWidth: 20 }
                        },
                        margin: { left: 15, right: 15 },
                        didParseCell: (data) => {
                            // Top 3'√º vurgula
                            if (data.section === 'body' && data.row.index < 3) {
                                const colors = [[255, 215, 0], [192, 192, 192], [205, 127, 50]];
                                data.cell.styles.fillColor = colors[data.row.index];
                                data.cell.styles.textColor = [255, 255, 255];
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                    });
                    
                    // ============ SAYFA 3: OYUN T√úRLERƒ∞ ANALƒ∞Zƒ∞ ============
                    doc.addPage();
                    startY = 20;
                    
                    // Sayfa ba≈ülƒ±ƒüƒ±
                    doc.setFillColor(59, 130, 246);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('OYUN TURLERI ANALIZI', pageWidth / 2, 16, { align: 'center' });
                    
                    startY = 40;
                    
                    // Oyun t√ºrleri detaylƒ± tablo
                    const gameTypeData = Object.entries(gameTypeStats).map(([type, stats]) => {
                        const typeName = type === 'mangala' ? 'Mangala' : 
                                       type === 'reversi' ? 'Reversi' : 
                                       type === 'pentago' ? 'Pentago' : 
                                       type === 'kulami' ? 'Kulami' : 
                                       type === 'kure' ? 'Kure' : 
                                       type === 'qbitz' ? 'Q-bitz' : type;
                        const completion = stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0;
                        const active = stats.total - stats.completed;
                        return [
                            typeName,
                            stats.total.toString(),
                            stats.completed.toString(),
                            active.toString(),
                            completion + '%'
                        ];
                    });
                    
                    doc.autoTable({
                        startY: startY,
                        head: [['Oyun Turu', 'Toplam', 'Tamamlanan', 'Devam Eden', 'Tamamlanma']],
                        body: gameTypeData,
                        theme: 'grid',
                        headStyles: {
                            fillColor: [59, 130, 246],
                            textColor: 255,
                            fontSize: 10,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { halign: 'left', cellWidth: 50 },
                            1: { halign: 'center', cellWidth: 25 },
                            2: { halign: 'center', cellWidth: 30 },
                            3: { halign: 'center', cellWidth: 30 },
                            4: { halign: 'center', cellWidth: 30 }
                        },
                        margin: { left: 15, right: 15 }
                    });
                    
                    startY = doc.lastAutoTable.finalY + 15;
                    
                    // PERFORMANS ANALƒ∞Zƒ∞
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('PERFORMANS ANALIZI', 15, startY);
                    startY += 10;
                    
                    // En ba≈üarƒ±lƒ± oyuncular (her kategoride)
                    const mostActive = sortedPlayers.sort(([, a], [, b]) => b.games - a.games)[0];
                    const bestWinRate = sortedPlayers
                        .filter(([, s]) => s.games >= 5)
                        .sort(([, a], [, b]) => (b.wins / b.games) - (a.wins / a.games))[0];
                    
                    const performanceData = [];
                    
                    if (sortedPlayers[0]) {
                        performanceData.push(['En Basarili Oyuncu', turkishToAscii(sortedPlayers[0][0]), sortedPlayers[0][1].wins + ' galibiyet']);
                    }
                    if (mostActive) {
                        performanceData.push(['En Aktif Oyuncu', turkishToAscii(mostActive[0]), mostActive[1].games + ' oyun']);
                    }
                    if (bestWinRate) {
                        const winRate = Math.round((bestWinRate[1].wins / bestWinRate[1].games) * 100);
                        performanceData.push(['En Yuksek Basari Orani', turkishToAscii(bestWinRate[0]), '%' + winRate]);
                    }
                    
                    doc.autoTable({
                        startY: startY,
                        head: [['Kategori', 'Oyuncu', 'Deger']],
                        body: performanceData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [16, 185, 129],
                            textColor: 255,
                            fontSize: 10,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { halign: 'left', cellWidth: 60, fontStyle: 'bold' },
                            1: { halign: 'left', cellWidth: 70 },
                            2: { halign: 'center', cellWidth: 35 }
                        },
                        margin: { left: 15, right: 15 }
                    });
                    
                    startY = doc.lastAutoTable.finalY + 15;
                    
                    // GENEL ƒ∞STATƒ∞STƒ∞KLER √ñZET
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('GENEL ISTATISTIKLER', 15, startY);
                    startY += 10;
                    
                    const generalStats = [
                        ['Toplam Oyun Sayisi', tournamentGames.length.toString()],
                        ['Tamamlanan Oyunlar', completedGames.length.toString()],
                        ['Devam Eden Oyunlar', activeGames.length.toString()],
                        ['Toplam Katilimci', Object.keys(playerStats).length.toString()],
                        ['Aktif Oyuncu', sortedPlayers.filter(([,s]) => s.wins > 0).length.toString()],
                        ['Ortalama Oyun/Oyuncu', (completedGames.length / Math.max(Object.keys(playerStats).length, 1)).toFixed(1)]
                    ];
                    
                    doc.autoTable({
                        startY: startY,
                        body: generalStats,
                        theme: 'plain',
                        styles: { 
                            fontSize: 10, 
                            cellPadding: 3,
                            lineColor: [200, 200, 200],
                            lineWidth: 0.1
                        },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 70, textColor: [50, 50, 50] },
                            1: { cellWidth: 40, halign: 'center', fontStyle: 'bold', textColor: [139, 92, 246] }
                        },
                        margin: { left: 25 }
                    });
                    
                    // Footer t√ºm sayfalara
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        
                        // Alt √ßizgi
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.5);
                        doc.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);
                        
                        doc.setFontSize(8);
                        doc.setTextColor(128, 128, 128);
                        doc.setFont('helvetica', 'normal');
                        
                        if (i === 1) {
                            doc.text('Akil Zeka Oyunlari - Turnuva Yonetim Sistemi', pageWidth / 2, pageHeight - 10, { align: 'center' });
                        } else {
                            doc.text('Akil Zeka Oyunlari', 15, pageHeight - 10);
                            doc.text('Sayfa ' + i + ' / ' + totalPages, pageWidth - 15, pageHeight - 10, { align: 'right' });
                        }
                    }
                    
                    const fileName = 'Turnuva_Raporu_Detayli_' + new Date().toISOString().split('T')[0] + '.pdf';
                    doc.save(fileName);
                    setToast({ message: 'Detayli turnuva raporu olusturuldu! üèÜ', type: 'success' });
                } catch (error) {
                    console.error('PDF generation error:', error);
                    setToast({ message: 'PDF olusturma hatasi: ' + error.message, type: 'error' });
                }
            }, [games]);

            // üèÜ Rozet Verme ƒ∞≈ülemi with Safety
            const giveBadge = useCallback(async (uid, badgeKey) => {
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const userRef = window.dbRef(window.db, 'users/' + uid);
                    const snapshot = await window.dbGet(userRef);
                    if (!snapshot.exists()) {
                        throw new Error('Kullanƒ±cƒ± bulunamadƒ±');
                    }
                    
                    const userData = snapshot.val();
                    const currentBadges = userData.badges || [];
                    if (!currentBadges.includes(badgeKey)) {
                        currentBadges.push(badgeKey);
                        const success = await window.dbUpdate(userRef, { badges: currentBadges });
                        if (!success) throw new Error('Rozet g√ºncellemesi ba≈üarƒ±sƒ±z');
                        setToast({ message: `üèÜ ${BADGES[badgeKey].name} rozeti verildi!`, type: 'success' });
                    } else {
                        setToast({ message: 'Bu rozet zaten var!', type: 'error' });
                    }
                } catch (error) {
                    console.error('Give badge error:', error);
                    setToast({ message: 'Rozet verme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                    setBadgeModalUser(null);
                    setSelectedBadgeToGive(null);
                }
            }, [canPerformOperation]);

            // üèÜ Rozet Silme ƒ∞≈ülemi with Safety
            const removeBadge = useCallback(async (uid, badgeKey) => {
                if (!confirm(`Bu rozeti silmek istediƒüinize emin misiniz?`)) return;
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const userRef = window.dbRef(window.db, 'users/' + uid);
                    const snapshot = await window.dbGet(userRef);
                    if (!snapshot.exists()) {
                        throw new Error('Kullanƒ±cƒ± bulunamadƒ±');
                    }
                    
                    const userData = snapshot.val();
                    const currentBadges = (userData.badges || []).filter(b => b !== badgeKey);
                    const success = await window.dbUpdate(userRef, { badges: currentBadges });
                    if (!success) throw new Error('Rozet g√ºncellemesi ba≈üarƒ±sƒ±z');
                    setToast({ message: `Rozet kaldƒ±rƒ±ldƒ±`, type: 'success' });
                } catch (error) {
                    console.error('Remove badge error:', error);
                    setToast({ message: 'Rozet kaldƒ±rma ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);

            // üè´ Okula Rozet Verme ƒ∞≈ülemi
            const giveSchoolBadge = useCallback(async (schoolId, badgeKey) => {
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const schoolRef = window.dbRef(window.db, 'schools/' + schoolId);
                    const snapshot = await window.dbGet(schoolRef);
                    if (!snapshot.exists()) {
                        throw new Error('Okul bulunamadƒ±');
                    }
                    
                    const schoolData = snapshot.val();
                    const currentBadges = schoolData.badges || [];
                    if (!currentBadges.includes(badgeKey)) {
                        currentBadges.push(badgeKey);
                        const success = await window.dbUpdate(schoolRef, { badges: currentBadges });
                        if (!success) throw new Error('Rozet g√ºncellemesi ba≈üarƒ±sƒ±z');
                        setToast({ message: `üèÜ ${SCHOOL_BADGES[badgeKey].name} rozeti okula verildi!`, type: 'success' });
                    } else {
                        setToast({ message: 'Bu rozet zaten var!', type: 'error' });
                    }
                } catch (error) {
                    console.error('Give school badge error:', error);
                    setToast({ message: 'Rozet verme ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);

            // üè´ Okul Rozetini Kaldƒ±rma ƒ∞≈ülemi
            const removeSchoolBadge = useCallback(async (schoolId, badgeKey) => {
                if (!confirm(`Bu rozeti kaldƒ±rmak istediƒüinize emin misiniz?`)) return;
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const schoolRef = window.dbRef(window.db, 'schools/' + schoolId);
                    const snapshot = await window.dbGet(schoolRef);
                    if (!snapshot.exists()) {
                        throw new Error('Okul bulunamadƒ±');
                    }
                    
                    const schoolData = snapshot.val();
                    const currentBadges = (schoolData.badges || []).filter(b => b !== badgeKey);
                    const success = await window.dbUpdate(schoolRef, { badges: currentBadges });
                    if (!success) throw new Error('Rozet g√ºncellemesi ba≈üarƒ±sƒ±z');
                    setToast({ message: `Rozet kaldƒ±rƒ±ldƒ±`, type: 'success' });
                } catch (error) {
                    console.error('Remove school badge error:', error);
                    setToast({ message: 'Rozet kaldƒ±rma ba≈üarƒ±sƒ±z: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);

            // üìÑ Okullar Arasƒ± Turnuva Raporu PDF Olu≈üturma
            const generateInterSchoolReport = useCallback(async (requestId) => {
                const request = interSchoolRequests[requestId];
                if (!request) {
                    setToast({ message: 'Turnuva bulunamadi!', type: 'error' });
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    // T√ºrk√ße karakter d√∂n√º≈ü√ºm√º
                    const turkishToAscii = (str) => {
                        if (!str) return '';
                        const charMap = {
                            '√ß': 'c', '√á': 'C', 'ƒü': 'g', 'ƒû': 'G', 'ƒ±': 'i', 'ƒ∞': 'I',
                            '√∂': 'o', '√ñ': 'O', '≈ü': 's', '≈û': 'S', '√º': 'u', '√ú': 'U'
                        };
                        return str.toString().replace(/[√ß√áƒüƒûƒ±ƒ∞√∂√ñ≈ü≈û√º√ú]/g, char => charMap[char] || char);
                    };
                    
                    // KAPAK SAYFASI
                    doc.setFillColor(249, 115, 22);
                    doc.rect(0, 0, pageWidth, 80, 'F');
                    doc.setFillColor(236, 72, 153);
                    doc.circle(pageWidth + 20, -20, 60, 'F');
                    doc.setFillColor(59, 130, 246);
                    doc.circle(-20, 100, 50, 'F');
                    
                    // Ba≈ülƒ±k
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont('helvetica', 'bold');
                    doc.text('OKULLAR ARASI TURNUVA', pageWidth / 2, 35, { align: 'center' });
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    doc.text('RAPORU', pageWidth / 2, 50, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(turkishToAscii(request.fromSchoolName) + ' vs ' + turkishToAscii(request.toSchoolName), pageWidth / 2, 65, { align: 'center' });
                    
                    // Bilgi Kutusu
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(15, 95, pageWidth - 30, 80, 3, 3, 'F');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TURNUVA BILGILERI', 25, 110);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text('Tarih: ' + request.date, 25, 125);
                    doc.text('Oyunlar: ' + request.games.join(', '), 25, 135);
                    doc.text('Her Okuldan Ogrenci: ' + request.studentCount, 25, 145);
                    doc.text('Durum: ' + (request.status === 'active' ? 'Devam Ediyor' : 
                                          request.status === 'completed' ? 'Tamamlandi' : 'Bekliyor'), 25, 155);
                    doc.text('Rapor Tarihi: ' + new Date().toLocaleDateString('tr-TR'), 25, 165);
                    
                    // Okul Kartlarƒ±
                    const cardY = 190;
                    const cardWidth = (pageWidth - 50) / 2;
                    
                    // Okul 1
                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(15, cardY, cardWidth, 50, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(turkishToAscii(request.fromSchoolName), 15 + cardWidth / 2, cardY + 15, { align: 'center' });
                    doc.setFontSize(24);
                    doc.text((request.fromSchoolStudents?.length || 0).toString(), 15 + cardWidth / 2, cardY + 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Ogrenci', 15 + cardWidth / 2, cardY + 43, { align: 'center' });
                    
                    // VS
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('VS', pageWidth / 2, cardY + 25, { align: 'center' });
                    
                    // Okul 2
                    doc.setFillColor(236, 72, 153);
                    doc.roundedRect(25 + cardWidth, cardY, cardWidth, 50, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(turkishToAscii(request.toSchoolName), 25 + cardWidth + cardWidth / 2, cardY + 15, { align: 'center' });
                    doc.setFontSize(24);
                    doc.text((request.toSchoolStudents?.length || 0).toString(), 25 + cardWidth + cardWidth / 2, cardY + 35, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Ogrenci', 25 + cardWidth + cardWidth / 2, cardY + 43, { align: 'center' });
                    
                    // √ñƒürenci Listeleri - Yeni Sayfa
                    doc.addPage();
                    
                    // Ba≈ülƒ±k
                    doc.setFillColor(249, 115, 22);
                    doc.rect(0, 0, pageWidth, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('KATILIMCI LISTESI', 15, 10);
                    
                    let startY = 30;
                    
                    // Okul 1 √ñƒürencileri
                    doc.setTextColor(59, 130, 246);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(turkishToAscii(request.fromSchoolName), 15, startY);
                    startY += 10;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    if (request.fromSchoolStudents && request.fromSchoolStudents.length > 0) {
                        request.fromSchoolStudents.forEach((uid, idx) => {
                            const student = allUsers[uid];
                            if (student) {
                                doc.text((idx + 1) + '. ' + turkishToAscii(student.name) + ' - ' + student.class + ' No:' + student.number, 20, startY);
                                startY += 7;
                            }
                        });
                    } else {
                        doc.text('Henuz ogrenci secilmedi', 20, startY);
                        startY += 7;
                    }
                    
                    startY += 10;
                    
                    // Okul 2 √ñƒürencileri
                    doc.setTextColor(236, 72, 153);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(turkishToAscii(request.toSchoolName), 15, startY);
                    startY += 10;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    if (request.toSchoolStudents && request.toSchoolStudents.length > 0) {
                        request.toSchoolStudents.forEach((uid, idx) => {
                            const student = allUsers[uid];
                            if (student) {
                                doc.text((idx + 1) + '. ' + turkishToAscii(student.name) + ' - ' + student.class + ' No:' + student.number, 20, startY);
                                startY += 7;
                            }
                        });
                    } else {
                        doc.text('Henuz ogrenci secilmedi', 20, startY);
                        startY += 7;
                    }
                    
                    // Footer
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(8);
                    doc.text('Akil Zeka Oyunlari - Okullar Arasi Turnuva Sistemi', pageWidth / 2, pageHeight - 10, { align: 'center' });
                    
                    // Kaydet
                    const fileName = 'Okullar_Arasi_Turnuva_' + turkishToAscii(request.fromSchoolName) + '_vs_' + turkishToAscii(request.toSchoolName) + '_' + new Date().toISOString().split('T')[0] + '.pdf';
                    doc.save(fileName);
                    setToast({ message: 'Okullar arasi turnuva raporu olusturuldu! üè´', type: 'success' });
                } catch (error) {
                    console.error('Inter-school report error:', error);
                    setToast({ message: 'PDF olusturulamadi: ' + error.message, type: 'error' });
                }
            }, [interSchoolRequests, allUsers]);

            // üéÆ Memoized game operations
            const deleteGame = useCallback(async (id) => {
                if (!confirm("Bu oyun silinsin mi? üéÆ")) return;
                if (!canPerformOperation()) return;
                
                setOperationInProgress(true);
                const success = await window.dbRemove(window.dbRef(window.db, 'games/' + id));
                if (success) {
                    setToast({ message: 'Oyun silindi', type: 'success' });
                }
                setOperationInProgress(false);
            }, [canPerformOperation]);

            const resetSystem = useCallback(async () => {
                if (!confirm("‚ö†Ô∏è T√ºm oyunlar ve lobi sƒ±fƒ±rlansƒ±n mƒ±?")) return;
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                setOperationInProgress(true);
                try {
                    const results = await Promise.allSettled([
                        window.dbRemove(window.dbRef(window.db, 'games')),
                        window.dbRemove(window.dbRef(window.db, 'lobby'))
                    ]);
                    
                    const failed = results.filter(r => r.status === 'rejected');
                    if (failed.length > 0) {
                        console.error('Some reset operations failed:', failed);
                        setToast({ message: 'Sistem kƒ±smen sƒ±fƒ±rlandƒ±!', type: 'error' });
                    } else {
                        setToast({ message: 'Sistem sƒ±fƒ±rlandƒ±!', type: 'success' });
                    }
                } catch (error) {
                    console.error('Reset system error:', error);
                    setToast({ message: 'Sƒ±fƒ±rlama hatasƒ±: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [canPerformOperation]);

            // üèÜ Tournament starter with batch operations and error handling
            const startTournament = useCallback(async (type) => {
                setShowGameSelector(false);
                if (!canPerformOperation()) return;
                if (!window.isFirebaseConnected) {
                    setToast({ message: 'Baƒülantƒ± yok!', type: 'error' });
                    return;
                }
                
                let playersToMatch = [];
                
                // üéØ E≈üle≈ütirme Moduna G√∂re Oyuncu Se√ßimi
                if (matchingMode === 'manual') {
                    // Manuel E≈üle≈ütirme - Se√ßilen 2 oyuncu
                    if (!selectedPlayer1 || !selectedPlayer2) {
                        setToast({ message: 'L√ºtfen iki oyuncu se√ßin! üë•', type: 'error' });
                        return;
                    }
                    const p1 = lobbyUsers[selectedPlayer1];
                    const p2 = lobbyUsers[selectedPlayer2];
                    if (!p1 || !p2 || p1.state !== 'waiting' || p2.state !== 'waiting') {
                        setToast({ message: 'Se√ßilen oyuncular uygun deƒüil!', type: 'error' });
                        return;
                    }
                    playersToMatch = [{ ...p1, id: selectedPlayer1 }, { ...p2, id: selectedPlayer2 }];
                    
                } else if (matchingMode === 'school-random') {
                    // Okul ƒ∞√ßi Rastgele E≈üle≈ütirme
                    if (!selectedSchool1) {
                        setToast({ message: 'L√ºtfen bir okul se√ßin! üè´', type: 'error' });
                        return;
                    }
                    const schoolPlayers = Object.entries(lobbyUsers)
                        .filter(([_, u]) => u.state === 'waiting' && u.schoolId === selectedSchool1)
                        .map(([id, u]) => ({ ...u, id }));
                    
                    if (schoolPlayers.length < 2) {
                        setToast({ message: 'Se√ßilen okulda en az 2 bekleyen √∂ƒürenci olmalƒ±! üë•', type: 'error' });
                        return;
                    }
                    playersToMatch = schoolPlayers;
                    
                } else if (matchingMode === 'cross-school') {
                    // Okullar Arasƒ± E≈üle≈ütirme
                    if (!selectedSchool1 || !selectedSchool2) {
                        setToast({ message: 'L√ºtfen iki okul se√ßin! üè´', type: 'error' });
                        return;
                    }
                    const school1Players = Object.entries(lobbyUsers)
                        .filter(([_, u]) => u.state === 'waiting' && u.schoolId === selectedSchool1)
                        .map(([id, u]) => ({ ...u, id }));
                    const school2Players = Object.entries(lobbyUsers)
                        .filter(([_, u]) => u.state === 'waiting' && u.schoolId === selectedSchool2)
                        .map(([id, u]) => ({ ...u, id }));
                    
                    if (school1Players.length === 0 || school2Players.length === 0) {
                        setToast({ message: 'Her iki okulda da bekleyen √∂ƒürenci olmalƒ±! üë•', type: 'error' });
                        return;
                    }
                    
                    // ƒ∞ki okul arasƒ±nda dengeli e≈üle≈ütirme
                    const minMatches = Math.min(school1Players.length, school2Players.length);
                    const shuffled1 = school1Players.sort(() => 0.5 - Math.random()).slice(0, minMatches);
                    const shuffled2 = school2Players.sort(() => 0.5 - Math.random()).slice(0, minMatches);
                    
                    // Birle≈ütirip tek liste haline getir (√ßiftler halinde)
                    playersToMatch = [];
                    for (let i = 0; i < minMatches; i++) {
                        playersToMatch.push(shuffled1[i], shuffled2[i]);
                    }
                    
                } else if (matchingMode === 'swiss') {
                    // üèÜ ƒ∞svi√ßre Sistemi - Benzer puanlƒ± oyuncularƒ± e≈üle≈ütir
                    const waitingPlayers = Object.entries(lobbyUsers)
                        .filter(([_, u]) => u.state === 'waiting')
                        .map(([id, u]) => {
                            const userStats = allUsers[id]?.stats || {};
                            const wins = userStats.wins || 0;
                            return { ...u, id, wins };
                        });
                    
                    if (waitingPlayers.length < 2) {
                        setToast({ message: 'En az 2 √∂ƒürenci lobide bekliyor olmalƒ±! üë•', type: 'error' });
                        return;
                    }
                    
                    // Kazanma sayƒ±sƒ±na g√∂re sƒ±rala (en y√ºksekten en d√º≈ü√ºƒüe)
                    waitingPlayers.sort((a, b) => b.wins - a.wins);
                    
                    // ƒ∞svi√ßre sistemine g√∂re e≈üle≈ütir:
                    // Aynƒ± veya yakƒ±n puanlƒ± oyuncularƒ± e≈üle≈ütir
                    playersToMatch = [];
                    const matched = new Set();
                    
                    for (let i = 0; i < waitingPlayers.length; i++) {
                        if (matched.has(i)) continue;
                        
                        const p1 = waitingPlayers[i];
                        let bestMatchIndex = -1;
                        let bestScoreDiff = Infinity;
                        
                        // En yakƒ±n puanlƒ± e≈üle≈ümemi≈ü oyuncuyu bul
                        for (let j = i + 1; j < waitingPlayers.length; j++) {
                            if (matched.has(j)) continue;
                            
                            const p2 = waitingPlayers[j];
                            const scoreDiff = Math.abs(p1.wins - p2.wins);
                            
                            if (scoreDiff < bestScoreDiff) {
                                bestScoreDiff = scoreDiff;
                                bestMatchIndex = j;
                            }
                        }
                        
                        if (bestMatchIndex !== -1) {
                            playersToMatch.push(p1, waitingPlayers[bestMatchIndex]);
                            matched.add(i);
                            matched.add(bestMatchIndex);
                        }
                    }
                    
                    if (playersToMatch.length < 2) {
                        setToast({ message: 'E≈üle≈ütirme yapƒ±lamadƒ±!', type: 'error' });
                        return;
                    }
                    
                } else {
                    // Varsayƒ±lan Rastgele E≈üle≈ütirme
                    // Okul y√∂neticisi ise sadece kendi okulundan, s√ºper admin ise herkesten
                    playersToMatch = Object.entries(filteredLobbyUsers)
                        .filter(([_, u]) => u.state === 'waiting')
                        .map(([id, u]) => ({ ...u, id }));
                }
                
                if (playersToMatch.length < 2) {
                    setToast({ message: 'En az 2 √∂ƒürenci lobide bekliyor olmalƒ±! üë•', type: 'error' });
                    return;
                }

                setOperationInProgress(true);
                
                // Manuel mod dƒ±≈üƒ±nda karƒ±≈ütƒ±r
                const shuffled = matchingMode === 'cross-school' 
                    ? playersToMatch // Zaten dengeli ≈üekilde hazƒ±rlandƒ±
                    : matchingMode === 'manual' 
                        ? playersToMatch // Manuel se√ßim, karƒ±≈ütƒ±rmaya gerek yok
                        : playersToMatch.sort(() => 0.5 - Math.random()); // Diƒüer modlarda karƒ±≈ütƒ±r
                
                let matchesCreated = 0;
                let matchesFailed = 0;
                
                try {
                    for (let i = 0; i < shuffled.length; i += 2) {
                        if (i + 1 >= shuffled.length) break;
                        const p1 = shuffled[i];
                        const p2 = shuffled[i + 1];
                        const id = Math.floor(Math.random() * 90000 + 10000).toString();
                        
                        let data = {
                            isP1Turn: true,
                            players: { p1: { name: p1.name }, p2: { name: p2.name } },
                            type,
                            createdAt: Date.now()
                        };

                        if (type === 'mangala') {
                            data.board = [4, 4, 4, 4, 4, 4, 0, 4, 4, 4, 4, 4, 4, 0];
                        } else if (type === 'reversi') {
                            let b = Array(64).fill(0);
                            b[27] = 2; b[28] = 1; b[35] = 1; b[36] = 2;
                            data.board = b;
                        } else if (type === 'pentago') {
                            data.board = Array(36).fill(0);
                            data.phase = 'place';
                            data.lastPlaced = null;
                        } else if (type === 'kulami') {
                            // Kulami panellerini olu≈ütur
                            const panels = createKulamiPanels();
                            
                            // ƒ∞lk hamle i√ßin t√ºm bo≈ü h√ºcreleri valid moves olarak i≈üaretle
                            const initialValidMoves = [];
                            panels.forEach((panel, panelIdx) => {
                                panel.cells.forEach((cell, cellIdx) => {
                                    if (cell.player === 0) {
                                        initialValidMoves.push({ panelId: panelIdx, cellIdx });
                                    }
                                });
                            });
                            
                            data.panels = panels;
                            data.board = [];
                            data.lastMove = null;
                            data.forbiddenPanel = null;
                            data.validMoves = initialValidMoves;
                            data.p1Score = 0;
                            data.p2Score = 0;
                        } else if (type === 'kure') {
                            // K√ºre: 7x7 = 49 h√ºcre - TAZOF KURALLARI
                            // P1 (Mor) √ºst sƒ±rada (satƒ±r 0), P2 (Turuncu) alt sƒ±rada (satƒ±r 6)
                            // Mor her zaman ba≈ülar (isP1Turn: true)
                            const board = Array(49).fill(0);
                            // Satƒ±r 0: P1 (Mor) ta≈ülarƒ± - indeksler 0-6
                            for (let col = 0; col < 7; col++) {
                                board[col] = 1; // P1 = Mor
                            }
                            // Satƒ±r 6: P2 (Turuncu) ta≈ülarƒ± - indeksler 42-48
                            for (let col = 0; col < 7; col++) {
                                board[42 + col] = 2; // P2 = Turuncu
                            }
                            data.board = board;
                            data.p1Captured = 0;  // P1'in aldƒ±ƒüƒ± ta≈ülar
                            data.p2Captured = 0;  // P2'nin aldƒ±ƒüƒ± ta≈ülar
                            data.lastMove = null;
                        } else if (type === 'abluka') {
                            // Abluka: 7x7 = 49 h√ºcre - TAZOF KURALLARI
                            // Siyah (P1) √ºst orta, Beyaz (P2) alt orta
                            // Siyah her zaman ba≈ülar (isP1Turn: true)
                            const board = Array(49).fill(0);
                            board[3] = 1;  // Siyah (P1) - satƒ±r 0, s√ºtun 3
                            board[45] = 2; // Beyaz (P2) - satƒ±r 6, s√ºtun 3
                            data.board = board;
                            data.blockers = []; // Engel h√ºcreleri
                            data.p1SetsWon = 0;  // P1'in kazandƒ±ƒüƒ± setler
                            data.p2SetsWon = 0;  // P2'nin kazandƒ±ƒüƒ± setler
                            data.currentSet = 1; // Mevcut set numarasƒ±
                            data.lastMove = null; // Son hamleyi yapan (abluka durumunda kazanan i√ßin)
                        } else if (type === 'qbitz') {
                            // Q-bitz: 4x4 grid, 6 farklƒ± y√ºz
                            // Rastgele hedef desen olu≈ütur
                            const target = Array(16).fill(0).map(() => Math.floor(Math.random() * 6));
                            data.target = target;
                            data.p1Grid = Array(16).fill(0);
                            data.p2Grid = Array(16).fill(0);
                        }

                        try {
                            const success = await window.dbSet(window.dbRef(window.db, 'games/' + id), data);
                            if (success) {
                                const results = await Promise.allSettled([
                                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p1.id), { gameId: id, role: 'P1', state: 'playing' }),
                                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p2.id), { gameId: id, role: 'P2', state: 'playing' })
                                ]);
                                
                                const failedUpdates = results.filter(r => r.status === 'rejected');
                                if (failedUpdates.length === 0) {
                                    matchesCreated++;
                                } else {
                                    console.error('Failed to update lobby for some players:', failedUpdates);
                                    // Rollback: delete the game if player updates failed
                                    await window.dbRemove(window.dbRef(window.db, 'games/' + id));
                                    matchesFailed++;
                                }
                            } else {
                                matchesFailed++;
                            }
                        } catch (error) {
                            console.error('Error creating match:', error);
                            matchesFailed++;
                        }
                    }
                    
                    if (matchesCreated > 0) {
                        setToast({ message: `${matchesCreated} ma√ß olu≈üturuldu! üéÆ${matchesFailed > 0 ? ` (${matchesFailed} ba≈üarƒ±sƒ±z)` : ''}`, type: 'success' });
                        // Reset selections
                        setSelectedPlayer1(null);
                        setSelectedPlayer2(null);
                        setSelectedSchool1('');
                        setSelectedSchool2('');
                    } else {
                        setToast({ message: 'Ma√ß olu≈üturulamadƒ±!', type: 'error' });
                    }
                } catch (error) {
                    console.error('Tournament start error:', error);
                    setToast({ message: 'Turnuva ba≈ülatma hatasƒ±: ' + error.message, type: 'error' });
                } finally {
                    setOperationInProgress(false);
                }
            }, [lobbyUsers, canPerformOperation, matchingMode, selectedPlayer1, selectedPlayer2, selectedSchool1, selectedSchool2, allUsers]);

            // üè´ Filtrelenmi≈ü lobi kullanƒ±cƒ±larƒ± (okul y√∂neticisi i√ßin kendi okulu)
            const filteredLobbyUsers = useMemo(() => {
                if (isSuperAdmin) return lobbyUsers;
                if (!adminSchool) return lobbyUsers;
                
                const filtered = {};
                Object.entries(lobbyUsers).forEach(([uid, user]) => {
                    if (user.schoolId === adminSchool) {
                        filtered[uid] = user;
                    }
                });
                return filtered;
            }, [lobbyUsers, isSuperAdmin, adminSchool]);

            // üìä Memoized statistics
            const stats = useMemo(() => ({
                pendingCount: isSuperAdmin 
                    ? Object.keys(pendingUsers).length 
                    : Object.values(pendingUsers).filter(u => u.schoolId === adminSchool).length,
                waitingCount: Object.values(filteredLobbyUsers).filter(u => u.state === 'waiting').length,
                playingCount: Object.values(filteredLobbyUsers).filter(u => u.state === 'playing').length,
                activeGames: Object.values(games).filter(g => !g.winner).length,
                totalUsers: isSuperAdmin 
                    ? Object.keys(allUsers).length 
                    : Object.values(allUsers).filter(u => u.schoolId === adminSchool).length
            }), [pendingUsers, filteredLobbyUsers, games, allUsers, isSuperAdmin, adminSchool]);

            // üìÑ Memoized paginated data
            const paginatedGames = useMemo(() => {
                const entries = Object.entries(games).reverse();
                const start = 0;
                const end = gamesPage * ITEMS_PER_PAGE;
                return entries.slice(start, end);
            }, [games, gamesPage]);

            const paginatedUsers = useMemo(() => {
                let entries = Object.entries(allUsers);
                
                // Okul y√∂neticisi ise sadece kendi okulu
                if (!isSuperAdmin && adminSchool) {
                    entries = entries.filter(([_, u]) => u.schoolId === adminSchool);
                } else if (selectedSchoolFilter) {
                    // S√ºper admin i√ßin okul filtresi
                    entries = entries.filter(([_, u]) => u.schoolId === selectedSchoolFilter);
                }
                
                // Sƒ±nƒ±f filtresi
                if (selectedClassFilter) {
                    entries = entries.filter(([_, u]) => u.class === selectedClassFilter);
                }
                
                // Arama filtresi
                if (studentSearch.trim()) {
                    const searchLower = studentSearch.toLowerCase();
                    entries = entries.filter(([_, u]) => 
                        u.name.toLowerCase().includes(searchLower) ||
                        u.class.toLowerCase().includes(searchLower) ||
                        u.number.toString().includes(searchLower) ||
                        u.schoolName.toLowerCase().includes(searchLower)
                    );
                }
                
                const start = 0;
                const end = usersPage * ITEMS_PER_PAGE;
                return {
                    data: entries.slice(start, end),
                    total: entries.length,
                    hasMore: end < entries.length
                };
            }, [allUsers, selectedSchoolFilter, selectedClassFilter, usersPage, studentSearch, isSuperAdmin, adminSchool]);
            
            // üè´ Okul bazlƒ± gruplama
            const studentsBySchool = useMemo(() => {
                let entries = Object.entries(allUsers);
                
                // Okul y√∂neticisi ise sadece kendi okulu
                if (!isSuperAdmin && adminSchool) {
                    entries = entries.filter(([_, u]) => u.schoolId === adminSchool);
                }
                
                // Arama filtresi
                if (studentSearch.trim()) {
                    const searchLower = studentSearch.toLowerCase();
                    entries = entries.filter(([_, u]) => 
                        u.name.toLowerCase().includes(searchLower) ||
                        u.class.toLowerCase().includes(searchLower) ||
                        u.number.toString().includes(searchLower) ||
                        u.schoolName.toLowerCase().includes(searchLower)
                    );
                }
                
                const grouped = {};
                entries.forEach(([uid, user]) => {
                    const schoolId = user.schoolId || 'unknown';
                    const schoolName = user.schoolName || 'Bilinmeyen Okul';
                    if (!grouped[schoolId]) {
                        grouped[schoolId] = { name: schoolName, students: [] };
                    }
                    grouped[schoolId].students.push([uid, user]);
                });
                
                return grouped;
            }, [allUsers, studentSearch]);
            
            // üìö T√ºm benzersiz sƒ±nƒ±flarƒ± al (okul bazlƒ± filtreleme ile)
            const uniqueClasses = useMemo(() => {
                const classes = new Set();
                Object.values(allUsers).forEach(user => {
                    // Okul y√∂neticisi i√ßin sadece kendi okulunun sƒ±nƒ±flarƒ±
                    if (!isSuperAdmin && adminSchool && user.schoolId !== adminSchool) return;
                    if (user.class) classes.add(user.class);
                });
                return Array.from(classes).sort();
            }, [allUsers, isSuperAdmin, adminSchool]);
            
            // üìã Sƒ±nƒ±f bazlƒ± √∂ƒürenci se√ßme (okul bazlƒ± filtreleme ile)
            const selectStudentsByClass = useCallback((className) => {
                const studentsInClass = Object.entries(allUsers)
                    .filter(([_, u]) => {
                        // Okul y√∂neticisi i√ßin sadece kendi okulunun √∂ƒürencileri
                        if (!isSuperAdmin && adminSchool && u.schoolId !== adminSchool) return false;
                        return u.class === className;
                    })
                    .map(([uid]) => uid);
                
                const newSet = new Set(selectedStudents);
                studentsInClass.forEach(uid => newSet.add(uid));
                setSelectedStudents(newSet);
                setToast({ message: `${studentsInClass.length} √∂ƒürenci se√ßildi (${className})`, type: 'success' });
            }, [allUsers, selectedStudents, isSuperAdmin, adminSchool]);

            // üîê Login fonksiyonu - Rate limiting ile g√ºvenli
            const handleLogin = () => {
                const code = loginCode.trim().toUpperCase();
                const pass = password.trim();
                
                if (!code || !pass) {
                    setLoginError("‚ö†Ô∏è L√ºtfen kod ve ≈üifre girin.");
                    return;
                }
                
                // Rate limiting kontrol√º
                const rateLimitCheck = window.rateLimiter.canAttempt(code);
                if (!rateLimitCheck.allowed) {
                    setLoginError(`üö´ ${rateLimitCheck.message}`);
                    return;
                }
                
                // S√ºper admin kontrol√º (hash ile kar≈üƒ±la≈ütƒ±rma - daha g√ºvenli)
                // NOT: Ger√ßek uygulamada bu ≈üifre environment variable olmalƒ±
                const SUPER_ADMIN_CODE = "ADMIN";
                const SUPER_ADMIN_PASS = "1234"; // Bu deƒüi≈ütirilmeli!
                
                if (code === SUPER_ADMIN_CODE && pass === SUPER_ADMIN_PASS) {
                    window.rateLimiter.recordAttempt(code, true);
                    setLoginError("");
                    setIsSuperAdmin(true);
                    setAdminSchool(null);
                    setIsLoggedIn(true);
                    console.log("‚úÖ S√ºper admin giri≈üi ba≈üarƒ±lƒ±!");
                    return;
                }
                
                // Okul bazlƒ± giri≈ü - koda g√∂re okul bul
                const school = Object.values(schools).find(s => s.code?.toUpperCase() === code);
                if (school && school.password === pass) {
                    window.rateLimiter.recordAttempt(code, true);
                    setLoginError("");
                    setIsSuperAdmin(false);
                    setAdminSchool(school.id);
                    setSelectedSchoolFilter(school.id); // Otomatik okul filtrele
                    setIsLoggedIn(true);
                    console.log(`‚úÖ ${school.name} okul y√∂neticisi giri≈üi ba≈üarƒ±lƒ±!`);
                    return;
                }
                
                // Ba≈üarƒ±sƒ±z giri≈ü - rate limiter g√ºncelle
                window.rateLimiter.recordAttempt(code, false);
                
                // Hata mesajlarƒ±
                if (!school) {
                    setLoginError("‚ùå Ge√ßersiz giri≈ü kodu!");
                } else {
                    setLoginError("‚ùå Yanlƒ±≈ü ≈üifre! Tekrar deneyin.");
                }
            };

            // üîê LOGIN SCREEN - KOD VE ≈ûƒ∞FRE ƒ∞LE Gƒ∞Rƒ∞≈û
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="glass-card p-6 sm:p-10 max-w-md w-full text-center pop-in">
                            <div className="text-5xl sm:text-6xl mb-4 sm:mb-6 bounce">üéÆ</div>
                            <h1 className="text-2xl sm:text-3xl font-bold rainbow-text mb-2">Y√ñNETƒ∞Cƒ∞ PANELƒ∞</h1>
                            <p className="text-white/60 text-xs sm:text-sm mb-6 sm:mb-8">Akƒ±l Zeka Oyunlarƒ± Turnuva Y√∂netimi</p>
                            
                            {loginError && (
                                <div className="bg-red-500/20 border-2 border-red-500 text-red-200 px-4 py-3 rounded-xl mb-4 flex items-center gap-2">
                                    <i className="fas fa-exclamation-triangle"></i>
                                    <span className="font-bold text-sm">{loginError}</span>
                                </div>
                            )}
                            
                            {/* Giri≈ü Kodu */}
                            <input
                                type="text"
                                value={loginCode}
                                onChange={e => {
                                    setLoginCode(e.target.value.toUpperCase());
                                    setLoginError("");
                                }}
                                className="input-fun w-full text-center mb-4 uppercase"
                                placeholder="üè´ Giri≈ü Kodu"
                                autoFocus
                            />
                            
                            {/* ≈ûifre */}
                            <input
                                type="password"
                                value={password}
                                onChange={e => {
                                    setPassword(e.target.value);
                                    setLoginError("");
                                }}
                                onKeyDown={e => {
                                    if (e.key === 'Enter') {
                                        handleLogin();
                                    }
                                }}
                                className="input-fun w-full text-center mb-4"
                                placeholder="üîí ≈ûifre"
                            />
                            
                            <button
                                onClick={handleLogin}
                                className="btn-candy btn-purple w-full"
                            >
                                <i className="fas fa-sign-in-alt mr-2"></i> Giri≈ü Yap
                            </button>
                            
                            <p className="text-white/40 text-xs mt-4">
                                Okul kodunuz ve ≈üifreniz ile giri≈ü yapƒ±n
                            </p>
                        </div>
                    </div>
                );
            }

            const { pendingCount, waitingCount, playingCount, activeGames, totalUsers } = stats;

            return (
                <div className="min-h-screen p-4 md:p-6 max-w-7xl mx-auto relative z-10">
                    {/* üîî Toast Notifications */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* üîå Connection Status */}
                    <ConnectionStatus isConnected={isConnected} isLoading={isLoading} />
                    
                    {/* ‚è≥ Operation Overlay */}
                    {operationInProgress && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[90]">
                            <div className="bg-white rounded-2xl p-6 flex items-center gap-4">
                                <div className="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                                <span className="font-bold text-gray-700">ƒ∞≈ülem yapƒ±lƒ±yor...</span>
                            </div>
                        </div>
                    )}

                    {/* Spectator Modal */}
                    {spectatingGameId && games[spectatingGameId] && (
                        <SpectatorModal 
                            game={games[spectatingGameId]} 
                            gameId={spectatingGameId} 
                            onClose={() => setSpectatingGameId(null)} 
                        />
                    )}
                    
                    {/* üìù Student Edit Modal */}
                    {editModalUser && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4">
                            <div className="glass-card-light p-4 sm:p-6 max-w-md w-full pop-in">
                                <div className="flex justify-between items-center mb-4 sm:mb-6">
                                    <div className="flex items-center gap-2 sm:gap-3">
                                        <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-white text-lg sm:text-xl font-bold">
                                            {editModalUser.name.charAt(0)}
                                        </div>
                                        <h3 className="text-lg sm:text-xl font-bold text-gray-800">√ñƒürenci D√ºzenle</h3>
                                    </div>
                                    <button onClick={() => setEditModalUser(null)} className="text-gray-400 active:text-gray-600 text-xl sm:text-2xl p-2">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <div className="space-y-3 sm:space-y-4">
                                    {/* ƒ∞sim (sadece g√∂sterim) */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üë§ ƒ∞sim</label>
                                        <input 
                                            type="text"
                                            value={editModalUser.name}
                                            disabled
                                            className="input-fun w-full bg-gray-100 cursor-not-allowed"
                                        />
                                    </div>
                                    
                                    {/* Numara */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üî¢ Numara</label>
                                        <input 
                                            type="number"
                                            value={editModalUser.number}
                                            onChange={(e) => setEditModalUser({ ...editModalUser, number: e.target.value })}
                                            className="input-fun w-full"
                                            placeholder="√ñƒürenci numarasƒ±"
                                        />
                                    </div>
                                    
                                    {/* Sƒ±nƒ±f */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üìö Sƒ±nƒ±f</label>
                                        <input 
                                            type="text"
                                            value={editModalUser.class}
                                            onChange={(e) => setEditModalUser({ ...editModalUser, class: e.target.value })}
                                            className="input-fun w-full"
                                            placeholder="√ñrn: 5-A"
                                        />
                                    </div>
                                    
                                    {/* Okul (sadece g√∂sterim) */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Okul</label>
                                        <input 
                                            type="text"
                                            value={editModalUser.schoolName}
                                            disabled
                                            className="input-fun w-full bg-gray-100 cursor-not-allowed"
                                        />
                                    </div>
                                    
                                    {/* Butonlar */}
                                    <div className="flex gap-2 sm:gap-3 pt-3 sm:pt-4">
                                        <button 
                                            onClick={() => {
                                                const { uid, name, schoolId, schoolName, ...rest } = editModalUser;
                                                editStudent(uid, { 
                                                    number: editModalUser.number,
                                                    class: editModalUser.class,
                                                    name,
                                                    schoolId,
                                                    schoolName
                                                });
                                            }}
                                            className="btn-candy btn-green flex-1 py-2 sm:py-3 text-sm sm:text-base"
                                            disabled={operationInProgress}
                                        >
                                            <i className="fas fa-save mr-1 sm:mr-2"></i>Kaydet
                                        </button>
                                        <button 
                                            onClick={() => setEditModalUser(null)}
                                            className="btn-candy btn-gray flex-1 py-2 sm:py-3 text-sm sm:text-base"
                                        >
                                            <i className="fas fa-times mr-1 sm:mr-2"></i>ƒ∞ptal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* üèÜ Badge Management Modal */}
                    {badgeModalUser && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4">
                            <div className="glass-card-light p-4 sm:p-6 max-w-2xl w-full max-h-[90vh] overflow-auto pop-in">
                                {/* Header */}
                                <div className="flex justify-between items-center mb-4 sm:mb-6">
                                    <div className="flex items-center gap-2 sm:gap-3">
                                        <div className="w-10 h-10 sm:w-14 sm:h-14 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white text-lg sm:text-2xl font-bold shadow-lg">
                                            {badgeModalUser.name.charAt(0)}
                                        </div>
                                        <div>
                                            <h3 className="text-base sm:text-xl font-bold text-gray-800">{badgeModalUser.name}</h3>
                                            <p className="text-gray-500 text-xs sm:text-base">{badgeModalUser.class} - {badgeModalUser.schoolName}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => { setBadgeModalUser(null); setSelectedBadgeToGive(null); }} className="text-gray-400 active:text-gray-600 text-xl sm:text-2xl p-2">
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>

                                {/* Current Badges */}
                                <div className="mb-4 sm:mb-6">
                                    <h4 className="text-base sm:text-lg font-bold text-gray-700 mb-2 sm:mb-3">üì¶ Mevcut Rozetler ({(badgeModalUser.badges || []).length})</h4>
                                    {(badgeModalUser.badges || []).length > 0 ? (
                                        <div className="flex flex-wrap gap-2">
                                            {(badgeModalUser.badges || []).map(badgeKey => {
                                                const badge = BADGES[badgeKey];
                                                if (!badge) return null;
                                                return (
                                                    <div 
                                                        key={badgeKey} 
                                                        className="relative group"
                                                        style={{ background: `linear-gradient(135deg, ${badge.color}20, ${badge.color}40)` }}
                                                    >
                                                        <div className="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-xl border-2" style={{ borderColor: badge.color }}>
                                                            <span className="text-lg sm:text-xl">{badge.icon}</span>
                                                            <span className="font-bold text-gray-700 text-xs sm:text-sm">{badge.name}</span>
                                                            <button 
                                                                onClick={() => removeBadge(badgeModalUser.uid, badgeKey)}
                                                                className="ml-1 text-red-400 active:text-red-600"
                                                                disabled={operationInProgress}
                                                            >
                                                                <i className="fas fa-times-circle"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <p className="text-gray-400 italic text-sm">Hen√ºz rozet yok</p>
                                    )}
                                </div>

                                {/* Give Special Badges */}
                                <div>
                                    <h4 className="text-base sm:text-lg font-bold text-gray-700 mb-2 sm:mb-3">üéÅ √ñzel Rozet Ver</h4>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                        {SPECIAL_BADGES.map(badgeKey => {
                                            const badge = BADGES[badgeKey];
                                            const alreadyHas = (badgeModalUser.badges || []).includes(badgeKey);
                                            return (
                                                <button
                                                    key={badgeKey}
                                                    onClick={() => !alreadyHas && giveBadge(badgeModalUser.uid, badgeKey)}
                                                    disabled={alreadyHas || operationInProgress}
                                                    className={`p-3 sm:p-4 rounded-2xl border-3 transition-all flex items-center gap-2 sm:gap-3 ${
                                                        alreadyHas 
                                                            ? 'bg-gray-100 border-gray-200 opacity-50 cursor-not-allowed' 
                                                            : 'active:scale-95 active:shadow-lg cursor-pointer'
                                                    }`}
                                                    style={{ 
                                                        background: alreadyHas ? undefined : `linear-gradient(135deg, ${badge.color}10, ${badge.color}30)`,
                                                        borderColor: alreadyHas ? undefined : badge.color
                                                    }}
                                                >
                                                    <span className="text-2xl sm:text-4xl">{badge.icon}</span>
                                                    <div className="text-left flex-1">
                                                        <div className="font-bold text-gray-800 text-sm sm:text-base">{badge.name}</div>
                                                        <div className="text-xs text-gray-500 hidden sm:block">{badge.description}</div>
                                                        <div 
                                                            className="text-xs font-bold mt-1 px-2 py-0.5 rounded-full inline-block"
                                                            style={{ background: RARITY_COLORS[badge.rarity], color: 'white' }}
                                                        >
                                                            {badge.rarity === 'legendary' ? 'üåü Efsanevi' : 
                                                             badge.rarity === 'special' ? 'üíé √ñzel' :
                                                             badge.rarity === 'epic' ? 'üíú Destansƒ±' : ''}
                                                        </div>
                                                    </div>
                                                    {alreadyHas && <span className="text-green-500 text-xl">‚úì</span>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Stats */}
                                <div className="mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-200">
                                    <h4 className="text-base sm:text-lg font-bold text-gray-700 mb-2 sm:mb-3">üìä ƒ∞statistikler</h4>
                                    <div className="grid grid-cols-4 gap-2 sm:gap-3">
                                        <div className="bg-green-50 rounded-xl p-2 sm:p-3 text-center border border-green-200">
                                            <div className="text-lg sm:text-2xl font-bold text-green-600">{badgeModalUser.stats?.wins || 0}</div>
                                            <div className="text-xs text-green-500">Galibiyet</div>
                                        </div>
                                        <div className="bg-blue-50 rounded-xl p-2 sm:p-3 text-center border border-blue-200">
                                            <div className="text-lg sm:text-2xl font-bold text-blue-600">{badgeModalUser.stats?.totalGames || 0}</div>
                                            <div className="text-xs text-blue-500">Toplam</div>
                                        </div>
                                        <div className="bg-purple-50 rounded-xl p-2 sm:p-3 text-center border border-purple-200">
                                            <div className="text-lg sm:text-2xl font-bold text-purple-600">{badgeModalUser.stats?.streak || 0}</div>
                                            <div className="text-xs text-purple-500">Seri</div>
                                        </div>
                                        <div className="bg-amber-50 rounded-xl p-2 sm:p-3 text-center border border-amber-200">
                                            <div className="text-lg sm:text-2xl font-bold text-amber-600">{(badgeModalUser.badges || []).length}</div>
                                            <div className="text-xs text-amber-500">Rozet</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game Selector Modal */}
                    {showGameSelector && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4 overflow-y-auto">
                            <div className="glass-card-light p-4 sm:p-8 max-w-4xl w-full pop-in my-4 sm:my-8">
                                <h3 className="text-xl sm:text-2xl font-bold text-gray-800 mb-2 text-center">üéÆ E≈üle≈ütirme Y√∂netimi</h3>
                                <p className="text-gray-500 mb-4 sm:mb-6 text-center text-sm sm:text-base">E≈üle≈ütirme modunu ve oyun t√ºr√ºn√º se√ßin</p>
                                
                                {/* E≈üle≈ütirme Modu Se√ßimi */}
                                <div className="mb-4 sm:mb-6">
                                    <h4 className="text-base sm:text-lg font-bold text-gray-700 mb-2 sm:mb-3 text-center">üìã E≈üle≈ütirme Modu</h4>
                                    <div className={`grid gap-2 sm:gap-3 ${isSuperAdmin ? 'grid-cols-3 sm:grid-cols-3 lg:grid-cols-5' : 'grid-cols-2 sm:grid-cols-3'}`}>
                                        <button 
                                            onClick={() => setMatchingMode('random')} 
                                            className={`btn-candy py-2 sm:py-4 flex flex-col items-center gap-1 sm:gap-2 ${matchingMode === 'random' ? 'btn-blue ring-2 sm:ring-4 ring-blue-300' : 'btn-gray'}`}
                                        >
                                            <span className="text-xl sm:text-2xl">üé≤</span>
                                            <span className="font-bold text-xs sm:text-sm">Rastgele</span>
                                        </button>
                                        <button 
                                            onClick={() => setMatchingMode('manual')} 
                                            className={`btn-candy py-2 sm:py-4 flex flex-col items-center gap-1 sm:gap-2 ${matchingMode === 'manual' ? 'btn-purple ring-2 sm:ring-4 ring-purple-300' : 'btn-gray'}`}
                                        >
                                            <span className="text-xl sm:text-2xl">‚úã</span>
                                            <span className="font-bold text-xs sm:text-sm">Manuel</span>
                                        </button>
                                        {/* S√ºper Admin i√ßin ek modlar */}
                                        {isSuperAdmin && (
                                            <>
                                                <button 
                                                    onClick={() => setMatchingMode('school-random')} 
                                                    className={`btn-candy py-2 sm:py-4 flex flex-col items-center gap-1 sm:gap-2 ${matchingMode === 'school-random' ? 'btn-green ring-2 sm:ring-4 ring-green-300' : 'btn-gray'}`}
                                                >
                                                    <span className="text-xl sm:text-2xl">üè´</span>
                                                    <span className="font-bold text-xs sm:text-sm">Okul ƒ∞√ßi</span>
                                                </button>
                                                <button 
                                                    onClick={() => setMatchingMode('cross-school')} 
                                                    className={`btn-candy py-2 sm:py-4 flex flex-col items-center gap-1 sm:gap-2 ${matchingMode === 'cross-school' ? 'btn-yellow ring-2 sm:ring-4 ring-yellow-300' : 'btn-gray'}`}
                                                >
                                                    <span className="text-lg sm:text-2xl">üè´üÜöüè´</span>
                                                    <span className="font-bold text-xs sm:text-sm">Okullar Arasƒ±</span>
                                                </button>
                                                <button 
                                                    onClick={() => setMatchingMode('swiss')} 
                                                    className={`btn-candy py-2 sm:py-4 flex flex-col items-center gap-1 sm:gap-2 ${matchingMode === 'swiss' ? 'btn-red ring-2 sm:ring-4 ring-red-300' : 'btn-gray'}`}
                                                >
                                                    <span className="text-xl sm:text-2xl">üèÜ</span>
                                                    <span className="font-bold text-xs sm:text-sm">ƒ∞svi√ßre</span>
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* Manuel E≈üle≈ütirme UI */}
                                {matchingMode === 'manual' && (
                                    <div className="mb-6 p-4 bg-purple-50 rounded-xl">
                                        <h4 className="text-md font-bold text-purple-700 mb-3">‚úã Manuel Oyuncu Se√ßimi</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">üë§ Oyuncu 1</label>
                                                <select 
                                                    onChange={e => setSelectedPlayer1(e.target.value)}
                                                    value={selectedPlayer1 || ''}
                                                    className="input-fun w-full"
                                                >
                                                    <option value="">Oyuncu Se√ßin...</option>
                                                    {Object.entries(filteredLobbyUsers)
                                                        .filter(([id, u]) => u.state === 'waiting' && id !== selectedPlayer2)
                                                        .map(([id, u]) => (
                                                            <option key={id} value={id}>{u.name} ({u.class})</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">üë§ Oyuncu 2</label>
                                                <select 
                                                    onChange={e => setSelectedPlayer2(e.target.value)}
                                                    value={selectedPlayer2 || ''}
                                                    className="input-fun w-full"
                                                >
                                                    <option value="">Oyuncu Se√ßin...</option>
                                                    {Object.entries(filteredLobbyUsers)
                                                        .filter(([id, u]) => u.state === 'waiting' && id !== selectedPlayer1)
                                                        .map(([id, u]) => (
                                                            <option key={id} value={id}>{u.name} ({u.class})</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Okul ƒ∞√ßi Rastgele E≈üle≈ütirme UI - Sadece S√ºper Admin */}
                                {isSuperAdmin && matchingMode === 'school-random' && (
                                    <div className="mb-6 p-4 bg-green-50 rounded-xl">
                                        <h4 className="text-md font-bold text-green-700 mb-3">üè´ Okul Se√ßimi</h4>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Okul Se√ßin</label>
                                            <select 
                                                onChange={e => setSelectedSchool1(e.target.value)}
                                                value={selectedSchool1}
                                                className="input-fun w-full"
                                            >
                                                <option value="">Okul Se√ßin...</option>
                                                {Object.values(schools).map(s => (
                                                    <option key={s.id} value={s.id}>{s.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                )}

                                {/* Okullar Arasƒ± E≈üle≈ütirme UI - Sadece S√ºper Admin */}
                                {isSuperAdmin && matchingMode === 'cross-school' && (
                                    <div className="mb-6 p-4 bg-yellow-50 rounded-xl">
                                        <h4 className="text-md font-bold text-yellow-700 mb-3">üè´üÜöüè´ ƒ∞ki Okul Se√ßimi</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Okul 1</label>
                                                <select 
                                                    onChange={e => setSelectedSchool1(e.target.value)}
                                                    value={selectedSchool1}
                                                    className="input-fun w-full"
                                                >
                                                    <option value="">Okul Se√ßin...</option>
                                                    {Object.values(schools)
                                                        .filter(s => s.id !== selectedSchool2)
                                                        .map(s => (
                                                            <option key={s.id} value={s.id}>{s.name}</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Okul 2</label>
                                                <select 
                                                    onChange={e => setSelectedSchool2(e.target.value)}
                                                    value={selectedSchool2}
                                                    className="input-fun w-full"
                                                >
                                                    <option value="">Okul Se√ßin...</option>
                                                    {Object.values(schools)
                                                        .filter(s => s.id !== selectedSchool1)
                                                        .map(s => (
                                                            <option key={s.id} value={s.id}>{s.name}</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Oyun T√ºr√º Se√ßimi */}
                                <div className="mb-4 sm:mb-6">
                                    <h4 className="text-base sm:text-lg font-bold text-gray-700 mb-2 sm:mb-3 text-center">üéÆ Oyun T√ºr√º</h4>
                                    <div className="grid grid-cols-3 sm:grid-cols-3 gap-2 sm:gap-4">
                                        <button onClick={() => startTournament('mangala')} className="btn-candy btn-yellow py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üéØ</span>
                                            <span className="font-bold text-xs sm:text-base">MANGALA</span>
                                        </button>
                                        <button onClick={() => startTournament('reversi')} className="btn-candy btn-green py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">‚ö´</span>
                                            <span className="font-bold text-xs sm:text-base">REVERSƒ∞</span>
                                        </button>
                                        <button onClick={() => startTournament('pentago')} className="btn-candy btn-purple py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üîÆ</span>
                                            <span className="font-bold text-xs sm:text-base">PENTAGO</span>
                                        </button>
                                        <button onClick={() => startTournament('kulami')} className="btn-candy btn-red py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üß©</span>
                                            <span className="font-bold text-xs sm:text-base">KULAMƒ∞</span>
                                        </button>
                                        <button onClick={() => startTournament('kure')} className="btn-candy bg-gradient-to-r from-blue-500 to-green-500 active:from-blue-600 active:to-green-600 text-white py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üåê</span>
                                            <span className="font-bold text-xs sm:text-base">K√úRE</span>
                                        </button>
                                        <button onClick={() => startTournament('abluka')} className="btn-candy bg-gradient-to-r from-gray-700 to-gray-900 active:from-gray-800 active:to-black text-white py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üè∞</span>
                                            <span className="font-bold text-xs sm:text-base">ABLUKA</span>
                                        </button>
                                        <button onClick={() => startTournament('qbitz')} className="btn-candy bg-gradient-to-r from-purple-500 to-pink-500 active:from-purple-600 active:to-pink-600 text-white py-3 sm:py-6 flex flex-col items-center gap-1 sm:gap-2">
                                            <span className="text-xl sm:text-3xl">üé≤</span>
                                            <span className="font-bold text-xs sm:text-base">Q-BITZ</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="text-center">
                                    <button onClick={() => {
                                        setShowGameSelector(false);
                                        setMatchingMode('random');
                                        setSelectedPlayer1(null);
                                        setSelectedPlayer2(null);
                                        setSelectedSchool1('');
                                        setSelectedSchool2('');
                                    }} className="text-gray-400 font-bold hover:text-gray-600">
                                        ƒ∞ptal
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <div className="glass-card p-3 sm:p-4 mb-4 sm:mb-6 flex flex-wrap justify-between items-center gap-3 sm:gap-4">
                        <div className="flex items-center gap-2 sm:gap-3">
                            <div className="text-3xl sm:text-4xl bounce">üéÆ</div>
                            <div>
                                <h1 className="text-lg sm:text-xl font-bold text-white">Turnuva Y√∂netimi</h1>
                                <p className="text-white/50 text-xs sm:text-sm hidden sm:block">Akƒ±l Zeka Oyunlarƒ±</p>
                            </div>
                        </div>
                        
                        {/* Navigation Tabs */}
                        <div className="flex flex-wrap gap-1 sm:gap-2 order-3 sm:order-2 w-full sm:w-auto justify-center">
                            <button onClick={() => setView("dashboard")} className={`tab-btn ${view === 'dashboard' ? 'active' : ''}`}>
                                <i className="fas fa-gamepad sm:mr-2"></i><span className="hidden sm:inline">Turnuva</span>
                            </button>
                            <button onClick={() => setView("interschool")} className={`tab-btn ${view === 'interschool' ? 'active' : ''}`}>
                                <i className="fas fa-school-flag sm:mr-2"></i><span className="hidden sm:inline">Okullar Arasƒ±</span>
                                {Object.values(interSchoolRequests).filter(r => 
                                    r.status === 'pending' && (r.toSchool === adminSchool || isSuperAdmin)
                                ).length > 0 && (
                                    <span className="ml-1 bg-orange-500 text-white text-xs px-1.5 py-0.5 rounded-full">
                                        {Object.values(interSchoolRequests).filter(r => r.status === 'pending' && (r.toSchool === adminSchool || isSuperAdmin)).length}
                                    </span>
                                )}
                            </button>
                            <button onClick={() => setView("students")} className={`tab-btn ${view === 'students' ? 'active' : ''}`}>
                                <i className="fas fa-users sm:mr-2"></i><span className="hidden sm:inline">√ñƒürenciler</span>
                            </button>
                            <button onClick={() => setView("approvals")} className={`tab-btn ${view === 'approvals' ? 'active' : ''}`}>
                                <i className="fas fa-user-check sm:mr-2"></i><span className="hidden sm:inline">Onaylar</span>
                                {pendingCount > 0 && <span className="ml-1 sm:ml-2 bg-red-500 text-white text-xs px-1.5 sm:px-2 py-0.5 rounded-full">{pendingCount}</span>}
                            </button>
                            <button onClick={() => setView("schools")} className={`tab-btn ${view === 'schools' ? 'active' : ''}`}>
                                <i className="fas fa-school sm:mr-2"></i><span className="hidden sm:inline">Okullar</span>
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-2 order-2 sm:order-3">
                            {/* Giri≈ü yapƒ±lan okul bilgisi */}
                            {adminSchool && !isSuperAdmin && (
                                <div className="hidden sm:flex items-center gap-2 bg-green-500/20 text-green-300 px-3 py-1 rounded-full text-sm">
                                    <i className="fas fa-school"></i>
                                    <span>{schools[adminSchool]?.name}</span>
                                </div>
                            )}
                            {isSuperAdmin && (
                                <div className="hidden sm:flex items-center gap-2 bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full text-sm">
                                    <i className="fas fa-crown"></i>
                                    <span>S√ºper Admin</span>
                                </div>
                            )}
                            <button onClick={() => setIsLoggedIn(false)} className="btn-candy btn-red">
                                <i className="fas fa-sign-out-alt mr-2"></i>√áƒ±kƒ±≈ü
                            </button>
                        </div>
                    </div>

                    {/* ===== DASHBOARD VIEW ===== */}
                    {view === "dashboard" && (
                        <div className="space-y-6 slide-up">
                            {/* Stats Row */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4">
                                <div className="stat-card">
                                    <div className="text-2xl sm:text-4xl mb-1 sm:mb-2">üë•</div>
                                    <div className="text-xl sm:text-3xl font-bold text-white">{waitingCount}</div>
                                    <div className="text-white/50 text-xs sm:text-sm">Bekleyen</div>
                                </div>
                                <div className="stat-card">
                                    <div className="text-2xl sm:text-4xl mb-1 sm:mb-2">üéÆ</div>
                                    <div className="text-xl sm:text-3xl font-bold text-green-400">{playingCount}</div>
                                    <div className="text-white/50 text-xs sm:text-sm">Oynayan</div>
                                </div>
                                <div className="stat-card">
                                    <div className="text-2xl sm:text-4xl mb-1 sm:mb-2">üèÜ</div>
                                    <div className="text-xl sm:text-3xl font-bold text-amber-400">{activeGames}</div>
                                    <div className="text-white/50 text-xs sm:text-sm">Aktif Oyun</div>
                                </div>
                                <div className="stat-card">
                                    <div className="text-2xl sm:text-4xl mb-1 sm:mb-2">üìö</div>
                                    <div className="text-xl sm:text-3xl font-bold text-blue-400">{totalUsers}</div>
                                    <div className="text-white/50 text-xs sm:text-sm">Toplam √ñƒürenci</div>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div className="flex flex-wrap gap-2 sm:gap-4 justify-center">
                                <button 
                                    onClick={() => setShowGameSelector(true)} 
                                    className="btn-candy btn-green pulse text-sm sm:text-base"
                                    disabled={operationInProgress || !isConnected}
                                >
                                    <i className="fas fa-play mr-1 sm:mr-2"></i><span className="hidden sm:inline">E≈ûLE≈ûTƒ∞RME YAP</span><span className="sm:hidden">E≈ûLE≈ûTIR</span> ‚ö°
                                </button>
                                <button 
                                    onClick={resetSystem} 
                                    className="btn-candy btn-red text-sm sm:text-base"
                                    disabled={operationInProgress || !isConnected}
                                >
                                    <i className="fas fa-redo mr-1 sm:mr-2"></i><span className="hidden sm:inline">Sƒ∞STEMƒ∞ SIFIRLA</span><span className="sm:hidden">SIFIRLA</span>
                                </button>
                            </div>

                            {/* Main Grid */}
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6">
                                {/* Lobby Users */}
                                <div className="glass-card p-3 sm:p-5">
                                    <h3 className="text-white font-bold mb-3 sm:mb-4 flex items-center gap-2 text-sm sm:text-base">
                                        <span className="wave">üéØ</span> LOBƒ∞DEKƒ∞LER ({Object.keys(filteredLobbyUsers).length})
                                    </h3>
                                    <div className="space-y-2 max-h-[300px] sm:max-h-[500px] overflow-auto">
                                        {Object.values(filteredLobbyUsers).map((u, i) => (
                                            <div key={i} className={`user-card ${u.state === 'waiting' ? 'waiting' : 'playing'}`}>
                                                <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white font-bold shadow text-sm sm:text-base">
                                                    {u.name.charAt(0)}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-gray-800 truncate text-sm sm:text-base">{u.name}</div>
                                                    <div className="text-xs text-gray-500">{u.class}</div>
                                                </div>
                                                <span className={`badge text-xs ${u.state === 'waiting' ? 'badge-green' : 'badge-blue'}`}>
                                                    {u.state === 'waiting' ? '‚è≥' : 'üéÆ'}<span className="hidden sm:inline"> {u.state === 'waiting' ? 'Hazƒ±r' : 'Oyunda'}</span>
                                                </span>
                                            </div>
                                        ))}
                                        {Object.keys(filteredLobbyUsers).length === 0 && (
                                            <div className="text-center py-8 text-white/40">
                                                <div className="text-4xl mb-2">üò¥</div>
                                                <p>Hen√ºz kimse yok</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Active Games */}
                                <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4">
                                    {isLoading ? (
                                        // Loading skeletons
                                        [...Array(6)].map((_, i) => (
                                            <div key={i} className="game-card p-4">
                                                <Skeleton className="h-12 w-full mb-3" />
                                                <Skeleton className="h-20 w-full mb-3" />
                                                <Skeleton className="h-10 w-full" />
                                            </div>
                                        ))
                                    ) : (
                                        <>
                                            {paginatedGames.map(([id, g]) => (
                                        <div key={id} className={`game-card ${g.winner ? 'finished' : 'playing'}`}>
                                            <div className="p-3 sm:p-4">
                                                {/* Game Header */}
                                                <div className="flex justify-between items-center mb-2 sm:mb-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className={`game-icon ${g.type}`} style={{width: '40px', height: '40px', fontSize: '1.2rem'}}>
                                                            {g.type === 'mangala' ? 'üéØ' : g.type === 'reversi' ? '‚ö´' : 'üîÆ'}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-gray-800 uppercase text-xs sm:text-sm">{g.type}</div>
                                                            <div className="text-xs text-gray-400">Masa #{id}</div>
                                                        </div>
                                                    </div>
                                                    {!g.winner ? (
                                                        <span className="badge badge-green">
                                                            <div className="live-dot" style={{width:'8px',height:'8px'}}></div>
                                                            Canlƒ±
                                                        </span>
                                                    ) : g.endReason === 'quit' ? (
                                                        <span className="badge badge-red">üö® Terk Edildi</span>
                                                    ) : (
                                                        <span className="badge badge-orange">üèÜ Bitti</span>
                                                    )}
                                                </div>

                                                {/* Players */}
                                                <div className="flex items-center justify-between bg-gray-50 rounded-xl p-2 sm:p-3 mb-2 sm:mb-3">
                                                    <div className="text-center">
                                                        <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-bold mx-auto mb-1 text-sm sm:text-base">
                                                            {g.players.p1.name.charAt(0)}
                                                        </div>
                                                        <div className="text-xs font-bold text-gray-700 truncate w-16 sm:w-20">{g.players.p1.name.split(' ')[0]}</div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="text-xl sm:text-2xl font-black text-gray-300">VS</div>
                                                    </div>
                                                    <div className="text-center">
                                                        <div className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold mx-auto mb-1 text-sm sm:text-base">
                                                            {g.players.p2.name.charAt(0)}
                                                        </div>
                                                        <div className="text-xs font-bold text-gray-700 truncate w-16 sm:w-20">{g.players.p2.name.split(' ')[0]}</div>
                                                    </div>
                                                </div>

                                                {/* Score */}
                                                {g.type === 'mangala' && (
                                                    <div className="text-center text-xl sm:text-2xl font-black text-purple-600 bg-purple-50 rounded-xl py-1.5 sm:py-2 mb-2 sm:mb-3">
                                                        {g.board ? g.board[6] : 0} <span className="text-purple-300 mx-1 sm:mx-2">:</span> {g.board ? g.board[13] : 0}
                                                    </div>
                                                )}

                                                {/* Winner */}
                                                {g.winner && (
                                                    <div className={`text-white text-center py-1.5 sm:py-2 rounded-xl font-bold mb-2 sm:mb-3 text-sm sm:text-base ${g.endReason === 'quit' ? 'bg-gradient-to-r from-red-400 to-red-600' : 'bg-gradient-to-r from-yellow-400 to-amber-500'}`}>
                                                        {g.endReason === 'quit' ? (
                                                            <>
                                                                <span className="text-sm opacity-80 block">{g.quitter} terk etti</span>
                                                                üèÜ Kazanan: {g.winner}
                                                            </>
                                                        ) : (
                                                            <>üèÜ {g.winner}</>
                                                        )}
                                                    </div>
                                                )}

                                                {/* Actions */}
                                                <div className="flex gap-2">
                                                    <button onClick={() => setSpectatingGameId(id)} className="btn-candy btn-blue flex-1 py-2 text-sm">
                                                        <i className="fas fa-eye mr-1"></i> ƒ∞zle
                                                    </button>
                                                    <button onClick={() => deleteGame(id)} className="btn-candy btn-red flex-1 py-2 text-sm" disabled={operationInProgress}>
                                                        <i className="fas fa-trash mr-1"></i> Sil
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    {Object.keys(games).length === 0 && !isLoading && (
                                        <div className="col-span-full glass-card p-10 text-center">
                                            <div className="text-6xl mb-4">üéÆ</div>
                                            <h3 className="text-xl font-bold text-white mb-2">Hen√ºz Oyun Yok</h3>
                                            <p className="text-white/50">E≈üle≈ütirme yaparak oyunlarƒ± ba≈ülatƒ±n!</p>
                                        </div>
                                    )}
                                    
                                    {/* Load More Button */}
                                    {paginatedGames.length < Object.keys(games).length && (
                                        <div className="col-span-full text-center">
                                            <button 
                                                onClick={() => setGamesPage(p => p + 1)}
                                                className="btn-candy btn-purple"
                                            >
                                                <i className="fas fa-plus mr-2"></i>
                                                Daha Fazla G√∂ster ({Object.keys(games).length - paginatedGames.length} kaldƒ±)
                                            </button>
                                        </div>
                                    )}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== STUDENTS VIEW ===== */}
                    {view === "students" && (
                        <div className="glass-card-light p-4 sm:p-6 slide-up">
                            {/* Ba≈ülƒ±k ve Filtreler */}
                            <div className="flex flex-col sm:flex-row sm:flex-wrap justify-between items-start sm:items-center gap-3 sm:gap-4 mb-4 sm:mb-6">
                                <h2 className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="wave">üéì</span> Kayƒ±tlƒ± √ñƒürenciler
                                    {!isSuperAdmin && adminSchool && (
                                        <span className="text-purple-600 text-base sm:text-lg">({schools[adminSchool]?.name})</span>
                                    )}
                                    <span className="text-gray-400 text-base sm:text-lg">
                                        ({isSuperAdmin ? Object.keys(allUsers).length : Object.values(allUsers).filter(u => u.schoolId === adminSchool).length})
                                    </span>
                                </h2>
                                
                                <div className="flex flex-wrap gap-2 sm:gap-3 w-full sm:w-auto">
                                    {/* Arama */}
                                    <input 
                                        type="text"
                                        value={studentSearch}
                                        onChange={e => setStudentSearch(e.target.value)}
                                        placeholder="üîç Ara..."
                                        className="input-fun flex-1 sm:flex-none text-sm sm:text-base"
                                    />
                                    
                                    {/* Sƒ±nƒ±f Filtresi */}
                                    <select 
                                        value={selectedClassFilter}
                                        onChange={e => setSelectedClassFilter(e.target.value)} 
                                        className="input-fun text-sm sm:text-base"
                                    >
                                        <option value="">üìö T√ºm Sƒ±nƒ±flar</option>
                                        {uniqueClasses.map(c => (
                                            <option key={c} value={c}>{c}</option>
                                        ))}
                                    </select>
                                    
                                    {/* Okul Filtresi - Sadece S√ºper Admin */}
                                    {isSuperAdmin && (
                                        <select 
                                            value={selectedSchoolFilter}
                                            onChange={e => setSelectedSchoolFilter(e.target.value)} 
                                            className="input-fun text-sm sm:text-base"
                                        >
                                            <option value="">üè´ T√ºm Okullar</option>
                                            {Object.values(schools).map(s => (
                                                <option key={s.id} value={s.id}>{s.name}</option>
                                            ))}
                                        </select>
                                    )}
                                    
                                    {/* G√∂r√ºn√ºm Modu */}
                                    <div className="flex gap-1 sm:gap-2 bg-gray-100 rounded-lg p-1 w-full sm:w-auto justify-center">
                                        <button 
                                            onClick={() => setStudentViewMode('table')}
                                            className={`px-2 sm:px-3 py-1.5 sm:py-2 rounded font-bold transition-all text-sm sm:text-base ${studentViewMode === 'table' ? 'bg-white shadow-md text-purple-600' : 'text-gray-500'}`}
                                        >
                                            <i className="fas fa-table sm:mr-1"></i><span className="hidden sm:inline">Tablo</span>
                                        </button>
                                        <button 
                                            onClick={() => setStudentViewMode('bySchool')}
                                            className={`px-2 sm:px-3 py-1.5 sm:py-2 rounded font-bold transition-all text-sm sm:text-base ${studentViewMode === 'bySchool' ? 'bg-white shadow-md text-purple-600' : 'text-gray-500'}`}
                                        >
                                            <i className="fas fa-school sm:mr-1"></i><span className="hidden sm:inline">Okul Bazlƒ±</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Hƒ±zlƒ± Eylemler */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3 mb-4 sm:mb-6">
                                {/* Sƒ±nƒ±f Bazlƒ± Se√ßim */}
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-3">
                                    <label className="block text-sm font-bold text-blue-700 mb-2">üìã Sƒ±nƒ±f Se√ß</label>
                                    <div className="flex gap-2">
                                        <select 
                                            onChange={(e) => e.target.value && selectStudentsByClass(e.target.value)}
                                            className="input-fun flex-1 text-sm"
                                            defaultValue=""
                                        >
                                            <option value="">Sƒ±nƒ±f se√ßin...</option>
                                            {uniqueClasses.map(c => (
                                                <option key={c} value={c}>{c}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                {/* PDF √áƒ±ktƒ±larƒ± */}
                                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-3">
                                    <label className="block text-sm font-bold text-green-700 mb-2">üìÑ PDF √áƒ±ktƒ±larƒ±</label>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={generateClassListPDF}
                                            className="btn-candy btn-green flex-1 py-2 text-sm"
                                        >
                                            <i className="fas fa-file-pdf mr-1"></i>Sƒ±nƒ±f Listesi
                                        </button>
                                        <button 
                                            onClick={generateTournamentPDF}
                                            className="btn-candy btn-yellow flex-1 py-2 text-sm"
                                        >
                                            <i className="fas fa-trophy mr-1"></i>Turnuva
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Toplu ƒ∞≈ülemler */}
                                <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                    <label className="block text-sm font-bold text-purple-700 mb-2">‚öôÔ∏è Toplu ƒ∞≈ülemler</label>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => setSelectedStudents(new Set())}
                                            className="btn-candy btn-gray flex-1 py-2 text-sm"
                                            disabled={selectedStudents.size === 0}
                                        >
                                            <i className="fas fa-times mr-1"></i>Se√ßimi Temizle
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Toplu ƒ∞≈ülem √áubuƒüu */}
                            {selectedStudents.size > 0 && (
                                <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-4">
                                    <div className="flex flex-wrap justify-between items-center gap-3 mb-3">
                                        <span className="font-bold text-purple-700">
                                            ‚úì {selectedStudents.size} √∂ƒürenci se√ßildi
                                        </span>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        {/* Toplu Sƒ±nƒ±f G√ºncelleme */}
                                        <div className="flex gap-2">
                                            <input 
                                                type="text"
                                                value={bulkClassUpdate}
                                                onChange={(e) => setBulkClassUpdate(e.target.value)}
                                                placeholder="Yeni sƒ±nƒ±f (√∂r: 6A)"
                                                className="input-fun flex-1 text-sm"
                                            />
                                            <button 
                                                onClick={bulkUpdateClass}
                                                className="btn-candy btn-blue py-2 px-4 text-sm whitespace-nowrap"
                                                disabled={operationInProgress || !bulkClassUpdate.trim()}
                                            >
                                                <i className="fas fa-sync mr-1"></i>Sƒ±nƒ±f G√ºncelle
                                            </button>
                                        </div>
                                        
                                        {/* Toplu Silme */}
                                        <div className="md:col-span-2 flex gap-2 justify-end">
                                            <button 
                                                onClick={deleteSelectedStudents}
                                                className="btn-candy btn-red py-2 px-4 text-sm"
                                                disabled={operationInProgress}
                                            >
                                                <i className="fas fa-trash mr-2"></i>Se√ßilenleri Sil ({selectedStudents.size})
                                            </button>
                                            <button 
                                                onClick={() => setSelectedStudents(new Set())}
                                                className="btn-candy btn-gray py-2 px-4 text-sm"
                                            >
                                                <i className="fas fa-times mr-2"></i>ƒ∞ptal
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* TABLO G√ñR√úN√úM√ú */}
                            {studentViewMode === 'table' && (
                                <div className="overflow-x-auto">
                                    <table className="fun-table">
                                        <thead>
                                            <tr>
                                                <th className="w-12">
                                                    <input 
                                                        type="checkbox"
                                                        checked={paginatedUsers.data.length > 0 && paginatedUsers.data.every(([uid]) => selectedStudents.has(uid))}
                                                        onChange={(e) => {
                                                            if (e.target.checked) {
                                                                const newSet = new Set(selectedStudents);
                                                                paginatedUsers.data.forEach(([uid]) => newSet.add(uid));
                                                                setSelectedStudents(newSet);
                                                            } else {
                                                                const newSet = new Set(selectedStudents);
                                                                paginatedUsers.data.forEach(([uid]) => newSet.delete(uid));
                                                                setSelectedStudents(newSet);
                                                            }
                                                        }}
                                                        className="w-5 h-5 cursor-pointer"
                                                    />
                                                </th>
                                                <th>üë§ √ñƒürenci</th>
                                                <th>üî¢ No</th>
                                                <th>üìö Sƒ±nƒ±f</th>
                                                <th>üè´ Okul</th>
                                                <th>üèÜ Ba≈üarƒ±</th>
                                                <th>üéñÔ∏è Rozetler</th>
                                                <th>‚öôÔ∏è ƒ∞≈ülem</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {isLoading ? (
                                                [...Array(5)].map((_, i) => (
                                                    <tr key={i}>
                                                        <td><Skeleton className="h-5 w-5" /></td>
                                                        <td><Skeleton className="h-10 w-40" /></td>
                                                        <td><Skeleton className="h-6 w-12" /></td>
                                                        <td><Skeleton className="h-6 w-16" /></td>
                                                        <td><Skeleton className="h-6 w-32" /></td>
                                                        <td><Skeleton className="h-6 w-16" /></td>
                                                        <td><Skeleton className="h-6 w-20" /></td>
                                                        <td><Skeleton className="h-8 w-20" /></td>
                                                    </tr>
                                                ))
                                            ) : paginatedUsers.data.length === 0 ? (
                                                <tr>
                                                    <td colSpan="8" className="text-center py-12">
                                                        <div className="text-6xl mb-4">üîç</div>
                                                        <h3 className="text-xl font-bold text-gray-400">√ñƒürenci bulunamadƒ±</h3>
                                                    </td>
                                                </tr>
                                            ) : (
                                                paginatedUsers.data.map(([uid, u]) => (
                                                    <tr key={uid}>
                                                        <td>
                                                            <input 
                                                                type="checkbox"
                                                                checked={selectedStudents.has(uid)}
                                                                onChange={(e) => {
                                                                    const newSet = new Set(selectedStudents);
                                                                    if (e.target.checked) {
                                                                        newSet.add(uid);
                                                                    } else {
                                                                        newSet.delete(uid);
                                                                    }
                                                                    setSelectedStudents(newSet);
                                                                }}
                                                                className="w-5 h-5 cursor-pointer"
                                                            />
                                                        </td>
                                                        <td>
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white font-bold">
                                                                    {u.name.charAt(0)}
                                                                </div>
                                                                <span className="font-bold text-gray-800">{u.name}</span>
                                                            </div>
                                                        </td>
                                                        <td><span className="badge badge-purple">{u.number}</span></td>
                                                        <td><span className="badge badge-blue">{u.class}</span></td>
                                                        <td className="text-gray-600">{u.schoolName}</td>
                                                        <td>
                                                            <div className="flex gap-2">
                                                                <span className="badge badge-green">üèÜ {u.stats?.wins || 0}</span>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div className="flex items-center gap-1">
                                                                {(u.badges || []).slice(0, 3).map((badgeKey, idx) => (
                                                                    BADGES[badgeKey] && (
                                                                        <span key={idx} className="text-lg" title={BADGES[badgeKey].name}>
                                                                            {BADGES[badgeKey].icon}
                                                                        </span>
                                                                    )
                                                                ))}
                                                                {(u.badges || []).length > 3 && (
                                                                    <span className="badge badge-purple text-xs">+{(u.badges || []).length - 3}</span>
                                                                )}
                                                                {(u.badges || []).length === 0 && (
                                                                    <span className="text-gray-300 text-sm">-</span>
                                                                )}
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div className="flex gap-2">
                                                                <button 
                                                                    onClick={() => setEditModalUser({ uid, ...u })} 
                                                                    className="btn-candy btn-blue py-2 px-4 text-sm" 
                                                                    title="D√ºzenle"
                                                                >
                                                                    <i className="fas fa-edit"></i>
                                                                </button>
                                                                <button 
                                                                    onClick={() => setBadgeModalUser({ uid, ...u })} 
                                                                    className="btn-candy btn-yellow py-2 px-4 text-sm" 
                                                                    title="Rozet Ver"
                                                                >
                                                                    üèÜ
                                                                </button>
                                                                <button 
                                                                    onClick={() => deleteStudent(uid, u.name)} 
                                                                    className="btn-candy btn-red py-2 px-4 text-sm" 
                                                                    disabled={operationInProgress}
                                                                >
                                                                    <i className="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                    
                                    {/* Load More for Users */}
                                    {paginatedUsers.hasMore && (
                                        <div className="text-center mt-6">
                                            <button 
                                                onClick={() => setUsersPage(p => p + 1)}
                                                className="btn-candy btn-purple"
                                            >
                                                <i className="fas fa-plus mr-2"></i>
                                                Daha Fazla G√∂ster ({paginatedUsers.total - paginatedUsers.data.length} kaldƒ±)
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* OKUL BAZLI G√ñR√úN√úM */}
                            {studentViewMode === 'bySchool' && (
                                <div className="space-y-4">
                                    {Object.entries(studentsBySchool).length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">üîç</div>
                                            <h3 className="text-xl font-bold text-gray-400">√ñƒürenci bulunamadƒ±</h3>
                                        </div>
                                    ) : (
                                        Object.entries(studentsBySchool).map(([schoolId, schoolData]) => {
                                            const isExpanded = expandedSchools.has(schoolId);
                                            return (
                                                <div key={schoolId} className="bg-white border-2 border-gray-200 rounded-xl overflow-hidden">
                                                    {/* School Header */}
                                                    <div 
                                                        onClick={() => {
                                                            const newSet = new Set(expandedSchools);
                                                            if (isExpanded) {
                                                                newSet.delete(schoolId);
                                                            } else {
                                                                newSet.add(schoolId);
                                                            }
                                                            setExpandedSchools(newSet);
                                                        }}
                                                        className="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 cursor-pointer hover:from-purple-600 hover:to-pink-600 transition-all flex justify-between items-center"
                                                    >
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-2xl">üè´</span>
                                                            <div>
                                                                <h3 className="font-bold text-lg">{schoolData.name}</h3>
                                                                <p className="text-white/70 text-sm">{schoolData.students.length} √∂ƒürenci</p>
                                                            </div>
                                                        </div>
                                                        <i className={`fas fa-chevron-${isExpanded ? 'up' : 'down'} text-2xl`}></i>
                                                    </div>
                                                    
                                                    {/* Students Grid */}
                                                    {isExpanded && (
                                                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                            {schoolData.students.map(([uid, u]) => (
                                                                <div key={uid} className="bg-gradient-to-br from-gray-50 to-white border-2 border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all">
                                                                    {/* Checkbox */}
                                                                    <div className="flex justify-between items-start mb-3">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={selectedStudents.has(uid)}
                                                                            onChange={(e) => {
                                                                                const newSet = new Set(selectedStudents);
                                                                                if (e.target.checked) {
                                                                                    newSet.add(uid);
                                                                                } else {
                                                                                    newSet.delete(uid);
                                                                                }
                                                                                setSelectedStudents(newSet);
                                                                            }}
                                                                            className="w-5 h-5 cursor-pointer"
                                                                        />
                                                                        <div className="flex gap-1">
                                                                            {(u.badges || []).slice(0, 2).map((badgeKey, idx) => (
                                                                                BADGES[badgeKey] && (
                                                                                    <span key={idx} className="text-xl" title={BADGES[badgeKey].name}>
                                                                                        {BADGES[badgeKey].icon}
                                                                                    </span>
                                                                                )
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Student Info */}
                                                                    <div className="flex items-center gap-3 mb-3">
                                                                        <div className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white text-xl font-bold">
                                                                            {u.name.charAt(0)}
                                                                        </div>
                                                                        <div className="flex-1">
                                                                            <h4 className="font-bold text-gray-800">{u.name}</h4>
                                                                            <div className="flex gap-2 mt-1">
                                                                                <span className="badge badge-purple text-xs">#{u.number}</span>
                                                                                <span className="badge badge-blue text-xs">{u.class}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Stats */}
                                                                    <div className="bg-gray-100 rounded-lg p-2 mb-3">
                                                                        <span className="text-sm text-gray-600">Galibiyetler: </span>
                                                                        <span className="font-bold text-green-600">{u.stats?.wins || 0} üèÜ</span>
                                                                    </div>
                                                                    
                                                                    {/* Actions */}
                                                                    <div className="flex gap-2">
                                                                        <button 
                                                                            onClick={() => setEditModalUser({ uid, ...u })} 
                                                                            className="btn-candy btn-blue py-2 px-3 text-sm flex-1" 
                                                                            title="D√ºzenle"
                                                                        >
                                                                            <i className="fas fa-edit"></i>
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => setBadgeModalUser({ uid, ...u })} 
                                                                            className="btn-candy btn-yellow py-2 px-3 text-sm flex-1" 
                                                                            title="Rozet"
                                                                        >
                                                                            üèÜ
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => deleteStudent(uid, u.name)} 
                                                                            className="btn-candy btn-red py-2 px-3 text-sm" 
                                                                            disabled={operationInProgress}
                                                                        >
                                                                            <i className="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* ===== APPROVALS VIEW ===== */}
                    {view === "approvals" && (
                        <div className="glass-card-light p-4 sm:p-6 slide-up">
                            <h2 className="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center gap-2">
                                <span className="wave">‚úÖ</span> Onay Bekleyenler
                                {!isSuperAdmin && adminSchool && (
                                    <span className="text-sm font-normal text-gray-500">({schools[adminSchool]?.name})</span>
                                )}
                            </h2>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                {Object.entries(pendingUsers)
                                    .filter(([_, u]) => isSuperAdmin || u.schoolId === adminSchool)
                                    .map(([uid, u]) => (
                                    <div key={uid} className="bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 rounded-2xl p-3 sm:p-5 pop-in">
                                        <div className="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
                                            <div className="w-10 h-10 sm:w-14 sm:h-14 rounded-full bg-gradient-to-br from-orange-400 to-amber-500 flex items-center justify-center text-white text-lg sm:text-2xl font-bold shadow-lg">
                                                {u.name.charAt(0)}
                                            </div>
                                            <div>
                                                <div className="font-bold text-base sm:text-xl text-gray-800">{u.name}</div>
                                                <div className="text-orange-600 font-bold text-xs sm:text-sm">{u.schoolName}</div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-2 mb-3 sm:mb-4">
                                            <span className="badge badge-blue text-xs">{u.class}</span>
                                            <span className="badge badge-purple text-xs">#{u.number}</span>
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <button onClick={() => approveUser(uid, u)} className="btn-candy btn-green flex-1 py-2 text-sm">
                                                <i className="fas fa-check mr-1"></i> Onayla
                                            </button>
                                            <button onClick={() => rejectUser(uid)} className="btn-candy btn-red flex-1 py-2 text-sm">
                                                <i className="fas fa-times mr-1"></i> Reddet
                                            </button>
                                        </div>
                                    </div>
                                ))}

                                {pendingCount === 0 && (
                                    <div className="col-span-full text-center py-8 sm:py-12">
                                        <div className="text-5xl sm:text-6xl mb-4">üéâ</div>
                                        <h3 className="text-lg sm:text-xl font-bold text-gray-400">Onay bekleyen yok!</h3>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* ===== INTER-SCHOOL TOURNAMENT VIEW ===== */}
                    {view === "interschool" && (
                        <div className="glass-card-light p-4 sm:p-6 slide-up">
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                                <h2 className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="wave">üè´</span> Okullar Arasƒ± Turnuva
                                </h2>
                                
                                {adminSchool && !isSuperAdmin && (
                                    <button 
                                        onClick={() => setShowInterSchoolModal(true)}
                                        className="btn-candy bg-gradient-to-r from-orange-500 to-red-500"
                                    >
                                        <i className="fas fa-paper-plane mr-2"></i> Turnuva ƒ∞steƒüi G√∂nder
                                    </button>
                                )}
                            </div>
                            
                            {/* Gelen ƒ∞stekler */}
                            <div className="mb-8">
                                <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <i className="fas fa-inbox text-blue-500"></i> Gelen ƒ∞stekler
                                </h3>
                                <div className="space-y-4">
                                    {Object.values(interSchoolRequests)
                                        .filter(r => (r.toSchool === adminSchool || isSuperAdmin) && r.status === 'pending')
                                        .map(request => (
                                            <div key={request.id} className="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-4">
                                                <div className="flex flex-col sm:flex-row justify-between items-start gap-3">
                                                    <div>
                                                        <div className="font-bold text-gray-800 text-lg mb-1">
                                                            üì® {request.fromSchoolName} ‚Üí {request.toSchoolName}
                                                        </div>
                                                        <div className="text-sm text-gray-600 space-y-1">
                                                            <div><i className="fas fa-calendar mr-2"></i>Tarih: {request.date}</div>
                                                            <div><i className="fas fa-gamepad mr-2"></i>Oyunlar: {request.games.join(', ')}</div>
                                                            <div><i className="fas fa-users mr-2"></i>√ñƒürenci Sayƒ±sƒ±: {request.studentCount}</div>
                                                            {request.description && (
                                                                <div><i className="fas fa-comment mr-2"></i>{request.description}</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => acceptInterSchoolRequest(request.id)}
                                                            className="btn-candy btn-green py-2 px-4"
                                                        >
                                                            <i className="fas fa-check mr-1"></i> Kabul
                                                        </button>
                                                        <button 
                                                            onClick={() => {
                                                                const reason = prompt('Red sebebi (opsiyonel):');
                                                                rejectInterSchoolRequest(request.id, reason || '');
                                                            }}
                                                            className="btn-candy btn-red py-2 px-4"
                                                        >
                                                            <i className="fas fa-times mr-1"></i> Red
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    {Object.values(interSchoolRequests).filter(r => (r.toSchool === adminSchool || isSuperAdmin) && r.status === 'pending').length === 0 && (
                                        <div className="text-center py-8 text-gray-400">
                                            <i className="fas fa-inbox text-4xl mb-2"></i>
                                            <p>Gelen istek yok</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* G√∂nderilen ƒ∞stekler */}
                            <div className="mb-8">
                                <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <i className="fas fa-paper-plane text-orange-500"></i> G√∂nderilen ƒ∞stekler
                                </h3>
                                <div className="space-y-4">
                                    {Object.values(interSchoolRequests)
                                        .filter(r => (r.fromSchool === adminSchool || isSuperAdmin))
                                        .map(request => (
                                            <div key={request.id} className={`border-2 rounded-2xl p-4 ${
                                                request.status === 'accepted' ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-300' :
                                                request.status === 'rejected' ? 'bg-gradient-to-r from-red-50 to-rose-50 border-red-300' :
                                                'bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200'
                                            }`}>
                                                <div className="flex flex-col sm:flex-row justify-between items-start gap-3">
                                                    <div>
                                                        <div className="font-bold text-gray-800 text-lg mb-1 flex items-center gap-2">
                                                            üì§ {request.fromSchoolName} ‚Üí {request.toSchoolName}
                                                            <span className={`text-xs px-2 py-1 rounded-full ${
                                                                request.status === 'accepted' ? 'bg-green-200 text-green-800' :
                                                                request.status === 'rejected' ? 'bg-red-200 text-red-800' :
                                                                request.status === 'active' ? 'bg-blue-200 text-blue-800' :
                                                                'bg-orange-200 text-orange-800'
                                                            }`}>
                                                                {request.status === 'accepted' ? '‚úì Kabul Edildi' :
                                                                 request.status === 'rejected' ? '‚úó Reddedildi' :
                                                                 request.status === 'active' ? 'üéÆ Devam Ediyor' : '‚è≥ Bekliyor'}
                                                            </span>
                                                        </div>
                                                        <div className="text-sm text-gray-600 space-y-1">
                                                            <div><i className="fas fa-calendar mr-2"></i>Tarih: {request.date}</div>
                                                            <div><i className="fas fa-gamepad mr-2"></i>Oyunlar: {request.games.join(', ')}</div>
                                                            <div><i className="fas fa-users mr-2"></i>√ñƒürenci: {request.studentCount} (her okul)</div>
                                                            {request.rejectionReason && (
                                                                <div className="text-red-600"><i className="fas fa-comment-slash mr-2"></i>Red sebebi: {request.rejectionReason}</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Kabul edildiyse √∂ƒürenci se√ßimi */}
                                                    {request.status === 'accepted' && (
                                                        <div className="flex flex-col gap-2">
                                                            <div className="text-sm">
                                                                <span className="text-gray-600">Se√ßilen: </span>
                                                                <span className="font-bold text-blue-600">
                                                                    {request.fromSchool === adminSchool 
                                                                        ? `${request.fromSchoolStudents?.length || 0}/${request.studentCount}`
                                                                        : `${request.toSchoolStudents?.length || 0}/${request.studentCount}`
                                                                    }
                                                                </span>
                                                            </div>
                                                            <button 
                                                                onClick={() => setShowStudentSelectModal(request.id)}
                                                                className="btn-candy bg-gradient-to-r from-blue-500 to-cyan-500 py-2 px-3 text-sm"
                                                            >
                                                                <i className="fas fa-user-plus mr-1"></i> √ñƒürenci Se√ß
                                                            </button>
                                                            {(request.fromSchoolStudents?.length > 0 && request.toSchoolStudents?.length > 0 && 
                                                              request.fromSchoolStudents.length === request.toSchoolStudents.length) && (
                                                                <>
                                                                    <button 
                                                                        onClick={() => startInterSchoolTournament(request.id)}
                                                                        className="btn-candy btn-green py-2 px-3 text-sm"
                                                                    >
                                                                        <i className="fas fa-play mr-1"></i> Ba≈ülat
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => generateInterSchoolReport(request.id)}
                                                                        className="btn-candy bg-gradient-to-r from-red-500 to-orange-500 py-2 px-3 text-sm"
                                                                    >
                                                                        <i className="fas fa-file-pdf mr-1"></i> Rapor
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    {Object.values(interSchoolRequests).filter(r => r.fromSchool === adminSchool || isSuperAdmin).length === 0 && (
                                        <div className="text-center py-8 text-gray-400">
                                            <i className="fas fa-paper-plane text-4xl mb-2"></i>
                                            <p>G√∂nderilen istek yok</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Aktif Turnuvalar */}
                            <div>
                                <h3 className="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <i className="fas fa-trophy text-yellow-500"></i> Aktif Okullar Arasƒ± Turnuvalar
                                </h3>
                                <div className="space-y-4">
                                    {Object.values(interSchoolRequests)
                                        .filter(r => r.status === 'active' && (r.fromSchool === adminSchool || r.toSchool === adminSchool || isSuperAdmin))
                                        .map(request => (
                                            <div key={request.id} className="bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 rounded-2xl p-4">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="font-bold text-gray-800 text-lg">
                                                        üèÜ {request.fromSchoolName} vs {request.toSchoolName}
                                                    </div>
                                                    <button 
                                                        onClick={() => generateInterSchoolReport(request.id)}
                                                        className="btn-candy bg-gradient-to-r from-red-500 to-orange-500 py-1 px-3 text-sm"
                                                    >
                                                        <i className="fas fa-file-pdf mr-1"></i> PDF Rapor
                                                    </button>
                                                </div>
                                                <div className="text-sm text-gray-600 mb-3">
                                                    <span className="mr-4"><i className="fas fa-calendar mr-1"></i>{request.date}</span>
                                                    <span><i className="fas fa-gamepad mr-1"></i>{request.games.join(', ')}</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="bg-white/50 rounded-xl p-3">
                                                        <div className="font-bold text-sm mb-2">{request.fromSchoolName}</div>
                                                        <div className="text-xs text-gray-600">
                                                            {request.fromSchoolStudents?.map(uid => allUsers[uid]?.name || uid).join(', ')}
                                                        </div>
                                                    </div>
                                                    <div className="bg-white/50 rounded-xl p-3">
                                                        <div className="font-bold text-sm mb-2">{request.toSchoolName}</div>
                                                        <div className="text-xs text-gray-600">
                                                            {request.toSchoolStudents?.map(uid => allUsers[uid]?.name || uid).join(', ')}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    {Object.values(interSchoolRequests).filter(r => r.status === 'active').length === 0 && (
                                        <div className="text-center py-8 text-gray-400">
                                            <i className="fas fa-trophy text-4xl mb-2"></i>
                                            <p>Aktif okullar arasƒ± turnuva yok</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Okullar Arasƒ± Turnuva ƒ∞stek Modalƒ± */}
                    {showInterSchoolModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass-card-light p-6 max-w-lg w-full pop-in max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <i className="fas fa-paper-plane text-orange-500"></i> Turnuva ƒ∞steƒüi G√∂nder
                                    </h3>
                                    <button onClick={() => setShowInterSchoolModal(false)} className="text-gray-400 hover:text-gray-600">
                                        <i className="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* Hedef Okul */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Rakip Okul</label>
                                        <select 
                                            value={interSchoolForm.targetSchool}
                                            onChange={e => setInterSchoolForm({...interSchoolForm, targetSchool: e.target.value})}
                                            className="input-fun w-full"
                                        >
                                            <option value="">Okul Se√ßin</option>
                                            {Object.values(schools)
                                                .filter(s => s.id !== adminSchool)
                                                .map(s => (
                                                    <option key={s.id} value={s.id}>{s.name}</option>
                                                ))}
                                        </select>
                                    </div>
                                    
                                    {/* Tarih */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üìÖ Turnuva Tarihi</label>
                                        <input 
                                            type="date"
                                            value={interSchoolForm.date}
                                            onChange={e => setInterSchoolForm({...interSchoolForm, date: e.target.value})}
                                            className="input-fun w-full"
                                            min={new Date().toISOString().split('T')[0]}
                                        />
                                    </div>
                                    
                                    {/* Oyunlar */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üéÆ Oyunlar</label>
                                        <div className="flex flex-wrap gap-2">
                                            {['Mangala', 'Reversi', 'Pentago', 'Kulami', 'K√ºre', 'Q-bitz', 'Abluka'].map(game => (
                                                <button
                                                    key={game}
                                                    onClick={() => {
                                                        const games = interSchoolForm.games.includes(game)
                                                            ? interSchoolForm.games.filter(g => g !== game)
                                                            : [...interSchoolForm.games, game];
                                                        setInterSchoolForm({...interSchoolForm, games});
                                                    }}
                                                    className={`px-3 py-2 rounded-xl text-sm font-bold transition-all ${
                                                        interSchoolForm.games.includes(game)
                                                            ? 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white'
                                                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                    }`}
                                                >
                                                    {game}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* √ñƒürenci Sayƒ±sƒ± */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üë• √ñƒürenci Sayƒ±sƒ± (her okul i√ßin)</label>
                                        <input 
                                            type="number"
                                            value={interSchoolForm.studentCount}
                                            onChange={e => setInterSchoolForm({...interSchoolForm, studentCount: Math.min(50, Math.max(1, parseInt(e.target.value) || 1))})}
                                            className="input-fun w-full"
                                            min="1"
                                            max="50"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Minimum 1, maksimum 50 √∂ƒürenci</p>
                                    </div>
                                    
                                    {/* A√ßƒ±klama */}
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">üí¨ A√ßƒ±klama (opsiyonel)</label>
                                        <textarea 
                                            value={interSchoolForm.description}
                                            onChange={e => setInterSchoolForm({...interSchoolForm, description: e.target.value})}
                                            className="input-fun w-full"
                                            rows="3"
                                            placeholder="Turnuva hakkƒ±nda not..."
                                        />
                                    </div>
                                    
                                    <button 
                                        onClick={sendInterSchoolRequest}
                                        className="btn-candy bg-gradient-to-r from-orange-500 to-red-500 w-full py-3"
                                    >
                                        <i className="fas fa-paper-plane mr-2"></i> ƒ∞stek G√∂nder
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* √ñƒürenci Se√ßim Modalƒ± */}
                    {showStudentSelectModal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="glass-card-light p-6 max-w-2xl w-full pop-in max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <i className="fas fa-user-plus text-blue-500"></i> Turnuvaya √ñƒürenci Se√ß
                                    </h3>
                                    <button onClick={() => {
                                        setShowStudentSelectModal(null);
                                        setSelectedInterSchoolStudents(new Set());
                                    }} className="text-gray-400 hover:text-gray-600">
                                        <i className="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                
                                {(() => {
                                    const request = interSchoolRequests[showStudentSelectModal];
                                    if (!request) return null;
                                    
                                    const myStudents = Object.entries(allUsers)
                                        .filter(([_, u]) => u.schoolId === adminSchool);
                                    
                                    return (
                                        <div>
                                            <div className="mb-4 text-sm text-gray-600">
                                                <strong>Maks se√ßim:</strong> {request.studentCount} √∂ƒürenci | 
                                                <strong> Se√ßili:</strong> {selectedInterSchoolStudents.size}
                                            </div>
                                            
                                            <div className="space-y-2 max-h-96 overflow-y-auto mb-4">
                                                {myStudents.map(([uid, user]) => (
                                                    <div 
                                                        key={uid}
                                                        onClick={() => {
                                                            const newSet = new Set(selectedInterSchoolStudents);
                                                            if (newSet.has(uid)) {
                                                                newSet.delete(uid);
                                                            } else if (newSet.size < request.studentCount) {
                                                                newSet.add(uid);
                                                            }
                                                            setSelectedInterSchoolStudents(newSet);
                                                        }}
                                                        className={`p-3 rounded-xl cursor-pointer transition-all flex justify-between items-center ${
                                                            selectedInterSchoolStudents.has(uid)
                                                                ? 'bg-gradient-to-r from-blue-100 to-cyan-100 border-2 border-blue-400'
                                                                : 'bg-gray-50 border-2 border-transparent hover:border-gray-200'
                                                        }`}
                                                    >
                                                        <div>
                                                            <div className="font-bold text-gray-800">{user.name}</div>
                                                            <div className="text-sm text-gray-500">{user.class} - No: {user.number}</div>
                                                        </div>
                                                        {selectedInterSchoolStudents.has(uid) && (
                                                            <i className="fas fa-check-circle text-blue-500 text-xl"></i>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            <button 
                                                onClick={() => addStudentsToInterSchool(showStudentSelectModal, Array.from(selectedInterSchoolStudents))}
                                                disabled={selectedInterSchoolStudents.size === 0}
                                                className="btn-candy bg-gradient-to-r from-green-500 to-emerald-500 w-full py-3 disabled:opacity-50"
                                            >
                                                <i className="fas fa-check mr-2"></i> {selectedInterSchoolStudents.size} √ñƒürenciyi Onayla
                                            </button>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}

                    {/* ===== SCHOOLS VIEW ===== */}
                    {view === "schools" && (
                        <div className="glass-card-light p-4 sm:p-6 slide-up">
                            <h2 className="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center gap-2">
                                <span className="wave">üè´</span> Okul Y√∂netimi
                                {adminSchool && !isSuperAdmin && (
                                    <span className="text-sm font-normal text-gray-500 ml-2">
                                        ({schools[adminSchool]?.name} - Sadece g√∂r√ºnt√ºleme)
                                    </span>
                                )}
                            </h2>

                            {/* Add School Form - Sadece S√ºper Admin */}
                            {isSuperAdmin && (
                                <div className="bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-200 rounded-2xl p-4 mb-6">
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <i className="fas fa-plus-circle text-teal-500"></i> Yeni Okul Ekle
                                    </h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-2 sm:gap-3">
                                        <input
                                            value={newSchoolName}
                                            onChange={e => setNewSchoolName(e.target.value)}
                                            placeholder="Okul Adƒ±"
                                            className="input-fun"
                                        />
                                        <input
                                            value={newSchoolCode}
                                            onChange={e => setNewSchoolCode(e.target.value.toUpperCase())}
                                            placeholder="Giri≈ü Kodu (min 3)"
                                            className="input-fun uppercase"
                                            maxLength="10"
                                        />
                                        <input
                                            type="password"
                                            value={newSchoolPassword}
                                            onChange={e => setNewSchoolPassword(e.target.value)}
                                            placeholder="≈ûifre (min 4)"
                                            className="input-fun"
                                        />
                                        <button onClick={addSchool} className="btn-candy btn-teal">
                                            <i className="fas fa-plus mr-2"></i> Ekle
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Schools List */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                {Object.values(schools)
                                    .filter(school => isSuperAdmin || school.id === adminSchool)
                                    .map(school => (
                                    <div key={school.id} className={`bg-gradient-to-br ${adminSchool === school.id ? 'from-green-50 to-emerald-50 border-green-400' : 'from-teal-50 to-cyan-50 border-teal-200'} border-2 rounded-2xl p-3 sm:p-5`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <div className="flex items-center gap-2 sm:gap-3">
                                                <div className="text-2xl sm:text-3xl">üè´</div>
                                                <div>
                                                    <span className="font-bold text-gray-800 text-sm sm:text-lg block">{school.name}</span>
                                                    {/* Kod sadece s√ºper admin veya kendi okulu i√ßin g√∂ster */}
                                                    {isSuperAdmin && (
                                                        <span className="text-xs text-blue-600 font-mono bg-blue-100 px-2 py-0.5 rounded">
                                                            Kod: {school.code || 'YOK'}
                                                        </span>
                                                    )}
                                                    {adminSchool === school.id && !isSuperAdmin && (
                                                        <span className="text-xs text-green-600 font-bold">‚úì Okulunuz</span>
                                                    )}
                                                </div>
                                            </div>
                                            {isSuperAdmin && (
                                                <button onClick={() => deleteSchool(school.id)} className="btn-candy btn-red py-2 px-3 text-sm">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            )}
                                        </div>
                                        
                                        {/* √ñƒürenci Sayƒ±sƒ± */}
                                        <div className="text-sm text-gray-600 mb-2">
                                            <i className="fas fa-users mr-1"></i>
                                            {Object.values(allUsers).filter(u => u.schoolId === school.id).length} √∂ƒürenci
                                        </div>
                                        
                                        {/* Okulun Rozetleri */}
                                        <div className="mb-3">
                                            <button 
                                                onClick={() => {
                                                    setSelectedSchoolForBadges(school);
                                                    setShowSchoolBadgeModal(true);
                                                }}
                                                className="w-full text-left"
                                            >
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    {(school.badges || []).length > 0 ? (
                                                        (school.badges || []).map(badgeKey => (
                                                            SCHOOL_BADGES[badgeKey] && (
                                                                <span 
                                                                    key={badgeKey} 
                                                                    className="text-lg sm:text-xl cursor-pointer hover:scale-125 transition-transform"
                                                                    title={SCHOOL_BADGES[badgeKey].name}
                                                                >
                                                                    {SCHOOL_BADGES[badgeKey].icon}
                                                                </span>
                                                            )
                                                        ))
                                                    ) : (
                                                        <span className="text-xs text-gray-400 italic">
                                                            üèÖ Rozet yok - tƒ±klayƒ±n
                                                        </span>
                                                    )}
                                                </div>
                                            </button>
                                        </div>
                                        
                                        {/* ≈ûifre ve Kod G√ºncelleme - S√ºper Admin veya Kendi Okulu */}
                                        {(isSuperAdmin || adminSchool === school.id) && (
                                            <div className="mt-3 pt-3 border-t border-gray-200 space-y-2">
                                                {/* Kod G√ºncelleme - Sadece S√ºper Admin */}
                                                {isSuperAdmin && (
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            placeholder="Yeni kod"
                                                            className="input-fun text-sm flex-1 py-1 uppercase"
                                                            id={`school-code-${school.id}`}
                                                            maxLength="10"
                                                        />
                                                        <button 
                                                            onClick={() => {
                                                                const input = document.getElementById(`school-code-${school.id}`);
                                                                if (input?.value) {
                                                                    updateSchoolCode(school.id, input.value);
                                                                    input.value = '';
                                                                }
                                                            }}
                                                            className="btn-candy bg-gradient-to-r from-purple-500 to-purple-600 text-white py-1 px-3 text-sm"
                                                        >
                                                            <i className="fas fa-tag"></i>
                                                        </button>
                                                    </div>
                                                )}
                                                {/* ≈ûifre G√ºncelleme */}
                                                <div className="flex gap-2">
                                                    <input
                                                        type="password"
                                                        placeholder="Yeni ≈üifre"
                                                        className="input-fun text-sm flex-1 py-1"
                                                        id={`school-pass-${school.id}`}
                                                    />
                                                    <button 
                                                        onClick={() => {
                                                            const input = document.getElementById(`school-pass-${school.id}`);
                                                            if (input?.value) {
                                                                updateSchoolPassword(school.id, input.value);
                                                                input.value = '';
                                                            }
                                                        }}
                                                        className="btn-candy bg-gradient-to-r from-blue-500 to-blue-600 text-white py-1 px-3 text-sm"
                                                    >
                                                        <i className="fas fa-key"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}

                                {Object.keys(schools).length === 0 && (
                                    <div className="col-span-full text-center py-8 sm:py-12">
                                        <div className="text-5xl sm:text-6xl mb-4">üè´</div>
                                        <h3 className="text-lg sm:text-xl font-bold text-gray-400">Hen√ºz okul eklenmedi</h3>
                                    </div>
                                )}
                            </div>

                            {/* üè´ Okul Rozet Modalƒ± */}
                            {showSchoolBadgeModal && selectedSchoolForBadges && (
                                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowSchoolBadgeModal(false)}>
                                    <div className="bg-white rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                                <span>üè´</span>
                                                {selectedSchoolForBadges.name}
                                            </h3>
                                            <button 
                                                onClick={() => setShowSchoolBadgeModal(false)}
                                                className="text-gray-400 hover:text-gray-600 text-2xl"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>

                                        {/* Okul Bilgileri */}
                                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 mb-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <span className="text-gray-500 text-sm">√ñƒürenci Sayƒ±sƒ±</span>
                                                    <div className="font-bold text-xl text-blue-600">
                                                        {Object.values(allUsers).filter(u => u.schoolId === selectedSchoolForBadges.id).length}
                                                    </div>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500 text-sm">Rozet Sayƒ±sƒ±</span>
                                                    <div className="font-bold text-xl text-purple-600">
                                                        {(selectedSchoolForBadges.badges || []).length}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Mevcut Rozetler */}
                                        <div className="mb-6">
                                            <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                                <i className="fas fa-medal text-yellow-500"></i> Mevcut Rozetler
                                            </h4>
                                            {(selectedSchoolForBadges.badges || []).length > 0 ? (
                                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                    {(selectedSchoolForBadges.badges || []).map(badgeKey => {
                                                        const badge = SCHOOL_BADGES[badgeKey];
                                                        if (!badge) return null;
                                                        const rarity = RARITY_COLORS[badge.rarity] || RARITY_COLORS.common;
                                                        return (
                                                            <div key={badgeKey} className={`${rarity.bg} ${rarity.border} border-2 rounded-xl p-3 relative group`}>
                                                                <div className="text-center">
                                                                    <div className="text-3xl mb-1">{badge.icon}</div>
                                                                    <div className={`font-bold text-sm ${rarity.text}`}>{badge.name}</div>
                                                                    <div className="text-xs text-gray-500">{badge.desc}</div>
                                                                </div>
                                                                {isSuperAdmin && (
                                                                    <button
                                                                        onClick={() => removeSchoolBadge(selectedSchoolForBadges.id, badgeKey)}
                                                                        className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        title="Rozeti Kaldƒ±r"
                                                                    >
                                                                        <i className="fas fa-times"></i>
                                                                    </button>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ) : (
                                                <div className="text-center py-8 text-gray-400">
                                                    <div className="text-4xl mb-2">üèÖ</div>
                                                    <p>Hen√ºz rozet kazanƒ±lmadƒ±</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* Rozet Ver - Sadece S√ºper Admin */}
                                        {isSuperAdmin && (
                                            <div>
                                                <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                                    <i className="fas fa-gift text-green-500"></i> Rozet Ver
                                                </h4>
                                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                    {Object.entries(SCHOOL_BADGES).map(([badgeKey, badge]) => {
                                                        const alreadyHas = (selectedSchoolForBadges.badges || []).includes(badgeKey);
                                                        const rarity = RARITY_COLORS[badge.rarity] || RARITY_COLORS.common;
                                                        return (
                                                            <button
                                                                key={badgeKey}
                                                                onClick={() => !alreadyHas && giveSchoolBadge(selectedSchoolForBadges.id, badgeKey)}
                                                                disabled={alreadyHas || operationInProgress}
                                                                className={`${rarity.bg} ${rarity.border} border-2 rounded-xl p-3 text-center transition-all ${
                                                                    alreadyHas ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 hover:shadow-lg cursor-pointer'
                                                                }`}
                                                            >
                                                                <div className="text-2xl mb-1">{badge.icon}</div>
                                                                <div className={`font-bold text-xs ${rarity.text}`}>{badge.name}</div>
                                                                {alreadyHas && <span className="text-xs text-green-600">‚úì Var</span>}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminPanel />);
    </script>
</body>
</html>