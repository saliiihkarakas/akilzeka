<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SHKO Y√∂netim Paneli</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        // ==========================================
        // BURAYA KENDƒ∞ FIREBASE Bƒ∞LGƒ∞LERƒ∞Nƒ∞ YAPI≈ûTIR
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db; window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue; window.dbRemove = remove; window.dbUpdate = update;
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const AdminPanel = () => {
            const [view, setView] = useState("dashboard"); // dashboard, approvals, schools, students
            const [lobbyUsers, setLobbyUsers] = useState({});
            const [games, setGames] = useState({});
            const [pendingUsers, setPendingUsers] = useState({});
            const [schools, setSchools] = useState({});
            const [allUsers, setAllUsers] = useState({}); // T√ºm kayƒ±tlƒ± √∂ƒürenciler
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [password, setPassword] = useState("");
            
            // Okul Y√∂netimi State
            const [newSchoolName, setNewSchoolName] = useState("");
            
            // √ñƒürenci Listesi State
            const [selectedSchoolFilter, setSelectedSchoolFilter] = useState("");

            useEffect(() => {
                if(!isLoggedIn) return;
                window.dbOnValue(window.dbRef(window.db, 'lobby'), (s) => setLobbyUsers(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'games'), (s) => setGames(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'pending_users'), (s) => setPendingUsers(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'schools'), (s) => setSchools(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'users'), (s) => setAllUsers(s.val() || {}));
            }, [isLoggedIn]);

            // --- FONKSƒ∞YONLAR ---
            const addSchool = () => {
                if(!newSchoolName.trim()) return;
                const schoolId = newSchoolName.toLowerCase()
                    .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                    .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                    .replace(/[^a-z0-9]/g, '');
                window.dbSet(window.dbRef(window.db, 'schools/' + schoolId), { name: newSchoolName, id: schoolId });
                setNewSchoolName("");
                alert("Okul eklendi!");
            };

            const deleteSchool = (id) => { if(confirm("Okulu silmek istediƒüine emin misin?")) window.dbRemove(window.dbRef(window.db, 'schools/' + id)); };
            const approveUser = (uid, data) => { if(confirm(`${data.name} onaylansƒ±n mƒ±?`)) { window.dbSet(window.dbRef(window.db, 'users/' + uid), data); window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid)); }};
            const rejectUser = (uid) => { if(confirm("Reddedilsin mi?")) window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid)); };
            const deleteGame = (id) => window.dbRemove(window.dbRef(window.db, 'games/' + id));
            
            // --- YENƒ∞: √ñƒûRENCƒ∞ Sƒ∞LME ---
            const deleteStudent = (uid, name) => {
                if(confirm(`Dƒ∞KKAT! ${name} isimli √∂ƒürenciyi ve t√ºm ba≈üarƒ±larƒ±nƒ± silmek √ºzeresin. Bu i≈ülem geri alƒ±namaz!\n\nMezuniyet/Ayrƒ±lma i≈ülemi onaylansƒ±n mƒ±?`)) {
                    window.dbRemove(window.dbRef(window.db, 'users/' + uid));
                    // Eƒüer lobideyse oradan da sil
                    window.dbRemove(window.dbRef(window.db, 'lobby/' + uid));
                }
            };

            // --- TURNUVA BA≈ûLATMA ---
            const [showGameSelector, setShowGameSelector] = useState(false);
            const startTournament = (gameType) => {
                setShowGameSelector(false);
                const waitingPlayers = Object.entries(lobbyUsers).filter(([_, u]) => u.state === 'waiting').map(([id, u]) => ({...u, id}));
                if(waitingPlayers.length < 2) return alert("En az 2 √∂ƒürenci lazƒ±m!");
                const shuffled = waitingPlayers.sort(() => 0.5 - Math.random());
                for (let i = 0; i < shuffled.length; i += 2) {
                    if (i + 1 >= shuffled.length) break; 
                    const p1 = shuffled[i]; const p2 = shuffled[i+1];
                    const newGameId = Math.floor(Math.random() * 90000 + 10000).toString();
                    let initialGameData = { isP1Turn: true, players: { p1: {name: p1.name}, p2: {name: p2.name} }, type: gameType };
                    if (gameType === 'mangala') initialGameData.board = [4, 4, 4, 4, 4, 4, 0, 4, 4, 4, 4, 4, 4, 0];
                    else if (gameType === 'reversi') { let b = Array(64).fill(0); b[27]=2; b[28]=1; b[35]=1; b[36]=2; initialGameData.board = b; }
                    window.dbSet(window.dbRef(window.db, 'games/' + newGameId), initialGameData);
                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p1.uid), { gameId: newGameId, role: 'P1', state: 'playing' });
                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p2.uid), { gameId: newGameId, role: 'P2', state: 'playing' });
                }
            };
            const resetSystem = () => { if(confirm("Her ≈üey silinsin mi?")) { window.dbRemove(window.dbRef(window.db, 'games')); window.dbRemove(window.dbRef(window.db, 'lobby')); }};

            if (!isLoggedIn) return (<div className="min-h-screen flex items-center justify-center bg-gray-800"><div className="bg-white p-8 rounded text-center"><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="border p-2 mb-4" placeholder="≈ûifre (1234)" /><button onClick={()=>password==="1234"&&setIsLoggedIn(true)} className="bg-blue-600 text-white w-full py-2 rounded">Gƒ∞Rƒ∞≈û</button></div></div>);

            const pendingCount = Object.keys(pendingUsers).length;

            return (
                <div className="min-h-screen bg-gray-100 p-6 max-w-7xl mx-auto">
                    {/* OYUN SE√áƒ∞M MODALI */}
                    {showGameSelector && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-8 rounded-xl shadow-2xl text-center">
                                <h3 className="text-xl font-bold mb-6">Hangi Turnuvayƒ± Ba≈ülatacaksƒ±n?</h3>
                                <div className="flex gap-4">
                                    <button onClick={() => startTournament('mangala')} className="bg-amber-600 text-white px-6 py-4 rounded-xl font-bold flex flex-col items-center gap-2 w-32"><i className="fas fa-chess-board text-2xl"></i> Mangala</button>
                                    <button onClick={() => startTournament('reversi')} className="bg-green-700 text-white px-6 py-4 rounded-xl font-bold flex flex-col items-center gap-2 w-32"><i className="fas fa-circle text-2xl"></i> Reversi</button>
                                </div>
                                <button onClick={() => setShowGameSelector(false)} className="mt-6 text-gray-500 underline text-sm">ƒ∞ptal</button>
                            </div>
                        </div>
                    )}

                    {/* NAVƒ∞GASYON */}
                    <div className="flex flex-wrap gap-4 mb-6">
                        <button onClick={()=>setView("dashboard")} className={`px-4 py-3 rounded-xl font-bold shadow flex items-center gap-2 ${view==='dashboard'?'bg-indigo-600 text-white':'bg-white text-gray-600'}`}>
                            <i className="fas fa-gamepad"></i> Turnuva
                        </button>
                        <button onClick={()=>setView("students")} className={`px-4 py-3 rounded-xl font-bold shadow flex items-center gap-2 ${view==='students'?'bg-purple-600 text-white':'bg-white text-gray-600'}`}>
                            <i className="fas fa-users"></i> √ñƒürenci Listesi
                        </button>
                        <button onClick={()=>setView("approvals")} className={`px-4 py-3 rounded-xl font-bold shadow flex items-center gap-2 ${view==='approvals'?'bg-orange-600 text-white':'bg-white text-gray-600'}`}>
                            <i className="fas fa-user-check"></i> Onaylar {pendingCount > 0 && <span className="bg-red-500 text-white px-2 rounded-full text-xs">{pendingCount}</span>}
                        </button>
                        <button onClick={()=>setView("schools")} className={`px-4 py-3 rounded-xl font-bold shadow flex items-center gap-2 ${view==='schools'?'bg-teal-600 text-white':'bg-white text-gray-600'}`}>
                            <i className="fas fa-school"></i> Okul Y√∂netimi
                        </button>
                    </div>

                    {/* --- √ñƒûRENCƒ∞ Lƒ∞STESƒ∞ VE Sƒ∞LME EKRANI --- */}
                    {view === "students" && (
                        <div className="bg-white p-6 rounded-xl shadow">
                            <h2 className="text-xl font-bold mb-4 border-b pb-2 flex justify-between items-center">
                                <span>Kayƒ±tlƒ± √ñƒürenciler</span>
                                <span className="text-sm font-normal text-gray-500">Toplam: {Object.keys(allUsers).length}</span>
                            </h2>
                            
                            {/* Filtre */}
                            <div className="mb-6 flex gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                <label className="font-bold text-gray-600">Okul Se√ß:</label>
                                <select 
                                    value={selectedSchoolFilter} 
                                    onChange={e=>setSelectedSchoolFilter(e.target.value)}
                                    className="border p-2 rounded-lg flex-1"
                                >
                                    <option value="">T√ºm Okullar</option>
                                    {Object.values(schools).map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            {/* Liste */}
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                            <th className="py-3 px-6">√ñƒürenci Adƒ±</th>
                                            <th className="py-3 px-6">Okul No</th>
                                            <th className="py-3 px-6">Sƒ±nƒ±f</th>
                                            <th className="py-3 px-6">Okul</th>
                                            <th className="py-3 px-6 text-center">Ba≈üarƒ±lar</th>
                                            <th className="py-3 px-6 text-center">ƒ∞≈ülem</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-gray-600 text-sm font-light">
                                        {Object.entries(allUsers)
                                            .filter(([_, user]) => !selectedSchoolFilter || user.schoolId === selectedSchoolFilter)
                                            .sort((a,b) => a[1].class.localeCompare(b[1].class)) // Sƒ±nƒ±fa g√∂re sƒ±rala
                                            .map(([uid, user]) => (
                                                <tr key={uid} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-3 px-6 font-bold text-gray-800">{user.name}</td>
                                                    <td className="py-3 px-6">{user.number}</td>
                                                    <td className="py-3 px-6"><span className="bg-blue-100 text-blue-700 py-1 px-3 rounded-full text-xs font-bold">{user.class}</span></td>
                                                    <td className="py-3 px-6">{user.schoolName}</td>
                                                    <td className="py-3 px-6 text-center">
                                                        <span className="mr-2">üèÜ {user.stats?.wins || 0}</span>
                                                        <span>üéñÔ∏è {(user.badges || []).length}</span>
                                                    </td>
                                                    <td className="py-3 px-6 text-center">
                                                        <button 
                                                            onClick={() => deleteStudent(uid, user.name)}
                                                            className="bg-red-100 text-red-600 py-1 px-3 rounded hover:bg-red-200 font-bold text-xs"
                                                        >
                                                            <i className="fas fa-trash-alt mr-1"></i> Sƒ∞L
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))
                                        }
                                        {Object.entries(allUsers).filter(([_, user]) => !selectedSchoolFilter || user.schoolId === selectedSchoolFilter).length === 0 && (
                                            <tr>
                                                <td colSpan="6" className="py-6 text-center text-gray-400">Bu kriterlere uygun √∂ƒürenci bulunamadƒ±.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* OKUL Y√ñNETƒ∞Mƒ∞ */}
                    {view === "schools" && (
                        <div className="bg-white p-6 rounded-xl shadow">
                            <h2 className="text-xl font-bold mb-4 border-b pb-2">Okul Listesi</h2>
                            <div className="flex gap-2 mb-6">
                                <input value={newSchoolName} onChange={e=>setNewSchoolName(e.target.value)} placeholder="Yeni Okul Adƒ±" className="border p-2 rounded flex-1" />
                                <button onClick={addSchool} className="bg-teal-600 text-white px-6 rounded font-bold hover:bg-teal-700">EKLE</button>
                            </div>
                            <div className="grid gap-2">
                                {Object.values(schools).map(school => (
                                    <div key={school.id} className="border p-3 rounded flex justify-between items-center bg-gray-50">
                                        <span className="font-bold">{school.name}</span>
                                        <button onClick={()=>deleteSchool(school.id)} className="text-red-500 hover:text-red-700 text-sm font-bold">Sƒ∞L</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* ONAYLAR */}
                    {view === "approvals" && (
                        <div className="bg-white p-6 rounded-xl shadow">
                            <h2 className="text-xl font-bold mb-4 border-b pb-2">Onay Bekleyenler</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {Object.entries(pendingUsers).map(([uid, u]) => (
                                    <div key={uid} className="border p-4 rounded-lg bg-orange-50">
                                        <div className="font-bold text-lg">{u.name}</div>
                                        <div className="text-sm font-bold text-indigo-700">{u.schoolName}</div>
                                        <div className="text-sm text-gray-500">{u.class} - No: {u.number}</div>
                                        <div className="flex gap-2 mt-3">
                                            <button onClick={()=>approveUser(uid, u)} className="flex-1 bg-green-600 text-white py-1 rounded text-sm font-bold">ONAYLA</button>
                                            <button onClick={()=>rejectUser(uid)} className="flex-1 bg-red-100 text-red-600 py-1 rounded text-sm font-bold">REDDET</button>
                                        </div>
                                    </div>
                                ))}
                                {pendingCount === 0 && <p className="text-gray-400">Bekleyen kayƒ±t yok.</p>}
                            </div>
                        </div>
                    )}

                    {/* TURNUVA PANELƒ∞ */}
                    {view === "dashboard" && (
                         <div className="bg-white p-6 rounded-xl shadow">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold">Turnuva Y√∂netimi</h2>
                                <div className="flex gap-2">
                                    <button onClick={resetSystem} className="text-red-600 border border-red-200 px-4 py-2 rounded text-sm font-bold hover:bg-red-50">Sistemi Sƒ±fƒ±rla</button>
                                    <button onClick={()=>setShowGameSelector(true)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold shadow animate-pulse">E≈ûLE≈ûTƒ∞RME BA≈ûLAT</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div className="bg-gray-50 p-4 rounded border">
                                    <h3 className="font-bold text-gray-600 mb-2">Lobi ({Object.keys(lobbyUsers).length})</h3>
                                    <div className="space-y-1 max-h-96 overflow-auto">
                                        {Object.values(lobbyUsers).map((u, i) => (
                                            <div key={i} className={`text-sm p-2 rounded flex justify-between ${u.state==='waiting'?'bg-green-100 text-green-800':'bg-white text-gray-400'}`}>
                                                <span>{u.name}</span>
                                                <span>{u.state==='waiting'?'‚è≥':'üéÆ'}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {Object.entries(games).reverse().map(([id, g]) => (
                                        <div key={id} className={`border p-3 rounded shadow-sm bg-white ${g.winner?'opacity-70':''}`}>
                                            <div className="flex justify-between text-xs font-bold mb-2">
                                                <span className="text-gray-400">MASA {id}</span>
                                                <span className="text-indigo-600 uppercase">{g.type}</span>
                                            </div>
                                            <div className="font-bold text-center mb-2">{g.players.p1.name} vs {g.players.p2.name}</div>
                                            <div className="text-center text-xl font-bold text-indigo-700 bg-indigo-50 rounded p-1 mb-2">
                                                {g.board ? g.board[6] : 0} - {g.board ? g.board[13] : 0}
                                            </div>
                                            {g.winner && <div className="bg-yellow-100 text-yellow-800 text-center text-sm font-bold rounded py-1 mb-2">üèÜ {g.winner}</div>}
                                            <button onClick={()=>deleteGame(id)} className="w-full bg-red-50 text-red-600 text-xs py-1 rounded font-bold">MASAYI KAPAT</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                         </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminPanel />);
    </script>
</body>
</html>