<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SHKO YÃ¶netim Paneli</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        // --- FIREBASE BÄ°LGÄ°LERÄ°NÄ° BURAYA YAPIÅTIR ---
        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db; window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue; window.dbRemove = remove; window.dbUpdate = update;
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const AdminPanel = () => {
            const [view, setView] = useState("dashboard");
            const [lobbyUsers, setLobbyUsers] = useState({});
            const [games, setGames] = useState({});
            const [pendingUsers, setPendingUsers] = useState({});
            const [schools, setSchools] = useState({});
            const [allUsers, setAllUsers] = useState({});
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [password, setPassword] = useState("");
            const [newSchoolName, setNewSchoolName] = useState("");
            const [selectedSchoolFilter, setSelectedSchoolFilter] = useState("");
            const [showGameSelector, setShowGameSelector] = useState(false);

            useEffect(() => {
                if(!isLoggedIn) return;
                window.dbOnValue(window.dbRef(window.db, 'lobby'), (s) => setLobbyUsers(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'games'), (s) => setGames(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'pending_users'), (s) => setPendingUsers(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'schools'), (s) => setSchools(s.val() || {}));
                window.dbOnValue(window.dbRef(window.db, 'users'), (s) => setAllUsers(s.val() || {}));
            }, [isLoggedIn]);

            const addSchool = () => { if(!newSchoolName.trim()) return; const id = newSchoolName.toLowerCase().replace(/[^a-z0-9]/g, ''); window.dbSet(window.dbRef(window.db, 'schools/' + id), { name: newSchoolName, id }); setNewSchoolName(""); };
            const deleteSchool = (id) => { if(confirm("Silinsin mi?")) window.dbRemove(window.dbRef(window.db, 'schools/' + id)); };
            const approveUser = (uid, data) => { if(confirm(`${data.name} onaylansÄ±n mÄ±?`)) { window.dbSet(window.dbRef(window.db, 'users/' + uid), data); window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid)); }};
            const rejectUser = (uid) => { if(confirm("Reddedilsin mi?")) window.dbRemove(window.dbRef(window.db, 'pending_users/' + uid)); };
            const deleteStudent = (uid, name) => { if(confirm(`${name} silinsin mi?`)) { window.dbRemove(window.dbRef(window.db, 'users/' + uid)); window.dbRemove(window.dbRef(window.db, 'lobby/' + uid)); } };
            const deleteGame = (id) => window.dbRemove(window.dbRef(window.db, 'games/' + id));
            const resetSystem = () => { if(confirm("Her ÅŸey silinsin mi?")) { window.dbRemove(window.dbRef(window.db, 'games')); window.dbRemove(window.dbRef(window.db, 'lobby')); }};
            
            const startTournament = (type) => {
                setShowGameSelector(false);
                const waiting = Object.entries(lobbyUsers).filter(([_, u]) => u.state === 'waiting').map(([id, u]) => ({...u, id}));
                if(waiting.length < 2) return alert("En az 2 Ã¶ÄŸrenci lazÄ±m!");
                const shuffled = waiting.sort(() => 0.5 - Math.random());
                for (let i = 0; i < shuffled.length; i += 2) {
                    if (i + 1 >= shuffled.length) break; 
                    const p1 = shuffled[i]; const p2 = shuffled[i+1];
                    const id = Math.floor(Math.random()*90000+10000).toString();
                    let data = { isP1Turn: true, players: { p1: {name: p1.name}, p2: {name: p2.name} }, type };
                    if (type === 'mangala') data.board = [4,4,4,4,4,4,0,4,4,4,4,4,4,0];
                    else if (type === 'reversi') { let b=Array(64).fill(0); b[27]=2; b[28]=1; b[35]=1; b[36]=2; data.board=b; }
                    window.dbSet(window.dbRef(window.db, 'games/' + id), data);
                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p1.uid), { gameId: id, role: 'P1', state: 'playing' });
                    window.dbUpdate(window.dbRef(window.db, 'lobby/' + p2.uid), { gameId: id, role: 'P2', state: 'playing' });
                }
            };

            const handleLogout = () => { setIsLoggedIn(false); setPassword(""); };

            if (!isLoggedIn) return (<div className="min-h-screen flex items-center justify-center bg-gray-800"><div className="bg-white p-8 rounded text-center"><h2 className="text-xl font-bold mb-4">SHKO YÃ¶netim</h2><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="border p-2 mb-4" placeholder="Åifre (1234)" /><button onClick={()=>password==="1234"&&setIsLoggedIn(true)} className="bg-blue-600 text-white w-full py-2 rounded">GÄ°RÄ°Å</button></div></div>);

            const pendingCount = Object.keys(pendingUsers).length;

            return (
                <div className="min-h-screen bg-gray-100 p-6 max-w-7xl mx-auto">
                    {showGameSelector && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-8 rounded-xl shadow-2xl text-center"><h3 className="text-xl font-bold mb-6">Turnuva SeÃ§</h3><div className="flex gap-4"><button onClick={() => startTournament('mangala')} className="bg-amber-600 text-white px-6 py-4 rounded-xl font-bold w-32">Mangala</button><button onClick={() => startTournament('reversi')} className="bg-green-700 text-white px-6 py-4 rounded-xl font-bold w-32">Reversi</button></div><button onClick={() => setShowGameSelector(false)} className="mt-6 text-gray-500 underline text-sm">Ä°ptal</button></div></div>)}

                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex flex-wrap gap-2">
                            <button onClick={()=>setView("dashboard")} className={`px-4 py-2 rounded-lg font-bold shadow ${view==='dashboard'?'bg-indigo-600 text-white':'bg-white text-gray-600'}`}>Turnuva</button>
                            <button onClick={()=>setView("students")} className={`px-4 py-2 rounded-lg font-bold shadow ${view==='students'?'bg-purple-600 text-white':'bg-white text-gray-600'}`}>Ã–ÄŸrenciler</button>
                            <button onClick={()=>setView("approvals")} className={`px-4 py-2 rounded-lg font-bold shadow ${view==='approvals'?'bg-orange-600 text-white':'bg-white text-gray-600'}`}>Onaylar {pendingCount>0 && <span className="bg-red-500 text-white px-2 rounded-full text-xs ml-1">{pendingCount}</span>}</button>
                            <button onClick={()=>setView("schools")} className={`px-4 py-2 rounded-lg font-bold shadow ${view==='schools'?'bg-teal-600 text-white':'bg-white text-gray-600'}`}>Okullar</button>
                        </div>
                        <button onClick={handleLogout} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700 shadow flex items-center gap-2"><i className="fas fa-sign-out-alt"></i> Ã‡IKIÅ</button>
                    </div>

                    {view === "students" && (
                        <div className="bg-white p-6 rounded-xl shadow">
                             <div className="mb-4 flex gap-4"><h2 className="text-xl font-bold">Ã–ÄŸrenci Listesi</h2><select onChange={e=>setSelectedSchoolFilter(e.target.value)} className="border p-1 rounded"><option value="">TÃ¼m Okullar</option>{Object.values(schools).map(s=><option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                             <div className="overflow-x-auto"><table className="w-full text-left text-sm border-collapse"><thead><tr className="bg-gray-100"><th className="p-3">Ad</th><th className="p-3">No</th><th className="p-3">SÄ±nÄ±f</th><th className="p-3">Okul</th><th className="p-3">BaÅŸarÄ±</th><th className="p-3">Sil</th></tr></thead><tbody>
                             {Object.entries(allUsers).filter(([_,u])=>!selectedSchoolFilter||u.schoolId===selectedSchoolFilter).map(([uid,u])=>(<tr key={uid} className="border-b hover:bg-gray-50"><td className="p-3 font-bold">{u.name}</td><td className="p-3">{u.number}</td><td className="p-3"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">{u.class}</span></td><td className="p-3">{u.schoolName}</td><td className="p-3">ğŸ†{u.stats?.wins||0}</td><td className="p-3"><button onClick={()=>deleteStudent(uid,u.name)} className="text-red-500 font-bold hover:underline">SÄ°L</button></td></tr>))}
                             </tbody></table></div>
                        </div>
                    )}

                    {view === "schools" && (
                        <div className="bg-white p-6 rounded-xl shadow">
                            <h2 className="text-xl font-bold mb-4">Okul Listesi</h2>
                            <div className="flex gap-2 mb-4"><input value={newSchoolName} onChange={e=>setNewSchoolName(e.target.value)} placeholder="Yeni Okul AdÄ±" className="border p-2 rounded flex-1" /><button onClick={addSchool} className="bg-teal-600 text-white px-4 rounded font-bold">EKLE</button></div>
                            <div className="grid gap-2">{Object.values(schools).map(s=>(<div key={s.id} className="border p-3 rounded flex justify-between bg-gray-50"><span className="font-bold">{s.name}</span><button onClick={()=>deleteSchool(s.id)} className="text-red-500 font-bold text-sm">SÄ°L</button></div>))}</div>
                        </div>
                    )}

                    {view === "approvals" && (
                        <div className="bg-white p-6 rounded-xl shadow"><h2 className="text-xl font-bold mb-4">Onay Bekleyenler</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{Object.entries(pendingUsers).map(([uid,u])=>(<div key={uid} className="border p-4 rounded bg-orange-50"><div className="font-bold">{u.name}</div><div className="text-sm text-indigo-700">{u.schoolName}</div><div className="text-sm text-gray-500">{u.class} - {u.number}</div><div className="flex gap-2 mt-2"><button onClick={()=>approveUser(uid,u)} className="flex-1 bg-green-600 text-white py-1 rounded text-sm font-bold">ONAYLA</button><button onClick={()=>rejectUser(uid)} className="flex-1 bg-red-100 text-red-600 py-1 rounded text-sm font-bold">REDDET</button></div></div>))}
                            {pendingCount===0 && <p className="text-gray-400">Yok.</p>}</div>
                        </div>
                    )}

                    {view === "dashboard" && (
                         <div className="bg-white p-6 rounded-xl shadow">
                            <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">Turnuva YÃ¶netimi</h2><div className="flex gap-2"><button onClick={resetSystem} className="text-red-600 border border-red-200 px-4 py-2 rounded text-sm font-bold">SÄ±fÄ±rla</button><button onClick={()=>setShowGameSelector(true)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold shadow animate-pulse">EÅLEÅTÄ°R</button></div></div>
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div className="bg-gray-50 p-4 rounded border"><h3 className="font-bold text-gray-600 mb-2">Lobi ({Object.keys(lobbyUsers).length})</h3><div className="space-y-1 max-h-96 overflow-auto">{Object.values(lobbyUsers).map((u,i)=>(<div key={i} className={`text-sm p-2 rounded flex justify-between ${u.state==='waiting'?'bg-green-100 text-green-800':'bg-white text-gray-400'}`}><span>{u.name}</span><span>{u.state==='waiting'?'â³':'ğŸ®'}</span></div>))}</div></div>
                                <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{Object.entries(games).reverse().map(([id,g])=>(<div key={id} className={`border p-3 rounded shadow-sm bg-white ${g.winner?'opacity-70':''}`}><div className="flex justify-between text-xs font-bold mb-2"><span className="text-gray-400">MASA {id}</span><span className="text-indigo-600 uppercase">{g.type}</span></div><div className="font-bold text-center mb-2">{g.players.p1.name} vs {g.players.p2.name}</div><div className="text-center text-xl font-bold text-indigo-700 bg-indigo-50 rounded p-1 mb-2">{g.board?g.board[6]:0} - {g.board?g.board[13]:0}</div>{g.winner&&<div className="bg-yellow-100 text-yellow-800 text-center text-sm font-bold rounded py-1 mb-2">ğŸ† {g.winner}</div>}<button onClick={()=>deleteGame(id)} className="w-full bg-red-50 text-red-600 text-xs py-1 rounded font-bold">MASAYI KAPAT</button></div>))}</div>
                            </div>
                         </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminPanel />);
    </script>
</body>
</html>