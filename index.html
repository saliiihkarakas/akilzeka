<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üéÆ Akƒ±l Zeka Oyunlarƒ± - Eƒülenceli D√ºnya</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db; window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue; window.dbUpdate = update; window.dbOnDisconnect = onDisconnect; window.dbGet = get; window.dbRemove = remove;
    </script>

    <style>
        * { box-sizing: border-box; }
        
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; 
            font-family: 'Fredoka', 'Baloo 2', sans-serif;
            touch-action: none;
            -webkit-user-select: none; user-select: none;
        }

        /* üåà MAGICAL ANIMATED BACKGROUND */
        .magic-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ‚ú® FLOATING PARTICLES */
        .particles {
            position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
            opacity: 0.6;
        }
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* üåü STARS */
        .stars {
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
        }
        .star {
            position: absolute;
            width: 4px; height: 4px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* üé® GLASS MORPHISM CARDS */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 
                        inset 0 0 32px rgba(255, 255, 255, 0.1);
        }

        .glass-card-dark {
            background: rgba(30, 30, 60, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* üéØ FUN BUTTONS */
        .btn-fun {
            position: relative;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-fun:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 0 rgba(0,0,0,0.2), 0 15px 30px rgba(0,0,0,0.3);
        }
        .btn-fun:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* üéÆ GAME PIT STYLES */
        .pit {
            position: relative;
            background: linear-gradient(145deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5));
            border-radius: 50%;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 
                        0 2px 5px rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .pit:hover {
            transform: scale(1.05);
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 
                        0 0 20px rgba(255,255,255,0.3);
        }
        .pit:active {
            transform: scale(0.95);
        }
        .pit-active {
            animation: pulseGlow 1.5s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 10px rgba(46, 213, 115, 0.5); }
            50% { box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 30px rgba(46, 213, 115, 0.8); }
        }

        /* üîÆ MARBLE STONES */
        .marble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd700 40%, #ff8c00 100%);
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.4), 
                        inset 2px 2px 6px rgba(255,255,255,0.8),
                        0 3px 6px rgba(0,0,0,0.4);
            animation: marbleBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .marble-opponent {
            background: radial-gradient(circle at 30% 30%, #fff 0%, #00d4ff 40%, #0099cc 100%);
        }
        @keyframes marbleBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* üì± RESPONSIVE */
        @media (min-width: 1024px) {
            .pc-container {
                max-width: 1100px;
                height: 90vh;
                margin: auto;
                border-radius: 32px;
                overflow: hidden;
            }
        }

        /* üéâ CONFETTI */
        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px; height: 10px;
            animation: confettiFall 3s linear forwards;
        }

        /* üåà RAINBOW TEXT */
        .rainbow-text {
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowMove 3s linear infinite;
        }
        @keyframes rainbowMove {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* ‚≠ê BOUNCE ANIMATION */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .bounce { animation: bounce 2s ease-in-out infinite; }

        /* üé™ POP IN */
        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* üåä WAVE */
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        .wave { animation: wave 1s ease-in-out infinite; display: inline-block; }

        /* üí´ GLOW */
        .glow {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
        }

        /* üéØ STATUS BADGE */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .status-online {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .status-waiting {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        /* üèÜ WINNER MODAL */
        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .winner-card {
            animation: winnerPulse 1s ease-in-out infinite;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        /* INPUT STYLES */
        .input-fun {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 14px 18px;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
        }
        .input-fun:focus {
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .input-fun::placeholder {
            color: rgba(255,255,255,0.5);
        }

        /* SELECT STYLES */
        .select-fun {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 14px 18px;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }
        .select-fun option {
            background: #2d1f4e;
            color: white;
        }
    </style>
</head>
<body>
    <!-- üåà Animated Background -->
    <div class="magic-bg"></div>
    
    <!-- ‚ú® Floating Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- üåü Twinkling Stars -->
    <div class="stars" id="stars"></div>
    
    <div id="root" class="w-full h-full relative z-10"></div>

    <script>
        // Create floating particles
        const particlesContainer = document.getElementById('particles');
        const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'];
        
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 30 + 10 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = Math.random() * 10 + 15 + 's';
            particlesContainer.appendChild(particle);
        }

        // Create twinkling stars
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // üèÜ KAPSAMLI ROZET Sƒ∞STEMƒ∞
        const BADGES = {
            // üåü BA≈ûLANGI√á ROZETLERƒ∞
            first_win: { icon: "‚≠ê", name: "ƒ∞lk Zafer", desc: "ƒ∞lk galibiyetini kazan", color: "#ffd700", rarity: "common" },
            first_blood: { icon: "üéØ", name: "ƒ∞lk Adƒ±m", desc: "ƒ∞lk oyununu tamamla", color: "#4ade80", rarity: "common" },
            
            // üéÆ OYUN USTALIƒûI ROZETLERƒ∞
            mangala_novice: { icon: "ü•â", name: "Mangala √áƒ±raƒüƒ±", desc: "Mangala'da 3 galibiyet", color: "#cd7f32", rarity: "common" },
            mangala_master: { icon: "ü¶Å", name: "Mangala Ustasƒ±", desc: "Mangala'da 10 galibiyet", color: "#ff9f43", rarity: "rare" },
            mangala_legend: { icon: "üëë", name: "Mangala Kralƒ±", desc: "Mangala'da 25 galibiyet", color: "#ffd700", rarity: "legendary" },
            
            reversi_novice: { icon: "üé≤", name: "Reversi Ba≈ülangƒ±√ß", desc: "Reversi'de 3 galibiyet", color: "#22d3ee", rarity: "common" },
            reversi_brain: { icon: "üß†", name: "Strateji Dehasƒ±", desc: "Reversi'de 10 galibiyet", color: "#54a0ff", rarity: "rare" },
            reversi_genius: { icon: "üîÆ", name: "Reversi B√ºy√ºc√ºs√º", desc: "Reversi'de 25 galibiyet", color: "#a855f7", rarity: "legendary" },
            
            pentago_novice: { icon: "üéØ", name: "Pentago Acemi", desc: "Pentago'da 3 galibiyet", color: "#f472b6", rarity: "common" },
            pentago_pro: { icon: "üíé", name: "Pentago Pro", desc: "Pentago'da 10 galibiyet", color: "#5f27cd", rarity: "rare" },
            pentago_master: { icon: "üåü", name: "Pentago Efsanesi", desc: "Pentago'da 25 galibiyet", color: "#ec4899", rarity: "legendary" },
            
            // üî• SERƒ∞ ROZETLERƒ∞
            streak_3: { icon: "üî•", name: "Ate≈ü Ba≈üladƒ±", desc: "3 ma√ß √ºst √ºste kazan", color: "#f97316", rarity: "common" },
            streak_5: { icon: "üí•", name: "Durdurulamaz", desc: "5 ma√ß √ºst √ºste kazan", color: "#ef4444", rarity: "rare" },
            streak_10: { icon: "‚òÑÔ∏è", name: "Meteor", desc: "10 ma√ß √ºst √ºste kazan", color: "#dc2626", rarity: "epic" },
            
            // üèÜ TOPLAM GALƒ∞Bƒ∞YET ROZETLERƒ∞
            wins_5: { icon: "üéñÔ∏è", name: "Yƒ±ldƒ±z Aday", desc: "Toplam 5 galibiyet", color: "#84cc16", rarity: "common" },
            wins_10: { icon: "üèÖ", name: "Bronz ≈ûampiyon", desc: "Toplam 10 galibiyet", color: "#cd7f32", rarity: "common" },
            wins_25: { icon: "ü•à", name: "G√ºm√º≈ü ≈ûampiyon", desc: "Toplam 25 galibiyet", color: "#c0c0c0", rarity: "rare" },
            wins_50: { icon: "ü•á", name: "Altƒ±n ≈ûampiyon", desc: "Toplam 50 galibiyet", color: "#ffd700", rarity: "epic" },
            wins_100: { icon: "üíé", name: "Elmas ≈ûampiyon", desc: "Toplam 100 galibiyet", color: "#06b6d4", rarity: "legendary" },
            
            // üåà √áOKLU OYUN ROZETLERƒ∞
            all_rounder: { icon: "üåà", name: "√áok Y√∂nl√º", desc: "Her oyundan en az 1 galibiyet", color: "#8b5cf6", rarity: "rare" },
            triple_master: { icon: "üé™", name: "√ú√ßl√º Usta", desc: "Her oyundan en az 5 galibiyet", color: "#f43f5e", rarity: "epic" },
            ultimate_champion: { icon: "üë∏", name: "S√ºper ≈ûampiyon", desc: "Her oyundan en az 15 galibiyet", color: "#fbbf24", rarity: "legendary" },
            
            // ‚ö° √ñZEL ROZETLER
            comeback_king: { icon: "‚ö°", name: "Geri D√∂n√º≈ü Kralƒ±", desc: "Kaybederken geri d√∂n ve kazan", color: "#eab308", rarity: "rare" },
            speed_demon: { icon: "üöÄ", name: "Hƒ±z ≈ûeytanƒ±", desc: "2 dakikadan kƒ±sa s√ºrede kazan", color: "#f43f5e", rarity: "rare" },
            perfect_game: { icon: "üíØ", name: "M√ºkemmel Oyun", desc: "Mangala'da 30+ ta≈ü farkla kazan", color: "#10b981", rarity: "epic" },
            
            // üéâ SOSYAL ROZETLER
            social_butterfly: { icon: "ü¶ã", name: "Sosyal Kelebek", desc: "10 farklƒ± rakiple oyna", color: "#d946ef", rarity: "rare" },
            veteran: { icon: "üéì", name: "Veteran", desc: "50 oyun tamamla", color: "#6366f1", rarity: "epic" },
            legend: { icon: "üåü", name: "Efsane", desc: "100 oyun tamamla", color: "#eab308", rarity: "legendary" },
            
            // üéÅ SEZONLuk ROZETLER (√ñƒüretmen tarafƒ±ndan verilebilir)
            tournament_winner: { icon: "üèÜ", name: "Turnuva ≈ûampiyonu", desc: "Okul turnuvasƒ±nƒ± kazan", color: "#fbbf24", rarity: "legendary" },
            fair_play: { icon: "ü§ù", name: "Fair Play", desc: "√ñrnek sporcu davranƒ±≈üƒ±", color: "#14b8a6", rarity: "special" },
            rising_star: { icon: "üí´", name: "Y√ºkselen Yƒ±ldƒ±z", desc: "En √ßok geli≈üen oyuncu", color: "#f472b6", rarity: "special" },
            brain_master: { icon: "üß©", name: "Beyin Ustasƒ±", desc: "Zeka oyunlarƒ±nda √ºst√ºn ba≈üarƒ±", color: "#8b5cf6", rarity: "special" }
        };

        // Rozet nadirlik renkleri
        const RARITY_COLORS = {
            common: { bg: "from-gray-400 to-gray-600", border: "border-gray-400", text: "text-gray-300" },
            rare: { bg: "from-blue-400 to-blue-600", border: "border-blue-400", text: "text-blue-300" },
            epic: { bg: "from-purple-400 to-purple-600", border: "border-purple-400", text: "text-purple-300" },
            legendary: { bg: "from-yellow-400 to-orange-500", border: "border-yellow-400", text: "text-yellow-300" },
            special: { bg: "from-pink-400 to-rose-500", border: "border-pink-400", text: "text-pink-300" }
        };

        const RARITY_NAMES = {
            common: "Yaygƒ±n",
            rare: "Nadir",
            epic: "Epik",
            legendary: "Efsanevi",
            special: "√ñzel"
        };

        // üéâ Confetti Effect
        const createConfetti = () => {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        };

        // --- GAME LOGIC ---
        function useMangalaGame(gameData, gameId, playerRole, onWin) {
            const moveStone = (pitIndex) => {
                if (gameData.winner) return;
                const isP1Turn = gameData.isP1Turn;
                const board = (gameData.board || []).map(n => parseInt(n, 10) || 0);

                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                if (isP1Turn && (pitIndex < 0 || pitIndex > 5)) return;
                if (!isP1Turn && (pitIndex < 7 || pitIndex > 12)) return;
                if (board[pitIndex] === 0) return;

                let stones = board[pitIndex];
                let currentIndex = pitIndex;
                board[pitIndex] = 0; 

                if (stones === 1) {
                    currentIndex = (currentIndex + 1) % 14;
                    board[currentIndex] += 1;
                } else {
                    board[currentIndex] = 1; stones--; 
                    while (stones > 0) {
                        currentIndex = (currentIndex + 1) % 14;
                        if (isP1Turn && currentIndex === 13) continue;
                        if (!isP1Turn && currentIndex === 6) continue;
                        board[currentIndex] += 1; stones--;
                    }
                }
                const lastIndex = currentIndex;
                const p1Store = 6; const p2Store = 13;
                const isMyStore = isP1Turn ? lastIndex === p1Store : lastIndex === p2Store;
                const isOpponentSide = isP1Turn ? (lastIndex >= 7 && lastIndex <= 12) : (lastIndex >= 0 && lastIndex <= 5);
                const isMySide = isP1Turn ? (lastIndex >= 0 && lastIndex <= 5) : (lastIndex >= 7 && lastIndex <= 12);
                let nextTurnIsP1 = !isP1Turn;
                if (isMyStore) { nextTurnIsP1 = isP1Turn; }
                else if (isOpponentSide && board[lastIndex] % 2 === 0) {
                    const myStoreIndex = isP1Turn ? p1Store : p2Store;
                    board[myStoreIndex] += board[lastIndex]; board[lastIndex] = 0;
                }
                else if (isMySide && board[lastIndex] === 1) { 
                    const oppositeIndex = 12 - lastIndex;
                    if (board[oppositeIndex] > 0) {
                        const myStoreIndex = isP1Turn ? p1Store : p2Store;
                        board[myStoreIndex] += (board[lastIndex] + board[oppositeIndex]);
                        board[lastIndex] = 0; board[oppositeIndex] = 0;
                    }
                }
                const p1PitSum = board.slice(0, 6).reduce((a, b) => a + b, 0);
                const p2PitSum = board.slice(7, 13).reduce((a, b) => a + b, 0);
                let w = null;
                if (p1PitSum === 0 || p2PitSum === 0) {
                    if (p1PitSum === 0) { board[p1Store] += p2PitSum; for(let i=7; i<=12; i++) board[i] = 0; } 
                    else { board[p2Store] += p1PitSum; for(let i=0; i<=5; i++) board[i] = 0; }
                    if (board[p1Store] > board[p2Store]) w = gameData.players.p1.name;
                    else if (board[p2Store] > board[p1Store]) w = gameData.players.p2.name;
                    else w = "Berabere";
                    if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ? 'P1' : 'P2'; if(wRole === playerRole) onWin('mangala'); }
                }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, isP1Turn: nextTurnIsP1, winner: w });
            };
            return { moveStone };
        }

        function useReversiGame(gameData, gameId, playerRole, onWin) {
            const makeMove = (row, col) => {
                if (gameData.winner) return;
                const isP1Turn = gameData.isP1Turn; if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                const myColor = isP1Turn ? 1 : 2; const oppColor = isP1Turn ? 2 : 1; const board = gameData.board;
                if (board[row * 8 + col] !== 0) return;
                let flips = [];
                const directions = [[0,1], [1,0], [0,-1], [-1,0], [1,1], [1,-1], [-1,1], [-1,-1]];
                directions.forEach(([dr, dc]) => { let r = row + dr, c = col + dc; let potential = []; while (r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === oppColor) { potential.push(r*8+c); r += dr; c += dc; } if (potential.length > 0 && r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === myColor) flips.push(...potential); });
                if (flips.length === 0) return;
                let newBoard = [...board]; newBoard[row * 8 + col] = myColor;
                flips.forEach(idx => newBoard[idx] = myColor);
                let w = null; if (!newBoard.includes(0)) { const p1c = newBoard.filter(x => x === 1).length;
                const p2c = newBoard.filter(x => x === 2).length; w = p1c > p2c ?
                gameData.players.p1.name : (p2c > p1c ? gameData.players.p2.name : "Berabere"); if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ?
                'P1' : 'P2'; if(wRole === playerRole) onWin('reversi'); } }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: newBoard, isP1Turn: !isP1Turn, winner: w });
            };
            return { makeMove };
        }

        function usePentagoGame(gameData, gameId, playerRole, onWin) {
            const checkWinner = (board) => {
                const lines = [];
                for (let r = 0; r < 6; r++) {
                    lines.push([r*6, r*6+1, r*6+2, r*6+3, r*6+4]);
                    lines.push([r*6+1, r*6+2, r*6+3, r*6+4, r*6+5]);
                }
                for (let c = 0; c < 6; c++) {
                    lines.push([c, c+6, c+12, c+18, c+24]);
                    lines.push([c+6, c+12, c+18, c+24, c+30]);
                }
                lines.push([0, 7, 14, 21, 28]); lines.push([1, 8, 15, 22, 29]); lines.push([6, 13, 20, 27, 34]);
                lines.push([7, 14, 21, 28, 35]); lines.push([1, 8, 15, 22, 29]); lines.push([2, 9, 16, 23, 30]);
                lines.push([4, 9, 14, 19, 24]); lines.push([5, 10, 15, 20, 25]); lines.push([10, 15, 20, 25, 30]);
                lines.push([3, 8, 13, 18, 23]); lines.push([4, 9, 14, 19, 24]); lines.push([11, 16, 21, 26, 31]);
                
                let p1Wins = false, p2Wins = false;
                lines.forEach(line => {
                    if (line.every(i => board[i] === 1)) p1Wins = true;
                    if (line.every(i => board[i] === 2)) p2Wins = true;
                });
                if (p1Wins && p2Wins) return 'draw';
                if (p1Wins) return 'p1';
                if (p2Wins) return 'p2';
                return null;
            };

            const rotateQuadrant = (board, quadrant, clockwise) => {
                const newBoard = [...board];
                const starts = [0, 3, 18, 21];
                const start = starts[quadrant];
                const offsets = [0, 1, 2, 6, 7, 8, 12, 13, 14];
                const indices = offsets.map(o => start + o);
                const values = indices.map(i => board[i]);
                const cwMap = [6, 3, 0, 7, 4, 1, 8, 5, 2];
                const ccwMap = [2, 5, 8, 1, 4, 7, 0, 3, 6];
                const map = clockwise ? cwMap : ccwMap;
                map.forEach((from, to) => { newBoard[indices[to]] = values[from]; });
                return newBoard;
            };

            const placeStone = (cellIndex) => {
                if (gameData.winner || gameData.phase === 'rotate') return;
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                const board = [...gameData.board];
                if (board[cellIndex] !== 0) return;
                const myColor = isP1Turn ? 1 : 2;
                board[cellIndex] = myColor;
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, phase: 'rotate', lastPlaced: cellIndex });
            };

            const doRotate = (quadrant, clockwise) => {
                if (gameData.winner || gameData.phase !== 'rotate') return;
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                
                let board = rotateQuadrant([...gameData.board], quadrant, clockwise);
                const result = checkWinner(board);
                
                let w = null;
                if (result === 'p1') { w = gameData.players.p1.name; if(playerRole === 'P1') onWin('pentago'); }
                else if (result === 'p2') { w = gameData.players.p2.name; if(playerRole === 'P2') onWin('pentago'); }
                else if (result === 'draw') { w = 'Berabere'; }
                else if (!board.includes(0)) { w = 'Berabere'; }
                
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, isP1Turn: !isP1Turn, phase: 'place', winner: w, lastPlaced: null });
            };

            return { placeStone, doRotate };
        }

        // üéÆ MANGALA BOARD COMPONENT
        const MangalaBoard = ({ game, playerRole, onMove }) => {
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);

            const Pit = ({ count, owner, store, onClick, active }) => {
                const marbles = [...Array(Math.min(count, 12))].map((_, i) => {
                    const angle = (i / Math.min(count, 12)) * 360;
                    const radius = store ? (count > 6 ? 25 : 15) : (count > 4 ? 12 : 8);
                    const x = Math.cos(angle * Math.PI / 180) * radius;
                    const y = Math.sin(angle * Math.PI / 180) * radius;
                    return (
                        <div 
                            key={i} 
                            className={`marble ${owner === 'opponent' ? 'marble-opponent' : ''}`}
                            style={{
                                width: store ? '12px' : '10px',
                                height: store ? '12px' : '10px',
                                transform: `translate(${x}px, ${y}px)`,
                                animationDelay: `${i * 0.05}s`
                            }}
                        />
                    );
                });

                return (
                    <div 
                        onClick={onClick}
                        className={`pit flex items-center justify-center relative
                            ${store ? 'w-20 sm:w-24 h-32 sm:h-40 rounded-[40px]' : 'w-12 sm:w-14 h-12 sm:h-14'}
                            ${active ? 'pit-active cursor-pointer' : 'cursor-default'}
                            ${owner === 'me' ? 'bg-gradient-to-br from-amber-900/50 to-orange-900/50' : 'bg-gradient-to-br from-cyan-900/50 to-blue-900/50'}
                        `}
                    >
                        <div className="relative flex items-center justify-center">
                            {marbles}
                        </div>
                        <div className={`absolute ${store ? 'bottom-2' : '-bottom-6'} left-1/2 -translate-x-1/2 
                            px-2 py-1 rounded-full text-xs font-bold
                            ${owner === 'me' ? 'bg-amber-500 text-white' : 'bg-cyan-500 text-white'}`}>
                            {count}
                        </div>
                    </div>
                );
            };

            return (
                <div className="w-full h-full flex flex-col md:flex-row items-center justify-center gap-4 p-4">
                    {/* Opponent Store */}
                    <div className="flex flex-col items-center gap-2">
                        <span className="text-cyan-400 text-sm font-bold flex items-center gap-2">
                            <span className="wave">üë§</span> {game.players[playerRole === 'P1' ? 'p2' : 'p1'].name.split(' ')[0]}
                        </span>
                        <Pit count={playerRole === 'P1' ? board[13] : board[6]} owner="opponent" store={true} />
                    </div>

                    {/* Main Board */}
                    <div className="glass-card-dark p-4 sm:p-6 flex flex-col gap-4">
                        {/* Opponent Row */}
                        <div className="flex justify-center gap-2 sm:gap-3">
                            {[0,1,2,3,4,5].map(i => {
                                const idx = playerRole === 'P1' ? (12 - i) : (5 - i);
                                return <Pit key={idx} count={board[idx]} owner="opponent" />;
                            })}
                        </div>
                        
                        {/* Turn Indicator */}
                        <div className="flex justify-center">
                            <div className={`status-badge ${isMyTurn ? 'status-online' : 'status-waiting'}`}>
                                {isMyTurn ? (
                                    <><span className="wave">üéØ</span> Senin Sƒ±ran!</>
                                ) : (
                                    <><span className="animate-pulse">‚è≥</span> Rakip Oynuyor...</>
                                )}
                            </div>
                        </div>

                        {/* My Row */}
                        <div className="flex justify-center gap-2 sm:gap-3">
                            {[0,1,2,3,4,5].map(i => {
                                const idx = playerRole === 'P1' ? i : (i + 7);
                                return (
                                    <Pit 
                                        key={idx} 
                                        count={board[idx]} 
                                        owner="me" 
                                        active={isMyTurn && board[idx] > 0}
                                        onClick={() => isMyTurn && onMove(idx)}
                                    />
                                );
                            })}
                        </div>
                    </div>

                    {/* My Store */}
                    <div className="flex flex-col items-center gap-2">
                        <span className="text-amber-400 text-sm font-bold flex items-center gap-2">
                            <span className="wave">‚≠ê</span> Sen
                        </span>
                        <Pit count={playerRole === 'P1' ? board[6] : board[13]} owner="me" store={true} />
                    </div>
                </div>
            );
        };

        // üéÆ REVERSI BOARD COMPONENT
        const ReversiBoard = ({ game, playerRole, onMove }) => {
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn); 
            const black = board.filter(x=>x===1).length; 
            const white = board.filter(x=>x===2).length;
            
            return (
                <div className="flex flex-col items-center justify-center w-full h-full p-4 gap-4 overflow-auto">
                    {/* Score Panel */}
                    <div className="flex items-center gap-4">
                        <div className={`glass-card px-4 py-2 flex items-center gap-3 ${playerRole === 'P1' ? 'ring-2 ring-amber-400' : ''}`}>
                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-black shadow-lg"></div>
                            <span className="text-2xl font-bold text-white">{black}</span>
                        </div>
                        
                        <div className={`status-badge ${isMyTurn ? 'status-online' : 'status-waiting'}`}>
                            {isMyTurn ? 'üéØ Oyna!' : '‚è≥ Bekle'}
                        </div>
                        
                        <div className={`glass-card px-4 py-2 flex items-center gap-3 ${playerRole === 'P2' ? 'ring-2 ring-amber-400' : ''}`}>
                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-white shadow-lg"></div>
                            <span className="text-2xl font-bold text-white">{white}</span>
                        </div>
                    </div>

                    {/* Board */}
                    <div className="bg-gradient-to-br from-green-700 to-green-900 p-2 rounded-2xl shadow-2xl border-4 border-green-950">
                        <div className="grid grid-cols-8 gap-1">
                            {board.map((cell, i) => (
                                <div 
                                    key={i} 
                                    onClick={() => isMyTurn && onMove(Math.floor(i/8), i%8)}
                                    className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center
                                        bg-green-600 hover:bg-green-500 cursor-pointer transition-all
                                        ${isMyTurn && cell === 0 ? 'hover:ring-2 hover:ring-yellow-400' : ''}
                                    `}
                                >
                                    {cell !== 0 && (
                                        <div className={`w-[80%] h-[80%] rounded-full shadow-lg transition-all duration-300 transform hover:scale-110
                                            ${cell === 1 
                                                ? 'bg-gradient-to-br from-gray-600 to-black border-2 border-gray-500' 
                                                : 'bg-gradient-to-br from-white to-gray-200 border-2 border-gray-300'
                                            }
                                        `}></div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // üéÆ PENTAGO BOARD COMPONENT
        const PentagoBoard = ({ game, playerRole, onPlace, onRotate }) => {
            const board = (game.board || Array(36).fill(0)).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);
            const phase = game.phase || 'place';
            const p1Count = board.filter(x => x === 1).length;
            const p2Count = board.filter(x => x === 2).length;

            const getQuadrantCells = (qId) => {
                const starts = [0, 3, 18, 21];
                const start = starts[qId];
                const offsets = [0, 1, 2, 6, 7, 8, 12, 13, 14];
                return offsets.map(o => start + o);
            };

            const QuadrantGrid = ({ qId }) => {
                const cells = getQuadrantCells(qId);
                const canRotate = isMyTurn && phase === 'rotate';
                
                return (
                    <div className="relative group">
                        <div className={`grid grid-cols-3 gap-1 p-2 rounded-xl transition-all duration-300 
                            ${canRotate 
                                ? 'bg-gradient-to-br from-purple-600/50 to-pink-600/50 ring-2 ring-purple-400 animate-pulse' 
                                : 'bg-white/10'
                            }`}>
                            {cells.map((cellIdx) => {
                                const cell = board[cellIdx];
                                const canPlace = isMyTurn && phase === 'place' && cell === 0;
                                const isLastPlaced = game.lastPlaced === cellIdx;
                                
                                return (
                                    <div 
                                        key={cellIdx} 
                                        onClick={() => canPlace && onPlace(cellIdx)}
                                        className={`w-10 h-10 sm:w-12 sm:h-12 rounded-lg flex items-center justify-center 
                                            bg-gradient-to-br from-slate-800 to-slate-900 transition-all duration-200
                                            ${canPlace ? 'hover:from-slate-700 hover:to-slate-800 cursor-pointer hover:scale-105' : ''}
                                            ${isLastPlaced ? 'ring-2 ring-yellow-400 ring-offset-2 ring-offset-transparent' : ''}
                                        `}
                                    >
                                        {cell !== 0 && (
                                            <div className={`w-[70%] h-[70%] rounded-full shadow-lg transition-transform 
                                                ${cell === 1 
                                                    ? 'bg-gradient-to-br from-rose-400 to-rose-600 border-2 border-rose-300' 
                                                    : 'bg-gradient-to-br from-cyan-400 to-cyan-600 border-2 border-cyan-300'
                                                }
                                                ${isLastPlaced ? 'scale-110 animate-bounce' : ''}
                                            `}></div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {canRotate && (
                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                                <div className="flex gap-2 bg-black/80 backdrop-blur p-2 rounded-xl">
                                    <button 
                                        onClick={() => onRotate(qId, false)} 
                                        className="btn-fun btn-warning py-2 px-3 text-sm"
                                    >
                                        <i className="fas fa-undo"></i>
                                    </button>
                                    <button 
                                        onClick={() => onRotate(qId, true)} 
                                        className="btn-fun btn-success py-2 px-3 text-sm"
                                    >
                                        <i className="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex flex-col items-center justify-center w-full h-full p-4 gap-4 overflow-auto">
                    {/* Score Panel */}
                    <div className="flex flex-wrap items-center justify-center gap-3">
                        <div className={`glass-card px-4 py-2 flex items-center gap-2 ${playerRole === 'P1' ? 'ring-2 ring-rose-400' : ''}`}>
                            <div className="w-5 h-5 rounded-full bg-gradient-to-br from-rose-400 to-rose-600"></div>
                            <span className="font-bold text-white">{game.players?.p1?.name?.split(' ')[0]}</span>
                            <span className="text-xl font-bold text-rose-400">{p1Count}</span>
                        </div>
                        
                        <div className={`status-badge ${isMyTurn ? (phase === 'place' ? 'status-online' : 'status-waiting') : 'bg-gray-600 text-white'}`}>
                            {!isMyTurn ? '‚è≥ Bekle' : (phase === 'place' ? 'üéØ Ta≈ü Koy' : 'üîÑ D√∂nd√ºr')}
                        </div>
                        
                        <div className={`glass-card px-4 py-2 flex items-center gap-2 ${playerRole === 'P2' ? 'ring-2 ring-cyan-400' : ''}`}>
                            <div className="w-5 h-5 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600"></div>
                            <span className="font-bold text-white">{game.players?.p2?.name?.split(' ')[0]}</span>
                            <span className="text-xl font-bold text-cyan-400">{p2Count}</span>
                        </div>
                    </div>

                    {/* Board */}
                    <div className="glass-card-dark p-3 sm:p-4">
                        <div className="grid grid-cols-2 gap-2 sm:gap-3">
                            {[0, 1, 2, 3].map(qId => (
                                <QuadrantGrid key={qId} qId={qId} />
                            ))}
                        </div>
                    </div>

                    {/* Info */}
                    <div className="glass-card px-4 py-2 text-center">
                        <p className="text-xs text-white/70">
                            <span className="text-yellow-400 font-bold">üí° ƒ∞pucu:</span> 5 ta≈üƒ± yan yana diz ve kazan!
                        </p>
                    </div>
                </div>
            );
        };

        // üë§ PROFILE MODAL - ROZET GALERƒ∞Sƒ∞ ƒ∞LE
        const ProfileModal = ({ user, onClose, onLogout }) => {
            const [activeTab, setActiveTab] = useState('badges');
            const userBadges = user.badges || [];
            const allBadgeKeys = Object.keys(BADGES);
            
            // Rozet istatistikleri
            const earnedCount = userBadges.length;
            const totalCount = allBadgeKeys.length;
            const percentage = Math.round((earnedCount / totalCount) * 100);
            
            // Nadirliƒüe g√∂re grupla
            const groupedBadges = {
                legendary: allBadgeKeys.filter(k => BADGES[k].rarity === 'legendary'),
                epic: allBadgeKeys.filter(k => BADGES[k].rarity === 'epic'),
                rare: allBadgeKeys.filter(k => BADGES[k].rarity === 'rare'),
                special: allBadgeKeys.filter(k => BADGES[k].rarity === 'special'),
                common: allBadgeKeys.filter(k => BADGES[k].rarity === 'common')
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4" onClick={onClose}>
                    <div className="glass-card w-full max-w-lg max-h-[90vh] overflow-hidden pop-in flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 p-6 text-center relative flex-shrink-0">
                            <button onClick={onClose} className="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/30 transition">
                                <i className="fas fa-times"></i>
                            </button>
                            <div className="w-20 h-20 mx-auto bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-xl mb-3 bounce ring-4 ring-white/30">
                                {user.name.charAt(0)}
                            </div>
                            <h2 className="text-xl font-bold text-white">{user.name}</h2>
                            <p className="text-white/70 text-sm">{user.schoolName} ‚Ä¢ {user.class}</p>
                        </div>
                        
                        {/* Stats Bar */}
                        <div className="p-4 grid grid-cols-3 gap-3 bg-white/5 flex-shrink-0">
                            <div className="text-center">
                                <div className="text-2xl font-bold text-yellow-400">{user.stats?.wins || 0}</div>
                                <div className="text-xs text-white/50">üèÜ Galibiyet</div>
                            </div>
                            <div className="text-center border-x border-white/10">
                                <div className="text-2xl font-bold text-purple-400">{earnedCount}</div>
                                <div className="text-xs text-white/50">üéñÔ∏è Rozet</div>
                            </div>
                            <div className="text-center">
                                <div className="text-2xl font-bold text-cyan-400">{user.stats?.totalGames || 0}</div>
                                <div className="text-xs text-white/50">üéÆ Oyun</div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-white/5 p-1 mx-4 rounded-xl flex-shrink-0">
                            <button 
                                onClick={() => setActiveTab('badges')}
                                className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition-all ${activeTab === 'badges' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-white/50 hover:text-white'}`}
                            >
                                üéñÔ∏è Rozetlerim
                            </button>
                            <button 
                                onClick={() => setActiveTab('gallery')}
                                className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition-all ${activeTab === 'gallery' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-white/50 hover:text-white'}`}
                            >
                                üèÜ Rozet Galerisi
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-4">
                            {activeTab === 'badges' ? (
                                <>
                                    {/* Progress Bar */}
                                    <div className="mb-4 p-3 bg-white/5 rounded-xl">
                                        <div className="flex justify-between text-xs mb-2">
                                            <span className="text-white/60">Koleksiyon ƒ∞lerlemesi</span>
                                            <span className="text-white font-bold">{earnedCount}/{totalCount} ({percentage}%)</span>
                                        </div>
                                        <div className="h-3 bg-white/10 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 rounded-full transition-all duration-1000"
                                                style={{ width: `${percentage}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    {/* Kazanƒ±lan Rozetler */}
                                    {userBadges.length > 0 ? (
                                        <div className="grid grid-cols-2 gap-3">
                                            {userBadges.map(badgeKey => {
                                                const badge = BADGES[badgeKey];
                                                if (!badge) return null;
                                                const rarity = RARITY_COLORS[badge.rarity];
                                                return (
                                                    <div 
                                                        key={badgeKey} 
                                                        className={`relative p-3 rounded-xl bg-gradient-to-br ${rarity.bg} border-2 ${rarity.border} shadow-lg hover:scale-105 transition-transform cursor-pointer`}
                                                    >
                                                        <div className="absolute top-1 right-1 text-[10px] px-2 py-0.5 rounded-full bg-black/30 text-white/80">
                                                            {RARITY_NAMES[badge.rarity]}
                                                        </div>
                                                        <div className="text-3xl mb-1">{badge.icon}</div>
                                                        <div className="font-bold text-white text-sm">{badge.name}</div>
                                                        <div className="text-white/60 text-xs mt-1">{badge.desc}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-white/40">
                                            <span className="text-5xl block mb-3">üéÆ</span>
                                            <span className="text-sm">Hen√ºz rozet kazanƒ±lmadƒ±</span>
                                            <p className="text-xs mt-2 text-white/30">Oyunlar oynayarak rozetler kazan!</p>
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* T√ºm Rozetler Galerisi */
                                <div className="space-y-4">
                                    {Object.entries(groupedBadges).map(([rarity, badges]) => {
                                        if (badges.length === 0) return null;
                                        const rarityStyle = RARITY_COLORS[rarity];
                                        return (
                                            <div key={rarity}>
                                                <div className={`text-xs font-bold ${rarityStyle.text} mb-2 flex items-center gap-2`}>
                                                    {rarity === 'legendary' && 'üëë'}
                                                    {rarity === 'epic' && 'üíú'}
                                                    {rarity === 'rare' && 'üíô'}
                                                    {rarity === 'special' && 'üíñ'}
                                                    {rarity === 'common' && '‚ö™'}
                                                    {RARITY_NAMES[rarity]} Rozetler ({badges.filter(b => userBadges.includes(b)).length}/{badges.length})
                                                </div>
                                                <div className="grid grid-cols-4 gap-2">
                                                    {badges.map(badgeKey => {
                                                        const badge = BADGES[badgeKey];
                                                        const isEarned = userBadges.includes(badgeKey);
                                                        return (
                                                            <div 
                                                                key={badgeKey}
                                                                className={`relative p-2 rounded-xl text-center transition-all cursor-pointer group
                                                                    ${isEarned 
                                                                        ? `bg-gradient-to-br ${rarityStyle.bg} border-2 ${rarityStyle.border}` 
                                                                        : 'bg-white/5 border border-white/10 grayscale opacity-50'
                                                                    }`}
                                                                title={badge.desc}
                                                            >
                                                                <div className={`text-2xl ${isEarned ? '' : 'filter blur-[1px]'}`}>
                                                                    {isEarned ? badge.icon : '‚ùì'}
                                                                </div>
                                                                <div className="text-[10px] text-white/70 truncate mt-1">
                                                                    {isEarned ? badge.name : '???'}
                                                                </div>
                                                                {/* Tooltip */}
                                                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-32 p-2 bg-black/90 rounded-lg text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                                                                    <div className="font-bold">{badge.name}</div>
                                                                    <div className="text-white/60 text-[10px] mt-1">{badge.desc}</div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        
                        {/* Logout */}
                        <button onClick={onLogout} className="w-full py-4 bg-red-500/20 text-red-400 font-bold hover:bg-red-500/30 transition border-t border-white/10 flex-shrink-0">
                            <i className="fas fa-sign-out-alt mr-2"></i> √áƒ±kƒ±≈ü Yap
                        </button>
                    </div>
                </div>
            );
        };

        // üîê AUTH SCREEN
        const AuthScreen = ({ onLogin, onRegister }) => {
            const [mode, setMode] = useState("login");
            const [schools, setSchools] = useState([]);
            const [schoolId, setSchoolId] = useState("");
            const [number, setNumber] = useState("");
            const [password, setPassword] = useState("");
            const [name, setName] = useState("");
            const [cls, setCls] = useState("");

            useEffect(() => {
                if (window.dbRef) {
                    window.dbOnValue(window.dbRef(window.db, 'schools'), (snap) => {
                        const val = snap.val();
                        if (val) setSchools(Object.values(val));
                    });
                }
            }, []);

            const doAuth = () => {
                if (!schoolId || !number || !password) return alert("T√ºm alanlarƒ± doldur! üìù");
                if (mode === "login") {
                    onLogin(schoolId, number, password);
                } else {
                    if (!name || !cls) return alert("Ad ve Sƒ±nƒ±f bilgisi gerekli! üìö");
                    const selectedSchool = schools.find(s => s.id === schoolId);
                    onRegister({ schoolId, schoolName: selectedSchool.name, number, password, name, class: cls });
                }
            };

            return (
                <div className="w-full h-full flex items-center justify-center p-4">
                    <div className="glass-card w-full max-w-md p-8 pop-in">
                        {/* Logo */}
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4 bounce">üéÆ</div>
                            <h1 className="text-4xl font-bold rainbow-text mb-2">AKIL ZEKA</h1>
                            <p className="text-white/60 text-sm">Eƒülenceli Oyun D√ºnyasƒ±</p>
                        </div>

                        {/* Toggle */}
                        <div className="flex bg-white/10 rounded-full p-1 mb-6">
                            <button 
                                onClick={() => setMode("login")}
                                className={`flex-1 py-2 px-4 rounded-full font-bold transition-all ${mode === 'login' ? 'bg-white text-purple-600' : 'text-white/70'}`}
                            >
                                üîë Giri≈ü
                            </button>
                            <button 
                                onClick={() => setMode("register")}
                                className={`flex-1 py-2 px-4 rounded-full font-bold transition-all ${mode === 'register' ? 'bg-white text-purple-600' : 'text-white/70'}`}
                            >
                                ‚ú® Kayƒ±t
                            </button>
                        </div>

                        {/* Form */}
                        <div className="space-y-4">
                            <div>
                                <label className="text-white/60 text-sm font-bold mb-2 block">üè´ Okul</label>
                                <select 
                                    value={schoolId} 
                                    onChange={e => setSchoolId(e.target.value)} 
                                    className="select-fun w-full"
                                >
                                    <option value="">Okulunu Se√ß</option>
                                    {schools.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            {mode === "register" && (
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-white/60 text-sm font-bold mb-2 block">üë§ Ad Soyad</label>
                                        <input 
                                            placeholder="Adƒ±n Soyadƒ±n" 
                                            value={name} 
                                            onChange={e => setName(e.target.value)} 
                                            className="input-fun w-full"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-white/60 text-sm font-bold mb-2 block">üìö Sƒ±nƒ±f</label>
                                        <input 
                                            placeholder="5-A" 
                                            value={cls} 
                                            onChange={e => setCls(e.target.value)} 
                                            className="input-fun w-full"
                                        />
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-white/60 text-sm font-bold mb-2 block">üî¢ Numara</label>
                                    <input 
                                        placeholder="1234" 
                                        value={number} 
                                        onChange={e => setNumber(e.target.value)} 
                                        className="input-fun w-full text-center"
                                    />
                                </div>
                                <div>
                                    <label className="text-white/60 text-sm font-bold mb-2 block">üîí ≈ûifre</label>
                                    <input 
                                        type="password" 
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)} 
                                        className="input-fun w-full text-center"
                                    />
                                </div>
                            </div>

                            <button onClick={doAuth} className="btn-fun btn-primary w-full mt-4">
                                {mode === "login" ? "üöÄ Giri≈ü Yap" : "‚ú® Kayƒ±t Ol"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // üéÆ GAME SHELL
        const GameShell = ({ gameId, playerRole, onBack, onWin }) => {
            const [gameData, setGameData] = useState(null);
            const [showQuitNotice, setShowQuitNotice] = useState(false);

            useEffect(() => {
                const sub = window.dbOnValue(window.dbRef(window.db, 'games/' + gameId), (s) => setGameData(s.val()));
                return () => sub();
            }, [gameId]);

            useEffect(() => {
                if (gameData?.winner && gameData.winner !== 'Berabere') {
                    createConfetti();
                }
                // Rakip √ßƒ±ktƒ±ysa bildiri g√∂ster ve kazan√ß i≈üle
                if (gameData?.endReason === 'quit' && gameData?.quitter) {
                    const myName = playerRole === 'P1' ? gameData.players?.p1?.name : gameData.players?.p2?.name;
                    if (gameData.quitter !== myName && !showQuitNotice) {
                        setShowQuitNotice(true);
                        // Rakip terk ettiƒüi i√ßin kazandƒ±n - onWin √ßaƒüƒ±r
                        if (onWin && gameData.type) {
                            onWin(gameData.type);
                        }
                    }
                }
            }, [gameData?.winner, gameData?.endReason, gameData?.quitter, playerRole, showQuitNotice, onWin]);

            if (!gameData) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center">
                        <div className="text-6xl mb-4 bounce">‚è≥</div>
                        <p className="text-white/60 font-bold">Oyun Y√ºkleniyor...</p>
                    </div>
                );
            }

            const gameTypeEmoji = { mangala: 'üéØ', reversi: '‚ö´', pentago: 'üîÆ' };
            const gameTypeName = { mangala: 'Mangala', reversi: 'Reversi', pentago: 'Pentago' };

            return (
                <div className="w-full h-full flex flex-col pc-container glass-card-dark overflow-hidden">
                    {/* Rakip √áƒ±ktƒ± Bildirimi */}
                    {showQuitNotice && (
                        <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="glass-card p-8 text-center pop-in max-w-sm">
                                <div className="text-6xl mb-4">üèÉ‚Äç‚ôÇÔ∏è</div>
                                <h2 className="text-2xl font-bold text-white mb-2">Rakip Ayrƒ±ldƒ±!</h2>
                                <p className="text-white/60 mb-2">{gameData?.quitter} oyundan √ßƒ±ktƒ±.</p>
                                <p className="text-green-400 font-bold text-lg mb-6">üèÜ Tebrikler, kazandƒ±n!</p>
                                <button onClick={onBack} className="btn-fun btn-success">
                                    <i className="fas fa-home mr-2"></i> Lobiye D√∂n
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex items-center justify-between px-4 py-3 bg-white/5 border-b border-white/10">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{gameTypeEmoji[gameData.type]}</span>
                            <div>
                                <div className="font-bold text-white">{gameTypeName[gameData.type]}</div>
                                <div className="text-xs text-white/50">Masa #{gameId}</div>
                            </div>
                        </div>
                        
                        {gameData.winner ? (
                            <div className="status-badge bg-gradient-to-r from-yellow-500 to-orange-500 text-white winner-card">
                                üèÜ {gameData.winner}
                            </div>
                        ) : (
                            <div className={`status-badge ${
                                ((playerRole === 'P1' && gameData.isP1Turn) || (playerRole === 'P2' && !gameData.isP1Turn)) 
                                    ? 'status-online' 
                                    : 'status-waiting'
                            }`}>
                                {((playerRole === 'P1' && gameData.isP1Turn) || (playerRole === 'P2' && !gameData.isP1Turn)) 
                                    ? 'üéØ Senin Sƒ±ran' 
                                    : '‚è≥ Bekle'}
                            </div>
                        )}
                        
                        <button onClick={onBack} className="w-10 h-10 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                            <i className="fas fa-times"></i>
                        </button>
                    </div>

                    {/* Game Area */}
                    <div className="flex-1 overflow-hidden">
                        {gameData.type === 'reversi' ? (
                            <ReversiBoard game={gameData} playerRole={playerRole} onMove={useReversiGame(gameData, gameId, playerRole, onWin).makeMove} />
                        ) : gameData.type === 'pentago' ? (
                            <PentagoBoard game={gameData} playerRole={playerRole} onPlace={usePentagoGame(gameData, gameId, playerRole, onWin).placeStone} onRotate={usePentagoGame(gameData, gameId, playerRole, onWin).doRotate} />
                        ) : (
                            <MangalaBoard game={gameData} playerRole={playerRole} onMove={useMangalaGame(gameData, gameId, playerRole, onWin).moveStone} />
                        )}
                    </div>
                </div>
            );
        };

        // üéØ MAIN APP
        const App = () => {
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState("loading");
            const [gameId, setGameId] = useState(null);
            const [role, setRole] = useState(null);
            const [showProfile, setShowProfile] = useState(false);
            const [badge, setBadge] = useState(null);

            useEffect(() => {
                const uid = localStorage.getItem("az_uid");
                if (uid) checkUser(uid);
                else setStatus("auth");
            }, []);

            const checkUser = (uid) => {
                window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(s => {
                    if (s.exists()) {
                        setUser(s.val());
                        connectToLobby(s.val(), uid);
                    } else {
                        window.dbGet(window.dbRef(window.db, 'pending_users/' + uid)).then(p => {
                            if (p.exists()) setStatus("pending");
                            else {
                                localStorage.removeItem("az_uid");
                                setStatus("auth");
                            }
                        });
                    }
                });
            };

            const connectToLobby = (u, uid) => {
                const r = window.dbRef(window.db, 'lobby/' + uid);
                window.dbUpdate(r, { name: u.name, class: u.class, schoolName: u.schoolName, state: 'waiting', uid });
                window.dbOnDisconnect(r).remove();
                setStatus("lobby");
            };

            const login = (sid, no, pass) => {
                const uid = `${sid}_${no}`;
                window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(s => {
                    if (s.exists() && s.val().password === pass) {
                        localStorage.setItem("az_uid", uid);
                        setUser(s.val());
                        connectToLobby(s.val(), uid);
                    } else {
                        alert("Hatalƒ± bilgi! üòÖ");
                    }
                });
            };

            const register = (data) => {
                const uid = `${data.schoolId}_${data.number}`;
                window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(s => {
                    if (s.exists()) {
                        alert("Bu numara zaten kayƒ±tlƒ±! üìö");
                    } else {
                        window.dbSet(window.dbRef(window.db, 'pending_users/' + uid), { ...data, badges: [], stats: { wins: 0 }, joinedAt: Date.now() });
                        alert("Kayƒ±t tamamlandƒ±! √ñƒüretmen onayƒ± bekleniyor. ‚úÖ");
                        setStatus("auth");
                    }
                });
            };

            const handleWin = async (type) => {
                if (!user) return;
                createConfetti();
                const uid = `${user.schoolId}_${user.number}`;
                const ref = window.dbRef(window.db, 'users/' + uid);
                const s = await window.dbGet(ref);
                let u = s.val();
                
                // ƒ∞statistikleri g√ºncelle
                if (!u.stats) u.stats = { wins: 0, totalGames: 0, streak: 0, mangalaWins: 0, reversiWins: 0, pentagoWins: 0 };
                u.stats.wins = (u.stats.wins || 0) + 1;
                u.stats.totalGames = (u.stats.totalGames || 0) + 1;
                u.stats.streak = (u.stats.streak || 0) + 1;
                
                // Oyun tipine g√∂re galibiyet say
                if (type === 'mangala') u.stats.mangalaWins = (u.stats.mangalaWins || 0) + 1;
                if (type === 'reversi') u.stats.reversiWins = (u.stats.reversiWins || 0) + 1;
                if (type === 'pentago') u.stats.pentagoWins = (u.stats.pentagoWins || 0) + 1;
                
                let badges = u.badges || [];
                let newBadges = [];
                
                // üåü ƒ∞lk Zafer
                if (!badges.includes("first_win") && u.stats.wins >= 1) {
                    badges.push("first_win");
                    newBadges.push("first_win");
                }
                
                // üéØ ƒ∞lk Adƒ±m (ilk oyunu tamamla)
                if (!badges.includes("first_blood") && u.stats.totalGames >= 1) {
                    badges.push("first_blood");
                    newBadges.push("first_blood");
                }
                
                // üéÆ MANGALA ROZETLERƒ∞
                if (!badges.includes("mangala_novice") && u.stats.mangalaWins >= 3) {
                    badges.push("mangala_novice");
                    newBadges.push("mangala_novice");
                }
                if (!badges.includes("mangala_master") && u.stats.mangalaWins >= 10) {
                    badges.push("mangala_master");
                    newBadges.push("mangala_master");
                }
                if (!badges.includes("mangala_legend") && u.stats.mangalaWins >= 25) {
                    badges.push("mangala_legend");
                    newBadges.push("mangala_legend");
                }
                
                // üéÆ REVERSƒ∞ ROZETLERƒ∞
                if (!badges.includes("reversi_novice") && u.stats.reversiWins >= 3) {
                    badges.push("reversi_novice");
                    newBadges.push("reversi_novice");
                }
                if (!badges.includes("reversi_brain") && u.stats.reversiWins >= 10) {
                    badges.push("reversi_brain");
                    newBadges.push("reversi_brain");
                }
                if (!badges.includes("reversi_genius") && u.stats.reversiWins >= 25) {
                    badges.push("reversi_genius");
                    newBadges.push("reversi_genius");
                }
                
                // üéÆ PENTAGO ROZETLERƒ∞
                if (!badges.includes("pentago_novice") && u.stats.pentagoWins >= 3) {
                    badges.push("pentago_novice");
                    newBadges.push("pentago_novice");
                }
                if (!badges.includes("pentago_pro") && u.stats.pentagoWins >= 10) {
                    badges.push("pentago_pro");
                    newBadges.push("pentago_pro");
                }
                if (!badges.includes("pentago_master") && u.stats.pentagoWins >= 25) {
                    badges.push("pentago_master");
                    newBadges.push("pentago_master");
                }
                
                // üî• SERƒ∞ ROZETLERƒ∞
                if (!badges.includes("streak_3") && u.stats.streak >= 3) {
                    badges.push("streak_3");
                    newBadges.push("streak_3");
                }
                if (!badges.includes("streak_5") && u.stats.streak >= 5) {
                    badges.push("streak_5");
                    newBadges.push("streak_5");
                }
                if (!badges.includes("streak_10") && u.stats.streak >= 10) {
                    badges.push("streak_10");
                    newBadges.push("streak_10");
                }
                
                // üèÜ TOPLAM GALƒ∞Bƒ∞YET ROZETLERƒ∞
                if (!badges.includes("wins_5") && u.stats.wins >= 5) {
                    badges.push("wins_5");
                    newBadges.push("wins_5");
                }
                if (!badges.includes("wins_10") && u.stats.wins >= 10) {
                    badges.push("wins_10");
                    newBadges.push("wins_10");
                }
                if (!badges.includes("wins_25") && u.stats.wins >= 25) {
                    badges.push("wins_25");
                    newBadges.push("wins_25");
                }
                if (!badges.includes("wins_50") && u.stats.wins >= 50) {
                    badges.push("wins_50");
                    newBadges.push("wins_50");
                }
                if (!badges.includes("wins_100") && u.stats.wins >= 100) {
                    badges.push("wins_100");
                    newBadges.push("wins_100");
                }
                
                // üåà √áOKLU OYUN ROZETLERƒ∞
                if (!badges.includes("all_rounder") && 
                    u.stats.mangalaWins >= 1 && u.stats.reversiWins >= 1 && u.stats.pentagoWins >= 1) {
                    badges.push("all_rounder");
                    newBadges.push("all_rounder");
                }
                if (!badges.includes("triple_master") && 
                    u.stats.mangalaWins >= 5 && u.stats.reversiWins >= 5 && u.stats.pentagoWins >= 5) {
                    badges.push("triple_master");
                    newBadges.push("triple_master");
                }
                if (!badges.includes("ultimate_champion") && 
                    u.stats.mangalaWins >= 15 && u.stats.reversiWins >= 15 && u.stats.pentagoWins >= 15) {
                    badges.push("ultimate_champion");
                    newBadges.push("ultimate_champion");
                }
                
                // üéì VETERAN ROZETLERƒ∞
                if (!badges.includes("veteran") && u.stats.totalGames >= 50) {
                    badges.push("veteran");
                    newBadges.push("veteran");
                }
                if (!badges.includes("legend") && u.stats.totalGames >= 100) {
                    badges.push("legend");
                    newBadges.push("legend");
                }
                
                u.badges = badges;
                await window.dbUpdate(ref, u);
                setUser(u);
                
                // Yeni rozet bildirimi g√∂ster (sƒ±rayla)
                if (newBadges.length > 0) {
                    for (let i = 0; i < newBadges.length; i++) {
                        setTimeout(() => {
                            setBadge(BADGES[newBadges[i]]);
                            setTimeout(() => setBadge(null), 3500);
                        }, i * 4000);
                    }
                }
            };
            
            // Oyun kaybedince seri sƒ±fƒ±rla
            const handleLose = async () => {
                if (!user) return;
                const uid = `${user.schoolId}_${user.number}`;
                const ref = window.dbRef(window.db, 'users/' + uid);
                await window.dbUpdate(ref, { 'stats/streak': 0, 'stats/totalGames': (user.stats?.totalGames || 0) + 1 });
            };

            useEffect(() => {
                if (status !== "lobby" || !user) return;
                const sub = window.dbOnValue(window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`), (s) => {
                    const d = s.val();
                    if (d && d.gameId) {
                        setGameId(d.gameId);
                        setRole(d.role);
                        setStatus("playing");
                    }
                });
                return () => sub();
            }, [status, user]);

            // Loading Screen
            if (status === "loading") {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center">
                        <div className="text-8xl mb-6 bounce">üéÆ</div>
                        <h1 className="text-3xl font-bold rainbow-text mb-4">AKIL ZEKA</h1>
                        <div className="flex gap-2">
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0s' }}></div>
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                        </div>
                    </div>
                );
            }

            // Auth Screen
            if (status === "auth") {
                return (
                    <div className="w-full h-full pc-container">
                        <AuthScreen onLogin={login} onRegister={register} />
                    </div>
                );
            }

            // Pending Screen
            if (status === "pending") {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center text-center p-4">
                        <div className="glass-card p-8 max-w-sm pop-in">
                            <div className="text-6xl mb-4 wave">‚è≥</div>
                            <h2 className="text-2xl font-bold text-white mb-2">Onay Bekleniyor</h2>
                            <p className="text-white/60 mb-6">√ñƒüretmenin kaydƒ±nƒ± onaylamasƒ±nƒ± bekle!</p>
                            <button 
                                onClick={() => { localStorage.removeItem("az_uid"); setStatus("auth"); }}
                                className="btn-fun btn-primary"
                            >
                                üîô Geri D√∂n
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-full flex items-center justify-center">
                    {/* Badge Notification - Geli≈ütirilmi≈ü */}
                    {badge && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none">
                            <div className="relative">
                                {/* Arka plan efekti */}
                                <div className="absolute inset-0 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 rounded-3xl blur-3xl opacity-50 animate-pulse scale-150"></div>
                                
                                {/* Ana kart */}
                                <div className="glass-card p-8 text-center pop-in relative overflow-hidden">
                                    {/* Parƒ±ltƒ± efekti */}
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 animate-pulse"></div>
                                    
                                    {/* ƒ∞√ßerik */}
                                    <div className="relative">
                                        <div className="text-xs text-white/60 font-bold mb-2">‚ú® YENƒ∞ ROZET KAZANDIN! ‚ú®</div>
                                        <div className="w-24 h-24 mx-auto mb-4 rounded-2xl flex items-center justify-center text-6xl bounce" 
                                             style={{ background: `linear-gradient(135deg, ${badge.color}40, ${badge.color}80)`, border: `3px solid ${badge.color}` }}>
                                            {badge.icon}
                                        </div>
                                        <div className="text-2xl font-bold text-white mb-2">{badge.name}</div>
                                        <div className="text-sm text-white/60">{badge.desc}</div>
                                        <div className="mt-3 inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold"
                                             style={{ background: `${badge.color}30`, color: badge.color }}>
                                            {badge.rarity && RARITY_NAMES[badge.rarity]}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Profile Modal */}
                    {showProfile && (
                        <ProfileModal 
                            user={user} 
                            onClose={() => setShowProfile(false)} 
                            onLogout={() => {
                                if (confirm("√áƒ±kƒ±≈ü yapmak istediƒüine emin misin? ü§î")) {
                                    window.dbRemove(window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`));
                                    localStorage.removeItem("az_uid");
                                    setStatus("auth");
                                    setShowProfile(false);
                                }
                            }}
                        />
                    )}

                    {/* Lobby */}
                    {status === "lobby" && (
                        <div className="w-full h-full flex flex-col items-center justify-center p-4 pc-container relative">
                            {/* Profile Button */}
                            <button 
                                onClick={() => setShowProfile(true)}
                                className="absolute top-6 right-6 glass-card px-4 py-2 flex items-center gap-2 hover:bg-white/20 transition cursor-pointer z-50"
                            >
                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">
                                    {user.name.charAt(0)}
                                </div>
                                <span className="font-bold text-white hidden sm:block">{user.name.split(' ')[0]}</span>
                            </button>

                            {/* Lobby Card */}
                            <div className="glass-card p-10 max-w-md w-full text-center pop-in">
                                <div className="text-8xl mb-6 bounce">üéÆ</div>
                                <h2 className="text-3xl font-bold text-white mb-2">Rakip Aranƒ±yor</h2>
                                <p className="text-white/60 mb-6">{user.schoolName}</p>
                                
                                <div className="flex justify-center gap-4 mb-8">
                                    <div className="w-4 h-4 rounded-full bg-purple-500 animate-bounce" style={{ animationDelay: '0s' }}></div>
                                    <div className="w-4 h-4 rounded-full bg-pink-500 animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                    <div className="w-4 h-4 rounded-full bg-blue-500 animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                </div>

                                <div className="status-badge status-online mx-auto">
                                    <span className="w-2 h-2 rounded-full bg-white animate-pulse"></span>
                                    Lobiye Baƒülandƒ±
                                </div>
                            </div>

                            {/* Fun Info */}
                            <div className="mt-8 text-center">
                                <p className="text-white/40 text-sm">
                                    üí° √ñƒüretmenin turnuvayƒ± ba≈ülatmasƒ±nƒ± bekle!
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Playing */}
                    {status === "playing" && (
                        <GameShell 
                            gameId={gameId} 
                            playerRole={role} 
                            onWin={handleWin}
                            onBack={async () => {
                                // Oyundan √ßƒ±kƒ±ldƒ±ƒüƒ±nda oyunu iptal et
                                if (gameId) {
                                    try {
                                        // Oyun verisini al
                                        const gameSnap = await window.dbGet(window.dbRef(window.db, 'games/' + gameId));
                                        if (gameSnap.exists()) {
                                            const gameData = gameSnap.val();
                                            // Eƒüer oyun hen√ºz bitmemi≈üse, √ßƒ±kan oyuncuyu kaybeden yap
                                            if (!gameData.winner) {
                                                const winnerName = role === 'P1' ? gameData.players.p2.name : gameData.players.p1.name;
                                                const quitterName = role === 'P1' ? gameData.players.p1.name : gameData.players.p2.name;
                                                await window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { 
                                                    winner: winnerName,
                                                    endReason: 'quit',
                                                    quitter: quitterName,
                                                    endedAt: Date.now()
                                                });
                                                // √áƒ±kan oyuncunun seri skorunu sƒ±fƒ±rla (kaybetti sayƒ±lƒ±r)
                                                await handleLose();
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Oyun iptal edilirken hata:', e);
                                    }
                                }
                                setStatus("lobby");
                                setGameId(null);
                                setRole(null);
                                window.dbUpdate(window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`), { state: 'waiting', gameId: null, role: null });
                            }}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
