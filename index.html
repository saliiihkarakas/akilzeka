<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üéÆ Akƒ±l Zeka Oyunlarƒ± - Eƒülenceli D√ºnya</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Baloo+2:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // üîå Connection State Monitoring
        const connectedRef = ref(db, '.info/connected');
        window.isFirebaseConnected = false;
        onValue(connectedRef, (snap) => {
            window.isFirebaseConnected = snap.val() === true;
            window.dispatchEvent(new CustomEvent('firebase-connection', { detail: snap.val() }));
        });
        
        // üì¶ Offline Operation Queue
        window.pendingOperations = [];
        window.processingQueue = false;
        
        const processOfflineQueue = async () => {
            if (window.processingQueue || !window.isFirebaseConnected) return;
            window.processingQueue = true;
            
            while (window.pendingOperations.length > 0 && window.isFirebaseConnected) {
                const op = window.pendingOperations.shift();
                try {
                    await op.execute();
                } catch (error) {
                    console.error('Offline operation failed:', error);
                    if (op.critical) {
                        window.pendingOperations.unshift(op);
                        break;
                    }
                }
            }
            window.processingQueue = false;
        };
        
        // üîÑ Safe Firebase Operations with Timeout & Retry
        const safeDbSet = async (refPath, data, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Set timeout')), 10000)
                    );
                    await Promise.race([set(refPath, data), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Set Failed:', error);
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            return false;
        };
        
        const safeDbUpdate = async (refPath, data, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Update timeout')), 10000)
                    );
                    await Promise.race([update(refPath, data), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Update Failed:', error);
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            return false;
        };
        
        const safeDbRemove = async (refPath, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Remove timeout')), 10000)
                    );
                    await Promise.race([remove(refPath), timeoutPromise]);
                    return true;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error('Firebase Remove Failed:', error);
                        return false;
                    }
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
            return false;
        };
        
        window.db = db; 
        window.dbRef = ref; 
        window.dbSet = safeDbSet; 
        window.dbOnValue = onValue; 
        window.dbUpdate = safeDbUpdate; 
        window.dbOnDisconnect = onDisconnect; 
        window.dbGet = get; 
        window.dbRemove = safeDbRemove;
        window.processOfflineQueue = processOfflineQueue;
        
        // ‚ö†Ô∏è Global Error Handlers
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled Promise Rejection:', event.reason);
            event.preventDefault();
        });
        
        window.addEventListener('error', (event) => {
            console.error('Global Error:', event.error);
        });
    </script>

    <style>
        * { box-sizing: border-box; }
        
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; 
            font-family: 'Fredoka', 'Baloo 2', sans-serif;
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; 
            user-select: none;
        }
        
        /* üéÆ Game boards should allow touch for interactions */
        .game-board, .pit, button, input, select {
            touch-action: manipulation;
        }

        /* üåà MAGICAL ANIMATED BACKGROUND */
        .magic-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ‚ú® FLOATING PARTICLES */
        .particles {
            position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
        }
        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
            opacity: 0.6;
        }
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* üåü STARS */
        .stars {
            position: fixed; inset: 0; pointer-events: none; z-index: 0;
        }
        .star {
            position: absolute;
            width: 4px; height: 4px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* üé® GLASS MORPHISM CARDS */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 
                        inset 0 0 32px rgba(255, 255, 255, 0.1);
        }

        .glass-card-dark {
            background: rgba(30, 30, 60, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* üéØ FUN BUTTONS - Mobil optimize */
        .btn-fun {
            position: relative;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 8px 16px rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .btn-fun:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 0 rgba(0,0,0,0.2), 0 12px 24px rgba(0,0,0,0.3);
        }
        .btn-fun:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.2);
        }
        
        @media (min-width: 640px) {
            .btn-fun {
                padding: 16px 32px;
                font-size: 1.1rem;
                box-shadow: 0 6px 0 rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.2);
            }
            .btn-fun:hover {
                box-shadow: 0 10px 0 rgba(0,0,0,0.2), 0 15px 30px rgba(0,0,0,0.3);
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* üéÆ GAME PIT STYLES */
        .pit {
            position: relative;
            background: linear-gradient(145deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5));
            border-radius: 50%;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 
                        0 2px 5px rgba(255,255,255,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .pit:hover {
            transform: scale(1.05);
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 
                        0 0 20px rgba(255,255,255,0.3);
        }
        .pit:active {
            transform: scale(0.95);
        }
        .pit-active {
            animation: pulseGlow 1.5s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 10px rgba(46, 213, 115, 0.5); }
            50% { box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 30px rgba(46, 213, 115, 0.8); }
        }
        
        /* üì± Mobile Performance Optimizations */
        @media (max-width: 768px) {
            .glass-card {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            .glass-card-dark {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            /* Reduce particle animations on mobile */
            .particle {
                animation-duration: 30s;
            }
            
            .star {
                animation-duration: 3s;
            }
        }
        
        /* ‚ö° Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* üîÆ MARBLE STONES */
        .marble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd700 40%, #ff8c00 100%);
            box-shadow: inset -2px -2px 6px rgba(0,0,0,0.4), 
                        inset 2px 2px 6px rgba(255,255,255,0.8),
                        0 3px 6px rgba(0,0,0,0.4);
            animation: marbleBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .marble-opponent {
            background: radial-gradient(circle at 30% 30%, #fff 0%, #00d4ff 40%, #0099cc 100%);
        }
        @keyframes marbleBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* üéØ MANGALA STONE MOVEMENT ANIMATION - ƒ∞yile≈ütirilmi≈ü */
        @keyframes stoneMove {
            0% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
                filter: brightness(1);
            }
            20% { 
                transform: scale(1.4) translateY(-30px); 
                filter: brightness(1.3);
            }
            40% { 
                transform: scale(1.2) translateY(-40px) translateX(-5px); 
            }
            60% { 
                transform: scale(1.1) translateY(-25px) translateX(5px); 
                opacity: 0.8;
            }
            80% { 
                transform: scale(0.8) translateY(-10px); 
                opacity: 0.4;
            }
            100% { 
                opacity: 0; 
                transform: scale(0.3) translateY(0); 
                filter: brightness(0.5);
            }
        }
        .stone-moving {
            animation: stoneMove 0.6s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
            position: relative;
            z-index: 10;
        }
        
        /* üß© KULAMI ANIMATIONS */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px rgba(34, 197, 94, 0.8), 0 0 25px rgba(34, 197, 94, 0.4);
                transform: scale(1.05);
            }
        }
        .kulami-valid-cell {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        /* üåä STONE LANDING ANIMATION - ƒ∞yile≈ütirilmi≈ü */
        @keyframes stoneLand {
            0% { 
                transform: scale(0) translateY(-50px) rotate(-180deg); 
                opacity: 0;
                filter: brightness(1.5);
            }
            40% { 
                transform: scale(1.5) translateY(-5px) rotate(-90deg); 
                opacity: 1;
                filter: brightness(1.3);
            }
            70% { 
                transform: scale(0.9) translateY(5px) rotate(-20deg); 
                filter: brightness(1.1);
            }
            85% { 
                transform: scale(1.1) translateY(-2px) rotate(5deg); 
            }
            100% { 
                transform: scale(1) translateY(0) rotate(0deg); 
                opacity: 1;
                filter: brightness(1);
            }
        }
        .stone-landing {
            animation: stoneLand 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            position: relative;
            z-index: 5;
        }
        
        /* ‚ú® PIT HIGHLIGHT ANIMATION - ƒ∞yile≈ütirilmi≈ü */
        @keyframes pitHighlight {
            0% { 
                box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 0 rgba(255,215,0,0);
                transform: scale(1);
            }
            25% { 
                box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 25px rgba(255,215,0,1), 0 0 40px rgba(255,215,0,0.6);
                transform: scale(1.08);
            }
            50% { 
                box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 30px rgba(255,215,0,1), 0 0 50px rgba(255,215,0,0.8);
                transform: scale(1.05);
            }
            75% { 
                box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 20px rgba(255,215,0,0.8);
                transform: scale(1.03);
            }
            100% { 
                box-shadow: inset 0 4px 15px rgba(0,0,0,0.6), 0 0 0 rgba(255,215,0,0);
                transform: scale(1);
            }
        }
        .pit-highlight {
            animation: pitHighlight 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* üì± RESPONSIVE */
        @media (min-width: 1024px) {
            .pc-container {
                max-width: 1100px;
                height: 90vh;
                margin: auto;
                border-radius: 32px;
                overflow: hidden;
            }
        }

        /* üéâ CONFETTI */
        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px; height: 10px;
            animation: confettiFall 3s linear forwards;
        }

        /* üåà RAINBOW TEXT */
        .rainbow-text {
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbowMove 3s linear infinite;
        }
        @keyframes rainbowMove {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* ‚≠ê BOUNCE ANIMATION */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .bounce { animation: bounce 2s ease-in-out infinite; }

        /* üé™ POP IN */
        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* üåä WAVE */
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        .wave { animation: wave 1s ease-in-out infinite; display: inline-block; }
        
        /* üîÑ PENTAGO QUADRANT ROTATION - ƒ∞yile≈ütirilmi≈ü */
        @keyframes rotateClockwise {
            0% { 
                transform: rotate(0deg) scale(1); 
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(139, 92, 246, 0);
            }
            25% { 
                transform: rotate(30deg) scale(1.12); 
                filter: brightness(1.2);
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
            }
            50% { 
                transform: rotate(60deg) scale(1.15); 
                filter: brightness(1.3);
                box-shadow: 0 0 30px rgba(139, 92, 246, 0.8);
            }
            75% { 
                transform: rotate(85deg) scale(1.08); 
                filter: brightness(1.15);
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
            }
            100% { 
                transform: rotate(90deg) scale(1); 
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(139, 92, 246, 0);
            }
        }
        @keyframes rotateCounterClockwise {
            0% { 
                transform: rotate(0deg) scale(1); 
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(236, 72, 153, 0);
            }
            25% { 
                transform: rotate(-30deg) scale(1.12); 
                filter: brightness(1.2);
                box-shadow: 0 0 20px rgba(236, 72, 153, 0.6);
            }
            50% { 
                transform: rotate(-60deg) scale(1.15); 
                filter: brightness(1.3);
                box-shadow: 0 0 30px rgba(236, 72, 153, 0.8);
            }
            75% { 
                transform: rotate(-85deg) scale(1.08); 
                filter: brightness(1.15);
                box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
            }
            100% { 
                transform: rotate(-90deg) scale(1); 
                filter: brightness(1);
                box-shadow: 0 0 0 rgba(236, 72, 153, 0);
            }
        }
        .rotating-cw {
            animation: rotateClockwise 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform-origin: center center;
            position: relative;
            z-index: 10;
        }
        .rotating-ccw {
            animation: rotateCounterClockwise 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform-origin: center center;
            position: relative;
            z-index: 10;
        }

        /* üéØ PENTAGO MARBLE ROTATION EFFECT */
        .rotating-cw > div > div {
            animation: marbleRotateCW 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .rotating-ccw > div > div {
            animation: marbleRotateCCW 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes marbleRotateCW {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(180deg); }
        }
        @keyframes marbleRotateCCW {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(-180deg); }
        }

        /* üí´ GLOW */
        .glow {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor;
        }

        /* üéØ STATUS BADGE - Mobil optimize */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        @media (min-width: 640px) {
            .status-badge {
                gap: 8px;
                padding: 8px 16px;
                font-size: 0.85rem;
            }
        }
        
        .status-online {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white;
        }
        .status-waiting {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        /* üèÜ WINNER MODAL */
        @keyframes winnerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .winner-card {
            animation: winnerPulse 1s ease-in-out infinite;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        /* INPUT STYLES - Mobil optimize */
        .input-fun {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px 14px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .input-fun:focus {
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        .input-fun::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        @media (min-width: 640px) {
            .input-fun {
                border-radius: 16px;
                padding: 14px 18px;
                font-size: 1rem;
            }
            .input-fun:focus {
                box-shadow: 0 0 20px rgba(255,255,255,0.2);
            }
        }

        /* SELECT STYLES - Mobil optimize */
        .select-fun {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px 14px;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .select-fun option {
            background: #2d1f4e;
            color: white;
        }
        
        @media (min-width: 640px) {
            .select-fun {
                border-radius: 16px;
                padding: 14px 18px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- üåà Animated Background -->
    <div class="magic-bg"></div>
    
    <!-- ‚ú® Floating Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- üåü Twinkling Stars -->
    <div class="stars" id="stars"></div>
    
    <div id="root" class="w-full h-full relative z-10"></div>

    <script>
        // Create floating particles
        const particlesContainer = document.getElementById('particles');
        const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'];
        
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 30 + 10 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = Math.random() * 10 + 15 + 's';
            particlesContainer.appendChild(particle);
        }

        // Create twinkling stars
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // üèÜ KAPSAMLI ROZET Sƒ∞STEMƒ∞
        const BADGES = {
            // üåü BA≈ûLANGI√á ROZETLERƒ∞
            first_win: { icon: "‚≠ê", name: "ƒ∞lk Zafer", desc: "ƒ∞lk galibiyetini kazan", color: "#ffd700", rarity: "common" },
            first_blood: { icon: "üéØ", name: "ƒ∞lk Adƒ±m", desc: "ƒ∞lk oyununu tamamla", color: "#4ade80", rarity: "common" },
            
            // üéÆ OYUN USTALIƒûI ROZETLERƒ∞
            mangala_novice: { icon: "ü•â", name: "Mangala √áƒ±raƒüƒ±", desc: "Mangala'da 3 galibiyet", color: "#cd7f32", rarity: "common" },
            mangala_master: { icon: "ü¶Å", name: "Mangala Ustasƒ±", desc: "Mangala'da 10 galibiyet", color: "#ff9f43", rarity: "rare" },
            mangala_legend: { icon: "üëë", name: "Mangala Kralƒ±", desc: "Mangala'da 25 galibiyet", color: "#ffd700", rarity: "legendary" },
            
            reversi_novice: { icon: "üé≤", name: "Reversi Ba≈ülangƒ±√ß", desc: "Reversi'de 3 galibiyet", color: "#22d3ee", rarity: "common" },
            reversi_brain: { icon: "üß†", name: "Strateji Dehasƒ±", desc: "Reversi'de 10 galibiyet", color: "#54a0ff", rarity: "rare" },
            reversi_genius: { icon: "üîÆ", name: "Reversi B√ºy√ºc√ºs√º", desc: "Reversi'de 25 galibiyet", color: "#a855f7", rarity: "legendary" },
            
            pentago_novice: { icon: "üéØ", name: "Pentago Acemi", desc: "Pentago'da 3 galibiyet", color: "#f472b6", rarity: "common" },
            pentago_pro: { icon: "üíé", name: "Pentago Pro", desc: "Pentago'da 10 galibiyet", color: "#5f27cd", rarity: "rare" },
            pentago_master: { icon: "üåü", name: "Pentago Efsanesi", desc: "Pentago'da 25 galibiyet", color: "#ec4899", rarity: "legendary" },
            
            kulami_novice: { icon: "üß©", name: "Kulami √áƒ±raƒüƒ±", desc: "Kulami'de 3 galibiyet", color: "#e74c3c", rarity: "common" },
            kulami_master: { icon: "üéØ", name: "Kulami Ustasƒ±", desc: "Kulami'de 10 galibiyet", color: "#c0392b", rarity: "rare" },
            kulami_legend: { icon: "üíé", name: "Kulami Efsanesi", desc: "Kulami'de 25 galibiyet", color: "#ff6b6b", rarity: "legendary" },
            
            kure_novice: { icon: "üåç", name: "K√ºre Acemi", desc: "K√ºre'de 3 galibiyet", color: "#4CAF50", rarity: "common" },
            kure_master: { icon: "üåé", name: "K√ºre Ustasƒ±", desc: "K√ºre'de 10 galibiyet", color: "#2196F3", rarity: "rare" },
            kure_legend: { icon: "üåè", name: "K√ºre Efsanesi", desc: "K√ºre'de 25 galibiyet", color: "#9C27B0", rarity: "epic" },
            
            qbitz_novice: { icon: "üé≤", name: "Q-bitz Acemi", desc: "Q-bitz'de 3 galibiyet", color: "#4CAF50", rarity: "common" },
            qbitz_master: { icon: "üéØ", name: "Q-bitz Ustasƒ±", desc: "Q-bitz'de 10 galibiyet", color: "#2196F3", rarity: "rare" },
            qbitz_legend: { icon: "üèÜ", name: "Q-bitz Efsanesi", desc: "Q-bitz'de 25 galibiyet", color: "#9C27B0", rarity: "epic" },
            
            // üî• SERƒ∞ ROZETLERƒ∞
            streak_3: { icon: "üî•", name: "Ate≈ü Ba≈üladƒ±", desc: "3 ma√ß √ºst √ºste kazan", color: "#f97316", rarity: "common" },
            streak_5: { icon: "üí•", name: "Durdurulamaz", desc: "5 ma√ß √ºst √ºste kazan", color: "#ef4444", rarity: "rare" },
            streak_10: { icon: "‚òÑÔ∏è", name: "Meteor", desc: "10 ma√ß √ºst √ºste kazan", color: "#dc2626", rarity: "epic" },
            
            // üèÜ TOPLAM GALƒ∞Bƒ∞YET ROZETLERƒ∞
            wins_5: { icon: "üéñÔ∏è", name: "Yƒ±ldƒ±z Aday", desc: "Toplam 5 galibiyet", color: "#84cc16", rarity: "common" },
            wins_10: { icon: "üèÖ", name: "Bronz ≈ûampiyon", desc: "Toplam 10 galibiyet", color: "#cd7f32", rarity: "common" },
            wins_25: { icon: "ü•à", name: "G√ºm√º≈ü ≈ûampiyon", desc: "Toplam 25 galibiyet", color: "#c0c0c0", rarity: "rare" },
            wins_50: { icon: "ü•á", name: "Altƒ±n ≈ûampiyon", desc: "Toplam 50 galibiyet", color: "#ffd700", rarity: "epic" },
            wins_100: { icon: "üíé", name: "Elmas ≈ûampiyon", desc: "Toplam 100 galibiyet", color: "#06b6d4", rarity: "legendary" },
            
            // üåà √áOKLU OYUN ROZETLERƒ∞
            all_rounder: { icon: "üåà", name: "√áok Y√∂nl√º", desc: "6 oyunun her birinden 1 galibiyet", color: "#8b5cf6", rarity: "rare" },
            triple_master: { icon: "üé™", name: "Altƒ±lƒ± Usta", desc: "6 oyunun her birinden 5 galibiyet", color: "#f43f5e", rarity: "epic" },
            ultimate_champion: { icon: "üë∏", name: "S√ºper ≈ûampiyon", desc: "6 oyunun her birinden 15 galibiyet", color: "#fbbf24", rarity: "legendary" },
            
            // ‚ö° √ñZEL ROZETLER
            comeback_king: { icon: "‚ö°", name: "Geri D√∂n√º≈ü Kralƒ±", desc: "Kaybederken geri d√∂n ve kazan", color: "#eab308", rarity: "rare" },
            speed_demon: { icon: "üöÄ", name: "Hƒ±z ≈ûeytanƒ±", desc: "2 dakikadan kƒ±sa s√ºrede kazan", color: "#f43f5e", rarity: "rare" },
            perfect_game: { icon: "üíØ", name: "M√ºkemmel Oyun", desc: "Mangala'da 30+ ta≈ü farkla kazan", color: "#10b981", rarity: "epic" },
            
            // üéâ SOSYAL ROZETLER
            social_butterfly: { icon: "ü¶ã", name: "Sosyal Kelebek", desc: "10 farklƒ± rakiple oyna", color: "#d946ef", rarity: "rare" },
            veteran: { icon: "üéì", name: "Veteran", desc: "50 oyun tamamla", color: "#6366f1", rarity: "epic" },
            legend: { icon: "üåü", name: "Efsane", desc: "100 oyun tamamla", color: "#eab308", rarity: "legendary" },
            
            // üéÅ √ñZEL ROZETLER (√ñƒüretmen tarafƒ±ndan verilebilir)
            tournament_winner: { icon: "üèÜ", name: "Turnuva ≈ûampiyonu", desc: "Okul turnuvasƒ±nƒ± kazan", color: "#fbbf24", rarity: "legendary" },
            fair_play: { icon: "ü§ù", name: "Fair Play", desc: "√ñrnek sporcu davranƒ±≈üƒ±", color: "#14b8a6", rarity: "special" },
            rising_star: { icon: "üí´", name: "Y√ºkselen Yƒ±ldƒ±z", desc: "En √ßok geli≈üen oyuncu", color: "#f472b6", rarity: "special" },
            brain_master: { icon: "üß©", name: "Beyin Ustasƒ±", desc: "Zeka oyunlarƒ±nda √ºst√ºn ba≈üarƒ±", color: "#8b5cf6", rarity: "special" },
            team_spirit: { icon: "ü§ú", name: "Takƒ±m Ruhu", desc: "Arkada≈ülarƒ±na yardƒ±mcƒ± ol", color: "#06b6d4", rarity: "special" },
            creative_mind: { icon: "üé®", name: "Yaratƒ±cƒ± Zeka", desc: "Farklƒ± stratejiler geli≈ütir", color: "#ec4899", rarity: "special" },
            patience_master: { icon: "üßò", name: "Sabƒ±r Ustasƒ±", desc: "Sabƒ±rlƒ± ve dik katlƒ± oyuncu", color: "#8b5cf6", rarity: "special" },
            quick_learner: { icon: "üìö", name: "Hƒ±zlƒ± √ñƒürenen", desc: "Kurallarƒ± hƒ±zlƒ± √∂ƒüren", color: "#10b981", rarity: "special" },
            helper_badge: { icon: "üß±", name: "Yardƒ±msever", desc: "Diƒüer √∂ƒürencilere destek ol", color: "#f59e0b", rarity: "special" },
            focus_champion: { icon: "üéØ", name: "Odaklanma ≈ûampiyonu", desc: "Y√ºksek konsantrasyon g√∂ster", color: "#ef4444", rarity: "special" },
            strategy_guru: { icon: "üß†", name: "Strateji Gurusu", desc: "M√ºkemmel strateji olu≈ütur", color: "#7c3aed", rarity: "special" },
            respect_badge: { icon: "üôè", name: "Saygƒ± Rozeti", desc: "Rakiplerine saygƒ±lƒ± ol", color: "#059669", rarity: "special" },
            positive_energy: { icon: "‚ú®", name: "Pozitif Enerji", desc: "Olumlu tutum sergile", color: "#fbbf24", rarity: "special" }
        };

        // Rozet nadirlik renkleri
        const RARITY_COLORS = {
            common: { bg: "from-gray-400 to-gray-600", border: "border-gray-400", text: "text-gray-300" },
            rare: { bg: "from-blue-400 to-blue-600", border: "border-blue-400", text: "text-blue-300" },
            epic: { bg: "from-purple-400 to-purple-600", border: "border-purple-400", text: "text-purple-300" },
            legendary: { bg: "from-yellow-400 to-orange-500", border: "border-yellow-400", text: "text-yellow-300" },
            special: { bg: "from-pink-400 to-rose-500", border: "border-pink-400", text: "text-pink-300" }
        };

        const RARITY_NAMES = {
            common: "Yaygƒ±n",
            rare: "Nadir",
            epic: "Epik",
            legendary: "Efsanevi",
            special: "√ñzel"
        };

        // üéâ Confetti Effect
        const createConfetti = () => {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        };

        // --- GAME LOGIC ---
        function useMangalaGame(gameData, gameId, playerRole, onWin) {
            const moveStone = (pitIndex) => {
                if (!gameData || gameData.winner) return;
                const isP1Turn = gameData.isP1Turn;
                const board = (gameData.board || []).map(n => parseInt(n, 10) || 0);

                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                if (isP1Turn && (pitIndex < 0 || pitIndex > 5)) return;
                if (!isP1Turn && (pitIndex < 7 || pitIndex > 12)) return;
                if (board[pitIndex] === 0) return;

                let stones = board[pitIndex];
                let currentIndex = pitIndex;
                board[pitIndex] = 0; 

                if (stones === 1) {
                    currentIndex = (currentIndex + 1) % 14;
                    board[currentIndex] += 1;
                } else {
                    board[currentIndex] = 1; stones--; 
                    while (stones > 0) {
                        currentIndex = (currentIndex + 1) % 14;
                        if (isP1Turn && currentIndex === 13) continue;
                        if (!isP1Turn && currentIndex === 6) continue;
                        board[currentIndex] += 1; stones--;
                    }
                }
                const lastIndex = currentIndex;
                const p1Store = 6; const p2Store = 13;
                const isMyStore = isP1Turn ? lastIndex === p1Store : lastIndex === p2Store;
                const isOpponentSide = isP1Turn ? (lastIndex >= 7 && lastIndex <= 12) : (lastIndex >= 0 && lastIndex <= 5);
                const isMySide = isP1Turn ? (lastIndex >= 0 && lastIndex <= 5) : (lastIndex >= 7 && lastIndex <= 12);
                let nextTurnIsP1 = !isP1Turn;
                if (isMyStore) { nextTurnIsP1 = isP1Turn; }
                else if (isOpponentSide && board[lastIndex] % 2 === 0) {
                    const myStoreIndex = isP1Turn ? p1Store : p2Store;
                    board[myStoreIndex] += board[lastIndex]; board[lastIndex] = 0;
                }
                else if (isMySide && board[lastIndex] === 1) { 
                    const oppositeIndex = 12 - lastIndex;
                    if (board[oppositeIndex] > 0) {
                        const myStoreIndex = isP1Turn ? p1Store : p2Store;
                        board[myStoreIndex] += (board[lastIndex] + board[oppositeIndex]);
                        board[lastIndex] = 0; board[oppositeIndex] = 0;
                    }
                }
                const p1PitSum = board.slice(0, 6).reduce((a, b) => a + b, 0);
                const p2PitSum = board.slice(7, 13).reduce((a, b) => a + b, 0);
                let w = null;
                if (p1PitSum === 0 || p2PitSum === 0) {
                    if (p1PitSum === 0) { board[p1Store] += p2PitSum; for(let i=7; i<=12; i++) board[i] = 0; } 
                    else { board[p2Store] += p1PitSum; for(let i=0; i<=5; i++) board[i] = 0; }
                    if (board[p1Store] > board[p2Store]) w = gameData.players.p1.name;
                    else if (board[p2Store] > board[p1Store]) w = gameData.players.p2.name;
                    else w = "Berabere";
                    if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ? 'P1' : 'P2'; if(wRole === playerRole) onWin('mangala'); }
                }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, isP1Turn: nextTurnIsP1, winner: w });
            };
            return { moveStone };
        }

        function useReversiGame(gameData, gameId, playerRole, onWin) {
            const makeMove = (row, col) => {
                if (!gameData || gameData.winner) return;
                const isP1Turn = gameData.isP1Turn; if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                const myColor = isP1Turn ? 1 : 2; const oppColor = isP1Turn ? 2 : 1; const board = gameData.board;
                if (board[row * 8 + col] !== 0) return;
                let flips = [];
                const directions = [[0,1], [1,0], [0,-1], [-1,0], [1,1], [1,-1], [-1,1], [-1,-1]];
                directions.forEach(([dr, dc]) => { let r = row + dr, c = col + dc; let potential = []; while (r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === oppColor) { potential.push(r*8+c); r += dr; c += dc; } if (potential.length > 0 && r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === myColor) flips.push(...potential); });
                if (flips.length === 0) return;
                let newBoard = [...board]; newBoard[row * 8 + col] = myColor;
                flips.forEach(idx => newBoard[idx] = myColor);
                let w = null; if (!newBoard.includes(0)) { const p1c = newBoard.filter(x => x === 1).length;
                const p2c = newBoard.filter(x => x === 2).length; w = p1c > p2c ?
                gameData.players.p1.name : (p2c > p1c ? gameData.players.p2.name : "Berabere"); if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ?
                'P1' : 'P2'; if(wRole === playerRole) onWin('reversi'); } }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: newBoard, isP1Turn: !isP1Turn, winner: w });
            };
            return { makeMove };
        }

        function usePentagoGame(gameData, gameId, playerRole, onWin) {
            const checkWinner = (board) => {
                const lines = [];
                for (let r = 0; r < 6; r++) {
                    lines.push([r*6, r*6+1, r*6+2, r*6+3, r*6+4]);
                    lines.push([r*6+1, r*6+2, r*6+3, r*6+4, r*6+5]);
                }
                for (let c = 0; c < 6; c++) {
                    lines.push([c, c+6, c+12, c+18, c+24]);
                    lines.push([c+6, c+12, c+18, c+24, c+30]);
                }
                lines.push([0, 7, 14, 21, 28]); lines.push([1, 8, 15, 22, 29]); lines.push([6, 13, 20, 27, 34]);
                lines.push([7, 14, 21, 28, 35]); lines.push([1, 8, 15, 22, 29]); lines.push([2, 9, 16, 23, 30]);
                lines.push([4, 9, 14, 19, 24]); lines.push([5, 10, 15, 20, 25]); lines.push([10, 15, 20, 25, 30]);
                lines.push([3, 8, 13, 18, 23]); lines.push([4, 9, 14, 19, 24]); lines.push([11, 16, 21, 26, 31]);
                
                let p1Wins = false, p2Wins = false;
                lines.forEach(line => {
                    if (line.every(i => board[i] === 1)) p1Wins = true;
                    if (line.every(i => board[i] === 2)) p2Wins = true;
                });
                if (p1Wins && p2Wins) return 'draw';
                if (p1Wins) return 'p1';
                if (p2Wins) return 'p2';
                return null;
            };

            const rotateQuadrant = (board, quadrant, clockwise) => {
                const newBoard = [...board];
                const starts = [0, 3, 18, 21];
                const start = starts[quadrant];
                const offsets = [0, 1, 2, 6, 7, 8, 12, 13, 14];
                const indices = offsets.map(o => start + o);
                const values = indices.map(i => board[i]);
                const cwMap = [6, 3, 0, 7, 4, 1, 8, 5, 2];
                const ccwMap = [2, 5, 8, 1, 4, 7, 0, 3, 6];
                const map = clockwise ? cwMap : ccwMap;
                map.forEach((from, to) => { newBoard[indices[to]] = values[from]; });
                return newBoard;
            };

            const placeStone = (cellIndex) => {
                if (!gameData || gameData.winner || gameData.phase === 'rotate') return;
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                const board = [...gameData.board];
                if (board[cellIndex] !== 0) return;
                const myColor = isP1Turn ? 1 : 2;
                board[cellIndex] = myColor;
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, phase: 'rotate', lastPlaced: cellIndex });
            };

            const doRotate = (quadrant, clockwise) => {
                if (!gameData || gameData.winner || gameData.phase !== 'rotate') return;
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                
                let board = rotateQuadrant([...gameData.board], quadrant, clockwise);
                const result = checkWinner(board);
                
                let w = null;
                if (result === 'p1') { w = gameData.players.p1.name; if(playerRole === 'P1') onWin('pentago'); }
                else if (result === 'p2') { w = gameData.players.p2.name; if(playerRole === 'P2') onWin('pentago'); }
                else if (result === 'draw') { w = 'Berabere'; }
                else if (!board.includes(0)) { w = 'Berabere'; }
                
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, isP1Turn: !isP1Turn, phase: 'place', winner: w, lastPlaced: null });
            };

            return { placeStone, doRotate };
        }

        // üß© KULAMI GAME LOGIC
        function useKulamiGame(gameData, gameId, playerRole, onWin) {
            // Ge√ßerli hamleleri hesapla
            const calculateValidMoves = (panels, lastMove, forbiddenPanel) => {
                const validMoves = [];
                
                if (!lastMove) {
                    // ƒ∞lk hamle - herhangi bir bo≈ü h√ºcreye oynanabilir
                    panels.forEach((panel, panelIdx) => {
                        panel.cells.forEach((cell, cellIdx) => {
                            if (cell.player === 0) {
                                validMoves.push({ panelId: panelIdx, cellIdx });
                            }
                        });
                    });
                    return validMoves;
                }
                
                // Son hamlenin global koordinatlarƒ±nƒ± hesapla
                const lastPanel = panels[lastMove.panelId];
                if (!lastPanel) return validMoves;
                
                const lastCellRow = Math.floor(lastMove.cellIdx / lastPanel.cols);
                const lastCellCol = lastMove.cellIdx % lastPanel.cols;
                
                // Panel'in global koordinatlarƒ± (gridRow, gridCol olarak saklanƒ±yor)
                const lastGlobalRow = (lastPanel.gridRow || 0) + lastCellRow;
                const lastGlobalCol = (lastPanel.gridCol || 0) + lastCellCol;
                
                // T√ºm panelleri kontrol et
                panels.forEach((panel, panelIdx) => {
                    // Yasak panel kontrol√º - son ta≈üƒ±n konulduƒüu panele oynanamaz
                    if (panelIdx === forbiddenPanel) return;
                    
                    panel.cells.forEach((cell, cellIdx) => {
                        if (cell.player !== 0) return; // Dolu h√ºcre
                        
                        const cellRow = Math.floor(cellIdx / panel.cols);
                        const cellCol = cellIdx % panel.cols;
                        const cellGlobalRow = (panel.gridRow || 0) + cellRow;
                        const cellGlobalCol = (panel.gridCol || 0) + cellCol;
                        
                        // Aynƒ± satƒ±r VEYA aynƒ± s√ºtunda mƒ±? (farklƒ± panelde olmalƒ±)
                        if (cellGlobalRow === lastGlobalRow || cellGlobalCol === lastGlobalCol) {
                            validMoves.push({ panelId: panelIdx, cellIdx });
                        }
                    });
                });
                
                return validMoves;
            };
            
            // Puan hesaplama
            const calculateScores = (panels) => {
                let p1Score = 0;
                let p2Score = 0;
                
                panels.forEach(panel => {
                    let p1Count = 0;
                    let p2Count = 0;
                    
                    panel.cells.forEach(cell => {
                        if (cell.player === 1) p1Count++;
                        else if (cell.player === 2) p2Count++;
                    });
                    
                    // Panel puanlamasƒ±
                    const panelPoints = panel.cells.length;
                    if (p1Count > p2Count) {
                        p1Score += panelPoints;
                    } else if (p2Count > p1Count) {
                        p2Score += panelPoints;
                    }
                    // E≈üitlik durumunda kimse puan almaz
                });
                
                return { p1Score, p2Score };
            };
            
            // Oyun bitti mi kontrol√º
            const checkGameOver = (panels) => {
                // T√ºm h√ºcreler dolu mu?
                return panels.every(panel => 
                    panel.cells.every(cell => cell.player !== 0)
                );
            };
            
            // Hamle yapma
            const makeMove = (panelId, cellIdx) => {
                if (!gameData || gameData.winner) return;
                
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                
                const panels = JSON.parse(JSON.stringify(gameData.panels));
                const validMoves = calculateValidMoves(panels, gameData.lastMove, gameData.forbiddenPanel);
                
                // Ge√ßerli hamle mi?
                const isValid = validMoves.some(m => m.panelId === panelId && m.cellIdx === cellIdx);
                if (!isValid) return;
                
                // Hamleyi yap
                const currentPlayer = isP1Turn ? 1 : 2;
                panels[panelId].cells[cellIdx].player = currentPlayer;
                
                const lastMove = { panelId, cellIdx };
                const forbiddenPanel = panelId; // Bu panele bir sonraki turda oy   nanamaz
                
                // Skorlarƒ± hesapla
                const scores = calculateScores(panels);
                
                // Oyun bitti mi?
                const gameOver = checkGameOver(panels);
                let winner = null;
                
                if (gameOver) {
                    if (scores.p1Score > scores.p2Score) {
                        winner = gameData.players.p1.name;
                        if (playerRole === 'P1') onWin('kulami');
                    } else if (scores.p2Score > scores.p1Score) {
                        winner = gameData.players.p2.name;
                        if (playerRole === 'P2') onWin('kulami');
                    } else {
                        winner = 'Berabere';
                    }
                }
                
                // Ge√ßerli hamleleri hesapla (sonraki tur i√ßin)
                const nextValidMoves = gameOver ? [] : calculateValidMoves(panels, lastMove, forbiddenPanel);
                
                // Firebase'i g√ºncelle
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), {
                    panels,
                    lastMove,
                    forbiddenPanel,
                    validMoves: nextValidMoves,
                    p1Score: scores.p1Score,
                    p2Score: scores.p2Score,
                    isP1Turn: !isP1Turn,
                    winner
                });
            };
            
            return { makeMove };
        }

        //   K√úRE GAME LOGIC
        function useKureGame(gameData, gameId, playerRole, onWin) {
            // 7x7 tahta - her h√ºcre 0:bo≈ü, 1:P1, 2:P2
            // Kenardan itme mekaniƒüi
            
            const pushFromEdge = (edge, position) => {
                if (!gameData || gameData.winner) return;
                
                const isP1Turn = gameData.isP1Turn;
                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                
                const board = [...gameData.board];
                const currentPlayer = isP1Turn ? 1 : 2;
                const opponentPlayer = isP1Turn ? 2 : 1;
                let p1Dropped = gameData.p1Dropped || 0;
                let p2Dropped = gameData.p2Dropped || 0;
                
                // Kenardan itme i≈ülemi
                if (edge === 'top') {
                    // position s√ºtunu yukarƒ±dan a≈üaƒüƒ±ya kaydƒ±r
                    const droppedStone = board[6 * 7 + position]; // En alttaki ta≈ü
                    if (droppedStone === opponentPlayer) {
                        if (isP1Turn) p2Dropped++;
                        else p1Dropped++;
                    }
                    
                    // A≈üaƒüƒ±dan yukarƒ±ya kaydƒ±r
                    for (let row = 6; row >= 1; row--) {
                        board[row * 7 + position] = board[(row - 1) * 7 + position];
                    }
                    board[position] = currentPlayer; // En √ºste yeni ta≈ü
                    
                } else if (edge === 'bottom') {
                    // position s√ºtunu a≈üaƒüƒ±dan yukarƒ±ya kaydƒ±r
                    const droppedStone = board[position]; // En √ºstteki ta≈ü
                    if (droppedStone === opponentPlayer) {
                        if (isP1Turn) p2Dropped++;
                        else p1Dropped++;
                    }
                    
                    // Yukarƒ±dan a≈üaƒüƒ±ya kaydƒ±r
                    for (let row = 0; row < 6; row++) {
                        board[row * 7 + position] = board[(row + 1) * 7 + position];
                    }
                    board[6 * 7 + position] = currentPlayer; // En alta yeni ta≈ü
                    
                } else if (edge === 'left') {
                    // position satƒ±rƒ± soldan saƒüa kaydƒ±r
                    const droppedStone = board[position * 7 + 6]; // En saƒüdaki ta≈ü
                    if (droppedStone === opponentPlayer) {
                        if (isP1Turn) p2Dropped++;
                        else p1Dropped++;
                    }
                    
                    // Saƒüdan sola kaydƒ±r
                    for (let col = 6; col >= 1; col--) {
                        board[position * 7 + col] = board[position * 7 + (col - 1)];
                    }
                    board[position * 7] = currentPlayer; // En sola yeni ta≈ü
                    
                } else if (edge === 'right') {
                    // position satƒ±rƒ± saƒüdan sola kaydƒ±r
                    const droppedStone = board[position * 7]; // En soldaki ta≈ü
                    if (droppedStone === opponentPlayer) {
                        if (isP1Turn) p2Dropped++;
                        else p1Dropped++;
                    }
                    
                    // Soldan saƒüa kaydƒ±r
                    for (let col = 0; col < 6; col++) {
                        board[position * 7 + col] = board[position * 7 + (col + 1)];
                    }
                    board[position * 7 + 6] = currentPlayer; // En saƒüa yeni ta≈ü
                }
                
                // Kazanma kontrol√º: Rakipten 3 ta≈ü d√º≈ü√ºrene kadar
                let winner = null;
                if (p1Dropped >= 3) {
                    winner = gameData.players.p1.name;
                    if (playerRole === 'P1') onWin('kure');
                } else if (p2Dropped >= 3) {
                    winner = gameData.players.p2.name;
                    if (playerRole === 'P2') onWin('kure');
                }
                
                // Firebase'i g√ºncelle
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), {
                    board,
                    p1Dropped,
                    p2Dropped,
                    isP1Turn: !isP1Turn,
                    winner
                });
            };
            
            return { pushFromEdge };
        }

        // üé≤ Q-BITZ GAME HOOK - E≈ûZAMANLI YARI≈û MODU
        function useQbitzGame(gameData, gameId, playerRole, onWin) {
            // 4x4 grid - her k√ºp√ºn 6 farklƒ± y√ºz√º var
            // Y√ºzler: 0=tam siyah, 1=tam beyaz, 2=√ºst-sol √º√ßgen, 3=alt-saƒü √º√ßgen, 4=kelebek, 5=merkez nokta
            // gameData.target = hedef desen (4x4 array)
            // gameData.p1Grid = P1'in grid'i (4x4 array)
            // gameData.p2Grid = P2'nin grid'i (4x4 array)
            // ‚ö° HER ƒ∞Kƒ∞ OYUNCU DA AYNI ANDA OYNAYABƒ∞Lƒ∞R - ƒ∞LK Bƒ∞Tƒ∞REN KAZANIR!
            
            const rotateCube = (index) => {
                if (!gameData || gameData.winner) return;
                
                // Kendi grid'imizi g√ºncelle (sƒ±ra kontrol√º yok - e≈üzamanlƒ± yarƒ±≈ü!)
                const gridKey = playerRole === 'P1' ? 'p1Grid' : 'p2Grid';
                const grid = [...(gameData[gridKey] || Array(16).fill(0))];
                
                // K√ºp√º d√∂nd√ºr (0->1->2->3->4->5->0)
                grid[index] = (grid[index] + 1) % 6;
                
                // Firebase'i g√ºncelle
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), {
                    [gridKey]: grid
                });
            };
            
            const submitPattern = () => {
                if (!gameData || gameData.winner) return;
                
                // Kendi grid'imizi kontrol et
                const gridKey = playerRole === 'P1' ? 'p1Grid' : 'p2Grid';
                const playerGrid = gameData[gridKey] || Array(16).fill(0);
                const target = gameData.target || [];
                
                // %100 e≈üle≈üme kontrol√º
                const isMatch = playerGrid.every((val, idx) => val === target[idx]);
                
                if (isMatch) {
                    // ƒ∞LK DOƒûRU TAMAMLAYAN KAZANIR!
                    const winner = playerRole === 'P1' ? gameData.players.p1.name : gameData.players.p2.name;
                    
                    // Kazananƒ± g√ºncelle
                    window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), {
                        winner
                    });
                    
                    // Badge kontrol√º
                    onWin('qbitz');
                }
                // E≈üle≈ümiyorsa hi√ßbir ≈üey yapma - oyuncu denemeye devam edebilir
            };
            
            return { rotateCube, submitPattern };
        }

        //  üéÆ MANGALA BOARD COMPONENT
        const MangalaBoard = ({ game, playerRole, onMove }) => {
            if (!game) return null;
            
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);
            const [animatingPit, setAnimatingPit] = React.useState(null);
            const [landingPits, setLandingPits] = React.useState([]);

            const handleMove = (pitIndex) => {
                if (!isMyTurn) return;
                
                // Animasyon ba≈ülat
                setAnimatingPit(pitIndex);
                
                // 400ms sonra landing animasyonu i√ßin sim√ºle edilen pit'leri hesapla (yeni animasyon s√ºresi)
                setTimeout(() => {
                    setAnimatingPit(null);
                    // Basit bir sim√ºlasyon: ta≈ülarƒ±n gideceƒüi yerleri tahmin et
                    const stones = board[pitIndex];
                    const affected = [];
                    for (let i = 1; i <= Math.min(stones, 14); i++) {
                        const nextIdx = (pitIndex + i) % 14;
                        affected.push(nextIdx);
                    }
                    setLandingPits(affected);
                    
                    // Asƒ±l hamleyi yap
                    onMove(pitIndex);
                    
                    // Landing animasyonunu temizle (yeni animasyon s√ºresi)
                    setTimeout(() => {
                        setLandingPits([]);
                    }, 700);
                }, 400);
            };

            const Pit = ({ count, owner, store, onClick, active, pitIndex }) => {
                const isAnimating = animatingPit === pitIndex;
                const isLanding = landingPits.includes(pitIndex);
                
                const marbles = [...Array(Math.min(count, 12))].map((_, i) => {
                    const angle = (i / Math.min(count, 12)) * 360;
                    const radius = store ? (count > 6 ? 20 : 12) : (count > 4 ? 10 : 6);
                    const x = Math.cos(angle * Math.PI / 180) * radius;
                    const y = Math.sin(angle * Math.PI / 180) * radius;
                    return (
                        <div 
                            key={i} 
                            className={`marble ${owner === 'opponent' ? 'marble-opponent' : ''} 
                                ${isAnimating ? 'stone-moving' : ''} 
                                ${isLanding ? 'stone-landing' : ''}
                            `}
                            style={{
                                width: store ? '10px' : '8px',
                                height: store ? '10px' : '8px',
                                transform: `translate(${x}px, ${y}px)`,
                                animationDelay: `${i * 0.05}s`
                            }}
                        />
                    );
                });

                return (
                    <div 
                        onClick={onClick}
                        className={`pit flex items-center justify-center relative
                            ${store ? 'w-16 sm:w-24 h-24 sm:h-40 rounded-[30px] sm:rounded-[40px]' : 'w-10 sm:w-14 h-10 sm:h-14'}
                            ${active ? 'pit-active cursor-pointer' : 'cursor-default'}
                            ${isLanding ? 'pit-highlight' : ''}
                            ${owner === 'me' ? 'bg-gradient-to-br from-amber-900/50 to-orange-900/50' : 'bg-gradient-to-br from-cyan-900/50 to-blue-900/50'}
                        `}
                    >
                        <div className="relative flex items-center justify-center">
                            {marbles}
                        </div>
                        <div className={`absolute ${store ? 'bottom-1 sm:bottom-2' : '-bottom-5 sm:-bottom-6'} left-1/2 -translate-x-1/2 
                            px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-bold
                            ${owner === 'me' ? 'bg-amber-500 text-white' : 'bg-cyan-500 text-white'}`}>
                            {count}
                        </div>
                    </div>
                );
            };

            return (
                <div className="w-full h-full flex flex-col md:flex-row items-center justify-center gap-2 sm:gap-4 p-2 sm:p-4">
                    {/* Opponent Store */}
                    <div className="flex flex-col items-center gap-1 sm:gap-2 order-1 md:order-1">
                        <span className="text-cyan-400 text-xs sm:text-sm font-bold flex items-center gap-1 sm:gap-2">
                            <span className="wave">üë§</span> {game.players[playerRole === 'P1' ? 'p2' : 'p1'].name.split(' ')[0]}
                        </span>
                        <Pit 
                            count={playerRole === 'P1' ? board[13] : board[6]} 
                            owner="opponent" 
                            store={true}
                            pitIndex={playerRole === 'P1' ? 13 : 6}
                        />
                    </div>

                    {/* Main Board */}
                    <div className="glass-card-dark p-3 sm:p-6 flex flex-col gap-2 sm:gap-4 order-2">
                        {/* Opponent Row */}
                        <div className="flex justify-center gap-1.5 sm:gap-3">
                            {[0,1,2,3,4,5].map(i => {
                                const idx = playerRole === 'P1' ? (12 - i) : (5 - i);
                                return <Pit key={idx} count={board[idx]} owner="opponent" pitIndex={idx} />;
                            })}
                        </div>
                        
                        {/* Turn Indicator */}
                        <div className="flex justify-center">
                            <div className={`status-badge ${isMyTurn ? 'status-online' : 'status-waiting'}`}>
                                {isMyTurn ? (
                                    <><span className="wave">üéØ</span> Senin Sƒ±ran!</>
                                ) : (
                                    <><span className="animate-pulse">‚è≥</span> Rakip Oynuyor...</>
                                )}
                            </div>
                        </div>

                        {/* My Row */}
                        <div className="flex justify-center gap-1.5 sm:gap-3">
                            {[0,1,2,3,4,5].map(i => {
                                const idx = playerRole === 'P1' ? i : (i + 7);
                                return (
                                    <Pit 
                                        key={idx} 
                                        count={board[idx]} 
                                        owner="me" 
                                        active={isMyTurn && board[idx] > 0}
                                        onClick={() => handleMove(idx)}
                                        pitIndex={idx}
                                    />
                                );
                            })}
                        </div>
                    </div>

                    {/* My Store */}
                    <div className="flex flex-col items-center gap-1 sm:gap-2 order-3">
                        <span className="text-amber-400 text-xs sm:text-sm font-bold flex items-center gap-1 sm:gap-2">
                            <span className="wave">‚≠ê</span> Sen
                        </span>
                        <Pit 
                            count={playerRole === 'P1' ? board[6] : board[13]} 
                            owner="me" 
                            store={true}
                            pitIndex={playerRole === 'P1' ? 6 : 13}
                        />
                    </div>
                </div>
            );
        };

        // üéÆ REVERSI BOARD COMPONENT - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const ReversiBoard = ({ game, playerRole, onMove }) => {
            if (!game) return null;
            
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn); 
            const black = board.filter(x=>x===1).length; 
            const white = board.filter(x=>x===2).length;
            
            return (
                <div className="flex flex-col items-center justify-center w-full h-full p-2 sm:p-4 gap-2 sm:gap-4 overflow-auto">
                    {/* Score Panel */}
                    <div className="flex items-center gap-2 sm:gap-4 flex-wrap justify-center">
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-2 sm:gap-3 ${playerRole === 'P1' ? 'ring-2 ring-amber-400' : ''}`}>
                            <div className="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-gray-700 to-black shadow-lg"></div>
                            <span className="text-xl sm:text-2xl font-bold text-white">{black}</span>
                        </div>
                        
                        <div className={`status-badge text-xs sm:text-sm ${isMyTurn ? 'status-online' : 'status-waiting'}`}>
                            {isMyTurn ? 'üéØ Oyna!' : '‚è≥ Bekle'}
                        </div>
                        
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-2 sm:gap-3 ${playerRole === 'P2' ? 'ring-2 ring-amber-400' : ''}`}>
                            <div className="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-gray-100 to-white shadow-lg"></div>
                            <span className="text-xl sm:text-2xl font-bold text-white">{white}</span>
                        </div>
                    </div>

                    {/* Board */}
                    <div className="bg-gradient-to-br from-green-700 to-green-900 p-1 sm:p-2 rounded-xl sm:rounded-2xl shadow-2xl border-2 sm:border-4 border-green-950">
                        <div className="grid grid-cols-8 gap-0.5 sm:gap-1">
                            {board.map((cell, i) => (
                                <div 
                                    key={i} 
                                    onClick={() => isMyTurn && onMove(Math.floor(i/8), i%8)}
                                    className={`w-7 h-7 sm:w-10 sm:h-10 rounded-md sm:rounded-lg flex items-center justify-center
                                        bg-green-600 active:bg-green-500 cursor-pointer transition-all
                                        ${isMyTurn && cell === 0 ? 'active:ring-2 active:ring-yellow-400' : ''}
                                    `}
                                >
                                    {cell !== 0 && (
                                        <div className={`w-[80%] h-[80%] rounded-full shadow-lg transition-all duration-300
                                            ${cell === 1 
                                                ? 'bg-gradient-to-br from-gray-600 to-black border-2 border-gray-500' 
                                                : 'bg-gradient-to-br from-white to-gray-200 border-2 border-gray-300'
                                            }
                                        `}></div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // üéÆ PENTAGO BOARD COMPONENT
        const PentagoBoard = ({ game, playerRole, onPlace, onRotate }) => {
            if (!game) return null;
            
            const board = (game.board || Array(36).fill(0)).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);
            const phase = game.phase || 'place';
            const p1Count = board.filter(x => x === 1).length;
            const p2Count = board.filter(x => x === 2).length;
            const [rotatingQuadrant, setRotatingQuadrant] = React.useState(null);
            const [rotationDirection, setRotationDirection] = React.useState(null);

            const handleRotate = (qId, clockwise) => {
                // Sadece saat y√∂n√ºnde d√∂n√º≈ü - kullanƒ±cƒ± hangi butona basarsa bassƒ±n
                const rotateClockwise = true; // Her zaman saat y√∂n√ºnde d√∂nd√ºr
                
                // Animasyonu ba≈ülat
                setRotatingQuadrant(qId);
                setRotationDirection('cw'); // Her zaman saat y√∂n√ºnde
                
                // Animasyon bitince ger√ßek d√∂nd√ºrmeyi yap (yeni animasyon s√ºresi)
                setTimeout(() => {
                    onRotate(qId, rotateClockwise); // Her zaman clockwise=true
                    setRotatingQuadrant(null);
                    setRotationDirection(null);
                }, 800);
            };

            const getQuadrantCells = (qId) => {
                const starts = [0, 3, 18, 21];
                const start = starts[qId];
                const offsets = [0, 1, 2, 6, 7, 8, 12, 13, 14];
                return offsets.map(o => start + o);
            };

            const QuadrantGrid = ({ qId }) => {
                const cells = getQuadrantCells(qId);
                const canRotate = isMyTurn && phase === 'rotate';
                const isRotating = rotatingQuadrant === qId;
                const rotClass = isRotating 
                    ? (rotationDirection === 'cw' ? 'rotating-cw' : 'rotating-ccw')
                    : '';
                
                // Oyuncunun son ta≈üƒ± koyduƒüu quadrant'ƒ± bul
                const lastPlacedQuadrant = game.lastPlaced !== null && game.lastPlaced !== undefined
                    ? [0, 1, 2, 3].find(q => getQuadrantCells(q).includes(game.lastPlaced))
                    : null;
                const isQuadrantWithLastMove = lastPlacedQuadrant === qId;
                
                return (
                    <div className="relative group">
                        <div className={`grid grid-cols-3 gap-1 p-2 rounded-xl transition-all duration-300 
                            ${canRotate 
                                ? isQuadrantWithLastMove
                                    ? 'bg-gradient-to-br from-yellow-500/70 to-orange-600/70 ring-4 ring-yellow-300 animate-pulse shadow-lg shadow-yellow-500/50' 
                                    : 'bg-gradient-to-br from-purple-600/50 to-pink-600/50 ring-2 ring-purple-400 animate-pulse'
                                : 'bg-white/10'
                            }
                            ${rotClass}
                        `}>
                            {cells.map((cellIdx) => {
                                const cell = board[cellIdx];
                                const canPlace = isMyTurn && phase === 'place' && cell === 0;
                                const isLastPlaced = game.lastPlaced === cellIdx;
                                
                                return (
                                    <div 
                                        key={cellIdx} 
                                        onClick={() => canPlace && onPlace(cellIdx)}
                                        className={`w-9 h-9 sm:w-12 sm:h-12 rounded-md sm:rounded-lg flex items-center justify-center 
                                            bg-gradient-to-br from-slate-800 to-slate-900 transition-all duration-200
                                            ${canPlace ? 'active:from-slate-700 active:to-slate-800 cursor-pointer active:scale-105' : ''}
                                            ${isLastPlaced ? 'ring-2 ring-yellow-400 ring-offset-1 sm:ring-offset-2 ring-offset-transparent animate-pulse' : ''}
                                        `}
                                    >
                                        {cell !== 0 && (
                                            <div className={`w-[70%] h-[70%] rounded-full shadow-lg transition-transform 
                                                ${cell === 1 
                                                    ? 'bg-gradient-to-br from-rose-400 to-rose-600 border-2 border-rose-300' 
                                                    : 'bg-gradient-to-br from-cyan-400 to-cyan-600 border-2 border-cyan-300'
                                                }
                                                ${isLastPlaced ? 'scale-110 animate-bounce' : ''}
                                            `}></div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {canRotate && !isRotating && (
                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                                <div className="bg-black/90 backdrop-blur-md p-3 rounded-2xl border-2 border-purple-400 shadow-2xl">
                                    <button 
                                        onClick={() => handleRotate(qId, true)} 
                                        className={`btn-fun py-3 px-5 text-base font-bold shadow-2xl flex items-center gap-2 transition-all
                                            ${isQuadrantWithLastMove 
                                                ? 'bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black ring-4 ring-yellow-300 animate-bounce' 
                                                : 'btn-success'
                                            }
                                        `}
                                        title="Saat Y√∂n√ºnde D√∂nd√ºr ‚ü≥"
                                    >
                                        <i className="fas fa-redo text-xl"></i>
                                        <span>{isQuadrantWithLastMove ? '√áevir!' : 'D√∂nd√ºr'}</span>
                                        <i className="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="flex flex-col items-center justify-center w-full h-full p-2 sm:p-4 gap-2 sm:gap-4 overflow-auto">
                    {/* Score Panel */}
                    <div className="flex flex-wrap items-center justify-center gap-2 sm:gap-3">
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-1 sm:gap-2 ${playerRole === 'P1' ? 'ring-2 ring-rose-400' : ''}`}>
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-rose-400 to-rose-600"></div>
                            <span className="font-bold text-white text-sm sm:text-base">{game.players?.p1?.name?.split(' ')[0]}</span>
                            <span className="text-lg sm:text-xl font-bold text-rose-400">{p1Count}</span>
                        </div>
                        
                        <div className={`status-badge text-xs sm:text-sm ${isMyTurn ? (phase === 'place' ? 'status-online' : 'status-waiting') : 'bg-gray-600 text-white'}`}>
                            {!isMyTurn ? '‚è≥ Bekle' : (phase === 'place' ? 'üéØ Ta≈ü Koy' : 'üîÑ D√∂nd√ºr')}
                        </div>
                        
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-1 sm:gap-2 ${playerRole === 'P2' ? 'ring-2 ring-cyan-400' : ''}`}>
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600"></div>
                            <span className="font-bold text-white text-sm sm:text-base">{game.players?.p2?.name?.split(' ')[0]}</span>
                            <span className="text-lg sm:text-xl font-bold text-cyan-400">{p2Count}</span>
                        </div>
                    </div>

                    {/* Board */}
                    <div className="glass-card-dark p-2 sm:p-4">
                        <div className="grid grid-cols-2 gap-2 sm:gap-3">
                            {[0, 1, 2, 3].map(qId => (
                                <QuadrantGrid key={qId} qId={qId} />
                            ))}
                        </div>
                    </div>

                    {/* Info */}
                    <div className="glass-card px-4 py-2 text-center">
                        <p className="text-xs text-white/70">
                            <span className="text-yellow-400 font-bold">üí° ƒ∞pucu:</span> 5 ta≈üƒ± yan yana diz ve kazan!
                        </p>
                    </div>
                </div>
            );
        };

        // üß© KULAMI BOARD COMPONENT - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const KulamiBoard = ({ game, playerRole, onMove }) => {
            if (!game) return null;
            
            const panels = game.panels || [];
            const lastMove = game.lastMove || null;
            const forbiddenPanel = game.forbiddenPanel;
            const validMoves = game.validMoves || [];
            const p1Score = game.p1Score || 0;
            const p2Score = game.p2Score || 0;
            
            const handleCellClick = (panelId, cellIdx) => {
                if (onMove) {
                    onMove(panelId, cellIdx);
                }
            };
            
            return (
                <div className="h-full flex flex-col items-center justify-center gap-2 sm:gap-3 p-2 sm:p-4 overflow-auto">
                    {/* Score Display */}
                    <div className="flex gap-2 sm:gap-4 items-center flex-wrap justify-center">
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-1 sm:gap-2 ${playerRole === 'P1' ? 'ring-2 ring-red-400' : ''}`}>
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-red-500 to-red-700"></div>
                            <span className="font-bold text-white text-sm sm:text-base">{game.players?.p1?.name?.split(' ')[0]}</span>
                            <span className="text-lg sm:text-xl font-bold text-red-400">{p1Score}</span>
                        </div>
                        <div className="px-2 sm:px-3 py-1 rounded-full text-[10px] sm:text-xs font-bold bg-purple-500/20 text-purple-300 border border-purple-500/30">
                            üß© KULAMI
                        </div>
                        <div className={`glass-card px-2 sm:px-4 py-1 sm:py-2 flex items-center gap-1 sm:gap-2 ${playerRole === 'P2' ? 'ring-2 ring-gray-400' : ''}`}>
                            <div className="w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-gradient-to-br from-gray-700 to-black"></div>
                            <span className="font-bold text-white text-sm sm:text-base">{game.players?.p2?.name?.split(' ')[0]}</span>
                            <span className="text-lg sm:text-xl font-bold text-gray-400">{p2Score}</span>
                        </div>
                    </div>
                    
                    {/* Board */}
                    <div className="glass-card-dark p-2 sm:p-6">
                        <div className="relative" style={{ width: 'min(300px, 85vw)', height: 'min(300px, 50vh)' }}>
                            {panels.map((panel, panelIdx) => {
                                const isForbidden = forbiddenPanel === panelIdx;
                                // Mobil i√ßin dinamik scale (ekran geni≈üliƒüine g√∂re)
                                const scaleFactor = window.innerWidth < 640 ? 0.7 : 0.875;
                                
                                return (
                                    <div 
                                        key={panelIdx}
                                        className={`absolute rounded-md sm:rounded-lg border-2 transition-all ${
                                            isForbidden 
                                                ? 'bg-red-500/10 border-red-500/40 opacity-40' 
                                                : 'bg-white/5 border-white/20'
                                        }`}
                                        style={{
                                            left: `${panel.x * scaleFactor}px`,
                                            top: `${panel.y * scaleFactor}px`,
                                            width: `${panel.width * scaleFactor}px`,
                                            height: `${panel.height * scaleFactor}px`
                                        }}
                                    >
                                        {/* Forbidden X overlay */}
                                        {isForbidden && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                                                <span className="text-red-500 text-4xl font-bold opacity-60">√ó</span>
                                            </div>
                                        )}
                                        
                                        <div className="grid gap-1 p-1.5 h-full" style={{
                                            gridTemplateColumns: `repeat(${panel.cols}, 1fr)`,
                                            gridTemplateRows: `repeat(${panel.rows}, 1fr)`
                                        }}>
                                            {panel.cells.map((cell, cellIdx) => {
                                                const isLastMove = lastMove && lastMove.panelId === panelIdx && lastMove.cellIdx === cellIdx;
                                                const isValidMove = validMoves.some(m => m.panelId === panelIdx && m.cellIdx === cellIdx);
                                                
                                                return (
                                                    <div 
                                                        key={cellIdx}
                                                        onClick={() => !isForbidden && isValidMove && handleCellClick(panelIdx, cellIdx)}
                                                        className={`rounded-full border-2 flex items-center justify-center transition-all ${
                                                            isLastMove ? 'ring-2 ring-yellow-400 shadow-lg shadow-yellow-400/50' : ''
                                                        } ${
                                                            isValidMove && !isForbidden && cell.player === 0 
                                                                ? 'kulami-valid-cell border-green-400/70 cursor-pointer active:bg-green-400/20' 
                                                                : ''
                                                        } ${
                                                            cell.player === 0 ? 'bg-gray-700/50 border-gray-600' :
                                                            cell.player === 1 ? 'bg-gradient-to-br from-red-500 to-red-700 border-red-600 shadow-lg' :
                                                            'bg-gradient-to-br from-gray-700 to-black border-gray-900 shadow-lg'
                                                        }`}
                                                        style={{
                                                            minWidth: '16px',
                                                            minHeight: '16px'
                                                        }}
                                                    >
                                                        {/* Valid move indicator */}
                                                        {isValidMove && !isForbidden && cell.player === 0 && (
                                                            <div className="w-2 h-2 rounded-full bg-green-400 opacity-70 pulse"></div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    {/* Game Info */}
                    <div className="glass-card px-4 py-2 text-center">
                        <p className="text-xs text-white/70">
                            <span className="text-green-400 font-bold">üí° ƒ∞pucu:</span> Ye≈üil h√ºcrelere tƒ±kla! Kƒ±rmƒ±zƒ± panele oynanamaz.
                        </p>
                    </div>
                </div>
            );
        };

        // üåê K√úRE BOARD COMPONENT - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const KureBoard = ({ game, playerRole, onPush }) => {
            if (!game) return null;
            
            const board = game.board || Array(49).fill(0); // 7x7 = 49
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);
            const p1Dropped = game.p1Dropped || 0;
            const p2Dropped = game.p2Dropped || 0;
            
            const handlePush = (edge, position) => {
                if (isMyTurn && onPush) {
                    onPush(edge, position);
                }
            };
            
            return (
                <div className="h-full flex flex-col items-center justify-center gap-2 sm:gap-4 p-2 sm:p-4 overflow-auto">
                    {/* Score Display */}
                    <div className="flex gap-3 sm:gap-6 items-center flex-wrap justify-center">
                        <div className={`glass-card px-2 sm:px-4 py-2 sm:py-3 flex flex-col items-center gap-1 ${playerRole === 'P1' ? 'ring-2 ring-blue-400' : ''}`}>
                            <div className="text-[10px] sm:text-xs text-white/60">D√º≈ü√ºrd√ºƒü√ºn</div>
                            <div className="flex items-center gap-1 sm:gap-2">
                                <div className="w-4 h-4 sm:w-6 sm:h-6 rounded-full bg-gradient-to-br from-blue-500 to-blue-700"></div>
                                <span className="text-lg sm:text-2xl font-bold text-blue-400">{playerRole === 'P1' ? p2Dropped : p1Dropped}</span>
                            </div>
                        </div>
                        <div className="px-2 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-bold bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border border-purple-500/30">
                            üåê K√úRE
                        </div>
                        <div className={`glass-card px-2 sm:px-4 py-2 sm:py-3 flex flex-col items-center gap-1 ${playerRole === 'P2' ? 'ring-2 ring-red-400' : ''}`}>
                            <div className="text-[10px] sm:text-xs text-white/60">D√º≈ü√ºrd√ºƒü√ºn</div>
                            <div className="flex items-center gap-1 sm:gap-2">
                                <div className="w-4 h-4 sm:w-6 sm:h-6 rounded-full bg-gradient-to-br from-red-500 to-red-700"></div>
                                <span className="text-lg sm:text-2xl font-bold text-red-400">{playerRole === 'P2' ? p2Dropped : p1Dropped}</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Board with Edge Buttons */}
                    <div className="glass-card-dark p-2 sm:p-6 relative">
                        {/* Top Edge Buttons */}
                        <div className="flex justify-center gap-0.5 sm:gap-1 mb-1 sm:mb-2">
                            {[0,1,2,3,4,5,6].map(col => (
                                <button
                                    key={`top-${col}`}
                                    onClick={() => handlePush('top', col)}
                                    disabled={!isMyTurn}
                                    className={`w-8 h-6 sm:w-10 sm:h-8 rounded-t-lg font-bold text-xs sm:text-sm transition-all ${
                                        isMyTurn 
                                            ? 'bg-gradient-to-b from-green-500 to-green-600 active:from-green-400 active:to-green-500 text-white cursor-pointer shadow-lg active:shadow-green-500/50' 
                                            : 'bg-gray-700/50 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    ‚Üì
                                </button>
                            ))}
                        </div>
                        
                        <div className="flex gap-0.5 sm:gap-2">
                            {/* Left Edge Buttons */}
                            <div className="flex flex-col gap-0.5 sm:gap-1">
                                {[0,1,2,3,4,5,6].map(row => (
                                    <button
                                        key={`left-${row}`}
                                        onClick={() => handlePush('left', row)}
                                        disabled={!isMyTurn}
                                        className={`w-6 h-8 sm:w-8 sm:h-10 rounded-l-lg font-bold text-xs sm:text-sm transition-all ${
                                            isMyTurn 
                                                ? 'bg-gradient-to-r from-green-500 to-green-600 active:from-green-400 active:to-green-500 text-white cursor-pointer shadow-lg active:shadow-green-500/50' 
                                                : 'bg-gray-700/50 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        ‚Üí
                                    </button>
                                ))}
                            </div>
                            
                            {/* 7x7 Grid */}
                            <div className="grid grid-cols-7 gap-0.5 sm:gap-1 bg-gradient-to-br from-slate-800 to-slate-900 p-1 sm:p-2 rounded-xl">
                                {board.map((cell, idx) => (
                                    <div
                                        key={idx}
                                        className="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-slate-700/50 flex items-center justify-center transition-all"
                                    >
                                        {cell === 1 && (
                                            <div className="w-5 h-5 sm:w-7 sm:h-7 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 shadow-lg"></div>
                                        )}
                                        {cell === 2 && (
                                            <div className="w-5 h-5 sm:w-7 sm:h-7 rounded-full bg-gradient-to-br from-red-500 to-red-700 shadow-lg"></div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            
                            {/* Right Edge Buttons */}
                            <div className="flex flex-col gap-0.5 sm:gap-1">
                                {[0,1,2,3,4,5,6].map(row => (
                                    <button
                                        key={`right-${row}`}
                                        onClick={() => handlePush('right', row)}
                                        disabled={!isMyTurn}
                                        className={`w-6 h-8 sm:w-8 sm:h-10 rounded-r-lg font-bold text-xs sm:text-sm transition-all ${
                                            isMyTurn 
                                                ? 'bg-gradient-to-l from-green-500 to-green-600 active:from-green-400 active:to-green-500 text-white cursor-pointer shadow-lg active:shadow-green-500/50' 
                                                : 'bg-gray-700/50 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        ‚Üê
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Bottom Edge Buttons */}
                        <div className="flex justify-center gap-0.5 sm:gap-1 mt-1 sm:mt-2">
                            {[0,1,2,3,4,5,6].map(col => (
                                <button
                                    key={`bottom-${col}`}
                                    onClick={() => handlePush('bottom', col)}
                                    disabled={!isMyTurn}
                                    className={`w-8 h-6 sm:w-10 sm:h-8 rounded-b-lg font-bold text-xs sm:text-sm transition-all ${
                                        isMyTurn 
                                            ? 'bg-gradient-to-t from-green-500 to-green-600 active:from-green-400 active:to-green-500 text-white cursor-pointer shadow-lg active:shadow-green-500/50' 
                                            : 'bg-gray-700/50 text-gray-500 cursor-not-allowed'
                                        }`}
                                >
                                    ‚Üë
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Game Info */}
                    <div className="glass-card px-4 py-2 text-center max-w-md">
                        <p className="text-xs text-white/70">
                            <span className="text-yellow-400 font-bold">üéØ Hedef:</span> Rakipten 3 ta≈ü d√º≈ü√ºr! Kenarlardan ta≈üƒ±nƒ± it.
                        </p>
                    </div>
                </div>
            );
        };

        // üé≤ Q-BITZ BOARD COMPONENT - E≈ûZAMANLI YARI≈û MODU - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const QbitzBoard = ({ game, playerRole, onRotate, onSubmit }) => {
            if (!game) return null;
            
            const target = game.target || Array(16).fill(0);
            const p1Grid = game.p1Grid || Array(16).fill(0);
            const p2Grid = game.p2Grid || Array(16).fill(0);
            const myGrid = playerRole === 'P1' ? p1Grid : p2Grid;
            const opponentGrid = playerRole === 'P1' ? p2Grid : p1Grid;
            const opponentName = playerRole === 'P1' ? game.players?.p2?.name : game.players?.p1?.name;
            const canPlay = !game.winner; // Kazanan yoksa oynayabilir
            
            // K√ºp y√ºz√º render fonksiyonu - mobil i√ßin k√º√ß√ºlt√ºld√º
            const renderCubeFace = (faceValue, size = 'w-10 h-10 sm:w-12 sm:h-12') => {
                const baseClass = `${size} rounded-md sm:rounded-lg flex items-center justify-center transition-all`;
                
                switch(faceValue) {
                    case 0: // Tam siyah
                        return <div className={`${baseClass} bg-gray-900 border-2 border-gray-700`}></div>;
                    case 1: // Tam beyaz
                        return <div className={`${baseClass} bg-white border-2 border-gray-300`}></div>;
                    case 2: // √úst-sol √º√ßgen (siyah)
                        return (
                            <div className={`${baseClass} bg-white border-2 border-gray-300 relative overflow-hidden`}>
                                <div className="absolute top-0 left-0 w-0 h-0 border-t-[40px] sm:border-t-[48px] border-t-gray-900 border-r-[40px] sm:border-r-[48px] border-r-transparent"></div>
                            </div>
                        );
                    case 3: // Alt-saƒü √º√ßgen (siyah)
                        return (
                            <div className={`${baseClass} bg-white border-2 border-gray-300 relative overflow-hidden`}>
                                <div className="absolute bottom-0 right-0 w-0 h-0 border-b-[40px] sm:border-b-[48px] border-b-gray-900 border-l-[40px] sm:border-l-[48px] border-l-transparent"></div>
                            </div>
                        );
                    case 4: // Kelebek/Kum saati (k√∂≈üelerde beyaz)
                        return (
                            <div className={`${baseClass} bg-gray-900 border-2 border-gray-700 relative overflow-hidden`}>
                                <div className="absolute top-0 left-0 w-0 h-0 border-t-[20px] sm:border-t-[24px] border-t-white border-r-[20px] sm:border-r-[24px] border-r-transparent"></div>
                                <div className="absolute top-0 right-0 w-0 h-0 border-t-[20px] sm:border-t-[24px] border-t-white border-l-[20px] sm:border-l-[24px] border-l-transparent"></div>
                                <div className="absolute bottom-0 left-0 w-0 h-0 border-b-[20px] sm:border-b-[24px] border-b-white border-r-[20px] sm:border-r-[24px] border-r-transparent"></div>
                                <div className="absolute bottom-0 right-0 w-0 h-0 border-b-[20px] sm:border-b-[24px] border-b-white border-l-[20px] sm:border-l-[24px] border-l-transparent"></div>
                            </div>
                        );
                    case 5: // Merkez nokta/√áeyrek daire
                        return (
                            <div className={`${baseClass} bg-white border-2 border-gray-300 relative overflow-hidden`}>
                                <div className="w-4 h-4 sm:w-6 sm:h-6 rounded-full bg-gray-900"></div>
                            </div>
                        );
                    default:
                        return <div className={`${baseClass} bg-gray-500`}></div>;
                }
            };
            
            // K√º√ß√ºk k√ºp render (rakip i√ßin)
            const renderSmallCube = (faceValue) => {
                const baseClass = 'w-5 h-5 sm:w-6 sm:h-6 rounded flex items-center justify-center';
                switch(faceValue) {
                    case 0: return <div className={`${baseClass} bg-gray-900`}></div>;
                    case 1: return <div className={`${baseClass} bg-white border border-gray-300`}></div>;
                    case 2: return (
                        <div className={`${baseClass} bg-white border border-gray-300 relative overflow-hidden`}>
                            <div className="absolute top-0 left-0 w-0 h-0 border-t-[20px] sm:border-t-[24px] border-t-gray-900 border-r-[20px] sm:border-r-[24px] border-r-transparent"></div>
                        </div>
                    );
                    case 3: return (
                        <div className={`${baseClass} bg-white border border-gray-300 relative overflow-hidden`}>
                            <div className="absolute bottom-0 right-0 w-0 h-0 border-b-[20px] sm:border-b-[24px] border-b-gray-900 border-l-[20px] sm:border-l-[24px] border-l-transparent"></div>
                        </div>
                    );
                    case 4: return <div className={`${baseClass} bg-gray-900`}></div>;
                    case 5: return (
                        <div className={`${baseClass} bg-white border border-gray-300`}>
                            <div className="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-gray-900"></div>
                        </div>
                    );
                    default: return <div className={`${baseClass} bg-gray-500`}></div>;
                }
            };
            
            return (
                <div className="h-full flex flex-col items-center justify-center gap-2 sm:gap-4 p-2 sm:p-4 overflow-auto">
                    {/* Header - Yarƒ±≈ü Modu */}
                    <div className="flex items-center gap-2 sm:gap-4">
                        <div className="px-3 sm:px-6 py-2 sm:py-3 rounded-full text-xs sm:text-lg font-bold bg-gradient-to-r from-red-500/30 to-orange-500/30 text-orange-300 border border-orange-500/50 animate-pulse">
                            ‚ö° YARI≈û MODU - ƒ∞LK Bƒ∞Tƒ∞REN KAZANIR!
                        </div>
                    </div>
                    
                    <div className="flex gap-2 sm:gap-6 items-start justify-center flex-wrap">
                        {/* Hedef Desen */}
                        <div className="glass-card-dark p-2 sm:p-4">
                            <h3 className="text-center text-yellow-400 font-bold mb-1 sm:mb-2 text-xs sm:text-sm">üéØ HEDEF DESEN</h3>
                            <div className="grid grid-cols-4 gap-1 sm:gap-1.5 bg-gradient-to-br from-yellow-900/50 to-orange-900/50 p-2 sm:p-3 rounded-lg sm:rounded-xl border-2 border-yellow-500/50">
                                {target.map((face, idx) => (
                                    <div key={`target-${idx}`}>
                                        {renderCubeFace(face, 'w-8 h-8 sm:w-10 sm:h-10')}
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Benim Grid'im */}
                        <div className={`glass-card-dark p-2 sm:p-4 ${canPlay ? 'ring-2 ring-green-500/50' : ''}`}>
                            <h3 className="text-center text-green-400 font-bold mb-1 sm:mb-2 text-xs sm:text-sm animate-pulse">
                                ‚ú® SENƒ∞N DESENƒ∞N
                            </h3>
                            <div className="grid grid-cols-4 gap-1 sm:gap-1.5 bg-gradient-to-br from-slate-800 to-slate-900 p-2 sm:p-3 rounded-lg sm:rounded-xl">
                                {myGrid.map((face, idx) => (
                                    <button
                                        key={`my-${idx}`}
                                        onClick={() => canPlay && onRotate(idx)}
                                        disabled={!canPlay}
                                        className={`transition-transform ${
                                            canPlay ? 'cursor-pointer active:scale-110 active:ring-2 active:ring-yellow-400' : 'cursor-not-allowed opacity-60'
                                        }`}
                                    >
                                        {renderCubeFace(face, 'w-8 h-8 sm:w-10 sm:h-10')}
                                    </button>
                                ))}
                            </div>
                            
                            {/* Bitti Butonu */}
                            <button
                                onClick={onSubmit}
                                disabled={!canPlay}
                                className={`w-full mt-2 sm:mt-3 py-2 sm:py-3 rounded-lg sm:rounded-xl font-bold text-sm sm:text-lg transition-all ${
                                    canPlay
                                        ? 'bg-gradient-to-r from-green-500 to-emerald-600 active:from-green-400 active:to-emerald-500 text-white cursor-pointer shadow-lg active:shadow-green-500/50 active:scale-95'
                                        : 'bg-gray-700/50 text-gray-500 cursor-not-allowed'
                                }`}
                            >
                                ‚úÖ Bƒ∞TTƒ∞!
                            </button>
                        </div>
                        
                        {/* Rakibin Grid'i (k√º√ß√ºk √∂nizleme) */}
                        <div className="glass-card-dark p-2 sm:p-4 opacity-70">
                            <h3 className="text-center text-red-400 font-bold mb-1 sm:mb-2 text-[10px] sm:text-xs">
                                üëÄ {opponentName?.split(' ')[0] || 'Rakip'}
                            </h3>
                            <div className="grid grid-cols-4 gap-0.5 sm:gap-1 bg-gradient-to-br from-red-900/30 to-red-950/30 p-1.5 sm:p-2 rounded-md sm:rounded-lg">
                                {opponentGrid.map((face, idx) => (
                                    <div key={`opp-${idx}`}>
                                        {renderSmallCube(face)}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    {/* Yardƒ±m */}
                    <div className="glass-card px-3 sm:px-4 py-1.5 sm:py-2 text-center max-w-lg">
                        <p className="text-[10px] sm:text-xs text-white/70">
                            <span className="text-orange-400 font-bold">‚ö° HIZLI OL!</span> K√ºplere tƒ±klayarak d√∂nd√ºr. Hedef deseni ilk tamamlayan kazanƒ±r!
                        </p>
                    </div>
                </div>
            );
        };

        // üë§ PROFILE MODAL - ROZET GALERƒ∞Sƒ∞ ƒ∞LE - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const ProfileModal = ({ user, onClose, onLogout }) => {
            const [activeTab, setActiveTab] = useState('badges');
            const userBadges = user.badges || [];
            const allBadgeKeys = Object.keys(BADGES);
            
            // Rozet istatistikleri
            const earnedCount = userBadges.length;
            const totalCount = allBadgeKeys.length;
            const percentage = Math.round((earnedCount / totalCount) * 100);
            
            // Nadirliƒüe g√∂re grupla - √ñzel rozetler en sonda (tooltip i√ßin)
            const groupedBadges = {
                legendary: allBadgeKeys.filter(k => BADGES[k].rarity === 'legendary'),
                epic: allBadgeKeys.filter(k => BADGES[k].rarity === 'epic'),
                rare: allBadgeKeys.filter(k => BADGES[k].rarity === 'rare'),
                common: allBadgeKeys.filter(k => BADGES[k].rarity === 'common'),
                special: allBadgeKeys.filter(k => BADGES[k].rarity === 'special')
            };

            return (
                <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-2 sm:p-4" onClick={onClose}>
                    <div className="glass-card w-full max-w-lg max-h-[95vh] sm:max-h-[90vh] overflow-hidden pop-in flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 p-4 sm:p-6 text-center relative flex-shrink-0">
                            <button onClick={onClose} className="absolute top-3 right-3 sm:top-4 sm:right-4 w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white/20 flex items-center justify-center text-white active:bg-white/30 transition">
                                <i className="fas fa-times text-sm"></i>
                            </button>
                            <div className="w-14 h-14 sm:w-20 sm:h-20 mx-auto bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-xl sm:text-3xl font-bold text-white shadow-xl mb-2 sm:mb-3 bounce ring-4 ring-white/30">
                                {user.name.charAt(0)}
                            </div>
                            <h2 className="text-lg sm:text-xl font-bold text-white">{user.name}</h2>
                            <p className="text-white/70 text-xs sm:text-sm">{user.schoolName} ‚Ä¢ {user.class}</p>
                        </div>
                        
                        {/* Stats Bar */}
                        <div className="p-2 sm:p-4 grid grid-cols-3 gap-2 sm:gap-3 bg-white/5 flex-shrink-0">
                            <div className="text-center">
                                <div className="text-xl sm:text-2xl font-bold text-yellow-400">{user.stats?.wins || 0}</div>
                                <div className="text-[10px] sm:text-xs text-white/50">üèÜ Galibiyet</div>
                            </div>
                            <div className="text-center border-x border-white/10">
                                <div className="text-xl sm:text-2xl font-bold text-purple-400">{earnedCount}</div>
                                <div className="text-[10px] sm:text-xs text-white/50">üéñÔ∏è Rozet</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xl sm:text-2xl font-bold text-cyan-400">{user.stats?.totalGames || 0}</div>
                                <div className="text-[10px] sm:text-xs text-white/50">üéÆ Oyun</div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-white/5 p-1 mx-2 sm:mx-4 rounded-xl flex-shrink-0">
                            <button 
                                onClick={() => setActiveTab('badges')}
                                className={`flex-1 py-1.5 sm:py-2 px-2 sm:px-4 rounded-lg font-bold text-xs sm:text-sm transition-all ${activeTab === 'badges' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-white/50 active:text-white'}`}
                            >
                                üéñÔ∏è Rozetlerim
                            </button>
                            <button 
                                onClick={() => setActiveTab('gallery')}
                                className={`flex-1 py-1.5 sm:py-2 px-2 sm:px-4 rounded-lg font-bold text-xs sm:text-sm transition-all ${activeTab === 'gallery' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-white/50 active:text-white'}`}
                            >
                                üèÜ Galeri
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-4">
                            {activeTab === 'badges' ? (
                                <>
                                    {/* Progress Bar */}
                                    <div className="mb-4 p-3 bg-white/5 rounded-xl">
                                        <div className="flex justify-between text-xs mb-2">
                                            <span className="text-white/60">Koleksiyon ƒ∞lerlemesi</span>
                                            <span className="text-white font-bold">{earnedCount}/{totalCount} ({percentage}%)</span>
                                        </div>
                                        <div className="h-3 bg-white/10 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 rounded-full transition-all duration-1000"
                                                style={{ width: `${percentage}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    {/* Kazanƒ±lan Rozetler */}
                                    {userBadges.length > 0 ? (
                                        <div className="grid grid-cols-2 gap-3">
                                            {userBadges.map(badgeKey => {
                                                const badge = BADGES[badgeKey];
                                                if (!badge) return null;
                                                const rarity = RARITY_COLORS[badge.rarity];
                                                return (
                                                    <div 
                                                        key={badgeKey} 
                                                        className={`relative p-3 rounded-xl bg-gradient-to-br ${rarity.bg} border-2 ${rarity.border} shadow-lg hover:scale-105 transition-transform cursor-pointer`}
                                                    >
                                                        <div className="absolute top-1 right-1 text-[10px] px-2 py-0.5 rounded-full bg-black/30 text-white/80">
                                                            {RARITY_NAMES[badge.rarity]}
                                                        </div>
                                                        <div className="text-3xl mb-1">{badge.icon}</div>
                                                        <div className="font-bold text-white text-sm">{badge.name}</div>
                                                        <div className="text-white/60 text-xs mt-1">{badge.desc}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-white/40">
                                            <span className="text-5xl block mb-3">üéÆ</span>
                                            <span className="text-sm">Hen√ºz rozet kazanƒ±lmadƒ±</span>
                                            <p className="text-xs mt-2 text-white/30">Oyunlar oynayarak rozetler kazan!</p>
                                        </div>
                                    )}
                                </>
                            ) : (
                                /* T√ºm Rozetler Galerisi */
                                <div className="space-y-4">
                                    {Object.entries(groupedBadges).map(([rarity, badges], rarityIndex) => {
                                        if (badges.length === 0) return null;
                                        const rarityStyle = RARITY_COLORS[rarity];
                                        // ƒ∞lk iki grup (legendary ve epic) i√ßin tooltip a≈üaƒüƒ± a√ßƒ±lsƒ±n
                                        const tooltipPosition = rarityIndex < 2 ? 'top-full mt-2' : 'bottom-full mb-2';
                                        return (
                                            <div key={rarity}>
                                                <div className={`text-xs font-bold ${rarityStyle.text} mb-2 flex items-center gap-2`}>
                                                    {rarity === 'legendary' && 'üëë'}
                                                    {rarity === 'epic' && 'üíú'}
                                                    {rarity === 'rare' && 'üíô'}
                                                    {rarity === 'special' && 'üíñ'}
                                                    {rarity === 'common' && '‚ö™'}
                                                    {RARITY_NAMES[rarity]} Rozetler ({badges.filter(b => userBadges.includes(b)).length}/{badges.length})
                                                </div>
                                                <div className="grid grid-cols-4 gap-2">
                                                    {badges.map((badgeKey, badgeIndex) => {
                                                        const badge = BADGES[badgeKey];
                                                        const isEarned = userBadges.includes(badgeKey);
                                                        // ƒ∞lk satƒ±rdaki rozetler i√ßin a≈üaƒüƒ±, diƒüerleri i√ßin yukarƒ±
                                                        const isFirstRow = badgeIndex < 4;
                                                        const finalTooltipPos = (rarityIndex < 2 || isFirstRow) ? 'top-full mt-2' : 'bottom-full mb-2';
                                                        return (
                                                            <div 
                                                                key={badgeKey}
                                                                className={`relative p-2 rounded-xl text-center transition-all cursor-pointer group
                                                                    ${isEarned 
                                                                        ? `bg-gradient-to-br ${rarityStyle.bg} border-2 ${rarityStyle.border} hover:scale-110 hover:shadow-lg` 
                                                                        : 'bg-white/5 border border-white/10 grayscale opacity-50 hover:opacity-70'
                                                                    }`}
                                                            >
                                                                <div className={`text-2xl ${isEarned ? '' : 'filter blur-[1px]'}`}>
                                                                    {isEarned ? badge.icon : '‚ùì'}
                                                                </div>
                                                                <div className="text-[10px] text-white/70 truncate mt-1">
                                                                    {isEarned ? badge.name : '???'}
                                                                </div>
                                                                {/* Tooltip - Akƒ±llƒ± Pozisyon */}
                                                                <div className={`absolute ${finalTooltipPos} left-1/2 -translate-x-1/2 w-36 p-2 bg-gray-900/95 backdrop-blur-sm rounded-lg text-xs text-white opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none z-50 shadow-xl border border-white/20`}>
                                                                    <div className="font-bold text-yellow-300">{badge.name}</div>
                                                                    <div className="text-white/80 text-[10px] mt-1">{badge.desc}</div>
                                                                    {isEarned && (
                                                                        <div className="text-green-400 text-[9px] mt-1 font-bold">‚úÖ Kazanƒ±ldƒ±!</div>
                                                                    )}
                                                                    {!isEarned && (
                                                                        <div className="text-gray-400 text-[9px] mt-1">üîí Kilitli</div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                        
                        {/* Logout */}
                        <button onClick={onLogout} className="w-full py-4 bg-red-500/20 text-red-400 font-bold hover:bg-red-500/30 transition border-t border-white/10 flex-shrink-0">
                            <i className="fas fa-sign-out-alt mr-2"></i> √áƒ±kƒ±≈ü Yap
                        </button>
                    </div>
                </div>
            );
        };

        //   PLAYER PROFILE MODAL (Ba≈üka oyuncunun profilini g√∂r√ºnt√ºle) - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const PlayerProfileModal = ({ player, onClose }) => {
            if (!player) return null;
            
            const playerBadges = player.badges || [];
            const stats = player.stats || {};
            
            return (
                <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-2 sm:p-4" onClick={onClose}>
                    <div className="glass-card w-full max-w-md max-h-[90vh] sm:max-h-[85vh] overflow-hidden pop-in flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="bg-gradient-to-r from-cyan-600 via-blue-600 to-purple-500 p-4 sm:p-6 text-center relative flex-shrink-0">
                            <button onClick={onClose} className="absolute top-3 right-3 sm:top-4 sm:right-4 w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-white/20 flex items-center justify-center text-white active:bg-white/30 transition">
                                <i className="fas fa-times text-sm"></i>
                            </button>
                            <div className="w-12 h-12 sm:w-16 sm:h-16 mx-auto bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center text-lg sm:text-2xl font-bold text-white shadow-xl mb-2 ring-4 ring-white/30">
                                {player.name?.charAt(0) || '?'}
                            </div>
                            <h2 className="text-base sm:text-lg font-bold text-white">{player.name}</h2>
                            <p className="text-white/70 text-xs sm:text-sm">{player.schoolName} ‚Ä¢ {player.class}</p>
                        </div>
                        
                        {/* Stats Grid */}
                        <div className="p-2 sm:p-4 grid grid-cols-3 gap-1.5 sm:gap-2 bg-white/5 flex-shrink-0">
                            <div className="text-center p-1.5 sm:p-2 rounded-lg bg-white/5">
                                <div className="text-lg sm:text-xl font-bold text-yellow-400">{stats.wins || 0}</div>
                                <div className="text-[9px] sm:text-[10px] text-white/50">üèÜ Galibiyet</div>
                            </div>
                            <div className="text-center p-1.5 sm:p-2 rounded-lg bg-white/5">
                                <div className="text-lg sm:text-xl font-bold text-purple-400">{playerBadges.length}</div>
                                <div className="text-[9px] sm:text-[10px] text-white/50">üéñÔ∏è Rozet</div>
                            </div>
                            <div className="text-center p-1.5 sm:p-2 rounded-lg bg-white/5">
                                <div className="text-lg sm:text-xl font-bold text-cyan-400">{stats.totalGames || 0}</div>
                                <div className="text-[9px] sm:text-[10px] text-white/50">üéÆ Oyun</div>
                            </div>
                        </div>
                        
                        {/* Game Stats */}
                        <div className="px-3 sm:px-4 py-2 sm:py-3 bg-white/5 border-y border-white/10 flex-shrink-0">
                            <div className="text-[10px] sm:text-xs font-bold text-white/60 mb-1.5 sm:mb-2">üéÆ Oyun Galibiyetleri</div>
                            <div className="grid grid-cols-6 gap-1.5 sm:gap-2 text-center">
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-yellow-500/20 to-orange-500/20">
                                    <div className="text-sm sm:text-lg">üéØ</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-yellow-400">{stats.mangalaWins || 0}</div>
                                </div>
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-green-500/20 to-teal-500/20">
                                    <div className="text-sm sm:text-lg">‚ö´</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-green-400">{stats.reversiWins || 0}</div>
                                </div>
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20">
                                    <div className="text-sm sm:text-lg">üîÆ</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-purple-400">{stats.pentagoWins || 0}</div>
                                </div>
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-red-500/20 to-rose-500/20">
                                    <div className="text-sm sm:text-lg">üß©</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-red-400">{stats.kulamiWins || 0}</div>
                                </div>
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-cyan-500/20">
                                    <div className="text-sm sm:text-lg">üåê</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-blue-400">{stats.kureWins || 0}</div>
                                </div>
                                <div className="p-1.5 sm:p-2 rounded-lg bg-gradient-to-br from-pink-500/20 to-purple-500/20">
                                    <div className="text-sm sm:text-lg">üé≤</div>
                                    <div className="text-[10px] sm:text-xs font-bold text-pink-400">{stats.qbitzWins || 0}</div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Badges Section */}
                        <div className="flex-1 overflow-y-auto p-3 sm:p-4">
                            <div className="text-[10px] sm:text-xs font-bold text-white/60 mb-2 sm:mb-3">üéñÔ∏è Kazanƒ±lan Rozetler ({playerBadges.length})</div>
                            {playerBadges.length > 0 ? (
                                <div className="grid grid-cols-4 gap-1.5 sm:gap-2">
                                    {playerBadges.map(badgeKey => {
                                        const badge = BADGES[badgeKey];
                                        if (!badge) return null;
                                        const rarity = RARITY_COLORS[badge.rarity];
                                        return (
                                            <div 
                                                key={badgeKey} 
                                                className={`relative p-1.5 sm:p-2 rounded-lg sm:rounded-xl bg-gradient-to-br ${rarity.bg} border ${rarity.border} text-center group`}
                                                title={badge.desc}
                                            >
                                                <div className="text-lg sm:text-xl">{badge.icon}</div>
                                                <div className="text-[8px] sm:text-[9px] text-white/80 truncate mt-0.5 sm:mt-1">{badge.name}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div className="text-center py-4 sm:py-6 text-white/40">
                                    <span className="text-2xl sm:text-3xl block mb-2">üéÆ</span>
                                    <span className="text-[10px] sm:text-xs">Hen√ºz rozet kazanƒ±lmamƒ±≈ü</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // üèÜ LEADERBOARD COMPONENT - MOBƒ∞L OPTƒ∞Mƒ∞ZE
        const Leaderboard = ({ currentUser }) => {
            const [allUsers, setAllUsers] = useState({});
            const [selectedGame, setSelectedGame] = useState('total');
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            
            useEffect(() => {
                const unsubscribe = window.dbOnValue(
                    window.dbRef(window.db, 'users'),
                    (snap) => {
                        if (snap.exists()) {
                            setAllUsers(snap.val());
                        }
                    }
                );
                return () => {
                    if (typeof unsubscribe === 'function') unsubscribe();
                };
            }, []);
            
            const games = [
                { key: 'total', name: 'Toplam', icon: 'üèÜ', field: 'wins' },
                { key: 'mangala', name: 'Mangala', icon: 'üéØ', field: 'mangalaWins' },
                { key: 'reversi', name: 'Reversi', icon: '‚ö´', field: 'reversiWins' },
                { key: 'pentago', name: 'Pentago', icon: 'üîÆ', field: 'pentagoWins' },
                { key: 'kulami', name: 'Kulami', icon: 'üß©', field: 'kulamiWins' },
                { key: 'kure', name: 'K√ºre', icon: 'üåê', field: 'kureWins' },
                { key: 'qbitz', name: 'Q-bitz', icon: 'üé≤', field: 'qbitzWins' }
            ];
            
            const currentGameData = games.find(g => g.key === selectedGame);
            
            // Se√ßili oyuna g√∂re sƒ±rala
            const sortedUsers = Object.entries(allUsers)
                .map(([id, u]) => ({ ...u, odaId: id }))
                .filter(u => (u.stats?.[currentGameData.field] || 0) > 0)
                .sort((a, b) => (b.stats?.[currentGameData.field] || 0) - (a.stats?.[currentGameData.field] || 0))
                .slice(0, 10);
            
            return (
                <>
                    <div className="glass-card p-3 sm:p-4 w-full max-w-md">
                        <h3 className="text-base sm:text-lg font-bold text-white mb-2 sm:mb-3 flex items-center gap-2">
                            <span className="text-xl sm:text-2xl">üèÜ</span> Lider Tablosu
                        </h3>
                        
                        {/* Game Selector */}
                        <div className="flex flex-wrap gap-1 mb-3 sm:mb-4">
                            {games.map(game => (
                                <button
                                    key={game.key}
                                    onClick={() => setSelectedGame(game.key)}
                                    className={`px-2 py-1 rounded-lg text-[10px] sm:text-xs font-bold transition-all ${
                                        selectedGame === game.key
                                            ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg'
                                            : 'bg-white/10 text-white/60 active:bg-white/20'
                                    }`}
                                >
                                    {game.icon}
                                </button>
                            ))}
                        </div>
                        
                        {/* Selected Game Title */}
                        <div className="text-center mb-2 sm:mb-3">
                            <span className="text-2xl">{currentGameData.icon}</span>
                            <span className="ml-2 text-white font-bold">{currentGameData.name}</span>
                        </div>
                        
                        {/* Leaderboard List */}
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                            {sortedUsers.length > 0 ? (
                                sortedUsers.map((player, index) => {
                                    const isCurrentUser = currentUser && 
                                        player.schoolId === currentUser.schoolId && 
                                        player.number === currentUser.number;
                                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                                    
                                    return (
                                        <div
                                            key={player.odaId}
                                            onClick={() => setSelectedPlayer(player)}
                                            className={`flex items-center gap-3 p-2 rounded-xl cursor-pointer transition-all hover:scale-[1.02] ${
                                                isCurrentUser 
                                                    ? 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 ring-2 ring-purple-400' 
                                                    : 'bg-white/5 hover:bg-white/10'
                                            }`}
                                        >
                                            <div className={`w-8 h-8 flex items-center justify-center font-bold ${
                                                index < 3 ? 'text-xl' : 'text-sm text-white/60'
                                            }`}>
                                                {medal}
                                            </div>
                                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-sm">
                                                {player.name?.charAt(0) || '?'}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-white text-sm truncate">
                                                    {player.name}
                                                    {isCurrentUser && <span className="ml-1 text-xs text-purple-300">(Sen)</span>}
                                                </div>
                                                <div className="text-[10px] text-white/50 truncate">{player.class}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-yellow-400">{player.stats?.[currentGameData.field] || 0}</div>
                                                <div className="text-[10px] text-white/50">galibiyet</div>
                                            </div>
                                            <div className="text-white/30">
                                                <i className="fas fa-chevron-right text-xs"></i>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : (
                                <div className="text-center py-6 text-white/40">
                                    <span className="text-3xl block mb-2">üìä</span>
                                    <span className="text-xs">Hen√ºz galibiyet yok</span>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Player Profile Modal */}
                    {selectedPlayer && (
                        <PlayerProfileModal 
                            player={selectedPlayer} 
                            onClose={() => setSelectedPlayer(null)} 
                        />
                    )}
                </>
            );
        };

        //  üîê AUTH SCREEN
        const AuthScreen = ({ onLogin, onRegister }) => {
            const [mode, setMode] = useState("login");
            const [schools, setSchools] = useState([]);
            const [schoolId, setSchoolId] = useState("");
            const [number, setNumber] = useState("");
            const [password, setPassword] = useState("");
            const [name, setName] = useState("");
            const [cls, setCls] = useState("");

            useEffect(() => {
                if (window.dbRef) {
                    const unsubscribe = window.dbOnValue(
                        window.dbRef(window.db, 'schools'), 
                        (snap) => {
                            try {
                                const val = snap.val();
                                if (val) setSchools(Object.values(val));
                            } catch (err) {
                                console.error('Schools data processing error:', err);
                            }
                        },
                        (error) => {
                            console.error('Schools listener error:', error);
                        }
                    );
                    return () => {
                        if (typeof unsubscribe === 'function') unsubscribe();
                    };
                }
            }, []);

            const doAuth = () => {
                if (!schoolId || !number || !password) return alert("T√ºm alanlarƒ± doldur! üìù");
                if (mode === "login") {
                    onLogin(schoolId, number, password);
                } else {
                    if (!name || !cls) return alert("Ad ve Sƒ±nƒ±f bilgisi gerekli! üìö");
                    const selectedSchool = schools.find(s => s.id === schoolId);
                    onRegister({ schoolId, schoolName: selectedSchool.name, number, password, name, class: cls });
                }
            };

            return (
                <div className="w-full h-full flex items-center justify-center p-3 sm:p-4 overflow-auto">
                    <div className="glass-card w-full max-w-md p-4 sm:p-8 pop-in">
                        {/* Logo */}
                        <div className="text-center mb-4 sm:mb-8">
                            <div className="text-4xl sm:text-6xl mb-2 sm:mb-4 bounce">üéÆ</div>
                            <h1 className="text-2xl sm:text-4xl font-bold rainbow-text mb-1 sm:mb-2">AKIL ZEKA</h1>
                            <p className="text-white/60 text-xs sm:text-sm">Eƒülenceli Oyun D√ºnyasƒ±</p>
                        </div>

                        {/* Toggle */}
                        <div className="flex bg-white/10 rounded-full p-1 mb-4 sm:mb-6">
                            <button 
                                onClick={() => setMode("login")}
                                className={`flex-1 py-2 px-3 sm:px-4 rounded-full font-bold text-sm sm:text-base transition-all ${mode === 'login' ? 'bg-white text-purple-600' : 'text-white/70'}`}
                            >
                                üîë Giri≈ü
                            </button>
                            <button 
                                onClick={() => setMode("register")}
                                className={`flex-1 py-2 px-3 sm:px-4 rounded-full font-bold text-sm sm:text-base transition-all ${mode === 'register' ? 'bg-white text-purple-600' : 'text-white/70'}`}
                            >
                                ‚ú® Kayƒ±t
                            </button>
                        </div>

                        {/* Form */}
                        <div className="space-y-3 sm:space-y-4">
                            <div>
                                <label className="text-white/60 text-xs sm:text-sm font-bold mb-1 sm:mb-2 block">üè´ Okul</label>
                                <select 
                                    value={schoolId} 
                                    onChange={e => setSchoolId(e.target.value)} 
                                    className="select-fun w-full text-sm sm:text-base py-2 sm:py-3"
                                >
                                    <option value="">Okulunu Se√ß</option>
                                    {schools.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            {mode === "register" && (
                                <div className="grid grid-cols-2 gap-2 sm:gap-3">
                                    <div>
                                        <label className="text-white/60 text-xs sm:text-sm font-bold mb-1 sm:mb-2 block">üë§ Ad Soyad</label>
                                        <input 
                                            placeholder="Adƒ±n Soyadƒ±n" 
                                            value={name} 
                                            onChange={e => setName(e.target.value)} 
                                            className="input-fun w-full text-sm sm:text-base py-2 sm:py-3"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-white/60 text-xs sm:text-sm font-bold mb-1 sm:mb-2 block">üìö Sƒ±nƒ±f</label>
                                        <input 
                                            placeholder="5-A" 
                                            value={cls} 
                                            onChange={e => setCls(e.target.value)} 
                                            className="input-fun w-full text-sm sm:text-base py-2 sm:py-3"
                                        />
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-2 sm:gap-3">
                                <div>
                                    <label className="text-white/60 text-xs sm:text-sm font-bold mb-1 sm:mb-2 block">üî¢ Numara</label>
                                    <input 
                                        placeholder="1234" 
                                        value={number} 
                                        onChange={e => setNumber(e.target.value)} 
                                        className="input-fun w-full text-center text-sm sm:text-base py-2 sm:py-3"
                                    />
                                </div>
                                <div>
                                    <label className="text-white/60 text-xs sm:text-sm font-bold mb-1 sm:mb-2 block">üîí ≈ûifre</label>
                                    <input 
                                        type="password" 
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                        value={password} 
                                        onChange={e => setPassword(e.target.value)} 
                                        className="input-fun w-full text-center text-sm sm:text-base py-2 sm:py-3"
                                    />
                                </div>
                            </div>

                            <button onClick={doAuth} className="btn-fun btn-primary w-full mt-2 sm:mt-4 py-3 sm:py-4 text-sm sm:text-base">
                                {mode === "login" ? "üöÄ Giri≈ü Yap" : "‚ú® Kayƒ±t Ol"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // üéÆ GAME SHELL
        const GameShell = ({ gameId, playerRole, onBack, onWin }) => {
            const [gameData, setGameData] = useState(null);
            const [showQuitNotice, setShowQuitNotice] = useState(false);

            useEffect(() => {
                const unsubscribe = window.dbOnValue(
                    window.dbRef(window.db, 'games/' + gameId), 
                    (s) => {
                        try {
                            setGameData(s.val());
                        } catch (err) {
                            console.error('Game data processing error:', err);
                        }
                    },
                    (error) => {
                        console.error('Game listener error:', error);
                    }
                );
                return () => {
                    if (typeof unsubscribe === 'function') unsubscribe();
                };
            }, [gameId]);
            
            // üéÆ GAME HOOKS - Her zaman t√ºm hook'larƒ± √ßaƒüƒ±r (React Rules of Hooks)
            const mangalaGame = React.useMemo(() => useMangalaGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);
            const reversiGame = React.useMemo(() => useReversiGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);
            const pentagoGame = React.useMemo(() => usePentagoGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);
            const kulamiGame = React.useMemo(() => useKulamiGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);
            const kureGame = React.useMemo(() => useKureGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);
            const qbitzGame = React.useMemo(() => useQbitzGame(gameData, gameId, playerRole, onWin), [gameData, gameId, playerRole, onWin]);

            useEffect(() => {
                if (gameData?.winner && gameData.winner !== 'Berabere') {
                    createConfetti();
                }
                // Rakip √ßƒ±ktƒ±ysa bildiri g√∂ster ve kazan√ß i≈üle
                if (gameData?.endReason === 'quit' && gameData?.quitter) {
                    const myName = playerRole === 'P1' ? gameData.players?.p1?.name : gameData.players?.p2?.name;
                    if (gameData.quitter !== myName && !showQuitNotice) {
                        setShowQuitNotice(true);
                        // Rakip terk ettiƒüi i√ßin kazandƒ±n - onWin √ßaƒüƒ±r
                        if (onWin && gameData.type) {
                            onWin(gameData.type);
                        }
                    }
                }
            }, [gameData?.winner, gameData?.endReason, gameData?.quitter, playerRole, showQuitNotice, onWin, gameData]);

            if (!gameData) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center">
                        <div className="text-6xl mb-4 bounce">‚è≥</div>
                        <p className="text-white/60 font-bold">Oyun Y√ºkleniyor...</p>
                    </div>
                );
            }

            const gameTypeEmoji = { mangala: 'üéØ', reversi: '‚ö´', pentago: 'üîÆ', kulami: 'üß©', kure: 'üåê', qbitz: 'üé≤' };
            const gameTypeName = { mangala: 'Mangala', reversi: 'Reversi', pentago: 'Pentago', kulami: 'Kulami', kure: 'K√ºre', qbitz: 'Q-bitz' };

            return (
                <div className="w-full h-full flex flex-col pc-container glass-card-dark overflow-hidden">
                    {/* Rakip √áƒ±ktƒ± Bildirimi */}
                    {showQuitNotice && (
                        <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="glass-card p-8 text-center pop-in max-w-sm">
                                <div className="text-6xl mb-4">üèÉ‚Äç‚ôÇÔ∏è</div>
                                <h2 className="text-2xl font-bold text-white mb-2">Rakip Ayrƒ±ldƒ±!</h2>
                                <p className="text-white/60 mb-2">{gameData?.quitter} oyundan √ßƒ±ktƒ±.</p>
                                <p className="text-green-400 font-bold text-lg mb-6">üèÜ Tebrikler, kazandƒ±n!</p>
                                <button onClick={onBack} className="btn-fun btn-success">
                                    <i className="fas fa-home mr-2"></i> Lobiye D√∂n
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex items-center justify-between px-2 sm:px-4 py-2 sm:py-3 bg-white/5 border-b border-white/10">
                        <div className="flex items-center gap-2 sm:gap-3">
                            <span className="text-xl sm:text-2xl">{gameTypeEmoji[gameData.type]}</span>
                            <div>
                                <div className="font-bold text-white text-sm sm:text-base">{gameTypeName[gameData.type]}</div>
                                <div className="text-[10px] sm:text-xs text-white/50">Masa #{gameId}</div>
                            </div>
                        </div>
                        
                        {gameData.winner ? (
                            <div className="status-badge bg-gradient-to-r from-yellow-500 to-orange-500 text-white winner-card text-xs sm:text-sm">
                                üèÜ {gameData.winner}
                            </div>
                        ) : (
                            <div className={`status-badge text-xs sm:text-sm ${
                                ((playerRole === 'P1' && gameData.isP1Turn) || (playerRole === 'P2' && !gameData.isP1Turn)) 
                                    ? 'status-online' 
                                    : 'status-waiting'
                            }`}>
                                {((playerRole === 'P1' && gameData.isP1Turn) || (playerRole === 'P2' && !gameData.isP1Turn)) 
                                    ? 'üéØ Sƒ±ran' 
                                    : '‚è≥ Bekle'}
                            </div>
                        )}
                        
                        <button onClick={onBack} className="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-red-500/20 text-red-400 active:bg-red-500 active:text-white transition flex items-center justify-center">
                            <i className="fas fa-times text-sm sm:text-base"></i>
                        </button>
                    </div>

                    {/* Game Area */}
                    <div className="flex-1 overflow-hidden">
                        {gameData.type === 'reversi' ? (
                            <ReversiBoard game={gameData} playerRole={playerRole} onMove={reversiGame.makeMove} />
                        ) : gameData.type === 'pentago' ? (
                            <PentagoBoard game={gameData} playerRole={playerRole} onPlace={pentagoGame.placeStone} onRotate={pentagoGame.doRotate} />
                        ) : gameData.type === 'kulami' ? (
                            <KulamiBoard game={gameData} playerRole={playerRole} onMove={kulamiGame.makeMove} />
                        ) : gameData.type === 'kure' ? (
                            <KureBoard game={gameData} playerRole={playerRole} onPush={kureGame.pushFromEdge} />
                        ) : gameData.type === 'qbitz' ? (
                            <QbitzBoard game={gameData} playerRole={playerRole} onRotate={qbitzGame.rotateCube} onSubmit={qbitzGame.submitPattern} />
                        ) : (
                            <MangalaBoard game={gameData} playerRole={playerRole} onMove={mangalaGame.moveStone} />
                        )}
                    </div>
                </div>
            );
        };

        // üéØ MAIN APP
        const App = () => {
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState("loading");
            const [gameId, setGameId] = useState(null);
            const [role, setRole] = useState(null);
            const [showProfile, setShowProfile] = useState(false);
            const [badge, setBadge] = useState(null);

            useEffect(() => {
                const uid = localStorage.getItem("az_uid");
                if (uid) checkUser(uid);
                else setStatus("auth");
            }, []);

            const checkUser = async (uid) => {
                try {
                    const s = await window.dbGet(window.dbRef(window.db, 'users/' + uid));
                    if (s.exists()) {
                        setUser(s.val());
                        connectToLobby(s.val(), uid);
                    } else {
                        const p = await window.dbGet(window.dbRef(window.db, 'pending_users/' + uid));
                        if (p.exists()) {
                            setStatus("pending");
                        } else {
                            localStorage.removeItem("az_uid");
                            setStatus("auth");
                        }
                    }
                } catch (error) {
                    console.error('Check user error:', error);
                    localStorage.removeItem("az_uid");
                    setStatus("auth");
                }
            };

            const connectToLobby = async (u, uid) => {
                try {
                    const r = window.dbRef(window.db, 'lobby/' + uid);
                    const success = await window.dbUpdate(r, { 
                        name: u.name, 
                        class: u.class, 
                        schoolName: u.schoolName, 
                        state: 'waiting', 
                        uid 
                    });
                    if (success) {
                        window.dbOnDisconnect(r).remove();
                        setStatus("lobby");
                    } else {
                        console.error('Failed to connect to lobby');
                        setStatus("auth");
                    }
                } catch (error) {
                    console.error('Connect to lobby error:', error);
                    setStatus("auth");
                }
            };

            const login = async (sid, no, pass) => {
                try {
                    const uid = `${sid}_${no}`;
                    const s = await window.dbGet(window.dbRef(window.db, 'users/' + uid));
                    if (s.exists() && s.val().password === pass) {
                        localStorage.setItem("az_uid", uid);
                        setUser(s.val());
                        connectToLobby(s.val(), uid);
                    } else {
                        alert("‚ùó Hatalƒ± bilgi! üòÖ");
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('‚ùå Giri≈ü ba≈üarƒ±sƒ±z! L√ºtfen tekrar deneyin.');
                }
            };

            const register = async (data) => {
                try {
                    const uid = `${data.schoolId}_${data.number}`;
                    const s = await window.dbGet(window.dbRef(window.db, 'users/' + uid));
                    if (s.exists()) {
                        alert("‚ùó Bu numara zaten kayƒ±tlƒ±! üìö");
                    } else {
                        const pending = await window.dbGet(window.dbRef(window.db, 'pending_users/' + uid));
                        if (pending.exists()) {
                            alert("‚ùó Bu kayƒ±t zaten onay bekliyor!");
                            return;
                        }
                        const success = await window.dbSet(
                            window.dbRef(window.db, 'pending_users/' + uid), 
                            { ...data, badges: [], stats: { wins: 0 }, joinedAt: Date.now() }
                        );
                        if (success) {
                            alert("‚úÖ Kayƒ±t tamamlandƒ±! √ñƒüretmen onayƒ± bekleniyor. ‚úÖ");
                            setStatus("auth");
                        } else {
                            alert('‚ùå Kayƒ±t ba≈üarƒ±sƒ±z! L√ºtfen tekrar deneyin.');
                        }
                    }
                } catch (error) {
                    console.error('Register error:', error);
                    alert('‚ùå Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu! L√ºtfen tekrar deneyin.');
                }
            };

            const handleWin = async (type) => {
                if (!user) return;
                try {
                    createConfetti();
                    const uid = `${user.schoolId}_${user.number}`;
                    const ref = window.dbRef(window.db, 'users/' + uid);
                    const s = await window.dbGet(ref);
                    if (!s.exists()) {
                        console.error('User not found in database');
                        return;
                    }
                    
                    let u = s.val();
                    
                    // ƒ∞statistikleri g√ºncelle
                    if (!u.stats) u.stats = { wins: 0, totalGames: 0, streak: 0, mangalaWins: 0, reversiWins: 0, pentagoWins: 0, kulamiWins: 0, kureWins: 0, qbitzWins: 0 };
                    u.stats.wins = (u.stats.wins || 0) + 1;
                    u.stats.totalGames = (u.stats.totalGames || 0) + 1;
                    u.stats.streak = (u.stats.streak || 0) + 1;
                    
                    // Oyun tipine g√∂re galibiyet say
                    if (type === 'mangala') u.stats.mangalaWins = (u.stats.mangalaWins || 0) + 1;
                    if (type === 'reversi') u.stats.reversiWins = (u.stats.reversiWins || 0) + 1;
                    if (type === 'pentago') u.stats.pentagoWins = (u.stats.pentagoWins || 0) + 1;
                    if (type === 'kulami') u.stats.kulamiWins = (u.stats.kulamiWins || 0) + 1;
                    if (type === 'kure') u.stats.kureWins = (u.stats.kureWins || 0) + 1;
                    if (type === 'qbitz') u.stats.qbitzWins = (u.stats.qbitzWins || 0) + 1;
                    
                    let badges = u.badges || [];
                    let newBadges = [];
                
                // üåü ƒ∞lk Zafer
                if (!badges.includes("first_win") && u.stats.wins >= 1) {
                    badges.push("first_win");
                    newBadges.push("first_win");
                }
                
                // üéØ ƒ∞lk Adƒ±m (ilk oyunu tamamla)
                if (!badges.includes("first_blood") && u.stats.totalGames >= 1) {
                    badges.push("first_blood");
                    newBadges.push("first_blood");
                }
                
                // üéÆ MANGALA ROZETLERƒ∞
                if (!badges.includes("mangala_novice") && u.stats.mangalaWins >= 3) {
                    badges.push("mangala_novice");
                    newBadges.push("mangala_novice");
                }
                if (!badges.includes("mangala_master") && u.stats.mangalaWins >= 10) {
                    badges.push("mangala_master");
                    newBadges.push("mangala_master");
                }
                if (!badges.includes("mangala_legend") && u.stats.mangalaWins >= 25) {
                    badges.push("mangala_legend");
                    newBadges.push("mangala_legend");
                }
                
                // üéÆ REVERSƒ∞ ROZETLERƒ∞
                if (!badges.includes("reversi_novice") && u.stats.reversiWins >= 3) {
                    badges.push("reversi_novice");
                    newBadges.push("reversi_novice");
                }
                if (!badges.includes("reversi_brain") && u.stats.reversiWins >= 10) {
                    badges.push("reversi_brain");
                    newBadges.push("reversi_brain");
                }
                if (!badges.includes("reversi_genius") && u.stats.reversiWins >= 25) {
                    badges.push("reversi_genius");
                    newBadges.push("reversi_genius");
                }
                
                // üéÆ PENTAGO ROZETLERƒ∞
                if (!badges.includes("pentago_novice") && u.stats.pentagoWins >= 3) {
                    badges.push("pentago_novice");
                    newBadges.push("pentago_novice");
                }
                if (!badges.includes("pentago_pro") && u.stats.pentagoWins >= 10) {
                    badges.push("pentago_pro");
                    newBadges.push("pentago_pro");
                }
                if (!badges.includes("pentago_master") && u.stats.pentagoWins >= 25) {
                    badges.push("pentago_master");
                    newBadges.push("pentago_master");
                }
                
                // üß© KULAMI ROZETLERƒ∞
                if (!badges.includes("kulami_novice") && u.stats.kulamiWins >= 3) {
                    badges.push("kulami_novice");
                    newBadges.push("kulami_novice");
                }
                if (!badges.includes("kulami_master") && u.stats.kulamiWins >= 10) {
                    badges.push("kulami_master");
                    newBadges.push("kulami_master");
                }
                if (!badges.includes("kulami_legend") && u.stats.kulamiWins >= 25) {
                    badges.push("kulami_legend");
                    newBadges.push("kulami_legend");
                }
                
                // üåê K√úRE ROZETLERƒ∞
                if (!badges.includes("kure_novice") && u.stats.kureWins >= 3) {
                    badges.push("kure_novice");
                    newBadges.push("kure_novice");
                }
                if (!badges.includes("kure_master") && u.stats.kureWins >= 10) {
                    badges.push("kure_master");
                    newBadges.push("kure_master");
                }
                if (!badges.includes("kure_legend") && u.stats.kureWins >= 25) {
                    badges.push("kure_legend");
                    newBadges.push("kure_legend");
                }
                
                // üé≤ Q-BITZ ROZETLERƒ∞
                if (!badges.includes("qbitz_novice") && u.stats.qbitzWins >= 3) {
                    badges.push("qbitz_novice");
                    newBadges.push("qbitz_novice");
                }
                if (!badges.includes("qbitz_master") && u.stats.qbitzWins >= 10) {
                    badges.push("qbitz_master");
                    newBadges.push("qbitz_master");
                }
                if (!badges.includes("qbitz_legend") && u.stats.qbitzWins >= 25) {
                    badges.push("qbitz_legend");
                    newBadges.push("qbitz_legend");
                }
                
                // üî• SERƒ∞ ROZETLERƒ∞
                if (!badges.includes("streak_3") && u.stats.streak >= 3) {
                    badges.push("streak_3");
                    newBadges.push("streak_3");
                }
                if (!badges.includes("streak_5") && u.stats.streak >= 5) {
                    badges.push("streak_5");
                    newBadges.push("streak_5");
                }
                if (!badges.includes("streak_10") && u.stats.streak >= 10) {
                    badges.push("streak_10");
                    newBadges.push("streak_10");
                }
                
                // üèÜ TOPLAM GALƒ∞Bƒ∞YET ROZETLERƒ∞
                if (!badges.includes("wins_5") && u.stats.wins >= 5) {
                    badges.push("wins_5");
                    newBadges.push("wins_5");
                }
                if (!badges.includes("wins_10") && u.stats.wins >= 10) {
                    badges.push("wins_10");
                    newBadges.push("wins_10");
                }
                if (!badges.includes("wins_25") && u.stats.wins >= 25) {
                    badges.push("wins_25");
                    newBadges.push("wins_25");
                }
                if (!badges.includes("wins_50") && u.stats.wins >= 50) {
                    badges.push("wins_50");
                    newBadges.push("wins_50");
                }
                if (!badges.includes("wins_100") && u.stats.wins >= 100) {
                    badges.push("wins_100");
                    newBadges.push("wins_100");
                }
                
                // üåà √áOKLU OYUN ROZETLERƒ∞ (T√ºm 6 oyun)
                const hasAllGames1 = (u.stats.mangalaWins || 0) >= 1 && (u.stats.reversiWins || 0) >= 1 && 
                                     (u.stats.pentagoWins || 0) >= 1 && (u.stats.kulamiWins || 0) >= 1 && 
                                     (u.stats.kureWins || 0) >= 1 && (u.stats.qbitzWins || 0) >= 1;
                if (!badges.includes("all_rounder") && hasAllGames1) {
                    badges.push("all_rounder");
                    newBadges.push("all_rounder");
                }
                
                const hasAllGames5 = (u.stats.mangalaWins || 0) >= 5 && (u.stats.reversiWins || 0) >= 5 && 
                                     (u.stats.pentagoWins || 0) >= 5 && (u.stats.kulamiWins || 0) >= 5 && 
                                     (u.stats.kureWins || 0) >= 5 && (u.stats.qbitzWins || 0) >= 5;
                if (!badges.includes("triple_master") && hasAllGames5) {
                    badges.push("triple_master");
                    newBadges.push("triple_master");
                }
                
                const hasAllGames15 = (u.stats.mangalaWins || 0) >= 15 && (u.stats.reversiWins || 0) >= 15 && 
                                      (u.stats.pentagoWins || 0) >= 15 && (u.stats.kulamiWins || 0) >= 15 && 
                                      (u.stats.kureWins || 0) >= 15 && (u.stats.qbitzWins || 0) >= 15;
                if (!badges.includes("ultimate_champion") && hasAllGames15) {
                    badges.push("ultimate_champion");
                    newBadges.push("ultimate_champion");
                }
                
                // üéì VETERAN ROZETLERƒ∞
                if (!badges.includes("veteran") && u.stats.totalGames >= 50) {
                    badges.push("veteran");
                    newBadges.push("veteran");
                }
                if (!badges.includes("legend") && u.stats.totalGames >= 100) {
                    badges.push("legend");
                    newBadges.push("legend");
                }
                
                u.badges = badges;
                const success = await window.dbUpdate(ref, u);
                if (success) {
                    setUser(u);
                    
                    // Yeni rozet bildirimi g√∂ster (sƒ±rayla)
                    if (newBadges.length > 0) {
                        for (let i = 0; i < newBadges.length; i++) {
                            setTimeout(() => {
                                setBadge(BADGES[newBadges[i]]);
                                setTimeout(() => setBadge(null), 3500);
                            }, i * 4000);
                        }
                    }
                } else {
                    console.error('Failed to update user stats');
                }
                } catch (error) {
                    console.error('Handle win error:', error);
                }
            };
            
            // Oyun kaybedince seri sƒ±fƒ±rla
            const handleLose = async () => {
                if (!user) return;
                try {
                    const uid = `${user.schoolId}_${user.number}`;
                    const ref = window.dbRef(window.db, 'users/' + uid);
                    const success = await window.dbUpdate(ref, { 
                        'stats/streak': 0, 
                        'stats/totalGames': (user.stats?.totalGames || 0) + 1 
                    });
                    if (!success) {
                        console.error('Failed to update loss stats');
                    }
                } catch (error) {
                    console.error('Handle lose error:', error);
                }
            };

            useEffect(() => {
                if (status !== "lobby" || !user) return;
                const unsubscribe = window.dbOnValue(
                    window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`), 
                    (s) => {
                        try {
                            const d = s.val();
                            if (d && d.gameId) {
                                setGameId(d.gameId);
                                setRole(d.role);
                                setStatus("playing");
                            }
                        } catch (err) {
                            console.error('Lobby data processing error:', err);
                        }
                    },
                    (error) => {
                        console.error('Lobby listener error:', error);
                    }
                );
                return () => {
                    if (typeof unsubscribe === 'function') unsubscribe();
                };
            }, [status, user]);

            // Loading Screen
            if (status === "loading") {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center">
                        <div className="text-8xl mb-6 bounce">üéÆ</div>
                        <h1 className="text-3xl font-bold rainbow-text mb-4">AKIL ZEKA</h1>
                        <div className="flex gap-2">
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0s' }}></div>
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                            <div className="w-3 h-3 rounded-full bg-white animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                        </div>
                    </div>
                );
            }

            // Auth Screen
            if (status === "auth") {
                return (
                    <div className="w-full h-full pc-container">
                        <AuthScreen onLogin={login} onRegister={register} />
                    </div>
                );
            }

            // Pending Screen
            if (status === "pending") {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center text-center p-4">
                        <div className="glass-card p-8 max-w-sm pop-in">
                            <div className="text-6xl mb-4 wave">‚è≥</div>
                            <h2 className="text-2xl font-bold text-white mb-2">Onay Bekleniyor</h2>
                            <p className="text-white/60 mb-6">√ñƒüretmenin kaydƒ±nƒ± onaylamasƒ±nƒ± bekle!</p>
                            <button 
                                onClick={() => { localStorage.removeItem("az_uid"); setStatus("auth"); }}
                                className="btn-fun btn-primary"
                            >
                                üîô Geri D√∂n
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-full flex items-center justify-center">
                    {/* Badge Notification - Geli≈ütirilmi≈ü & Mobil */}
                    {badge && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center pointer-events-none p-4">
                            <div className="relative">
                                {/* Arka plan efekti */}
                                <div className="absolute inset-0 bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 rounded-2xl sm:rounded-3xl blur-2xl sm:blur-3xl opacity-50 animate-pulse scale-125 sm:scale-150"></div>
                                
                                {/* Ana kart */}
                                <div className="glass-card p-4 sm:p-8 text-center pop-in relative overflow-hidden">
                                    {/* Parƒ±ltƒ± efekti */}
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 animate-pulse"></div>
                                    
                                    {/* ƒ∞√ßerik */}
                                    <div className="relative">
                                        <div className="text-[10px] sm:text-xs text-white/60 font-bold mb-1 sm:mb-2">‚ú® YENƒ∞ ROZET KAZANDIN! ‚ú®</div>
                                        <div className="w-16 h-16 sm:w-24 sm:h-24 mx-auto mb-2 sm:mb-4 rounded-xl sm:rounded-2xl flex items-center justify-center text-4xl sm:text-6xl bounce" 
                                             style={{ background: `linear-gradient(135deg, ${badge.color}40, ${badge.color}80)`, border: `3px solid ${badge.color}` }}>
                                            {badge.icon}
                                        </div>
                                        <div className="text-lg sm:text-2xl font-bold text-white mb-1 sm:mb-2">{badge.name}</div>
                                        <div className="text-xs sm:text-sm text-white/60">{badge.desc}</div>
                                        <div className="mt-2 sm:mt-3 inline-flex items-center gap-1 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-xs font-bold"
                                             style={{ background: `${badge.color}30`, color: badge.color }}>
                                            {badge.rarity && RARITY_NAMES[badge.rarity]}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Profile Modal */}
                    {showProfile && (
                        <ProfileModal 
                            user={user} 
                            onClose={() => setShowProfile(false)} 
                            onLogout={async () => {
                                if (confirm("√áƒ±kƒ±≈ü yapmak istediƒüine emin misin? ü§î")) {
                                    try {
                                        const success = await window.dbRemove(
                                            window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`)
                                        );
                                        if (!success) {
                                            console.error('Failed to remove from lobby');
                                        }
                                    } catch (e) {
                                        console.error('Logout error:', e);
                                    } finally {
                                        // Her durumda √ßƒ±kƒ±≈ü yap
                                        localStorage.removeItem("az_uid");
                                        setStatus("auth");
                                        setShowProfile(false);
                                    }
                                }
                            }}
                        />
                    )}

                    {/* Lobby */}
                    {status === "lobby" && (
                        <div className="w-full h-full flex flex-col items-center p-3 sm:p-4 pc-container relative overflow-y-auto">
                            {/* Profile Button */}
                            <button 
                                onClick={() => setShowProfile(true)}
                                className="absolute top-3 right-3 sm:top-6 sm:right-6 glass-card px-2 sm:px-4 py-1.5 sm:py-2 flex items-center gap-1 sm:gap-2 active:bg-white/20 transition cursor-pointer z-50"
                            >
                                <div className="w-6 h-6 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-xs sm:text-base">
                                    {user.name.charAt(0)}
                                </div>
                                <span className="font-bold text-white hidden sm:block text-sm">{user.name.split(' ')[0]}</span>
                            </button>

                            {/* Lobby Card */}
                            <div className="glass-card p-4 sm:p-8 max-w-md w-full text-center pop-in mt-12 sm:mt-16 mb-4 sm:mb-6">
                                <div className="text-4xl sm:text-6xl mb-2 sm:mb-4 bounce">üéÆ</div>
                                <h2 className="text-xl sm:text-2xl font-bold text-white mb-1 sm:mb-2">Rakip Aranƒ±yor</h2>
                                <p className="text-white/60 text-sm sm:text-base mb-3 sm:mb-4">{user.schoolName}</p>
                                
                                <div className="flex justify-center gap-3 sm:gap-4 mb-3 sm:mb-4">
                                    <div className="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-purple-500 animate-bounce" style={{ animationDelay: '0s' }}></div>
                                    <div className="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-pink-500 animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                    <div className="w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-blue-500 animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                </div>

                                <div className="status-badge status-online mx-auto text-xs sm:text-sm">
                                    <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full bg-white animate-pulse"></span>
                                    Lobiye Baƒülandƒ±
                                </div>
                                
                                <p className="text-white/40 text-[10px] sm:text-xs mt-3 sm:mt-4">
                                    üí° √ñƒüretmenin turnuvayƒ± ba≈ülatmasƒ±nƒ± bekle!
                                </p>
                            </div>

                            {/* Leaderboard */}
                            <Leaderboard currentUser={user} />
                        </div>
                    )}

                    {/* Playing */}
                    {status === "playing" && (
                        <GameShell 
                            gameId={gameId} 
                            playerRole={role} 
                            onWin={handleWin}
                            onBack={async () => {
                                // Oyundan √ßƒ±kƒ±ldƒ±ƒüƒ±nda oyunu iptal et
                                if (gameId) {
                                    try {
                                        // Oyun verisini al
                                        const gameSnap = await window.dbGet(window.dbRef(window.db, 'games/' + gameId));
                                        if (gameSnap.exists()) {
                                            const gameData = gameSnap.val();
                                            // Eƒüer oyun hen√ºz bitmemi≈üse, √ßƒ±kan oyuncuyu kaybeden yap
                                            if (!gameData.winner) {
                                                const winnerName = role === 'P1' ? gameData.players.p2.name : gameData.players.p1.name;
                                                const quitterName = role === 'P1' ? gameData.players.p1.name : gameData.players.p2.name;
                                                const success = await window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { 
                                                    winner: winnerName,
                                                    endReason: 'quit',
                                                    quitter: quitterName,
                                                    endedAt: Date.now()
                                                });
                                                if (!success) {
                                                    console.error('Failed to update game on quit');
                                                }
                                                // √áƒ±kan oyuncunun seri skorunu sƒ±fƒ±rla (kaybetti sayƒ±lƒ±r)
                                                await handleLose();
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Oyun iptal edilirken hata:', e);
                                    }
                                }
                                
                                // Lobiye geri d√∂n
                                try {
                                    setStatus("lobby");
                                    setGameId(null);
                                    setRole(null);
                                    const success = await window.dbUpdate(
                                        window.dbRef(window.db, 'lobby/' + `${user.schoolId}_${user.number}`), 
                                        { state: 'waiting', gameId: null, role: null }
                                    );
                                    if (!success) {
                                        console.error('Failed to reset lobby state');
                                    }
                                } catch (e) {
                                    console.error('Lobiye d√∂n√º≈ü hatasƒ±:', e);
                                    // En azƒ±ndan UI state'i g√ºncelle
                                    setStatus("lobby");
                                    setGameId(null);
                                    setRole(null);
                                }
                            }}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
