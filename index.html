<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AkÄ±l Zeka OyunlarÄ±</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063822.png">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByVamD_83D1gNH9wMiR0jtQErasgq7Gss",
            authDomain: "turnuva-2418e.firebaseapp.com",
            databaseURL: "https://turnuva-2418e-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "turnuva-2418e",
            storageBucket: "turnuva-2418e.firebasestorage.app",
            messagingSenderId: "299388405608",
            appId: "1:299388405608:web:e0985927f084bf803678dd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        window.db = db;
        window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue; window.dbUpdate = update; window.dbOnDisconnect = onDisconnect; window.dbGet = get; window.dbRemove = remove;
    </script>

    <style>
        /* CSS Reset & Base */
        html, body {
            height: 100%;
            overflow: hidden; /* KaydÄ±rmayÄ± engelle, oyun tam ekran olsun */
            touch-action: manipulation; /* Ã‡ift tÄ±klama zoom'unu engelle */
        }
        body { 
            background-color: #0f172a; 
            background-image: 
                radial-gradient(circle at 50% 0%, #1e293b 0%, transparent 70%),
                radial-gradient(circle at 100% 100%, #172554 0%, transparent 50%);
            font-family: 'Fredoka', sans-serif; 
            user-select:none; 
            -webkit-tap-highlight-color: transparent;
            color: #fff;
            margin: 0;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* 3D Butonlar */
        .btn-game { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(0); border-bottom-width: 4px; }
        .btn-game:active { transform: translateY(2px); border-bottom-width: 2px; }

        /* Misket TaÅŸÄ± */
        .marble {
            border-radius: 50%;
            box-shadow: inset -1px -1px 3px rgba(0,0,0,0.6), inset 1px 1px 2px rgba(255,255,255,0.5), 1px 1px 3px rgba(0,0,0,0.3);
            position: relative;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .marble::after {
            content: ''; position: absolute; top: 15%; left: 15%; width: 30%; height: 30%;
            border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.9), transparent);
            filter: blur(0.5px);
        }
        .marble-enter { animation: popIn 0.3s ease-out forwards; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Kuyu Efekti */
        .pit-container {
            background: #0f172a;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.8), inset 0 -1px 1px rgba(255,255,255,0.1), 0 1px 2px rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .active-pit {
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.9), 0 0 10px rgba(59, 130, 246, 0.6);
            border-color: #3b82f6;
        }
        .active-pit:active { transform: scale(0.95); }

        .animate-pop { animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popUp { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const BADGES = { first_win: {icon:"â­",name:"Ä°lk Zafer"}, mangala_master: {icon:"ğŸ¦",name:"Mangala Kurdu"}, reversi_brain: {icon:"ğŸ§ ",name:"Strateji DehasÄ±"}, streak_fire: {icon:"ğŸ”¥",name:"Yenilmez"} };

        // --- OYUN MOTORLARI ---
        function useMangalaGame(gameData, gameId, playerRole, onWin) {
            const moveStone = (pitIndex) => {
                if (gameData.winner) return;
                const isP1Turn = gameData.isP1Turn;
                const board = (gameData.board || []).map(n => parseInt(n, 10) || 0);

                if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                if (isP1Turn && (pitIndex < 0 || pitIndex > 5)) return;
                if (!isP1Turn && (pitIndex < 7 || pitIndex > 12)) return;
                if (board[pitIndex] === 0) return;

                let stones = board[pitIndex];
                let currentIndex = pitIndex;
                board[pitIndex] = 0; 

                if (stones === 1) {
                    currentIndex = (currentIndex + 1) % 14;
                    board[currentIndex] += 1;
                } else {
                    board[currentIndex] = 1; stones--; 
                    while (stones > 0) {
                        currentIndex = (currentIndex + 1) % 14;
                        if (isP1Turn && currentIndex === 13) continue;
                        if (!isP1Turn && currentIndex === 6) continue;
                        board[currentIndex] += 1; stones--;
                    }
                }

                const lastIndex = currentIndex;
                const p1Store = 6; const p2Store = 13;
                const isMyStore = isP1Turn ? lastIndex === p1Store : lastIndex === p2Store;
                const isOpponentSide = isP1Turn ? (lastIndex >= 7 && lastIndex <= 12) : (lastIndex >= 0 && lastIndex <= 5);
                const isMySide = isP1Turn ? (lastIndex >= 0 && lastIndex <= 5) : (lastIndex >= 7 && lastIndex <= 12);

                let nextTurnIsP1 = !isP1Turn;

                if (isMyStore) { nextTurnIsP1 = isP1Turn; }
                else if (isOpponentSide && board[lastIndex] % 2 === 0) {
                    const myStoreIndex = isP1Turn ? p1Store : p2Store;
                    board[myStoreIndex] += board[lastIndex]; board[lastIndex] = 0;
                }
                else if (isMySide && board[lastIndex] === 1) { 
                    const oppositeIndex = 12 - lastIndex;
                    if (board[oppositeIndex] > 0) {
                        const myStoreIndex = isP1Turn ? p1Store : p2Store;
                        board[myStoreIndex] += (board[lastIndex] + board[oppositeIndex]);
                        board[lastIndex] = 0; board[oppositeIndex] = 0;
                    }
                }

                const p1PitSum = board.slice(0, 6).reduce((a, b) => a + b, 0);
                const p2PitSum = board.slice(7, 13).reduce((a, b) => a + b, 0);
                let w = null;

                if (p1PitSum === 0 || p2PitSum === 0) {
                    if (p1PitSum === 0) { board[p1Store] += p2PitSum; for(let i=7; i<=12; i++) board[i] = 0; } 
                    else { board[p2Store] += p1PitSum; for(let i=0; i<=5; i++) board[i] = 0; }
                    if (board[p1Store] > board[p2Store]) w = gameData.players.p1.name;
                    else if (board[p2Store] > board[p1Store]) w = gameData.players.p2.name;
                    else w = "Berabere";
                    if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ? 'P1' : 'P2'; if(wRole === playerRole) onWin('mangala'); }
                }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: board, isP1Turn: nextTurnIsP1, winner: w });
            };
            return { moveStone };
        }

        function useReversiGame(gameData, gameId, playerRole, onWin) {
            const makeMove = (row, col) => {
                if (gameData.winner) return;
                const isP1Turn = gameData.isP1Turn; if ((playerRole === 'P1' && !isP1Turn) || (playerRole === 'P2' && isP1Turn)) return;
                const myColor = isP1Turn ? 1 : 2; const oppColor = isP1Turn ? 2 : 1; const board = gameData.board;
                if (board[row * 8 + col] !== 0) return;
                let flips = [];
                const directions = [[0,1], [1,0], [0,-1], [-1,0], [1,1], [1,-1], [-1,1], [-1,-1]];
                directions.forEach(([dr, dc]) => { let r = row + dr, c = col + dc; let potential = []; while (r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === oppColor) { potential.push(r*8+c); r += dr; c += dc; } if (potential.length > 0 && r>=0 && r<8 && c>=0 && c<8 && board[r*8+c] === myColor) flips.push(...potential); });
                if (flips.length === 0) return;
                let newBoard = [...board]; newBoard[row * 8 + col] = myColor;
                flips.forEach(idx => newBoard[idx] = myColor);
                let w = null; if (!newBoard.includes(0)) { const p1c = newBoard.filter(x => x === 1).length;
                const p2c = newBoard.filter(x => x === 2).length; w = p1c > p2c ?
                gameData.players.p1.name : (p2c > p1c ? gameData.players.p2.name : "Berabere"); if(w && w !== "Berabere") { const wRole = w === gameData.players.p1.name ?
                'P1' : 'P2'; if(wRole === playerRole) onWin('reversi'); } }
                window.dbUpdate(window.dbRef(window.db, 'games/' + gameId), { board: newBoard, isP1Turn: !isP1Turn, winner: w });
            };
            return { makeMove };
        }

        // --- MOBÄ°L UYUMLU MANGALA TASARIMI ---
        const MangalaBoard = ({ game, playerRole, onMove }) => {
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn);

            const Pit = ({ c, owner, store, act, active }) => {
                const stoneCount = Math.max(0, c || 0);
                // Mobilde performansÄ± artÄ±rmak iÃ§in max taÅŸ gÃ¶sterimini kÄ±stÄ±m
                const displayStones = stoneCount > 10 ? 10 : stoneCount;
                
                const getMarbleStyle = (owner) => {
                    return owner === 'me' 
                        ? 'bg-gradient-to-br from-amber-300 to-orange-600' 
                        : 'bg-gradient-to-br from-cyan-300 to-blue-600';
                };

                return (
                    <div onClick={act} 
                         className={`relative flex justify-center items-center rounded-2xl sm:rounded-3xl pit-container border sm:border-2 border-transparent
                         ${store ? 'w-full h-full' : 'w-full aspect-square'} 
                         ${active ? 'active-pit' : ''}`}>
                        
                        {/* TaÅŸlar: Mobilde daha sÄ±kÄ±ÅŸÄ±k, desktopta rahat */}
                        <div className="flex flex-wrap gap-0.5 sm:gap-1 justify-center items-center content-center w-full h-full p-1 sm:p-2 overflow-hidden">
                            {[...Array(displayStones)].map((_,i)=> (
                                <div key={i} className={`w-2.5 h-2.5 sm:w-4 sm:h-4 lg:w-5 lg:h-5 marble marble-enter ${getMarbleStyle(owner)}`} 
                                     style={{animationDelay: `${i*0.02}s`}}></div>
                            ))}
                            {stoneCount > 10 && <span className="font-bold text-slate-400 text-[9px] sm:text-xs">+{(stoneCount-10)}</span>}
                        </div>

                        {/* SayÄ± GÃ¶stergesi */}
                        <div className={`absolute -bottom-2 sm:-bottom-3 px-1.5 sm:px-3 py-0.5 rounded-full text-[10px] sm:text-xs font-bold shadow-lg border border-slate-600 text-white min-w-[1.2rem] text-center z-10
                            ${active ? 'bg-blue-600' : 'bg-slate-800'}`}>
                            {stoneCount}
                        </div>
                    </div>
                );
            };

            return (
                <div className="w-full h-full flex items-center justify-center p-2 sm:p-4">
                    {/* Ana Kasa: Esnek GeniÅŸlik */}
                    <div className="bg-slate-800 p-2 sm:p-6 rounded-[2rem] shadow-2xl border-2 sm:border-4 border-slate-700 w-full max-w-5xl">
                        
                        <div className="flex gap-2 sm:gap-4 h-[60vh] sm:h-auto sm:aspect-[2/1] max-h-[500px]">
                            
                            {/* Rakip Hazine (Sol) */}
                            <div className="w-1/6 sm:w-24 flex flex-col items-center gap-1 sm:gap-2">
                                <div className="text-[8px] sm:text-[10px] font-bold text-slate-500 bg-slate-900 px-2 py-0.5 rounded border border-slate-700">RAKÄ°P</div>
                                <Pit c={playerRole==='P1'?board[13]:board[6]} owner="opponent" store={true} />
                            </div>

                            {/* Kuyular AlanÄ± (OrtasÄ±) */}
                            <div className="flex-1 flex flex-col justify-between gap-2 sm:gap-4">
                                {/* Rakip SÄ±rasÄ± */}
                                <div className="flex-1 grid grid-cols-6 gap-1 sm:gap-3 bg-slate-900/50 p-2 sm:p-3 rounded-2xl border border-slate-700/50 direction-rtl">
                                    {/* direction-rtl yerine manuel reverse map daha gÃ¼venli */}
                                    {[0,1,2,3,4,5].map(i => { 
                                        const idx = playerRole==='P1' ? (12-i) : (5-i); 
                                        return <div className="flex items-center justify-center" key={idx}><Pit c={board[idx]} owner="opponent"/></div>
                                    })}
                                </div>

                                {/* Benim SÄ±ram */}
                                <div className={`flex-1 grid grid-cols-6 gap-1 sm:gap-3 bg-slate-900/50 p-2 sm:p-3 rounded-2xl border transition-colors duration-300 ${isMyTurn ? 'border-blue-500/30 bg-blue-900/10' : 'border-slate-700/50'}`}>
                                    {[0,1,2,3,4,5].map(i => { 
                                        const idx = playerRole==='P1' ? i : (i+7); 
                                        return <div className="flex items-center justify-center" key={idx}><Pit c={board[idx]} owner="me" active={isMyTurn} act={()=>isMyTurn && onMove(idx)}/></div>
                                    })}
                                </div>
                            </div>

                            {/* Benim Hazine (SaÄŸ) */}
                            <div className="w-1/6 sm:w-24 flex flex-col items-center gap-1 sm:gap-2">
                                <div className="text-[8px] sm:text-[10px] font-bold text-amber-500 bg-slate-900 px-2 py-0.5 rounded border border-amber-900/30">SEN</div>
                                <Pit c={playerRole==='P1'?board[6]:board[13]} owner="me" store={true} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ReversiBoard = ({ game, playerRole, onMove }) => {
            const board = (game.board || []).map(n => parseInt(n, 10) || 0);
            const isMyTurn = (playerRole === 'P1' && game.isP1Turn) || (playerRole === 'P2' && !game.isP1Turn); const black = board.filter(x=>x===1).length;
            const white = board.filter(x=>x===2).length;
            return (<div className="flex flex-col items-center gap-4 w-full max-w-md"><div className="flex gap-4 w-full"><div className="flex-1 bg-slate-800 text-white p-4 rounded-2xl flex items-center justify-between border-b-4 border-slate-950 shadow"><div className="w-8 h-8 bg-black rounded-full border-2 border-slate-600 shadow-lg"></div> <span className="text-3xl font-bold">{black}</span></div><div className="flex-1 bg-slate-200 text-slate-900 p-4 rounded-2xl flex items-center justify-between border-b-4 border-slate-400 shadow"><div className="w-8 h-8 bg-white rounded-full border-2 border-slate-300 shadow-lg"></div> <span className="text-3xl font-bold">{white}</span></div></div><div className="bg-green-800 p-3 rounded-xl shadow-[0_10px_0_#14532d] border-4 border-green-900 w-full aspect-square"><div className="grid grid-cols-8 gap-1 h-full w-full">{board.map((cell, i) => (<div key={i} onClick={() => isMyTurn && onMove(Math.floor(i/8), i%8)} className="bg-green-600 rounded flex items-center justify-center cursor-pointer hover:bg-green-500 relative shadow-inner">{cell !== 0 && (<div className={`w-[80%] h-[80%] rounded-full shadow-lg transition-transform duration-300 hover:scale-105 ${cell===1 ? 'bg-slate-900 border-2 border-slate-700' : 'bg-white border-2 border-slate-200'}`}></div>)}</div>))}</div></div></div>);
        };

        const AuthScreen = ({ onLogin, onRegister }) => {
            const [mode, setMode] = useState("login");
            const [schools, setSchools] = useState([]); const [schoolId, setSchoolId] = useState(""); const [number, setNumber] = useState(""); const [password, setPassword] = useState("");
            const [name, setName] = useState(""); const [cls, setCls] = useState("");
            
            useEffect(() => { 
                if(window.dbRef && window.dbOnValue) {
                    window.dbOnValue(window.dbRef(window.db, 'schools'), (snap) => { const val = snap.val(); if(val) setSchools(Object.values(val)); }); 
                }
            }, []);

            const doLogin = () => { if(!schoolId || !number || !password) return alert("Eksik bilgi!"); onLogin(schoolId, number, password); };
            const doRegister = () => { if(!schoolId || !number || !password || !name || !cls) return alert("TÃ¼m alanlarÄ± doldur!");
            const selectedSchool = schools.find(s => s.id === schoolId); onRegister({ schoolId, schoolName: selectedSchool.name, number, password, name, class: cls }); };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-4 overflow-y-auto">
                    <div className="bg-slate-800/90 backdrop-blur-xl p-6 sm:p-8 rounded-3xl shadow-2xl w-full max-w-sm border border-slate-700 animate-pop my-auto">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 sm:w-20 sm:h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-3xl sm:text-4xl shadow-lg mb-4 text-white rotate-3 hover:rotate-6 transition"><i className="fas fa-brain"></i></div>
                            <h1 className="text-xl sm:text-2xl font-bold text-white tracking-wide">AKIL OYUNLARI</h1>
                            <p className="text-slate-400 text-xs sm:text-sm font-medium mt-1">{mode==="login"?"Turnuva Platformu":"Oyuncu KaydÄ±"}</p>
                        </div>
                        <div className="space-y-3 sm:space-y-4">
                            <div className="bg-slate-900/50 p-2 rounded-xl border border-slate-700"><label className="block text-[10px] font-bold text-blue-400 ml-2 mb-1 tracking-wider">OKUL SEÃ‡Ä°MÄ°</label><select value={schoolId} onChange={e=>setSchoolId(e.target.value)} className="w-full bg-transparent font-bold text-slate-200 outline-none p-1 sm:p-2 text-sm"><option value="">Listeden seÃ§iniz...</option>{schools.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                            {mode === "register" && (<><input placeholder="Ad Soyad" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl font-bold outline-none focus:border-blue-500 text-white placeholder-slate-600 text-sm" /><input placeholder="SÄ±nÄ±f (Ã–rn: 5-A)" value={cls} onChange={e=>setCls(e.target.value)} className="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl font-bold outline-none focus:border-blue-500 text-white placeholder-slate-600 text-sm" /></>)}
                            <div className="grid grid-cols-2 gap-3"><input placeholder="Okul No" value={number} onChange={e=>setNumber(e.target.value)} className="bg-slate-900 border border-slate-700 p-3 rounded-xl font-bold outline-none focus:border-blue-500 text-white text-center placeholder-slate-600 text-sm" /><input type="password" placeholder="Åifre" value={password} onChange={e=>setPassword(e.target.value)} className="bg-slate-900 border border-slate-700 p-3 rounded-xl font-bold outline-none focus:border-blue-500 text-white text-center placeholder-slate-600 text-sm" /></div>
                            {mode === "login" ?
                            (<button onClick={doLogin} className="w-full bg-blue-600 text-white py-3 sm:py-4 rounded-xl font-bold text-sm btn-game border-blue-800 shadow-lg hover:bg-blue-500">GÄ°RÄ°Å YAP</button>) : (<button onClick={doRegister} className="w-full bg-emerald-600 text-white py-3 sm:py-4 rounded-xl font-bold text-sm btn-game border-emerald-800 shadow-lg hover:bg-emerald-500">KAYDI TAMAMLA</button>)}
                        </div>
                        <div className="text-center mt-6"><button onClick={()=>setMode(mode==="login"?"register":"login")} className="text-blue-400 font-bold hover:text-blue-300 transition text-xs">{mode==="login" ? "Hesap OluÅŸtur" : "GiriÅŸ EkranÄ±na DÃ¶n"}</button></div>
                    </div>
                </div>
            );
        };

        const PendingScreen = ({ onBack }) => (<div className="min-h-screen flex flex-col items-center justify-center p-6 text-center text-white"><div className="text-6xl mb-6 animate-pulse text-blue-500"><i className="fas fa-hourglass-half"></i></div><h2 className="text-2xl font-bold mb-2">Onay Bekleniyor</h2><p className="text-slate-400 text-sm mb-8 max-w-xs mx-auto">KaydÄ±n Ã¶ÄŸretmen ekranÄ±na dÃ¼ÅŸtÃ¼. OnaylandÄ±ÄŸÄ±nda otomatik giriÅŸ yapabileceksin.</p><button onClick={onBack} className="bg-slate-800 text-white px-8 py-3 rounded-full font-bold btn-game border-slate-950 text-sm">Geri DÃ¶n</button></div>);
        
        const LobbyScreen = ({ user, onProfile }) => (<div className="min-h-screen flex flex-col items-center justify-center p-4 text-center"><button onClick={onProfile} className="absolute top-4 right-4 bg-slate-800 border border-slate-700 p-2 pr-4 pl-2 rounded-full flex items-center gap-3 hover:bg-slate-700 transition text-white shadow-lg z-10"><div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center border border-blue-400"><i className="fas fa-user"></i></div><span className="font-bold text-sm text-slate-200">{user.name.split(' ')[0]}</span></button><div className="bg-slate-800/80 backdrop-blur rounded-[2rem] p-6 sm:p-10 w-full max-w-md shadow-2xl animate-pop border border-slate-700 relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500"></div><div className="w-16 h-16 sm:w-20 sm:h-20 bg-slate-900 rounded-full mx-auto flex items-center justify-center text-3xl sm:text-4xl mb-6 text-blue-500 border border-slate-700 shadow-inner"><i className="fas fa-gamepad"></i></div><h2 className="text-xl sm:text-2xl font-bold text-white mb-2">Rakip AranÄ±yor</h2><p className="text-slate-400 font-medium mb-8 text-sm">{user.schoolName} <span className="mx-2 text-slate-600">|</span> <span className="text-blue-400">{user.class}</span></p><div className="bg-blue-900/30 text-blue-300 px-6 py-4 rounded-xl font-bold border border-blue-500/30 flex items-center justify-center gap-3 animate-pulse"><div className="w-2 h-2 bg-blue-400 rounded-full"></div>Lobiye BaÄŸlÄ±sÄ±n</div></div></div>);
        
        const ProfileModal = ({ user, onClose, onLogout }) => (<div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}><div className="bg-slate-900 rounded-3xl w-full max-w-md overflow-hidden shadow-2xl animate-pop border border-slate-700" onClick={e=>e.stopPropagation()}><div className="bg-slate-800 p-6 sm:p-8 text-white text-center relative border-b border-slate-700"><button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white"><i className="fas fa-times"></i></button><div className="w-16 h-16 sm:w-20 sm:h-20 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-3xl mb-4 text-white shadow-lg"><i className="fas fa-user-astronaut"></i></div><h2 className="text-xl font-bold">{user.name}</h2><p className="text-slate-400 text-sm">{user.schoolName}</p><div className="mt-6 flex justify-center gap-4"><div className="bg-slate-900 rounded-xl p-3 px-5 border border-slate-700"><div className="text-xl font-bold text-blue-400">ğŸ† {user.stats?.wins || 0}</div><div className="text-[10px] text-slate-500 font-bold tracking-wider">ZAFER</div></div><div className="bg-slate-900 rounded-xl p-3 px-5 border border-slate-700"><div className="text-xl font-bold text-purple-400">ğŸ… {(user.badges || []).length}</div><div className="text-[10px] text-slate-500 font-bold tracking-wider">ROZET</div></div></div></div><div className="p-6 bg-slate-950/50 max-h-[40vh] overflow-auto"><h3 className="font-bold text-slate-500 mb-4 text-xs tracking-widest">KAZANILAN ROZETLER</h3><div className="grid grid-cols-2 gap-3">{Object.entries(BADGES).map(([key, data]) => { const hasBadge = (user.badges || []).includes(key); return (<div key={key} className={`p-3 rounded-xl border flex items-center gap-3 transition-all ${hasBadge ? 'bg-slate-800 border-blue-500/50 opacity-100' : 'bg-slate-900 border-slate-800 opacity-40 grayscale'}`}><div className="text-2xl">{data.icon}</div><div><div className="font-bold text-xs text-slate-300">{data.name}</div>{hasBadge && <div className="text-[9px] text-emerald-400 font-bold mt-1">AKTÄ°F</div>}</div></div>); })}</div></div><div className="p-4 bg-slate-900 border-t border-slate-800"><button onClick={onLogout} className="w-full py-3 bg-red-900/20 text-red-400 rounded-xl font-bold hover:bg-red-900/40 transition border border-red-900/30 text-sm">OTURUMU KAPAT</button></div></div></div>);
        
        const GameContainer = ({ gameId, playerRole, onBack, onWin }) => {
            const [gameData, setGameData] = useState(null);
            useEffect(() => { const gameRef = window.dbRef(window.db, 'games/' + gameId); const unsubscribe = window.dbOnValue(gameRef, (s) => setGameData(s.val())); return () => unsubscribe(); }, [gameId]);
            if (!gameData) return <div className="min-h-screen flex items-center justify-center text-white font-bold"><div className="animate-spin text-4xl text-blue-500"><i className="fas fa-circle-notch"></i></div></div>;
            const gameType = gameData.type || 'mangala';
            return (
                <div className="flex flex-col items-center justify-start pt-2 sm:pt-6 min-h-screen pb-10 w-full">
                    <div className="w-full max-w-6xl flex justify-between items-center mb-4 sm:mb-8 px-4"><div className="bg-slate-800 text-slate-400 px-3 py-1 sm:px-4 sm:py-2 rounded-lg text-[10px] sm:text-xs font-bold border border-slate-700 tracking-wider">ODA: {gameId}</div><button onClick={onBack} className="bg-red-600 text-white px-4 py-1.5 sm:px-6 sm:py-2 rounded-lg text-[10px] sm:text-xs font-bold hover:bg-red-700 transition shadow-lg">Ã‡IKIÅ</button></div>
                    <div className="mb-4 sm:mb-8 text-center w-full px-4">{gameData.winner ? 
                    (<div className="bg-slate-800 p-6 sm:p-8 rounded-3xl shadow-2xl border border-slate-700 animate-pop inline-block"><h2 className="text-2xl sm:text-3xl font-black text-white mb-2">OYUN BÄ°TTÄ°</h2><p className="text-base sm:text-lg font-medium text-slate-400">Kazanan: <span className="text-amber-400 font-bold">{gameData.winner}</span> ğŸ†</p></div>) : (<div className={`inline-block px-6 py-2 sm:px-10 sm:py-4 rounded-xl text-white font-bold text-xs sm:text-sm shadow-2xl border transition-all duration-300 transform ${((playerRole==='P1' && gameData.isP1Turn)||(playerRole==='P2' && !gameData.isP1Turn)) ?
                    'bg-blue-600 border-blue-400 scale-105 shadow-blue-900/50' : 'bg-slate-800 border-slate-700 text-slate-500 scale-100'}`}>{((playerRole==='P1' && gameData.isP1Turn)||(playerRole==='P2' && !gameData.isP1Turn)) ?
                    "HAMLE SIRASI SÄ°ZDE" : "RAKÄ°P DÃœÅÃœNÃœYOR..."}</div>)}</div>
                    {gameType === 'reversi' ?
                    <ReversiBoard game={gameData} playerRole={playerRole} onMove={useReversiGame(gameData, gameId, playerRole, onWin).makeMove} /> : <MangalaBoard game={gameData} playerRole={playerRole} onMove={useMangalaGame(gameData, gameId, playerRole, onWin).moveStone} />}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState("loading"); const [activeGameId, setActiveGameId] = useState(null); const [playerRole, setPlayerRole] = useState(null); const [showProfile, setShowProfile] = useState(false);
            const [newBadge, setNewBadge] = useState(null);
            
            useEffect(() => { 
                const savedUID = localStorage.getItem("az_uid"); 
                if (savedUID) checkUserStatus(savedUID); 
                else setStatus("auth"); 
            }, []);

            const checkUserStatus = (uid) => { window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(snap => { if (snap.exists()) { setUser(snap.val()); connectToLobby(snap.val(), uid); } else { window.dbGet(window.dbRef(window.db, 'pending_users/' + uid)).then(pSnap => { if (pSnap.exists()) setStatus("pending"); else { localStorage.removeItem("az_uid"); setStatus("auth"); } }); } }); };
            const connectToLobby = (userData, uid) => { const lobbyRef = window.dbRef(window.db, 'lobby/' + uid);
            window.dbUpdate(lobbyRef, { name: userData.name, class: userData.class, schoolName: userData.schoolName, state: 'waiting', uid: uid }); window.dbOnDisconnect(lobbyRef).remove(); setStatus("lobby"); };
            const handleLogin = (schoolId, number, password) => { const uid = `${schoolId}_${number}`;
            window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(snap => { if (snap.exists()) { const data = snap.val(); if (data.password === password) { localStorage.setItem("az_uid", uid); setUser(data); connectToLobby(data, uid); } else alert("Åifre hatalÄ±!"); } else { window.dbGet(window.dbRef(window.db, 'pending_users/' + uid)).then(pSnap => { if(pSnap.exists()) alert("HesabÄ±nÄ±z onay bekliyor."); else alert("BÃ¶yle bir kayÄ±t bulunamadÄ±."); }); } }); };
            const handleRegister = (formData) => { const uid = `${formData.schoolId}_${formData.number}`;
            window.dbGet(window.dbRef(window.db, 'users/' + uid)).then(snap => { if(snap.exists()) return alert("Bu numara zaten kayÄ±tlÄ±!"); window.dbGet(window.dbRef(window.db, 'pending_users/' + uid)).then(pSnap => { if(pSnap.exists()) return alert("Zaten onay bekliyor!"); const newUser = { ...formData, badges: [], stats: {wins:0, games:0}, joinedAt: Date.now() }; window.dbSet(window.dbRef(window.db, 'pending_users/' + uid), newUser); alert("KayÄ±t alÄ±ndÄ±! Ã–ÄŸretmen onaylayÄ±nca girebilirsin."); setStatus("auth"); }); }); };
            const handleLogout = () => { if(confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸine emin misin?")) { const uid = `${user.schoolId}_${user.number}`;
            window.dbRemove(window.dbRef(window.db, 'lobby/' + uid)); localStorage.removeItem("az_uid"); setUser(null); setStatus("auth"); setShowProfile(false); } };
            const handleWin = async (gameType) => { if(!user) return;
            const uid = `${user.schoolId}_${user.number}`; const userRef = window.dbRef(window.db, 'users/' + uid); const snap = await window.dbGet(userRef); let userData = snap.val();
            userData.stats.wins = (userData.stats.wins || 0) + 1; let badges = userData.badges || []; let won = null;
            if (!badges.includes("first_win") && userData.stats.wins >= 1) { badges.push("first_win"); won = "first_win"; } if (!badges.includes("streak_fire") && userData.stats.wins >= 3) { badges.push("streak_fire");
            won = "streak_fire"; } if (!badges.includes("mangala_master") && gameType === 'mangala') { badges.push("mangala_master"); won = "mangala_master";
            } if (!badges.includes("reversi_brain") && gameType === 'reversi') { badges.push("reversi_brain"); won = "reversi_brain"; } userData.badges = badges; await window.dbUpdate(userRef, userData); setUser(userData);
            if(won) { setNewBadge(BADGES[won]); setTimeout(() => setNewBadge(null), 4000); } };
            useEffect(() => { if (status !== "lobby" || !user) return; const uid = `${user.schoolId}_${user.number}`; const myRef = window.dbRef(window.db, 'lobby/' + uid); const unsubscribe = window.dbOnValue(myRef, (snapshot) => { const data = snapshot.val(); if (data && data.gameId) { setActiveGameId(data.gameId); setPlayerRole(data.role); setStatus("playing"); } }); return () => unsubscribe(); }, [status, user]);
            
            if(status === "loading") return <div className="min-h-screen flex items-center justify-center text-white font-bold"><div className="animate-spin text-4xl text-blue-500"><i className="fas fa-circle-notch"></i></div></div>;
            if(status === "auth") return <AuthScreen onLogin={handleLogin} onRegister={handleRegister} />;
            if(status === "pending") return <PendingScreen onBack={()=>{localStorage.removeItem("az_uid"); setStatus("auth")}} />;
            return (
                <div className="font-sans antialiased h-full w-full">
                    {newBadge && (<div className="fixed inset-0 flex items-center justify-center z-50 pointer-events-none"><div className="bg-slate-900 p-8 rounded-[2rem] shadow-2xl text-center border border-amber-500/50 animate-pop pointer-events-auto relative overflow-hidden max-w-xs w-full"><div className="absolute inset-0 bg-amber-500/10 animate-pulse"></div><div className="text-7xl mb-4 animate-bounce">{newBadge.icon}</div><h2 className="text-2xl font-black text-amber-500 mb-2">HARÄ°KA!</h2><p className="font-bold text-slate-300 text-sm">{newBadge.name}</p></div></div>)}
                
                    {showProfile && user && <ProfileModal user={user} onClose={()=>setShowProfile(false)} onLogout={handleLogout} />}
                    {status === "lobby" && <LobbyScreen user={user} onProfile={()=>setShowProfile(true)} />}
                    {status === "playing" && (<GameContainer gameId={activeGameId} playerRole={playerRole} onWin={handleWin} onBack={() => { setStatus("lobby");
                    setActiveGameId(null); const uid = `${user.schoolId}_${user.number}`; window.dbUpdate(window.dbRef(window.db, 'lobby/' + uid), { state: 'waiting', gameId: null, role: null });
                    }} />)}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>